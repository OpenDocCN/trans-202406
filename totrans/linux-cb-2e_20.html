<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Troubleshooting a Linux PC"><div class="chapter" id="cha-trouble">
<h1><span class="label">Chapter 20. </span>Troubleshooting a Linux PC</h1>


<p>Linux includes numerous utilities to help diagnose and fix problems, enough to
fill several thick books. In this chapter, the focus is on using system logs to find out what went wrong, building a central systemd logging server, monitoring
hardware health, finding and stopping troublesome processes, getting the best
performance from hardware, and tips and tricks for diagnosing hardware issues.</p>






<section data-type="sect1" class="orm:non-recipe" data-pdf-bookmark="Overview"><div class="sect1" id="idm46466153611832">
<h1>Overview</h1>

<p>Get to<a data-type="indexterm" data-primary="troubleshooting" data-secondary="logging" data-tertiary="purpose of" id="idm46466153610104"/><a data-type="indexterm" data-primary="logging" data-secondary="purpose of" id="idm46466153609016"/> know your system logs well, and you will find the causes of problems. If
learning the cause does not point you to a solution, you have the information you
need to ask for help, whether it’s product documentation, distribution
documentation, paid support, or community support.</p>

<p>Get well-acquainted <a data-type="indexterm" data-primary="troubleshooting" data-secondary="documentation, purpose of" id="idm46466153602840"/><a data-type="indexterm" data-primary="documentation, purpose of" id="idm46466153604184"/><a data-type="indexterm" data-primary="system logs" data-see="logging" id="idm46466153608040"/><a data-type="indexterm" data-primary="debugging" data-see="troubleshooting" id="idm46466153607192"/>with the documentation for your Linux distributions,
especially changelogs and release notes, and the documentation for the servers
and applications that you use. Ubuntu, Fedora, and openSUSE all
excel at maintaining their documentation and detailed release notes. Also get
acquainted with the forums, wikis, and chats for your distro, servers, and
applications. For every issue you encounter, it is likely many other users have
dealt with the same issue.</p>








<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="Prevention"><div class="sect2" id="idm46466153605624">
<h2>Prevention</h2>

<p>Most <a data-type="indexterm" data-primary="troubleshooting" data-secondary="hardware" data-tertiary="preventing problems" id="troubleshoot-hardware-prevent"/><a data-type="indexterm" data-primary="hardware" data-secondary="preventing problems" id="hardware-prevent"/><a data-type="indexterm" data-primary="preventing hardware problems" id="prevent-hardware"/>errors are caused by software. Even consumer-grade hardware is pretty
robust, and it fails most often from abuse and age. The most common hardware
failures are components with moving parts:</p>

<ul>
<li>
<p>SATA and SCSI disk drives</p>
</li>
<li>
<p>CPU coolers</p>
</li>
<li>
<p>Power supplies</p>
</li>
<li>
<p>Case fans</p>
</li>
<li>
<p>CD/DVD drives</p>
</li>
</ul>

<p>There are simple measures you can take to extend the life of your
hardware. Overheating <a data-type="indexterm" data-primary="cooling" data-secondary="hardware" id="idm46466153589064"/>and unreliable electricity are electronics killers. Good
cooling is essential for keeping your computers healthy. Good cooling comes from
well-designed cases that provide proper airflow, heat sinks and CPU coolers, and
case fans oriented so that air is pulled in and pushed out correctly. This can get
a little noisy, and you can buy cases, power supplies, and fans that run quietly.
Vacuum out your computer insides periodically with a nonstatic vacuum, and
clean case filters. If you prefer using compressed air to blow the dust out, be
careful with fans. If you spin them too fast you can damage their bearings.</p>

<p>A power conditioner <a data-type="indexterm" data-primary="power conditioners" id="idm46466153590312"/>provides continuous protection from voltage sags and spikes,
and from radio and electromagnetic interference. Surge protectors cost less, but
only provide protection from surges. Voltage sags are just as damaging as spikes.
A power conditioner more than pays for itself in longer life and stable<a data-type="indexterm" data-primary="troubleshooting" data-secondary="hardware" data-tertiary="preventing problems" data-startref="troubleshoot-hardware-prevent" id="idm46466153589704"/><a data-type="indexterm" data-primary="hardware" data-secondary="preventing problems" data-startref="hardware-prevent" id="idm46466153582056"/><a data-type="indexterm" data-primary="preventing hardware problems" data-startref="prevent-hardware" id="idm46466153580840"/> operation.</p>
</div></section>













<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="Patience"><div class="sect2" id="idm46466153602040">
<h2>Patience</h2>

<p>Patience <a data-type="indexterm" data-primary="troubleshooting" data-secondary="patience, importance of" id="troubleshoot-patience"/><a data-type="indexterm" data-primary="patience, importance of" id="patience"/>is your best friend when debugging problems. It’s best to take it slowly and 
<span class="keep-together">systematically</span>:</p>

<ul>
<li>
<p>Review instructions and make sure you did not miss any steps or make a mistake.</p>
</li>
<li>
<p>Is an update available? Many times this is the solution.</p>
</li>
<li>
<p>Copy error messages and log file entries, and use them in web searches and
trouble tickets.</p>
</li>
<li>
<p>What are the last things that happened before the error occurred? What are the
exact steps that created the error? Is it reproducible?</p>
</li>
<li>
<p>Are the last things that happened reversible? If the answer is yes, undo them one
at a time and test. Making multiple changes at once means you may not discover what
caused the error.</p>
</li>
<li>
<p>As a last resort, reboot. Really! This works a surprising number of times to
resolve the issue, though you may not learn what the problem was.</p>
</li>
</ul>

<p>Some graphical applications, such as the wonderful digiKam photo manager and
editor, emit all manner of details when you start them from a terminal, as this
snippet shows after digiKam failed to start:</p>
<pre>$ <strong>digikam</strong>
Object::connect: No such signal org::freedesktop::UPower::DeviceAdded(QString)
Object::connect: No such signal org::freedesktop::UPower::DeviceRemoved(QString)
digikam: symbol lookup error: digikam: undefined symbol:
_ZNK11KExiv2Iface14AltLangStrEdit8textEditEv
</pre>

<p>I have no idea what this means, but someone does, so I can reference this in a
web search, or ask for help in the digiKam forums.</p>

<p>When you ask for help, remember patience and courtesy. When you are asked for
additional information, provide exactly what you are asked for. When you resolve
your issue, share your solution and thank the people who <a data-type="indexterm" data-primary="troubleshooting" data-secondary="patience, importance of" data-startref="troubleshoot-patience" id="idm46466153571368"/><a data-type="indexterm" data-primary="patience, importance of" data-startref="patience" id="idm46466153569192"/>helped you.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.1 Finding Useful Information in Logfiles"><div class="sect1" id="rec-logfiles">
<h1>20.1 Finding Useful Information in Logfiles</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153565512">
<h2>Problem</h2>

<p>Weird stuff<a data-type="indexterm" data-primary="troubleshooting" data-secondary="logging" data-tertiary="viewing log files" id="troubleshoot-log-view"/><a data-type="indexterm" data-primary="logging" data-secondary="viewing log files" id="logging-view"/><a data-type="indexterm" data-primary="displaying" data-secondary="log files" id="display-log"/> is happening, and you need to know where to start figuring it out.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153559864">
<h2>Solution</h2>

<p>Log everything, and then read your logfiles. <em>/var/log</em> contains log files, and
the <em>dmesg</em> and <em>journalctl</em> commands display log messages.
systemd manages all logs with <em>journald</em>, so you will see a lot of duplication
with <em>dmesg</em> and <em>/var/log</em>.</p>

<p><em>dmesg</em> reads<a data-type="indexterm" data-primary="dmesg command" id="dmesg"/> the kernel ring buffer, which is a special memory location for
recording kernel activity. Look in <em>dmesg</em> to see everything that happened at
startup; hardware activity after startup, such as attaching and removing
USB devices; and network interface activity. The kernel ring buffer is a fixed
size, so new entries overwrite the oldest entries. Nothing is lost because the
kernel logs are stored in <em>/var/log/messages</em>, <em>/var/log/dmesg</em>, and
<em>journalctl</em>.</p>

<p>Read <em>dmesg</em> like this:</p>
<pre>$ <strong>dmesg | less</strong>
[    0.000000] microcode: microcode updated early to revision 0x28,
date = 2019-11-12
[    0.000000] Linux version 5.8.0-45-generic (buildd@lcy01-amd64-024) (gcc
(Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0, GNU ld (GNU Binutils for Ubuntu) 2.34)
#51~20.04.1-Ubuntu SMP Tue Feb 23 13:46:31 UTC 2021
(Ubuntu 5.8.0-45.51~20.04.1-generic 5.8.18)
[...]</pre>

<p>When you are looking for something specific, use <em>grep</em>, like<a data-type="indexterm" data-primary="grep command" id="grep"/> when you are having
trouble with a storage drive:</p>
<pre>$ <strong>dmesg | grep -w sd</strong>
[11236.888910] sd 7:0:0:0: [sdd] Attached SCSI removable disk
[11245.095341] FAT-fs (sdd1): Volume was not properly unmounted. Some data may
be corrupt. Please run fsck.</pre>
<div data-type="tip"><h1>Finding Whole Words with grep</h1>
<p>When you want to find a word with <em>grep</em> use the <em>-w</em> switch. For example,
when you grep for <em>ping</em> you will get results like piping, escaping, sleeping.
<em>-w</em> returns only whole word<a data-type="indexterm" data-primary="grep command" data-startref="grep" id="idm46466153542088"/> matches.</p>
</div>

<p>Run <em>dmesg -T</em> to see human-readable timestamps:</p>
<pre>$ <strong>dmesg -T | less</strong>
[Tue Mar 23 15:25:17 2021] PCI: CLS 64 bytes, default 64
[Tue Mar 23 15:25:17 2021] Trying to unpack rootfs image as initramfs...
[Tue Mar 23 15:25:17 2021] Freeing initrd memory: 56008K
[...]</pre>

<p>The default is the seconds and nanoseconds since startup. Run <em>dmesg --follow</em>
to monitor new events as they occur, such as plugging and unplugging USB devices.
Press Ctrl-C to stop.</p>

<p>Look for certain logging levels, such as errors and warnings:</p>
<pre>$ <strong>dmesg -l err,warn</strong></pre>

<p>Run <em>dmesg -h</em> to see commands and <a data-type="indexterm" data-primary="dmesg command" data-startref="dmesg" id="idm46466153534856"/>options.</p>

<p><em>/var/log</em> is<a data-type="indexterm" data-primary="/var/log" id="idm46466153533160"/> the legacy location for log files, and you will still find logs
there, depending on how your Linux distribution manages them. <em>/var/log</em> is easy
to search because most of the files are in plain text. When you’re not sure
where to start looking, <em>grep</em> the whole directory.</p>

<p>For example, suppose you
thought you installed <em>graphicsmagick</em>, but can’t find it. Take a quick look in
<em>/var/log</em>, and there it is, a record of its 
<span class="keep-together">installation</span>:</p>
<pre>$ <strong>sudo grep -ir graphicsmagick /var/log</strong>
apt/history.log:Install: libgraphicsmagick-q16-3:amd64 (1.4+really1.3.35-1,
automatic), graphicsmagick:amd64 (1.4+really1.3.35-1)
[...]
/var/log/dpkg.log:2021-03-11 17:00:57 install libgraphicsmagick-q16-3:amd64
1.4+really1.3.35-1
[...]
</pre>

<p>Systemd stuffs <a data-type="indexterm" data-primary="journalctl command" id="journalctl"/><a data-type="indexterm" data-primary="systemd" data-secondary="journalctl" id="systemd-journalctl"/>all logging into <em>journalctl</em>, so you can use it exclusively and
not bother with <em>dmesg</em> and <em>/var/log</em>:</p>
<pre>$ <strong>journalctl</strong></pre>

<p>Invoke it with <em>sudo</em> to see if that adds any more information. Usually it
doesn’t.</p>

<p><em>journalctl</em> defaults to displaying oldest entries first. Press the spacebar or PageUp/
Down keys to navigate a screen at a time, or use the arrow keys to scroll one line at
a time. Ctrl-End goes all the way to the newest, and Ctrl-Home goes back to the
oldest. Press the Q key to exit.</p>

<p class="pagebreak-before less_space">See newest entries first:</p>
<pre>$ <strong>journalctl -r</strong></pre>

<p>It does not wrap long lines by default, so you have to use arrow keys to read
long lines. Make it wrap by piping its output to <em>less</em>:</p>
<pre>$ <strong>journalctl -r | less</strong></pre>

<p>See the most recent entries, with explanation messages, if there are any. This
shows an example of an explanation message:</p>
<pre>$ <strong>journalctl -ex | less</strong>

-- The unit grub-initrd-fallback.service has successfully entered the 'dead'
state.
Mar 27 10:14:29 client4 systemd[1]: Finished GRUB failed boot detection.
-- Subject: A start job for unit grub-initrd-fallback.service has finished
successfully
-- Defined-By: systemd</pre>

<p>Search for specific services, such as MariaDB:</p>
<pre>$ <strong>sudo journalctl -u mariadb.service</strong>
Mar 19 16:07:27 client4 /etc/mysql/debian-start[7927]: Looking for 'mysql' as:
/usr/bin/mysql
Mar 19 16:07:27 client4 /etc/mysql/debian-start[7927]: Looking for 'mysqlcheck'
as: /usr/bin/mysqlcheck
[...]</pre>

<p>Select date ranges, which you can define in several ways:</p>
<pre>$ <strong>journalctl -u mariadb.service -S today</strong>
$ <strong>journalctl -u ssh.service -S '1 week ago'</strong>
$ <strong>journalctl -u libvirtd.service -S '2021-03-05'</strong>
$ <strong>journalctl -u httpd.service -S '2021-03-05' -u '2021-03-09'</strong>
$ <strong>journalctl -u nginx.service -S '2 hours ago'</strong>
</pre>

<p>When you do not specify times, the default is 00:00:00, midnight. Specify times
in HH:MM:SS format:</p>
<pre>$ <strong>journalctl -u httpd.service -S '2021-03-05 13:15:00' -U now</strong>
</pre>

<p>Look at activity from an hour ago until 5 minutes ago and show the unit
filenames:</p>
<pre>$ <strong>journalctl -S '1h ago' -U '5 min ago' -o with-unit</strong>
</pre>

<p><em>journalctl</em> sorts logs by system boot. Look at HTTP server activity since
the most recent boot, and limit the number of lines displayed to the most
recent 50:</p>
<pre>$ <strong>journalctl -b -n 50 -u httpd.service</strong></pre>

<p>See what happened three boots ago:</p>
<pre>$ <strong>journalctl -b -2 -u httpd.service</strong></pre>

<p>List all recorded boot sessions, with timestamps:</p>
<pre>$ <strong>journalctl --list-boots</strong></pre>

<p>You can filter for specific severity levels. When you specify a single level, in
this example, <em>crit</em>, it shows all messages from <em>crit</em> up to the most
severe level, <em>emerg</em>:</p>
<pre>$ <strong>journalctl -b -1 -p "crit" -u nginx.service</strong></pre>

<p>Define your own range, for example from <em>crit</em> to <em>warning</em>:</p>
<pre>$ <strong>journalctl -b -3 -p "crit".."warning"</strong></pre>

<p>Follow new events as they are logged, starting from the 10 most recent entries:</p>
<pre>$ <strong>journalctl -n 10 -u mariadb.service -f</strong></pre>

<p>Ctrl-C stops it.</p>

<p>And, of course, use good old <em>grep</em> to find things, like usernames, or any
search term you wish:</p>
<pre>$ <strong>journalctl -b -1 | grep madmax</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153557144">
<h2>Discussion</h2>

<p>Severity levels <a data-type="indexterm" data-primary="severity levels for system logs" id="idm46466153495864"/><a data-type="indexterm" data-primary="logging" data-secondary="severity levels for" id="idm46466153495256"/><a data-type="indexterm" data-primary="troubleshooting" data-secondary="logging" data-tertiary="severity levels for" id="idm46466153494408"/>are the standard syslog levels, from 0 to 7, with 0 being the most severe, and 7 the least severe:</p>
<pre>emerg      (0)
alert      (1)
crit       (2)
err        (3)
warning    (4)
notice     (5)
info       (6)
debug      (7)</pre>

<p><em>journalctl</em> provides dozens of ways to filter and parse your output, and you can
learn even<a data-type="indexterm" data-primary="journalctl command" data-startref="journalctl" id="idm46466153490088"/><a data-type="indexterm" data-primary="systemd" data-secondary="journalctl" data-startref="systemd-journalctl" id="idm46466153489352"/><a data-type="indexterm" data-primary="troubleshooting" data-secondary="logging" data-tertiary="viewing log files" data-startref="troubleshoot-log-view" id="idm46466153488264"/><a data-type="indexterm" data-primary="logging" data-secondary="viewing log files" data-startref="logging-view" id="idm46466153486712"/><a data-type="indexterm" data-primary="displaying" data-secondary="log files" data-startref="display-log" id="idm46466153485464"/> more in <em>man 1 journalctl</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153491352">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 3 syslog</em></p>
</li>
<li>
<p><em>man 1 journalctl</em></p>
</li>
<li>
<p><em>man 1 dmesg</em></p>
</li>
<li>
<p><a href="https://systemd.io"><em class="hyperlink">https://systemd.io</em></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.2 Configuring journald"><div class="sect1" id="idm46466153477560">
<h1>20.2 Configuring journald</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153476456">
<h2>Problem</h2>

<p>You’re<a data-type="indexterm" data-primary="troubleshooting" data-secondary="logging" data-tertiary="journald configuration" id="troubleshoot-log-journald"/><a data-type="indexterm" data-primary="logging" data-secondary="journald configuration" id="log-journald-config"/><a data-type="indexterm" data-primary="journald" data-secondary="configuring" id="journald-config"/><a data-type="indexterm" data-primary="configuring" data-secondary="journald" id="config-journald"/><a data-type="indexterm" data-primary="systemd" data-secondary="journald" data-tertiary="configuring" id="systemd-journald-config"/> not sure what the default configuration is for <em>journald</em>, and you need
to know how to see the current configuration and how to change it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153466984">
<h2>Solution</h2>

<p><em>journald</em> is configured in <em>/etc/systemd/journald.conf</em>. Some default options
are commented out, and all compile-time defaults are documented in
<em>man 5 journald.conf</em>. We will take a look at the most commonly used options.</p>

<p><em>Storage=auto</em> means different things on different distros. Ubuntu and Fedora
use <em>/run/log/journal/</em> for volatile storage, and persistent storage
is in <em>/var/log/journal</em>. See the locations of log files, used space, and
free space with <em>systemctl</em>:</p>
<pre>$ <strong>systemctl status systemd-journald.service</strong>s
● systemd-journald.service - Journal Service
   Loaded: loaded (/usr/lib/systemd/system/systemd-journald.service; static;
   vendor preset: disabled)
   Active: active (running)
   [...]
Mar 27 15:04:40 server2 systemd-journald[508]: Runtime journal (/run/log/journal/
1181e27c52294e97a8ca5c5af5c92e20) is 8.0M, max 2.3G, 2.3G free.
Mar 27 15:04:55 server2 systemd-journald[508]: Time spent on flushing to /var is
381.408ms for 1176 entries.
Mar 27 15:04:55 server2 systemd-journald[508]: System journal (/var/log/journal/
1181e27c52294e97a8ca5c5af5c92e20) is 16.0M, max 4.0G, 3.9G free.</pre>

<p>openSUSE puts volatile storage in <em>/run/log/journal/</em> and
persistent storage in <em>/var/log/messages</em>. If you prefer to use
<em>/var/log/journal</em>, create it and change the group owner to
<em>systemd-journal</em>:</p>
<pre>$ <strong>sudo mkdir /var/log/journal</strong>
$ <strong>sudo chgrp /var/log/journal/ systemd-journal</strong></pre>

<p>You don’t have to change anything else, and the storage is changed after reboot.
Other options are <em>volatile</em>, <em>persistent</em>, and <em>none</em>.</p>

<p><em>volatile</em> stores logs only in memory, in <em>/run/log/journal/</em>.</p>

<p><em>persistent</em> stores logs on disk and uses <em>/run/log/journal/</em> when the disk
is not available, such as early in system startup.</p>

<p><em>none</em> disables all local logging, and you have the option to send log messages
to a central logging server.</p>

<p><em>SystemMaxUse=</em> controls the size of log storage on disk, and
<em>RuntimeMaxUse=</em> controls the size of volatile storage. The default is 10% of
available space in the filesystem, to a maximum of 4 GB.</p>

<p><em>SystemKeepFree=</em> and <em>RuntimeKeepFree=</em> control how much disk space is left
free for other uses. The defaults are 15% and 4 GB. You may change these by
specifying numbers of bytes, or use K, M, G, T, P, and E; for example, 25 G (gigabytes).</p>

<p><em>MaxRetentionSec=</em> controls how long files are retained. The default is 0, which
disables it, and files are retained according to other settings, such as available
disk space. You may configure a time value, using <code>year</code>, <code>month</code>, <code>week</code>,
<code>day</code>, <code>h</code>, or <code>m</code>, for example, 
<span class="keep-together"><code>6 month</code>.</span></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153468648">
<h2>Discussion</h2>

<p><em>journald</em> automatically handles log rotation. Active files are rotated into
archived files, and archived files are deleted according to your<a data-type="indexterm" data-primary="troubleshooting" data-secondary="logging" data-tertiary="journald configuration" data-startref="troubleshoot-log-journald" id="idm46466153443880"/><a data-type="indexterm" data-primary="logging" data-secondary="journald configuration" data-startref="log-journald-config" id="idm46466153442328"/><a data-type="indexterm" data-primary="journald" data-secondary="configuring" data-startref="journald-config" id="idm46466153440968"/><a data-type="indexterm" data-primary="configuring" data-secondary="journald" data-startref="config-journald" id="idm46466153439880"/><a data-type="indexterm" data-primary="systemd" data-secondary="journald" data-tertiary="configuring" data-startref="systemd-journald-config" id="idm46466153438728"/> configuration.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153435960">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 5 journald.conf</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.3 Building a Logging Server with systemd"><div class="sect1" id="idm46466153433544">
<h1>20.3 Building a Logging Server with systemd</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153432648">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="troubleshooting" data-secondary="logging" data-tertiary="logging server creation" id="troubleshoot-log-server"/><a data-type="indexterm" data-primary="logging" data-secondary="logging server creation" id="log-create"/><a data-type="indexterm" data-primary="servers" data-secondary="logging, creating" id="server-log-create"/><a data-type="indexterm" data-primary="systemd" data-secondary="journald" data-tertiary="logging server creation" id="systemd-journald-create"/><a data-type="indexterm" data-primary="journald" data-secondary="logging server creation" id="journald-create"/> want to set up a central logging server so that logs are preserved when
systems go down, and for centralized management.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153423848">
<h2>Solution</h2>

<p>systemd provides a remote logging daemon, <em>journald</em>. Client machines
send their log messages to the <em>journald</em> server. The prerequisites are as follows:</p>

<ul>
<li>
<p>A machine to host the log files</p>
</li>
<li>
<p>Network access to the logging server for clients</p>
</li>
<li>
<p>The <em>systemd-journal-remote</em> package installed on the log server and on all
clients</p>
</li>
<li>
<p>Your public key infrastructure (PKI) already in place (<a data-type="xref" href="ch13.xhtml#rec-create-pki">Recipe 13.5</a>),
with keys and certificates distributed to servers and clients</p>
</li>
</ul>

<p class="pagebreak-before less_space">After installing <em>systemd-journal-remote</em>, edit <em>/etc/systemd/journal-remote.conf</em>
on the server. I like to store encryption keys and certificates in
<em>/etc/pki/journald/</em>:</p>
<pre>[Remote]
Seal=false
SplitMode=host
ServerKeyFile=/etc/pki/journald/<i>log-server.key</i>
ServerCertificateFile=/etc/pki/journald/<i>log-server.crt</i>
TrustedCertificateFile=/etc/pki/journald/<i>ca.crt</i></pre>

<p>Set permissions for the server key and certificates:</p>
<pre>$ <strong>sudo chmod -R 0755 /etc/pki/journald</strong>
$ <strong>sudo chmod 0440 /etc/pki/journald/<i>log-server.key</i></strong></pre>

<p>Change the group owner of the server private key to <em>systemd-journal-remote</em>:</p>
<pre>$ <strong>sudo chgrp systemd-journal-remote /etc/pki/journald/<i>log-
server.key</i></strong></pre>

<p>Enable and start the <em>systemd-journal-remote</em> service, starting
<em>systemd-journal-remote.socket</em> first:</p>
<pre>$ <strong>sudo systemctl enable --now systemd-journal-remote.socket</strong>
$ <strong>sudo systemctl enable --now systemd-journal-remote.service</strong></pre>

<p>Check the status of both to make sure they started correctly. Open the necessary
ports in the server firewall:</p>
<pre>$ <strong>sudo firewall-cmd --zone=<i>internal</i> --add-port=19532/tcp</strong>
$ <strong>sudo firewall-cmd --zone=<i>internal</i> --add-port=80/tcp</strong>
$ <strong>sudo firewall-cmd --runtime-to-permanent</strong>
$ <strong>sudo firewall-cmd --reload</strong></pre>

<p>On every client, create a new user, <em>systemd-journal-upload</em>. This is the user
that the <em>systemd-journal-upload</em> process uses to transfer log messages to the
central server:</p>
<pre>$ <strong>sudo useradd -r -d /run/systemd -M -s /usr/sbin/nologin -U \
systemd-journal-upload</strong></pre>

<p>Set permissions for the client key and certificates:</p>
<pre>$ <strong>sudo chmod -R 0755 /etc/pki/journald</strong>
$ <strong>sudo chmod 0440 /etc/pki/journald/<i>client.key</i></strong></pre>

<p>Edit <em>/etc/systemd/journal-upload.conf</em> with the URL and TCP port to your log
server, and the locations of the client key and certificates:</p>
<pre>[Upload]
URL=https://<i>logserver.example.com:19532</i>
ServerKeyFile=/etc/pki/journald/<i>client1.key</i>
ServerCertificateFile=/etc/pki/journald/<i>client1.crt</i>
TrustedCertificateFile=/etc/pki/journald/<i>ca.crt</i></pre>

<p class="pagebreak-before less_space">Restart the <em>systemd-journal-upload.service</em>:</p>
<pre>$ <strong>sudo systemctl restart systemd-journal-upload.service</strong></pre>

<p>If it restarts successfully, without errors, run the following steps to test
that the client is sending log entries to the server. Check the log directory
on the server:</p>
<pre>$ <strong>sudo ls -la /var/log/journal/remote/</strong>
total 7204
drwxr-xr-x  2 systemd-journal-remote systemd-journal-remote  6 Mar 26 16:41 .
drwxr-sr-x+ 4 root                   systemd-journal        60 Mar 26 16:41 ..
rw-r-----  1 systemd-journal-remote systemd-journal-remote 8388608 Mar 26  1
10:46 'remote-CN=client1.example.com'</pre>

<p>Looking good so far. Now, send the server a message from the client:</p>
<pre>$ <strong>sudo logger -p syslog.debug "Hello, I am client1! Do you hear me?"</strong></pre>

<p>Run your favorite <em>journalctl</em> incantation on the server to call up the most
recent entries. If you see the client message, you know you set it all up
correctly:</p>
<pre>Mar 27 18:30:11 client1 madmax[15228]: Hello, I am client1! Do you hear me?</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153422936">
<h2>Discussion</h2>

<p>A central logging server preserves client logs and centralizes logging storage
for easier maintenance and analysis. Every client has their own directory on the
server.</p>

<p><em>Seal=false</em> disables cryptographic signing of journal entries. To try it out,
refer to the <em>--setup-keys</em> option in <em>man 1 journalctl</em>. I could not find a
definitive answer if it provides a meaningful benefit, but it doesn’t hurt to
learn about it.</p>

<p><em>SplitMode=host</em> stores each client log in their own file. Set it to
<em>false</em> to dump everything into a single file.</p>

<p><em>ServerKeyFile=</em>, <em>ServerCertificateFile=</em>, and <em>TrustedCertificateFile=</em> are
where your encryption keys and certificates are <a data-type="indexterm" data-primary="troubleshooting" data-secondary="logging" data-tertiary="logging server creation" data-startref="troubleshoot-log-server" id="idm46466153379672"/><a data-type="indexterm" data-primary="logging" data-secondary="logging server creation" data-startref="log-create" id="idm46466153378344"/><a data-type="indexterm" data-primary="servers" data-secondary="logging, creating" data-startref="server-log-create" id="idm46466153377256"/><a data-type="indexterm" data-primary="systemd" data-secondary="journald" data-tertiary="logging server creation" data-startref="systemd-journald-create" id="idm46466153376168"/><a data-type="indexterm" data-primary="journald" data-secondary="logging server creation" data-startref="journald-create" id="idm46466153374712"/>stored.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153380136">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 5 journal-remote.conf</em></p>
</li>
<li>
<p><em>man 5 journald.conf</em></p>
</li>
<li>
<p><em>man 1 journalctl</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.4 Monitoring Temperatures, Fans, and Voltages &#10;with lm-sensors"><div class="sect1" id="idm46466153369288">
<h1>20.4 Monitoring Temperatures, Fans, and Voltages 
<span class="keep-together">with lm-sensors</span></h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153368264">
<h2>Problem</h2>

<p>Your <a data-type="indexterm" data-primary="troubleshooting" data-secondary="hardware" data-tertiary="temperature monitoring" id="troubleshoot-hardware-temp-monitor"/><a data-type="indexterm" data-primary="hardware" data-secondary="preventing problems" data-tertiary="temperature monitoring" id="hardware-prevent-temp-monitor"/><a data-type="indexterm" data-primary="preventing hardware problems" data-secondary="temperature monitoring" id="prevent-hardware-temp-monitor"/><a data-type="indexterm" data-primary="temperature, monitoring" id="temp-monitor"/><a data-type="indexterm" data-primary="monitoring" data-secondary="temperature" id="monitor-temp"/><a data-type="indexterm" data-primary="lm-sensors" data-secondary="temperature monitoring" id="lm-sensors-temp-monitor"/>want to measure temperatures inside your computer case, fan
speeds, and 
<span class="keep-together">voltages</span>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153357096">
<h2>Solution</h2>

<p>Use <em>lm-sensors</em> to continually monitor CPU, hard disk, and case temperatures.
This is supplied by the <em>sensors</em> package on openSUSE, <em>lm_sensors</em> on Fedora,
and <em>lm-sensors</em> on Ubuntu.</p>

<p>After installing <em>lm-sensors</em>, run <a data-type="indexterm" data-primary="sensors-detect command" id="idm46466153353288"/>the <em>sensors-detect</em> command to calibrate
<em>lm-sensors</em> to your hardware:</p>
<pre>$ <strong>sudo sensors-detect</strong>
# sensors-detect version 3.6.0
# Board: ASRock H97M Pro4
# Kernel: 5.8.0-45-generic x86_64
# Processor: Intel(R) Core(TM) i7-4770K CPU @ 3.50GHz (6/60/3)

This program will help you determine which kernel modules you need
to load to use lm_sensors most effectively. It is generally safe
and recommended to accept the default answers to all questions,
unless you know what you're doing.

Some south bridges, CPUs or memory controllers contain embedded sensors.
Do you want to scan for them? This is totally safe. (YES/no):
[...]</pre>

<p>Press Enter to accept all of the defaults. When it is finished you will see
something like this:</p>
<pre>To load everything that is needed, add this to /etc/modules:
#----cut here----
# Chip drivers
coretemp
nct6775
#----cut here----
If you have some drivers built into your kernel, the list above will
contain too many modules. Skip the appropriate ones!

Do you want to add these lines automatically to /etc/modules? (yes/NO) <strong>yes</strong>
Successful!</pre>

<p>The modules will be loaded after a restart, or you can load them immediately:</p>
<pre>$ <strong>sudo systemctl restart systemd-modules-load.service</strong></pre>

<p>Now run the <em>sensors</em> command <a data-type="indexterm" data-primary="sensors command" id="idm46466153346024"/>and see what you get:</p>
<pre>$ <strong>sensors</strong>
coretemp-isa-0000
Adapter: ISA adapter
Package id 0:  +42.0°C  (high = +86.0°C, crit = +96.0°C)
Core 0:        +34.0°C  (high = +86.0°C, crit = +96.0°C)
Core 1:        +35.0°C  (high = +86.0°C, crit = +96.0°C)
Core 2:        +32.0°C  (high = +86.0°C, crit = +96.0°C)
Core 3:        +31.0°C  (high = +86.0°C, crit = +96.0°C)

nouveau-pci-0300
Adapter: PCI adapter
GPU core:     +1.01 V  (min =  +0.70 V, max =  +1.20 V)
fan1:        2850 RPM
temp1:        +51.0°C  (high = +95.0°C, hyst =  +3.0°C)
                       (crit = +105.0°C, hyst =  +5.0°C)
                       (emerg = +135.0°C, hyst =  +5.0°C)

dell_smm-virtual-0
Adapter: Virtual device
Processor Fan: 1070 RPM
Other Fan:        0 RPM
Other Fan:      603 RPM
CPU:            +41.0°C
SODIMM:         +25.0°C
SODIMM:         +35.0°C
SODIMM:         +34.0°C</pre>

<p>This shows information for CPU cores, a graphics adapter, fans, and memory
modules. You see the current temperatures, and the high, critical, and emergency
temperature ranges. CPUs have built-in self-preservation and shut down when they
get 
<span class="keep-together">too hot.</span></p>

<p>Use the <em>watch</em> command <a data-type="indexterm" data-primary="watch command" id="idm46466153341784"/>to see updated status every two seconds, with any
differences highlighted:</p>
<pre>$ <strong>watch -d sensors</strong></pre>

<p>Set a different update interval, like 10 seconds:</p>
<pre>$ <strong>watch -d -n 10 sensors</strong>
Every 10.0s: sensors
[...]</pre>

<p>Press Ctrl-C to stop.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153356328">
<h2>Discussion</h2>

<p><em>lm_sensors</em> is not magic, it reads only devices that have temperature sensors
and that also have Linux drivers. Most temperature sensors are not very precise,
so don’t worry about small fluctuations.</p>

<p>Monitoring temperatures, voltages, and fan speeds can give you early warning of
trouble. It is cheaper to replace a fan than to rebuild a cooked computer.
Voltage drops could indicate a failing power supply or a bad connection.</p>

<p>Before you modify the <em>/etc/modules</em> file, check your kernel configuration to
see if the modules suggested by <em>sensors-detect</em> are already loaded, or are
statically compiled. Your kernel configuration file is in the <em>/boot</em> directory,
named <em>config-kernel-version</em>, like <em>config-5.8.0-45-generic</em>. For example,
search for the <em>nct6775</em> module:</p>
<pre>$ <strong>grep -i nct6775 config-5.8.0-45-generic</strong>
CONFIG_SENSORS_NCT6775=m</pre>

<p>The <em>m</em> means it is a loadable kernel module. Check if it is already loaded:</p>
<pre>$ <strong>lsmod | grep nct6775</strong></pre>

<p>If this returns nothing, go ahead and add it to <em>/etc/modules</em>. If it were
statically compiled, it would look like this in <em>config-*</em>:</p>
<pre>CONFIG_SENSORS_NCT6775=y</pre>

<p>The <em>y</em> means it is built-in to the kernel, so do not add<a data-type="indexterm" data-primary="troubleshooting" data-secondary="hardware" data-tertiary="temperature monitoring" data-startref="troubleshoot-hardware-temp-monitor" id="idm46466153325304"/><a data-type="indexterm" data-primary="hardware" data-secondary="preventing problems" data-tertiary="temperature monitoring" data-startref="hardware-prevent-temp-monitor" id="idm46466153323976"/><a data-type="indexterm" data-primary="preventing hardware problems" data-secondary="temperature monitoring" data-startref="prevent-hardware-temp-monitor" id="idm46466153322648"/><a data-type="indexterm" data-primary="temperature, monitoring" data-startref="temp-monitor" id="idm46466153321560"/><a data-type="indexterm" data-primary="monitoring" data-secondary="temperature" data-startref="monitor-temp" id="idm46466153320520"/><a data-type="indexterm" data-primary="lm-sensors" data-secondary="temperature monitoring" data-startref="lm-sensors-temp-monitor" id="idm46466153319176"/> it to <em>/etc/modules</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153325880">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 1 watch</em></p>
</li>
<li>
<p><em>man 1 sensors</em></p>
</li>
<li>
<p><em>man 8 lsmod</em></p>
</li>
<li>
<p><a href="https://kernel.org"><em class="hyperlink">https://kernel.org</em></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.5 Adding a Graphical Interface to lm-sensors"><div class="sect1" id="idm46466153311224">
<h1>20.5 Adding a Graphical Interface to lm-sensors</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153310328">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="lm-sensors" data-secondary="graphical display for" id="lm-sensors-graphics"/><a data-type="indexterm" data-primary="graphical environments" data-secondary="for lm-sensors" data-secondary-sortas="lm-sensors" id="graphical-lm-sensors"/><a data-type="indexterm" data-primary="Psensor" id="psensor"/>want a configurable graphical display for <em>lm-sensors</em> that updates
automatically.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153304904">
<h2>Solution</h2>

<p>You have several good choices. Graphical frontends to <em>lm-sensors</em> also support
other monitors, such as <em>smartmontools</em> and <em>hddtemp</em>. Psensor provides a
large display, colored graphs, and simple configuration to rename labels and show
just what you want to see (<a data-type="xref" href="#fig-trouble-1">Figure 20-1</a>).</p>

<p>Psensor supports alarms. Enable alarms individually, like for the CPU cores
and fans, by clicking on each monitor to bring up a Preferences menu (<a data-type="xref" href="#fig-trouble-3">Figure 20-2</a>).</p>

<figure><div id="fig-trouble-1" class="figure">
<img src="Images/lcb2_2001.png" alt="Psensor tracks multiple hardware monitors." width="748" height="381"/>
<h6><span class="label">Figure 20-1. </span>Psensor tracks multiple hardware monitors</h6>
</div></figure>

<figure><div id="fig-trouble-3" class="figure">
<img src="Images/lcb2_2002.png" alt="Enabling alarms and alarm thresholds." width="581" height="268"/>
<h6><span class="label">Figure 20-2. </span>Enabling alarms and alarm thresholds</h6>
</div></figure>

<p>You need to write a simple script to set up an alarm, like the following example:</p>
<pre>#!/bin/bash
# toohot.sh, plays a mad klavichord riff when a sensor monitor
# exceeds its upper limit

play /home/madmax/Music/klavichord-4.wav</pre>

<p>Install <em>sox</em> to get the <em>play</em> command. Make your script executable:</p>
<pre>$ <strong>chmod +x <i>toohot.sh</i></strong></pre>

<p>Test it:</p>
<pre>$ <strong>play <i>toohot.sh</i></strong></pre>

<p>When it works to your satisfaction, configure Psensor to use it. Open Psensor → Preferences → Sensors (<a data-type="xref" href="#fig-trouble-2">Figure 20-3</a>).</p>

<figure><div id="fig-trouble-2" class="figure">
<img src="Images/lcb2_2003.png" alt="Setting up an alarm." width="546" height="334"/>
<h6><span class="label">Figure 20-3. </span>Setting up an alarm</h6>
</div></figure>

<p>A simple way to test it in Psensors is to set some of your maximum temperatures
too low.</p>

<p>Many desktop environments, such as Xfce4, GNOME, and KDE, have nice little taskbar
plug-ins, such as what’s shown in <a data-type="xref" href="#fig-trouble-4">Figure 20-4</a> for Xfce4.</p>

<figure><div id="fig-trouble-4" class="figure">
<img src="Images/lcb2_2004.png" alt="Xfce taskbar plugin for lm-sensors." width="314" height="43"/>
<h6><span class="label">Figure 20-4. </span>Xfce taskbar plug-in for lm-sensors</h6>
</div></figure>

<p>All of them have <em>sensor</em> in their package names, except
<em>gnome-shell-extension-freon</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153303800">
<h2>Discussion</h2>

<p>You can write your script to automatically shut the system down when an alarm is
triggered, like this simple<a data-type="indexterm" data-primary="lm-sensors" data-secondary="graphical display for" data-startref="lm-sensors-graphics" id="idm46466153280040"/><a data-type="indexterm" data-primary="graphical environments" data-secondary="for lm-sensors" data-secondary-sortas="lm-sensors" data-startref="graphical-lm-sensors" id="idm46466153279400"/><a data-type="indexterm" data-primary="Psensor" data-startref="psensor" id="idm46466153278632"/> example:</p>
<pre>#!/bin/bash
echo "Help, too hot, I am shutting down right now!" &amp;&amp; shutdown -h now</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153276296">
<h2>See Also</h2>

<ul class="no-space-list">
<li>
<p><em>man 1 play</em></p>
</li>
<li>
<p><em>man 1 sensors</em></p>
</li>
<li>
<p><a href="https://oreil.ly/IcRok">Psensor</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.6 Monitoring Hard Disk Health with smartmontools"><div class="sect1" id="rec-smartmon">
<h1>20.6 Monitoring Hard Disk Health with smartmontools</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153268504">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="troubleshooting" data-secondary="hardware" data-tertiary="hard disk monitoring" id="troubleshoot-hardware-hard-disk"/><a data-type="indexterm" data-primary="hardware" data-secondary="preventing problems" data-tertiary="hard disk monitoring" id="hardware-prevent-hard-disk"/><a data-type="indexterm" data-primary="preventing hardware problems" data-secondary="hard disk monitoring" id="prevent-hardware-hard-disk"/><a data-type="indexterm" data-primary="hard disks" data-secondary="monitoring" id="hard-disk-monitor"/><a data-type="indexterm" data-primary="monitoring" data-secondary="hard disks" id="monitor-hard-disk"/><a data-type="indexterm" data-primary="smartmontools" data-secondary="hard disk monitoring" id="smartmontools-monitor"/><a data-type="indexterm" data-primary="S.M.A.R.T. (Self-Monitoring Analysis and Reporting Technology)" id="SMART"/>need to know when a hard disk is faulty or, preferably, when it is
becoming faulty, so you can replace it before you lose data.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153257224">
<h2>Solution</h2>

<p>Most hard disks and solid-state drives come with S.M.A.R.T.
(Self-Monitoring Analysis and Reporting Technology) built in. S.M.A.R.T. tracks
and records certain performance attributes, which you can monitor to (hopefully)
predict immiment failures. Linux users have <em>smartmontools</em> to read this
information and give warnings.</p>

<p><em>smartmontools</em> is provided by the <em>smartmontools</em> package. It should install
and start a systemd service automatically, which you can check with <em>systemctl</em>:</p>
<pre>$ <strong>systemctl status smartd.service</strong></pre>

<p>Use the <em>smartctl</em> command <a data-type="indexterm" data-primary="smartctl command" id="smartctl"/>to see if your disk has S.M.A.R.T. support. Look for
the <em>SMART</em> support lines:</p>
<pre>$ <strong>sudo smartctl -i /dev/<i>sda</i></strong>
smartctl 7.1 2019-12-30 r5022 [x86_64-linux-5.8.0-45-generic] (local build)
Copyright (C) 2002-19, Bruce Allen, Christian Franke, www.smartmontools.org

=== START OF INFORMATION SECTION ===
Model Family:     Seagate Desktop HDD.15
Device Model:     ST4000DM000-1F2168
[...]
SMART support is: Available - device has SMART capability.
SMART support is: Enabled</pre>

<p>Enable and disable <em>smartctl</em> for each disk you want to monitor:</p>
<pre>$ <strong>sudo smartctl -s on /dev/<i>sda</i></strong>
$ <strong>sudo smartctl -s off /dev/<i>sda</i></strong></pre>

<p>Use the <em>-x</em> flag for a complete data dump:</p>
<pre>$ <strong>sudo smartctl -x /dev/<i>sda</i></strong></pre>

<p>Run the short health check:</p>
<pre>$ <strong>sudo smartctl -H /dev/<i>sda</i></strong>
smartctl 7.1 2019-12-30 r5022 [x86_64-linux-5.8.0-45-generic] (local build)
Copyright (C) 2002-19, Bruce Allen, Christian Franke, www.smartmontools.org

=== START OF READ SMART DATA SECTION ===
SMART overall-health self-assessment test result: PASSED</pre>

<p>Use the <em>-Hc</em> flags to see the complete report.</p>

<p>Check the log file:</p>
<pre>$ <strong>sudo smartctl -l error /dev/<i>sda</i></strong>
smartctl 7.0 2019-05-21 r4917 [x86_64-linux-5.3.18-lp152.66-preempt] (SUSE RPM)
Copyright (C) 2002-18, Bruce Allen, Christian Franke, www.smartmontools.org

=== START OF READ SMART DATA SECTION ===
SMART Error Log Version: 1
No Errors Logged</pre>

<p>There is a short self-test and a long self-test. They tell you how long each test
will take when you start them:</p>
<pre>$ <strong>sudo smartctl -t long /dev/<i>sda</i></strong>
[...]
=== START OF OFFLINE IMMEDIATE AND SELF-TEST SECTION ===
Sending command: "Execute SMART Extended self-test routine immediately in
off-line mode".
Drive command "Execute SMART Extended self-test routine immediately in off-line
mode" successful.
Testing has begun.
Please wait 109 minutes for test to complete.
Test will complete after Thu Mar 25 17:06:33 2021

Use smartctl -X to abort test.</pre>

<p>It will not notify you when it is finished, and you can check the log file at
any time:</p>
<pre>$ <strong>sudo smartctl -l selftest /dev/<i>sda</i></strong>

[sudo] password for carla:
[...]
=== START OF READ SMART DATA SECTION ===
SMART Self-test log structure revision number 1
Num  Test_Description    Status                  Remaining  LifeTime(hours)
 # 1  Extended offline    Self-test routine in progress 70%      7961
 # 2  Short offline       Completed without error       00%      7960
 # 3  Short offline       Completed without error       00%      7952
 [...]</pre>

<p>Remember to update the hard drive database<a data-type="indexterm" data-primary="smartctl command" data-startref="smartctl" id="idm46466153232472"/> periodically:</p>
<pre>$ <strong>sudo update-smart-drivedb</strong>
/usr/share/smartmontools/drivedb.h updated from branches/RELEASE_7_0_DRIVEDB</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153256408">
<h2>Discussion</h2>

<p>S.M.A.R.T. is about 60% reliable. It could be better, but the S.M.A.R.T.
standard leaves a lot of room for interpretation, and every drive
manufacturer implements it differently. Manufacturer documentation is scarce,
and the best resources I have found are Wikipedia and
<a href="https://smartmontools.org"><em class="hyperlink">https://smartmontools.org</em></a>. As always, your best insurance
is regular backups.</p>

<p>Even so, it’s free, it’s easy to use, and often useful. Pay attention to the
<em>Pre-fail</em> attributes (as in the following snippet), and review the introduction to this chapter on how to get better performance and reliability from your systems.</p>

<p>Run <em>sudo smartctl -a /dev/sda</em> to dump all the S.M.A.R.T. data. The
section that tends to cause alarm is this one:</p>
<pre>SMART Attributes Data Structure revision number: 10
Vendor Specific SMART Attributes with Thresholds:
ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED
  1 Raw_Read_Error_Rate     0x000f   119   099   006    Pre-fail  Always
  3 Spin_Up_Time            0x0003   092   091   000    Pre-fail  Always
  4 Start_Stop_Count        0x0032   099   099   020    Old_age   Always
  5 Reallocated_Sector_Ct   0x0033   100   100   010    Pre-fail  Always
  7 Seek_Error_Rate         0x000f   059   057   030    Pre-fail  Always
  9 Power_On_Hours          0x0032   089   089   000    Old_age   Always
 10 Spin_Retry_Count        0x0013   100   100   097    Pre-fail  Always
 12 Power_Cycle_Count       0x0032   099   099   020    Old_age   Always
183 Runtime_Bad_Block       0x0032   100   100   000    Old_age   Always
184 End-to-End_Error        0x0032   100   100   099    Old_age   Always
187 Reported_Uncorrect      0x0032   100   100   000    Old_age   Always
188 Command_Timeout         0x0032   100   099   000    Old_age   Always
189 High_Fly_Writes         0x003a   100   100   000    Old_age   Always
190 Airflow_Temperature_Cel 0x0022   072   059   045    Old_age   Always
191 G-Sense_Error_Rate      0x0032   100   100   000    Old_age   Always
192 Power-Off_Retract_Count 0x0032   100   100   000    Old_age   Always
193 Load_Cycle_Count        0x0032   096   096   000    Old_age   Always
194 Temperature_Celsius     0x0022   028   041   000    Old_age   Always
197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always
198 Offline_Uncorrectable   0x0010   100   100   000    Old_age   Offline
199 UDMA_CRC_Error_Count    0x003e   200   200   000    Old_age   Always
240 Head_Flying_Hours       0x0000   100   253   000    Old_age   Offline
241 Total_LBAs_Written      0x0000   100   253   000    Old_age   Offline
242 Total_LBAs_Read         0x0000   100   253   000    Old_age   Offline
</pre>

<p>The <code>TYPE</code> column tells the type of the attributes, either <code>Pre-fail</code> or <code>Old_age</code>.
When you see all those <code>Pre-fail</code> and <code>Old_age</code> labels, it doesn’t mean your disk is
doomed, that is just the type of attribute on that row.</p>

<p><code>Pre-fail</code> is a critical attribute, one that may indicate imminent failure, and it
is always included in health assessments.</p>

<p><code>Old_age</code> is a noncritical attribute; it is not included in disk health reports.</p>

<p><code>ID#</code> and <code>ATTRIBUTE_NAME</code> identify each attribute. These vary by manufacturer.</p>

<p><code>FLAG</code> is the attribute handling flag, and has no relevance to disk health.</p>

<p>The <code>VALUE</code> column displays the current values for the attributes. These range from
0-255, except for 0, 254, and 255. 253 means “unused,” like when you have a new
drive. <code>VALUE</code> is a scale from good to bad, with higher numbers being good and lower
numbers bad, except the temperature attributes, which are temperatures in Celsius.</p>

<p><code>WORST</code> is the lowest value recorded for that attribute.</p>

<p><code>THRESH</code> is the lowest threshold for each attribute, and when a <code>Pre-fail</code> attribute
falls below <code>THRESH</code>, then disk failure may be imminent.</p>

<p><code>UPDATED</code> is supposed to indicate when the attributes have been updated. Always is
both online and offline, and Offline supposedly means only when offline tests are
run. Usually this is inaccurate, and not all that helpful in any case. <a data-type="indexterm" data-primary="troubleshooting" data-secondary="hardware" data-tertiary="hard disk monitoring" data-startref="troubleshoot-hardware-hard-disk" id="idm46466153213032"/><a data-type="indexterm" data-primary="hardware" data-secondary="preventing problems" data-tertiary="hard disk monitoring" data-startref="hardware-prevent-hard-disk" id="idm46466153211944"/><a data-type="indexterm" data-primary="preventing hardware problems" data-secondary="hard disk monitoring" data-startref="prevent-hardware-hard-disk" id="idm46466153210456"/><a data-type="indexterm" data-primary="hard disks" data-secondary="monitoring" data-startref="hard-disk-monitor" id="idm46466153208824"/><a data-type="indexterm" data-primary="monitoring" data-secondary="hard disks" data-startref="monitor-hard-disk" id="idm46466153207736"/><a data-type="indexterm" data-primary="smartmontools" data-secondary="hard disk monitoring" data-startref="smartmontools-monitor" id="idm46466153206648"/><a data-type="indexterm" data-primary="S.M.A.R.T. (Self-Monitoring Analysis and Reporting Technology)" data-startref="SMART" id="idm46466153205336"/></p>

<p>If an attribute enters a failed state, the time it failed is recorded in <em>WHEN_FAILED</em>.</p>

<p><em>RAW_VALUE</em> is particular to each manufacturer. Ignore it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153231128">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 smartctl</em></p>
</li>
<li>
<p><em>man 8 smartd</em></p>
</li>
<li>
<p><em>man 8 update-smart-drivedb</em></p>
</li>
<li>
<p><em>man 5 smartd.conf</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.7 Configuring smartmontools to Send Email Reports"><div class="sect1" id="idm46466153196568">
<h1>20.7 Configuring smartmontools to Send Email Reports</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153195672">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="smartmontools" data-secondary="configuring for email" id="smartmontools-config"/><a data-type="indexterm" data-primary="configuring" data-secondary="smartmontools for email" id="config-smartmontools"/><a data-type="indexterm" data-primary="email reports, configuring smartmontools for" id="email-smartmontools"/><a data-type="indexterm" data-primary="smartd, configuring for email" id="smartd-config"/> want email notifications of any problems emailed to you by <em>smartd</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153189048">
<h2>Solution</h2>

<p>First, check if you already have system mail set up and working by sending a test
message to another user on the system, such as root:</p>
<pre>$ <strong>echo "Hello, this is my message" | mail -s "Message subject" root@localhost</strong>
</pre>

<pre>[root@localhost ~]# <strong>mail</strong>
"/var/mail/root": 1 message 1 unread
&gt;U "/var/mail/root": 1 message 1 new
&gt;N   1 stash    Mon Mar 29 15:26  13/429   Message subject
?</pre>

<p>Press 1 to read the message, and q to quit. This shows that system mail is
already set up. If it is not, install <em>mailx</em> and <em>postfix</em>. <em>mailx</em> is<a data-type="indexterm" data-primary="mailx" id="idm46466153183416"/> a mail user agent (MUA), which is a mail client like Evolution, Thunderbird, KMail, Mutt, and so on. <em>postfix</em> is<a data-type="indexterm" data-primary="postfix" id="idm46466153182136"/> a mail transfer agent (MTA). You need both. After installation,
check if they are running with <em>systemctl</em>:</p>
<pre>$ <strong>systemctl status smartd.service</strong>
$ <strong>systemctl status postfix.service</strong></pre>

<p>If they are not, enable and start them. Then try your test message again.</p>
<pre>$ <strong>sudo systemctl enable --now smartd.service</strong>
$ <strong>sudo systemctl enable --now postfix.service</strong></pre>

<p><em>smartd</em> is configured in <em>/etc/smartd.conf</em> or <em>/etc/smartmontools/smartd.conf</em>.
The default is to scan for all possible devices and email error reports to the
root user. It is better to configure which devices you want monitored. Every Linux
has its own special configuration. The following should work on all of them,
and of course you must specify your own disks and email address:</p>
<pre>DEFAULT -a -o on -S on -s (S/../.././02|L/../../5/01):
/dev/<i>sda</i>
/dev/<i>sdb</i>
/dev/<i>sdc</i>
DEFAULT -H -m root -M test</pre>

<p>Save your configuration changes and reload <em>smartd.service</em>:</p>
<pre>$ <strong>sudo systemctl reload smartd.service</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153189912">
<h2>Discussion</h2>

<p>The default behavior in <em>smartd.conf</em> is to scan for all available drives. It is
more efficient to specify the drives you want to monitor.</p>

<p>The <em>-a</em> flag is the same as all of these combined:</p>

<ul>
<li>
<p><em>-H</em>, check the S.M.A.R.T. health status</p>
</li>
<li>
<p><em>-f</em>, report Usage Attributes (<em>VALUE</em> and <em>WORST</em>) failures</p>
</li>
<li>
<p><em>-t</em>, report changes in Prefailure and Usage Attributes</p>
</li>
<li>
<p><em>-l</em>, report increases in ATA errors</p>
</li>
<li>
<p><em>-l selftest</em>, report increases in Self-Test Log errors</p>
</li>
<li>
<p><em>-l selfteststs</em>, report changes of Self-Test execution status</p>
</li>
<li>
<p><em>-C 197</em>, report nonzero values of the current pending sector count</p>
</li>
<li>
<p><em>-U 198</em>, report nonzero values of the offline pending sector count</p>
</li>
</ul>

<p>That covers all the important stuff, and of course you may tweak it to report
whatever attributes you like.</p>

<p><em>-M test</em> sends the specified user (in the preceding example, <em>-m root@localhost</em>)
a test message at every startup. You can remove this when you are confident it is working the way you want.</p>

<p>There are several packages that provide the <em>mail</em> binary: <em>mailutils</em>,
<em>mailx</em>, <em>bsd-mailx</em>, and <em>s-nail</em>, to name a few. For a simple local
mailer for system daemons to use, any of them will do the job, and the <em>mail</em>
binary takes the same options on all of them.</p>

<p>You don’t have to use <em>postfix</em>, but can use any MTA that you prefer, such as Exim
or <a data-type="indexterm" data-primary="smartmontools" data-secondary="configuring for email" data-startref="smartmontools-config" id="idm46466153151064"/><a data-type="indexterm" data-primary="configuring" data-secondary="smartmontools for email" data-startref="config-smartmontools" id="idm46466153149720"/><a data-type="indexterm" data-primary="email reports, configuring smartmontools for" data-startref="email-smartmontools" id="idm46466153148632"/><a data-type="indexterm" data-primary="smartd, configuring for email" data-startref="smartd-config" id="idm46466153147688"/>Sendmail.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153151496">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 smartd</em></p>
</li>
<li>
<p><em>man 5 smartdconf</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.8 Diagnosing a Sluggish System with top"><div class="sect1" id="idm46466153143288">
<h1>20.8 Diagnosing a Sluggish System with top</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153142008">
<h2>Problem</h2>

<p>Your <a data-type="indexterm" data-primary="troubleshooting" data-secondary="sluggish systems" id="troubleshoot-sluggish"/><a data-type="indexterm" data-primary="sluggish systems, troubleshooting" id="sluggish-troubleshoot"/><a data-type="indexterm" data-primary="top command" data-secondary="killing processes" id="top-kill"/><a data-type="indexterm" data-primary="processes" data-secondary="killing" id="process-kill-top"/><a data-type="indexterm" data-primary="killing processes" id="kill-process-top"/>system usually runs well, but now everything is bogging down and taking
forever. Applications are taking a long time to start or shut down, or are
slow to respond to user input. You need to find out the cause, and then fix it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153134616">
<h2>Solution</h2>

<p>Fire up the <em>top</em> command to see which processes are using excessive system
resources. CPU and memory hogs make your nice powerful system feel ancient:</p>
<pre>$ <strong>top</strong>
Tasks: 284 total,   1 running, 283 sleeping,   0 stopped,   0 zombie
%Cpu(s):  6.4 us,  4.8 sy,  0.0 ni, 88.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :  15691.4 total,   6758.9 free,   4913.0 used,   4019.6 buff/cache
MiB Swap:  15258.0 total,  15258.0 free,      0.0 used.  10016.5 avail Mem

    PID USER      PR  NI   VIRT    RES    SHR S    %CPU  %MEM   TIME+ COMMAND
   1299 duchess      9  0 2803912  22296  17904 S  80.5   0.1  172:25 Web Content
   1685 duchess     20  0 3756840 543124 241296 S   7.6   3.4   27:53 firefox
  15926 libvirt+    20  0 5151504   2.3g  25024 S   1.7  15.3    1:39 qemu
  [...]</pre>

<p><em>top</em> runs until you stop it, refreshing every few seconds and displaying processes in order from the most to least active. Press the q key to exit.</p>

<p>This shows a wealth of information. The relevant bit is that <code>Web Content</code> is using
80.5% share of CPU time. Poorly constructed websites are a common cause of
bringing your system to a halt. The fast way to correct this is to kill the
offending process.</p>

<p>Process IDs are in the left column. Press the k key to open the kill dialog. If
the default PID to kill is correct, press the Enter key. Press Enter to accept
the default <em>15/sigterm</em> to terminate the process:</p>
<pre>PID to signal/kill [default pid = 1299]
Send pid 1299 signal [15/sigterm]</pre>

<p>If that does not kill the process, use the nuclear option, <em>9</em>, which is
<em>sigkill</em>:</p>
<pre>PID to signal/kill [default pid = 1299]
Send pid 1299 signal [15/sigterm] <strong>9</strong></pre>

<p>If you do not have sufficient permissions to kill the process, start <em>top</em> with
<em>sudo</em>. Or, run <em>sudo kill &lt;pid&gt;</em> in another terminal.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153134024">
<h2>Discussion</h2>

<p>Killing a process is not always the best solution. If the process is controlled by
systemd, systemd may immediately restart it, or other processes may be dependent
on it, and then you risk making a mess. If possible, shut it down with
<em>systemctl stop &lt;service name&gt;</em>. If the offending process is not controlled
by systemd, then go ahead and 
<span class="keep-together">kill it.</span></p>

<p>The default PID to kill is always the one at the top, the one using the most system
resources. If that is not the one you want to stop, you can enter a different PID.</p>

<p>What is<a data-type="indexterm" data-primary="signals" id="signals"/> this <em>sigterm</em> stuff, you ask? <em>Signals</em> are inherited from Unix, and are
very crufty, with numerous variations added over the years that you can learn all
about in <em>man 2 signal</em>, such as <em>SIGHUP</em>, <em>SIGINT</em>, <em>SIGQUIT</em>, and a host of others.</p>

<p>The two that are most pertinent to users and system administrators are <em>SIGKILL</em>
and <em>SIGTERM</em>. Always <a data-type="indexterm" data-primary="SIGKILL" id="idm46466153113736"/><a data-type="indexterm" data-primary="SIGTERM" id="idm46466153112824"/>try <em>SIGTERM</em> first, because it stops a process gracefully,
ensuring that any child processes are handed off to <em>INIT</em> and not orphaned, and
parent 
<span class="keep-together">processes</span> are informed. The one downside to <em>SIGTERM</em> is the process can
elect to 
<span class="keep-together">ignore it.</span></p>

<p>Use <em>SIGKILL</em> only when <em>SIGTERM</em> is ineffective. <em>SIGKILL</em> cannot be ignored, and it
also kills child processes, which may affect other processes. A process can be left in
limbo as a<a data-type="indexterm" data-primary="zombie processes" id="zombie"/> zombie process because the parent is not informed. Zombie processes
are no big deal by themselves, they just sit there not doing anything. You can
see if you have any in the header of <em>top</em>, on the right side of the Tasks
line. The following example shows two zombies:</p>
<pre>Tasks: 249 total, 1 running, 248 sleeping, 0 stopped, 2 zombie</pre>

<p>You don’t need to do anything as the parent application should automatically
clean them up. If it doesn’t, it’s not a big deal, unless it generates a horde
of zombies. That tells you there is a problem with the application. You can’t
kill zombies because they are already dead. They use a miniscule bit of system
resources, but if you want to try getting rid of them, try sending<a data-type="indexterm" data-primary="zombie processes" data-startref="zombie" id="idm46466153106024"/><a data-type="indexterm" data-primary="SIGCHILD" id="idm46466153104520"/> them a
<em>SIGCHLD</em>:</p>
<pre>$ <strong>sudo kill -s SIGCHLD <i>1299</i></strong></pre>

<p>If the same process keeps using excessive system resources, review the
configuration file or settings of its program to see if there are errors, or if
you can tune it to be more efficient. Check your logfiles (<a data-type="xref" href="#rec-logfiles">Recipe 20.1</a>)
for <a data-type="indexterm" data-primary="signals" data-startref="signals" id="idm46466153100856"/><a data-type="indexterm" data-primary="troubleshooting" data-secondary="sluggish systems" data-startref="troubleshoot-sluggish" id="idm46466153100008"/><a data-type="indexterm" data-primary="sluggish systems, troubleshooting" data-startref="sluggish-troubleshoot" id="idm46466153098824"/><a data-type="indexterm" data-primary="top command" data-secondary="killing processes" data-startref="top-kill" id="idm46466153096584"/><a data-type="indexterm" data-primary="processes" data-secondary="killing" data-startref="process-kill-top" id="idm46466153095240"/><a data-type="indexterm" data-primary="killing processes" data-startref="kill-process-top" id="idm46466153093896"/>clues.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153092728">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 1 top</em></p>
</li>
<li>
<p><em>man 1 kill</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.9 Viewing Selected Processes in top"><div class="sect1" id="idm46466153088760">
<h1>20.9 Viewing Selected Processes in top</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153087880">
<h2>Problem</h2>

<p>You want <a data-type="indexterm" data-primary="top command" data-secondary="viewing processes" id="idm46466153086744"/><a data-type="indexterm" data-primary="processes" data-secondary="viewing" id="idm46466153085896"/><a data-type="indexterm" data-primary="displaying" data-secondary="processes" id="idm46466153085048"/>to track just one or a small number of processes.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153083912">
<h2>Solution</h2>

<p>Start <em>top</em> with a comma-delimited list of the processes you want to track:</p>
<pre>$ <strong>top -p <i>4548, 8685, 9348</i></strong>
top - 10:57:39 up 44 min,  2 users,  load average: 0.10, 0.11, 0.21
Tasks:   3 total,   0 running,   3 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.2 us,  0.2 sy,  0.0 ni, 99.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :  15691.4 total,  12989.5 free,   1467.4 used,   1234.4 buff/cache
MiB Swap:  15258.0 total,  15258.0 free,      0.0 used.  13601.1 avail Mem

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
   2907 mysql     20   0 1775688  78584  18396 S   0.0   0.5   0:00.22 mysqld
    927 root      20   0 1569764  39072  29320 S   0.0   0.2   0:00.16 libvirtd
    822 root      20   0   11040   6384   4732 S   0.0   0.0   0:00.02 smartd</pre>

<p>Now you can keep an eye on what you want to see, without having to wade through
the remaining hordes of processes. Press the equals sign key (=) to return to the complete process list.</p>
</div></section>













<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153079496">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 1 top</em></p>
</li>
<li>
<p><em>man 1 kill</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.10 Escaping from a Frozen Graphical Desktop"><div class="sect1" id="idm46466153074872">
<h1>20.10 Escaping from a Frozen Graphical Desktop</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153074200">
<h2>Problem</h2>

<p>There<a data-type="indexterm" data-primary="troubleshooting" data-secondary="frozen graphical environments" id="troubleshoot-frozen"/><a data-type="indexterm" data-primary="frozen graphical environments, troubleshooting" id="frozen-troubleshoot"/><a data-type="indexterm" data-primary="graphical environments" data-secondary="troubleshooting" id="graphical-troubleshoot"/> you were, working happily, when your graphical desktop froze. The cursor
moves, but very slowly, or it does not move at all.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153069032">
<h2>Solution</h2>

<p>This is one of my favorite Linux features: dropping to the console from a graphical
session. Press Ctrl-Alt-F2, and you should find yourself at the plain-text console
that lies underneath your graphical session (<a data-type="xref" href="#fig-trouble-5">Figure 20-5</a>).</p>

<figure><div id="fig-trouble-5" class="figure">
<img src="Images/lcb2_2005.png" alt="The Linux console." width="728" height="124"/>
<h6><span class="label">Figure 20-5. </span>The Linux console</h6>
</div></figure>

<p>Log in, and now you can run some troubleshooting commands. Start with <em>top</em> to find
the wayward process clogging your system and kill it, check log files, run other
diagnostics, whatever you need to do. Once you have resolved the problem, press
Alt-F7 to return to your graphical desktop. The worse case is you will have to
shut down or reboot, which is better than a forced shutdown from pressing the
power button.</p>

<p>The various Linuxes map these key combinations in different ways. Alt-F7 is
traditional for the graphical session. Fedora uses Alt-F1. It hurts nothing to
try them all.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153063208">
<h2>Discussion</h2>

<p>Another option is to open an SSH session from another computer and try to
unfreeze your graphical desktop.</p>

<p>To me this is the best of all worlds, having both the console and graphical
environment available at the same time.</p>

<p>A forced shutdown isn’t necessarily a disaster as it used to be, especially when
you are using a journaling filesystem such as Ext4, XFS, or Btrfs.</p>

<p>The standard configuration is seven consoles, F1 through F7. Each one is an
independent login session.</p>

<p>Use Ctrl-Alt-F<em>n</em> to leave a graphical session and enter the console,
and when you are in the console, <a data-type="indexterm" data-primary="troubleshooting" data-secondary="frozen graphical environments" data-startref="troubleshoot-frozen" id="idm46466153056680"/><a data-type="indexterm" data-primary="frozen graphical environments, troubleshooting" data-startref="frozen-troubleshoot" id="idm46466153055704"/><a data-type="indexterm" data-primary="graphical environments" data-secondary="troubleshooting" data-startref="graphical-troubleshoot" id="idm46466153054856"/>use Alt-F<em>n</em>.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="20.11 Troubleshooting Hardware"><div class="sect1" id="idm46466153059464">
<h1>20.11 Troubleshooting Hardware</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153052840">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="troubleshooting" data-secondary="hardware" data-tertiary="testing" id="troubleshoot-hardware-test"/><a data-type="indexterm" data-primary="hardware" data-secondary="testing" id="hardware-test"/><a data-type="indexterm" data-primary="testing" data-secondary="hardware" id="test-hardware"/>think you have failing hardware and need to know how to test it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153046936">
<h2>Solution</h2>

<p>When you suspect a hardware problem, first try the recipes in this chapter about
hardware monitoring. Some system UEFI firmwares include hardware health 
<span class="keep-together">monitors</span>.</p>

<p>If the monitors do not point you in a clear direction, shut down the machine,
open the case, clean out the dust, clean the filters if there are any, then remove
and reseat everything that can be unplugged and reconnected: power cables, SATA
cables, graphics adapters and other PCI expansion cards, memory modules, and fan
connectors. Carefully reconnect everything, and pay special attention to
reseating your memory modules correctly.</p>
<div data-type="warning" epub:type="warning"><h1>How to Not Kill Your Hardware, or Yourself</h1>
<p>Be careful! Ground <a data-type="indexterm" data-primary="grounding" id="idm46466153043080"/>yourself by touching something else to discharge static
electricity. Wear an anti-static wrist strap, and place your components on an
anti-static mat. Unplug your machine, and NEVER touch anything inside the case
while it is plugged in.</p>
</div>

<p>Test the power supply with a multimeter, if you know how to do this, or try a
different power supply. Testing with a multimeter is fairly easy, and there are
plenty of how-tos. If you have spare parts, swapping out a suspect component and
trying a different one can pinpoint faulty hardware.</p>

<p>After you are finished and everything is back together, see if the problem is
corrected. In my computer adventures a number of problems were solved by
reseating the 
<span class="keep-together">memory</span> modules or moving them to different slots. Note that on
most motherboards you must install RAM pairs in certain slots. Some issues related
to RAM are data 
<span class="keep-together">corruption</span>, incomplete boots, and odd behaviors like
when you press the power switch to start up your system, it fluctuates like the
power supply is faulty, and does not start.</p>

<p>Make certain that your case fans are oriented the right way. Air must be
pulled into the case, usually from the front and sides, and then evacuated out
the back.</p>

<p>There are quite a few hardware testers in Linux-land. Some vendors provide their
own hardware and system testers; for example, Lenovo ThinkPads come with comprehensive
testers that test every component on your system.</p>

<p><a href="https://oreil.ly/7gEST">GtkStressTesting</a> is<a data-type="indexterm" data-primary="GtkStressTesting" id="idm46466153039208"/> a good
utility for stress testing CPU, memory, and other components, and it extracts detailed
motherboard information. Follow the instructions in the Setup Guide to install it on
your system. It includes monitors similar to 
<span class="keep-together"><em>lm-sensors</em>.</span></p>

<p>One feature it does not have is I/O monitoring, which you need to spot
performance bottlenecks. For this, use <em>iotop</em>, which<a data-type="indexterm" data-primary="iotop" id="idm46466153033432"/> monitors disk performance
in a <em>top</em>-like 
<span class="keep-together">interface</span>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153046392">
<h2>Discussion</h2>

<p>It can be difficult to determine whether a problem is software or hardware. Be
systematic and thorough, as hurrying takes longer. Use the available help
for your Linux distribution, as there are always issues particular to each
distro. Always read the release<a data-type="indexterm" data-primary="troubleshooting" data-secondary="hardware" data-tertiary="testing" data-startref="troubleshoot-hardware-test" id="idm46466153026088"/><a data-type="indexterm" data-primary="hardware" data-secondary="testing" data-startref="hardware-test" id="idm46466153029064"/><a data-type="indexterm" data-primary="testing" data-secondary="hardware" data-startref="test-hardware" id="idm46466153027912"/> notes.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153024392">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 iotop</em></p>
</li>
<li>
<p><a href="https://oreil.ly/7gEST">GtkStressTesting</a></p>
</li>
<li>
<p>The documentation for your hardware components</p>
</li>
<li>
<p>Your Linux distribution’s documentation, forums, wikis, and release notes</p>
</li>
<li>
<p><a data-type="xref" href="Images/ch10.html#cha-discover-hardware">Chapter 10</a></p>
</li>
<li>
<p><a data-type="xref" href="#rec-smartmon">Recipe 20.6</a></p>
</li>
</ul>
</div></section>





</div></section>







</div></section></div></body></html>