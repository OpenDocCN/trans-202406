<html><head></head><body><section data-pdf-bookmark="Chapter 9. Advanced Custom Resources" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_advanced-topics">&#13;
<h1><span class="label">Chapter 9. </span>Advanced Custom Resources</h1>&#13;
&#13;
&#13;
<p>In this chapter we walk you through advanced topics about CRs: versioning, conversion, and admission controllers.</p>&#13;
&#13;
<p>With multiple versions, CRDs become much more serious and are much less distinguishable from Golang-based API resources. Of course, at the same time the complexity considerably grows, both in development and maintenance but also operationally. We call these features “advanced” because they move CRDs from being a manifest (i.e., purely declarative) into the Golang world (i.e., into a real software development project).</p>&#13;
&#13;
<p>Even if you do not plan to build a custom API server and instead intend to directly switch to CRDs, we highly recommend not skipping <a data-type="xref" href="ch08.html#ch_custom-api-servers">Chapter 8</a>. Many of the concepts around advanced CRDs have direct counterparts in the world of custom API servers and are motivated by them. Reading <a data-type="xref" href="ch08.html#ch_custom-api-servers">Chapter 8</a> will make it much easier to understand this chapter as well.</p>&#13;
&#13;
<p>The code for all the examples shown and discussed here is available via the <a href="http://bit.ly/2RBSjAl">GitHub repository</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom Resource Versioning" data-type="sect1"><div class="sect1" id="crd-versioning">&#13;
<h1>Custom Resource Versioning</h1>&#13;
&#13;
<p>In <a data-type="xref" href="ch08.html#ch_custom-api-servers">Chapter 8</a> we<a data-primary="custom resource definitions (CRDs)" data-secondary="versioning" data-type="indexterm" id="CRversion09"/><a data-primary="versioning" data-secondary="overview of" data-type="indexterm" id="idm46336844619960"/> saw how resources are available through different API versions. In the example of the custom API server, the pizza resources exist in version <code>v1alpha1</code> and <code>v1beta1</code> at the same time (see <a data-type="xref" href="ch08.html#aggregation-example">“Example: A Pizza Restaurant”</a>). Inside of the custom API server, each object in a request is first converted from the API endpoint version to an internal version (see <a data-type="xref" href="ch08.html#aggregated-apiserver-development-internal-types">“Internal Types and Conversion”</a> and <a data-type="xref" href="ch08.html#aggregation-conversions-figure">Figure 8-5</a>) and then converted back to an external version for storage and to return a response. The<a data-primary="conversion" data-secondary="webhooks" data-type="indexterm" id="idm46336844615192"/> conversion mechanism is implemented by conversion functions, some of them manually written, and some generated (see <a data-type="xref" href="ch08.html#aggregated-apiserver-conversion">“Conversions”</a>).</p>&#13;
&#13;
<p>Versioning APIs is a powerful mechanism to adapt and improve APIs while keeping compatibility for older clients. Versioning<a data-primary="general availability (GA)" data-type="indexterm" id="idm46336844612744"/> plays a central role everywhere in Kubernetes to promote alpha APIs to beta and eventually to general availability (GA). During this process APIs often change structure or are extended.</p>&#13;
&#13;
<p>For a long time, versioning was a feature available only through<a data-primary="aggregation" data-type="indexterm" id="idm46336844611352"/> aggregated API servers as presented in <a data-type="xref" href="ch08.html#ch_custom-api-servers">Chapter 8</a>. Any serious API needs versioning eventually, as it is not acceptable to break compatibility with consumers of the API.</p>&#13;
&#13;
<p>Luckily, versioning for CRDs has been added very recently to Kubernetes—as alpha in Kubernetes 1.14 and promoted to beta in 1.15. Note that conversion requires OpenAPI v3 validation schemas that are <em>structural</em> (see <a data-type="xref" href="ch04.html#crd-validation">“Validating Custom Resources”</a>). Structural schema are basically what tools like Kubebuilder produce anyway. We will discuss the technical details in <a data-type="xref" href="#crd-structural-schema">“Structural Schemas”</a>.</p>&#13;
&#13;
<p>We’ll show you how versioning works here as it will play a central role in many serious applications of CRs in the near future.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Revising the Pizza Restaurant" data-type="sect2"><div class="sect2" id="idm46336844590360">&#13;
<h2>Revising the Pizza Restaurant</h2>&#13;
&#13;
<p>To<a data-primary="versioning" data-secondary="example" data-type="indexterm" id="idm46336844588408"/> learn how CR conversion works, we’ll reimplement the pizza restaurant example from <a data-type="xref" href="ch08.html#ch_custom-api-servers">Chapter 8</a>, this time purely with CRDs—that is, without the aggregated API server involved.</p>&#13;
&#13;
<p>For conversion, we will concentrate on the <code>Pizza</code> resource:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">restaurant.programming-kubernetes.info/v1alpha1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">Pizza</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">margherita</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">toppings</code><code class="p">:</code>&#13;
  <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">mozzarella</code>&#13;
  <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">tomato</code></pre>&#13;
&#13;
<p>This object should have a different representation of the toppings slice in the <code>v1beta1</code> version:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">restaurant.programming-kubernetes.info/v1beta1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">Pizza</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">margherita</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">toppings</code><code class="p">:</code>&#13;
  <code class="p-Indicator">-</code> <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">mozzarella</code>&#13;
    <code class="nt">quantity</code><code class="p">:</code> <code class="l-Scalar-Plain">1</code>&#13;
  <code class="p-Indicator">-</code> <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">tomato</code>&#13;
    <code class="nt">quantity</code><code class="p">:</code> <code class="l-Scalar-Plain">1</code></pre>&#13;
&#13;
<p>While in <code>v1alpha1</code>, repetition of toppings is used to represent an extra cheese pizza, we do this in <code>v1beta1</code> by using a quantity field for each topping. The order of toppings does not matter.</p>&#13;
&#13;
<p>We want to implement this translation—converting from <code>v1alpha1</code> to <code>v1beta1</code> and back. Before we do so, though, let’s define the API as a CRD. Note here that we cannot have an aggregated API server and CRDs of the same GroupVersion in the same cluster. So make sure that the APIServices from <a data-type="xref" href="ch08.html#ch_custom-api-servers">Chapter 8</a> are removed before continuing with the CRDs here.</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">apiextensions.k8s.io/v1beta1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">CustomResourceDefinition</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">pizzas.restaurant.programming-kubernetes.info</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">group</code><code class="p">:</code> <code class="l-Scalar-Plain">restaurant.programming-kubernetes.info</code>&#13;
  <code class="nt">names</code><code class="p">:</code>&#13;
    <code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">Pizza</code>&#13;
    <code class="nt">listKind</code><code class="p">:</code> <code class="l-Scalar-Plain">PizzaList</code>&#13;
    <code class="nt">plural</code><code class="p">:</code> <code class="l-Scalar-Plain">pizzas</code>&#13;
    <code class="nt">singular</code><code class="p">:</code> <code class="l-Scalar-Plain">pizza</code>&#13;
  <code class="nt">scope</code><code class="p">:</code> <code class="l-Scalar-Plain">Namespaced</code>&#13;
  <code class="nt">version</code><code class="p">:</code> <code class="l-Scalar-Plain">v1alpha1</code>&#13;
  <code class="nt">versions</code><code class="p">:</code>&#13;
  <code class="p-Indicator">-</code> <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">v1alpha1</code>&#13;
    <code class="nt">served</code><code class="p">:</code> <code class="l-Scalar-Plain">true</code>&#13;
    <code class="nt">storage</code><code class="p">:</code> <code class="l-Scalar-Plain">true</code>&#13;
    <code class="nt">schema</code><code class="p">:</code> <code class="l-Scalar-Plain">...</code>&#13;
  <code class="p-Indicator">-</code> <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">v1beta1</code>&#13;
    <code class="nt">served</code><code class="p">:</code> <code class="l-Scalar-Plain">true</code>&#13;
    <code class="nt">storage</code><code class="p">:</code> <code class="l-Scalar-Plain">false</code>&#13;
    <code class="nt">schema</code><code class="p">:</code> <code class="l-Scalar-Plain">...</code></pre>&#13;
&#13;
<p>The CRD defines two versions: <code>v1alpha1</code> and <code>v1beta1</code>. We set the former as the storage version (see <a data-type="xref" href="#crd-conversion-resource-versioning">Figure 9-1</a>), meaning every object to be stored in <code>etcd</code> is first converted to <code>v1alpha1</code>.</p>&#13;
&#13;
<figure><div class="figure" id="crd-conversion-resource-versioning">&#13;
<img alt="Conversion and storage version" src="assets/prku_0901.png"/>&#13;
<h6><span class="label">Figure 9-1. </span>Conversion and storage version</h6>&#13;
</div></figure>&#13;
&#13;
<p>As the CRD is defined currently, we can create an object as <code>v1alpha1</code> and retrieve it as <code>v1beta1</code>, but both API endpoints return the same object. This is obviously not what we want. But we’ll improve this very soon.</p>&#13;
&#13;
<p>But before we do that, we’ll set up the CRD in a cluster and create a margherita pizza:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">restaurant.programming-kubernetes.info/v1alpha1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">Pizza</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">margherita</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">toppings</code><code class="p">:</code>&#13;
  <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">mozzarella</code>&#13;
  <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">tomato</code></pre>&#13;
&#13;
<p>We register the preceding CRD and then create the margherita object:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl create -f pizza-crd.yaml&#13;
<code class="nv">$ </code>kubectl create -f margherita-pizza.yaml</pre>&#13;
&#13;
<p>As expected, we get back the same object for both versions:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl get pizza margherita -o yaml&#13;
apiVersion: restaurant.programming-kubernetes.info/v1beta1&#13;
kind: Pizza&#13;
metadata:&#13;
  creationTimestamp: <code class="s2">"2019-04-14T11:39:20Z"</code>&#13;
  generation: 1&#13;
  name: margherita&#13;
  namespace: pizza-apiserver&#13;
  resourceVersion: <code class="s2">"47959"</code>&#13;
  selfLink: /apis/restaurant.programming-kubernetes.info/v1beta1/namespaces/pizza-apiserver/&#13;
  pizzas/margherita&#13;
  uid: f18427f0-5ea9-11e9-8219-124e4d2dc074&#13;
spec:&#13;
  toppings:&#13;
  - mozzarella&#13;
  - tomato</pre>&#13;
&#13;
<p>Kubernetes uses the canonical version order; that is:</p>&#13;
<dl>&#13;
<dt><code>v1alpha1</code></dt>&#13;
<dd>&#13;
<p>Unstable: might go away or change any time and often disabled by default.</p>&#13;
</dd>&#13;
<dt><code>v1beta1</code></dt>&#13;
<dd>&#13;
<p>Towards stable: exists at least in one release in parallel to <code>v1</code>; contract: no incompatible API changes.</p>&#13;
</dd>&#13;
<dt><code>v1</code></dt>&#13;
<dd>&#13;
<p>Stable or generally available (GA): will stay for good, and will be compatible.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The GA versions come first in that order, then the betas, and then the alphas, with the major version ordered from high to low and the same for the minor version. Every CRD version not fitting into this pattern comes last, ordered alphabetically.</p>&#13;
&#13;
<p>In our case, the preceding <code>kubectl get pizza</code> therefore returns <code>v1beta1</code>, although the created object was in version <code>v1alpha1</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conversion Webhook Architecture" data-type="sect2"><div class="sect2" id="idm46336844357512">&#13;
<h2>Conversion Webhook Architecture</h2>&#13;
&#13;
<p>Now<a data-primary="conversion" data-secondary="webhooks" data-type="indexterm" id="idm46336844371304"/><a data-primary="versioning" data-secondary="conversion webhook architecture" data-type="indexterm" id="idm46336844370296"/><a data-primary="webhooks" data-secondary="conversion webhook architecture" data-type="indexterm" id="idm46336844369384"/> let’s add the conversion from <code>v1alpha1</code> to <code>v1beta1</code> and back. CRD conversions are implemented via webhooks in Kubernetes. <a data-type="xref" href="#crd-conversion-webhook">Figure 9-2</a> shows the flow:</p>&#13;
<ol>&#13;
<li>&#13;
<p>The client (e.g., our <code>kubectl get pizza margherita</code>) requests a version.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>etcd</code> has stored the object in some version.</p>&#13;
</li>&#13;
<li>&#13;
<p>If the versions do not match, the storage object is sent to the webhook server for conversion. The webhook returns a response with the converted object.</p>&#13;
</li>&#13;
<li>&#13;
<p>The converted object is sent back to the client.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<figure><div class="figure" id="crd-conversion-webhook">&#13;
<img alt="Conversion Webhook" src="assets/prku_0902.png"/>&#13;
<h6><span class="label">Figure 9-2. </span>Conversion webhook</h6>&#13;
</div></figure>&#13;
&#13;
<p>We<a data-primary="conversion" data-secondary="ConversionReview" data-type="indexterm" id="idm46336844271848"/> have to implement this webhook server. Before doing so, let’s look at the webhook API. The Kubernetes API server sends a <code>ConversionReview</code> object in the API group <code>apiextensions.k8s.io/v1beta1</code>:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code> <code class="nx">ConversionReview</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">metav1</code><code class="p">.</code><code class="nx">TypeMeta</code> <code class="s">`json:",inline"`</code>&#13;
    <code class="nx">Request</code> <code class="o">*</code><code class="nx">ConversionRequest</code>&#13;
    <code class="nx">Response</code> <code class="o">*</code><code class="nx">ConversionResponse</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The request field is set in the payload sent to the webhook. The response field is set in the response.</p>&#13;
&#13;
<p>The request looks like this:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code> <code class="nx">ConversionRequest</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="o">...</code>&#13;
&#13;
    <code class="c1">// `desiredAPIVersion` is the version to convert given objects to.</code>&#13;
    <code class="c1">// For example, "myapi.example.com/v1."</code>&#13;
    <code class="nx">DesiredAPIVersion</code> <code class="kt">string</code>&#13;
&#13;
    <code class="c1">// `objects` is the list of CR objects to be converted.</code>&#13;
    <code class="nx">Objects</code> <code class="p">[]</code><code class="nx">runtime</code><code class="p">.</code><code class="nx">RawExtension</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>DesiredAPIVersion</code> string has the usual <code>apiVersion</code> format we know from <span class="keep-together"><code>TypeMeta</code></span>: <em><code>group/version</code></em>.</p>&#13;
&#13;
<p>The objects field has a number of objects. It is a slice because for one list request for pizzas, the webhook will receive one conversion request, with this slice being all objects for the list request.</p>&#13;
&#13;
<p>The webhook converts and sets the response:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code> <code class="nx">ConversionResponse</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="o">...</code>&#13;
&#13;
    <code class="c1">// `convertedObjects` is the list of converted versions of `request.objects`</code>&#13;
    <code class="c1">// if the `result` is successful otherwise empty. The webhook is expected to</code>&#13;
    <code class="c1">// set apiVersion of these objects to the ConversionRequest.desiredAPIVersion.</code>&#13;
    <code class="c1">// The list must also have the same size as input list with the same objects</code>&#13;
    <code class="c1">// in the same order (i.e. equal UIDs and object meta).</code>&#13;
    <code class="nx">ConvertedObjects</code> <code class="p">[]</code><code class="nx">runtime</code><code class="p">.</code><code class="nx">RawExtension</code>&#13;
&#13;
    <code class="c1">// `result` contains the result of conversion with extra details if the</code>&#13;
    <code class="c1">// conversion failed. `result.status` determines if the conversion failed</code>&#13;
    <code class="c1">// or succeeded. The `result.status` field is required and represents the</code>&#13;
    <code class="c1">// success or failure of the conversion. A successful conversion must set</code>&#13;
    <code class="c1">// `result.status` to `Success`. A failed conversion must set `result.status`</code>&#13;
    <code class="c1">// to `Failure` and provide more details in `result.message` and return http</code>&#13;
    <code class="c1">// status 200. The `result.message` will be used to construct an error</code>&#13;
    <code class="c1">// message for the end user.</code>&#13;
    <code class="nx">Result</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">Status</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The result status tells the Kubernetes API server whether the conversion was <span class="keep-together">successful</span>.</p>&#13;
&#13;
<p>But when in the request pipeline is our conversion webhook actually called? What kind of input object can we expect? To understand this better, take a look at the general request pipeline in <a data-type="xref" href="#crd-conversion-crd-webhook-calls">Figure 9-3</a>: all those solid and striped circles are where conversion takes place in the <em>k8s.io/apiserver</em> code.</p>&#13;
&#13;
<figure><div class="figure" id="crd-conversion-crd-webhook-calls">&#13;
<img alt="Conversion webhook calls for CRs" src="assets/prku_0903.png"/>&#13;
<h6><span class="label">Figure 9-3. </span>Conversion webhook calls for CRs</h6>&#13;
</div></figure>&#13;
&#13;
<p>In contrast to aggregated custom API servers (see <a data-type="xref" href="ch08.html#aggregated-apiserver-development-internal-types">“Internal Types and Conversion”</a>), CRs do not use internal types but convert directly between the external API versions. Hence, only those yellow circles are actually doing conversions in <a data-type="xref" href="#crd-conversion-crd-pipeline">Figure 9-4</a>; the solid circles are NOOPs for CRDs. In other words: CRD conversion takes place only from and to <code>etcd</code>.</p>&#13;
&#13;
<figure><div class="figure" id="crd-conversion-crd-pipeline">&#13;
<img alt="Where conversion takes place for CRs" src="assets/prku_0904.png"/>&#13;
<h6><span class="label">Figure 9-4. </span>Where conversion takes place for CRs</h6>&#13;
</div></figure>&#13;
&#13;
<p>Therefore, we can assume our webhook will be called from those two places in the request pipeline (refer to <a data-type="xref" href="#crd-conversion-crd-webhook-calls">Figure 9-3</a>).</p>&#13;
&#13;
<p>Also note that patch requests do automatic retries on conflict (updates cannot retry, and they respond with errors directly to the caller). Each retry consists of a read and write to <code>etcd</code> (the yellow circles in <a data-type="xref" href="#crd-conversion-crd-webhook-calls">Figure 9-3</a>) and therefore leads to two calls to the webhook per iteration.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>All the warnings about the criticality of conversion in <a data-type="xref" href="ch08.html#aggregated-apiserver-conversion">“Conversions”</a> apply here as well: conversions must be correct. Bugs quickly lead to data loss and inconsistent behavior of the API.</p>&#13;
</div>&#13;
&#13;
<p>Before we start implementing the webhook, some final words about what the webhook can do and must avoid:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The order of the objects in request and response must not change.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>ObjectMeta</code> with the exception of labels and annotation must not be mutated.</p>&#13;
</li>&#13;
<li>&#13;
<p>Conversion is all or nothing: either all objects are successfully converted or all fail.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conversion Webhook Implementation" data-type="sect2"><div class="sect2" id="idm46336844372344">&#13;
<h2>Conversion Webhook Implementation</h2>&#13;
&#13;
<p>With<a data-primary="versioning" data-secondary="conversion webhook implementation" data-type="indexterm" id="idm46336844100216"/><a data-primary="webhooks" data-secondary="conversion webhook implementation" data-type="indexterm" id="idm46336844099144"/> the theory behind us, we are ready to start the implementation of the webhook project. You can find the source at <a href="http://bit.ly/2IHXKLn">the repository</a>, which includes:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A webhook implementation as an HTTPS web server</p>&#13;
</li>&#13;
<li>&#13;
<p>A number of endpoints:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>/convert/v1beta1/pizza</em> converts a pizza object between <code>v1alpha1</code> and <code>v1beta1</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p><em>/admit/v1beta1/pizza</em> defaults the <code>spec.toppings</code> field to mozzarella, tomato, salami.</p>&#13;
</li>&#13;
<li>&#13;
<p><em>/validate/v1beta1/pizza</em> verifies that each specified topping has a corresponding toppings object.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The last two endpoints are admission webhooks, which will be discussed in detail in <a data-type="xref" href="#admission-webhooks">“Admission Webhooks”</a>. The same webhook binary will serve both admission and conversion.</p>&#13;
&#13;
<p>The <code>v1beta1</code> in these paths should not be confused with <code>v1beta1</code> of our restaurant API group, but it is meant as the <code>apiextensions.k8s.io</code> API group version we support as a webhook. Someday <code>v1</code> of that webhook API will be supported,<sup><a data-type="noteref" href="ch09.html#idm46336844085864" id="idm46336844085864-marker">1</a></sup> at which time we’ll add the corresponding <code>v1</code> as another endpoint, in order to support old (as of today) and new Kubernetes clusters. It is possible to specify inside the CRD manifest which versions a webhook supports.</p>&#13;
&#13;
<p>Let’s look into how this conversion webhook actually works. Afterwards we will take a deeper dive into how to deploy the webhook into a real cluster. Note again that webhook conversion is still alpha in 1.14 and must be enabled manually using the <code>CustomResourceWebhookConversion</code> feature gate, but it is available as beta in 1.15.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Setting Up the HTTPS Server" data-type="sect2"><div class="sect2" id="idm46336844082536">&#13;
<h2>Setting Up the HTTPS Server</h2>&#13;
&#13;
<p>The<a data-primary="versioning" data-secondary="HTTPs server setup" data-type="indexterm" id="idm46336844080504"/> first step is to start a web server with support for transport layer security, or TLS (i.e., HTTPS). Webhooks in Kubernetes require HTTPS. The conversion webhook even requires certificates that are successfully checked by the Kubernetes API server against the CA bundle provided in the CRD object.</p>&#13;
&#13;
<p>In the example project, we make use of the secure serving library that is part of the <em>k8s.io/apiserver</em>. It<a data-primary="kube-apiserver" data-type="indexterm" id="idm46336844078248"/> provides all TLS flags and behavior you might be used to from deploying a <code>kube-apiserver</code> or an aggregated API server binary.</p>&#13;
&#13;
<p>The <em>k8s.io/apiserver</em> secure serving<a data-primary="option-config pattern" data-type="indexterm" id="idm46336844076088"/> code follows the <code>options-config</code> pattern (see <a data-type="xref" href="ch08.html#aggregated-apiserver-development-options-config">“Options and Config Pattern and Startup Plumbing”</a>). It is very easy to embed that code into your own binary:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code> <code class="nx">NewDefaultOptions</code><code class="p">()</code> <code class="o">*</code><code class="nx">Options</code> <code class="p">{</code>&#13;
    <code class="nx">o</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">Options</code><code class="p">{</code>&#13;
        <code class="o">*</code><code class="nx">options</code><code class="p">.</code><code class="nx">NewSecureServingOptions</code><code class="p">(),</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">o</code><code class="p">.</code><code class="nx">SecureServing</code><code class="p">.</code><code class="nx">ServerCert</code><code class="p">.</code><code class="nx">PairName</code> <code class="p">=</code> <code class="s">"pizza-crd-webhook"</code>&#13;
    <code class="k">return</code> <code class="nx">o</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">type</code> <code class="nx">Options</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">SecureServing</code> <code class="nx">options</code><code class="p">.</code><code class="nx">SecureServingOptions</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">type</code> <code class="nx">Config</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">SecureServing</code> <code class="o">*</code><code class="nx">server</code><code class="p">.</code><code class="nx">SecureServingInfo</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">o</code> <code class="o">*</code><code class="nx">Options</code><code class="p">)</code> <code class="nx">AddFlags</code><code class="p">(</code><code class="nx">fs</code> <code class="o">*</code><code class="nx">pflag</code><code class="p">.</code><code class="nx">FlagSet</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">o</code><code class="p">.</code><code class="nx">SecureServing</code><code class="p">.</code><code class="nx">AddFlags</code><code class="p">(</code><code class="nx">fs</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">o</code> <code class="o">*</code><code class="nx">Options</code><code class="p">)</code> <code class="nx">Config</code><code class="p">()</code> <code class="p">(</code><code class="o">*</code><code class="nx">Config</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">err</code> <code class="o">:=</code> <code class="nx">o</code><code class="p">.</code><code class="nx">SecureServing</code><code class="p">.</code><code class="nx">MaybeDefaultWithSelfSignedCerts</code><code class="p">(</code><code class="s">"0.0.0.0"</code><code class="p">,</code> <code class="kc">nil</code><code class="p">,</code> <code class="kc">nil</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">err</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">c</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">Config</code><code class="p">{}</code>&#13;
&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">o</code><code class="p">.</code><code class="nx">SecureServing</code><code class="p">.</code><code class="nx">ApplyTo</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">c</code><code class="p">.</code><code class="nx">SecureServing</code><code class="p">);</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">err</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">c</code><code class="p">,</code> <code class="kc">nil</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In the main function of the binary, this <code>Options</code> struct is instantiated and wired to a flag set:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">opt</code> <code class="o">:=</code> <code class="nx">NewDefaultOptions</code><code class="p">()</code>&#13;
<code class="nx">fs</code> <code class="o">:=</code> <code class="nx">pflag</code><code class="p">.</code><code class="nx">NewFlagSet</code><code class="p">(</code><code class="s">"pizza-crd-webhook"</code><code class="p">,</code> <code class="nx">pflag</code><code class="p">.</code><code class="nx">ExitOnError</code><code class="p">)</code>&#13;
<code class="nx">globalflag</code><code class="p">.</code><code class="nx">AddGlobalFlags</code><code class="p">(</code><code class="nx">fs</code><code class="p">,</code> <code class="s">"pizza-crd-webhook"</code><code class="p">)</code>&#13;
<code class="nx">opt</code><code class="p">.</code><code class="nx">AddFlags</code><code class="p">(</code><code class="nx">fs</code><code class="p">)</code>&#13;
<code class="k">if</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">fs</code><code class="p">.</code><code class="nx">Parse</code><code class="p">(</code><code class="nx">os</code><code class="p">.</code><code class="nx">Args</code><code class="p">);</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="nb">panic</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// create runtime config</code>&#13;
<code class="nx">cfg</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">opt</code><code class="p">.</code><code class="nx">Config</code><code class="p">()</code>&#13;
<code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="nb">panic</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="nx">stopCh</code> <code class="o">:=</code> <code class="nx">server</code><code class="p">.</code><code class="nx">SetupSignalHandler</code><code class="p">()</code>&#13;
&#13;
<code class="o">...</code>&#13;
&#13;
<code class="c1">// run server</code>&#13;
<code class="nx">restaurantInformers</code><code class="p">.</code><code class="nx">Start</code><code class="p">(</code><code class="nx">stopCh</code><code class="p">)</code>&#13;
<code class="k">if</code> <code class="nx">doneCh</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">cfg</code><code class="p">.</code><code class="nx">SecureServing</code><code class="p">.</code><code class="nx">Serve</code><code class="p">(</code>&#13;
    <code class="nx">handlers</code><code class="p">.</code><code class="nx">LoggingHandler</code><code class="p">(</code><code class="nx">os</code><code class="p">.</code><code class="nx">Stdout</code><code class="p">,</code> <code class="nx">mux</code><code class="p">),</code>&#13;
    <code class="nx">time</code><code class="p">.</code><code class="nx">Second</code> <code class="o">*</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">stopCh</code><code class="p">,</code>&#13;
<code class="p">);</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="nb">panic</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code>&#13;
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="o">&lt;-</code><code class="nx">doneCh</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In place of the three dots, we set up the HTTP multiplexer with our three paths as follows:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// register handlers</code>&#13;
<code class="nx">restaurantInformers</code> <code class="o">:=</code> <code class="nx">restaurantinformers</code><code class="p">.</code><code class="nx">NewSharedInformerFactory</code><code class="p">(</code>&#13;
    <code class="nx">clientset</code><code class="p">,</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Minute</code> <code class="o">*</code> <code class="mi">5</code><code class="p">,</code>&#13;
<code class="p">)</code>&#13;
<code class="nx">mux</code> <code class="o">:=</code> <code class="nx">http</code><code class="p">.</code><code class="nx">NewServeMux</code><code class="p">()</code>&#13;
<code class="nx">mux</code><code class="p">.</code><code class="nx">Handle</code><code class="p">(</code><code class="s">"/convert/v1beta1/pizza"</code><code class="p">,</code> <code class="nx">http</code><code class="p">.</code><code class="nx">HandlerFunc</code><code class="p">(</code><code class="nx">conversion</code><code class="p">.</code><code class="nx">Serve</code><code class="p">))</code>&#13;
<code class="nx">mux</code><code class="p">.</code><code class="nx">Handle</code><code class="p">(</code><code class="s">"/admit/v1beta1/pizza"</code><code class="p">,</code> <code class="nx">http</code><code class="p">.</code><code class="nx">HandlerFunc</code><code class="p">(</code><code class="nx">admission</code><code class="p">.</code><code class="nx">ServePizzaAdmit</code><code class="p">))</code>&#13;
<code class="nx">mux</code><code class="p">.</code><code class="nx">Handle</code><code class="p">(</code><code class="s">"/validate/v1beta1/pizza"</code><code class="p">,</code>&#13;
    <code class="nx">http</code><code class="p">.</code><code class="nx">HandlerFunc</code><code class="p">(</code><code class="nx">admission</code><code class="p">.</code><code class="nx">ServePizzaValidation</code><code class="p">(</code><code class="nx">restaurantInformers</code><code class="p">)))</code>&#13;
<code class="nx">restaurantInformers</code><code class="p">.</code><code class="nx">Start</code><code class="p">(</code><code class="nx">stopCh</code><code class="p">)</code></pre>&#13;
&#13;
<p>As the pizza validation webhook at the path <em>/validate/v1beta1/pizza</em> has to know the existing topping objects in the cluster, we instantiate a shared informer factory for the <code>restaurant.programming-kubernetes.info</code> API group.</p>&#13;
&#13;
<p>Now we’ll look at the actual conversion webhook implementation behind <code>conversion.Serve</code>. It is a normal Golang HTTP handler function, meaning it gets a request and a response writer as arguments.</p>&#13;
&#13;
<p>The request body contains a <code>ConversionReview</code> object from the  API group <code><span class="keep-together">apiextensions.k8s.io/v1beta1</span></code>. Hence, we have to first read the body from the request, and then decode the byte slice. We do this by using a deserializer from API Machinery:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code> <code class="nx">Serve</code><code class="p">(</code><code class="nx">w</code> <code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="nx">req</code> <code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// read body</code>&#13;
    <code class="nx">body</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">ioutil</code><code class="p">.</code><code class="nx">ReadAll</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">Body</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to read body: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// decode body as conversion review</code>&#13;
    <code class="nx">gv</code> <code class="o">:=</code> <code class="nx">apiextensionsv1beta1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code>&#13;
    <code class="nx">reviewGVK</code> <code class="o">:=</code> <code class="nx">gv</code><code class="p">.</code><code class="nx">WithKind</code><code class="p">(</code><code class="s">"ConversionReview"</code><code class="p">)</code>&#13;
    <code class="nx">obj</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">codecs</code><code class="p">.</code><code class="nx">UniversalDeserializer</code><code class="p">().</code><code class="nx">Decode</code><code class="p">(</code><code class="nx">body</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">reviewGVK</code><code class="p">,</code>&#13;
        <code class="o">&amp;</code><code class="nx">apiextensionsv1beta1</code><code class="p">.</code><code class="nx">ConversionReview</code><code class="p">{})</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to decode body: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">review</code><code class="p">,</code> <code class="nx">ok</code> <code class="o">:=</code> <code class="nx">obj</code><code class="p">.(</code><code class="o">*</code><code class="nx">apiextensionsv1beta1</code><code class="p">.</code><code class="nx">ConversionReview</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="p">!</code><code class="nx">ok</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unexpected GroupVersionKind: %s"</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">if</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code> <code class="o">==</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unexpected nil request"</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="o">...</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This code makes use of the codec factory <code>codecs</code>, which is derived from a scheme. This scheme has to include the types of <em>apiextensions.k8s.io/v1beta1</em>. We also add the types of our restaurant API group. The passed <code>ConversionReview</code> object will have our pizza type embedded in a <code>runtime.RawExtension</code> type—more about that in a second.</p>&#13;
&#13;
<p>First let’s create our scheme and the codec factory:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kn">import</code> <code class="p">(</code>&#13;
    <code class="nx">apiextensionsv1beta1</code> <code class="s">"k8s.io/apiextensions-apiserver/pkg/apis/apiextensions/v1beta1"</code>&#13;
    <code class="s">"github.com/programming-kubernetes/pizza-crd/pkg/apis/restaurant/install"</code>&#13;
    <code class="o">...</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="kd">var</code> <code class="p">(</code>&#13;
    <code class="nx">scheme</code> <code class="p">=</code> <code class="nx">runtime</code><code class="p">.</code><code class="nx">NewScheme</code><code class="p">()</code>&#13;
    <code class="nx">codecs</code> <code class="p">=</code> <code class="nx">serializer</code><code class="p">.</code><code class="nx">NewCodecFactory</code><code class="p">(</code><code class="nx">scheme</code><code class="p">)</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="kd">func</code> <code class="nx">init</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">utilruntime</code><code class="p">.</code><code class="nx">Must</code><code class="p">(</code><code class="nx">apiextensionsv1beta1</code><code class="p">.</code><code class="nx">AddToScheme</code><code class="p">(</code><code class="nx">scheme</code><code class="p">))</code>&#13;
    <code class="nx">install</code><code class="p">.</code><code class="nx">Install</code><code class="p">(</code><code class="nx">scheme</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>A <code>runtime.RawExtension</code> is a wrapper for Kubernetes-like objects embedded in a field of another object. Its structure is actually very simple:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code> <code class="nx">RawExtension</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="c1">// Raw is the underlying serialization of this object.</code>&#13;
    <code class="nx">Raw</code> <code class="p">[]</code><code class="kt">byte</code> <code class="s">`protobuf:"bytes,1,opt,name=raw"`</code>&#13;
    <code class="c1">// Object can hold a representation of this extension - useful for working</code>&#13;
    <code class="c1">// with versioned structs.</code>&#13;
    <code class="nx">Object</code> <code class="nx">Object</code> <code class="s">`json:"-"`</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In addition, <code>runtime.RawExtension</code> has special JSON and protobuf marshaling two methods. Moreover, there is special logic around the conversion to <code>runtime.Object</code> on the fly, when converting to internal types—that is, automatic encoding and <span class="keep-together">decoding</span>.</p>&#13;
&#13;
<p>In this case of CRDs, we don’t have internal types, and therefore that conversion magic does not play a role. Only <code>RawExtension.Raw</code> is filled with a JSON byte slice of the pizza object sent to the webhook for conversion. Thus, we will have to decode this byte slice. Note again that one <code>ConversionReview</code> potentially carries a number of objects, such that we have to loop over all of them:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// convert objects</code>&#13;
<code class="nx">review</code><code class="p">.</code><code class="nx">Response</code> <code class="p">=</code> <code class="o">&amp;</code><code class="nx">apiextensionsv1beta1</code><code class="p">.</code><code class="nx">ConversionResponse</code><code class="p">{</code>&#13;
    <code class="nx">UID</code><code class="p">:</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">UID</code><code class="p">,</code>&#13;
    <code class="nx">Result</code><code class="p">:</code>  <code class="nx">metav1</code><code class="p">.</code><code class="nx">Status</code><code class="p">{</code>&#13;
        <code class="nx">Status</code><code class="p">:</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">StatusSuccess</code><code class="p">,</code>&#13;
    <code class="p">},</code>&#13;
<code class="p">}</code>&#13;
<code class="kd">var</code> <code class="nx">objs</code> <code class="p">[]</code><code class="nx">runtime</code><code class="p">.</code><code class="nx">Object</code>&#13;
<code class="k">for</code> <code class="nx">_</code><code class="p">,</code> <code class="nx">in</code> <code class="o">:=</code> <code class="k">range</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">Objects</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Object</code> <code class="o">==</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="kd">var</code> <code class="nx">err</code> <code class="kt">error</code>&#13;
        <code class="nx">in</code><code class="p">.</code><code class="nx">Object</code><code class="p">,</code> <code class="nx">_</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">codecs</code><code class="p">.</code><code class="nx">UniversalDeserializer</code><code class="p">().</code><code class="nx">Decode</code><code class="p">(</code>&#13;
            <code class="nx">in</code><code class="p">.</code><code class="nx">Raw</code><code class="p">,</code> <code class="kc">nil</code><code class="p">,</code> <code class="kc">nil</code><code class="p">,</code>&#13;
        <code class="p">)</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Result</code> <code class="p">=</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">Status</code><code class="p">{</code>&#13;
                <code class="nx">Message</code><code class="p">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(),</code>&#13;
                <code class="nx">Status</code><code class="p">:</code>  <code class="nx">metav1</code><code class="p">.</code><code class="nx">StatusFailure</code><code class="p">,</code>&#13;
            <code class="p">}</code>&#13;
            <code class="k">break</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">obj</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">convert</code><code class="p">(</code><code class="nx">in</code><code class="p">.</code><code class="nx">Object</code><code class="p">,</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">DesiredAPIVersion</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Result</code> <code class="p">=</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">Status</code><code class="p">{</code>&#13;
            <code class="nx">Message</code><code class="p">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(),</code>&#13;
            <code class="nx">Status</code><code class="p">:</code>  <code class="nx">metav1</code><code class="p">.</code><code class="nx">StatusFailure</code><code class="p">,</code>&#13;
        <code class="p">}</code>&#13;
        <code class="k">break</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">objs</code> <code class="p">=</code> <code class="nb">append</code><code class="p">(</code><code class="nx">objs</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>convert</code> call does the actual conversion of <code>in.Object</code>, with the desired API version as the target version. Note here that we break the loop immediately when the first error occurs.</p>&#13;
&#13;
<p>Finally, we set the <code>Response</code> field in the <code>ConversionReview</code> object and write it back as the response body of the request using API Machinery’s response writer, which again uses our codec factory to create a serializer:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="k">if</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Result</code><code class="p">.</code><code class="nx">Status</code> <code class="o">==</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">StatusSuccess</code> <code class="p">{</code>&#13;
    <code class="k">for</code> <code class="nx">_</code><code class="p">,</code> <code class="nx">obj</code> <code class="p">=</code> <code class="k">range</code> <code class="nx">objs</code> <code class="p">{</code>&#13;
        <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">ConvertedObjects</code> <code class="p">=</code>&#13;
          <code class="nb">append</code><code class="p">(</code><code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">ConvertedObjects</code><code class="p">,</code>&#13;
            <code class="nx">runtime</code><code class="p">.</code><code class="nx">RawExtension</code><code class="p">{</code><code class="nx">Object</code><code class="p">:</code> <code class="nx">obj</code><code class="p">},</code>&#13;
          <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// write negotiated response</code>&#13;
<code class="nx">responsewriters</code><code class="p">.</code><code class="nx">WriteObject</code><code class="p">(</code>&#13;
    <code class="nx">http</code><code class="p">.</code><code class="nx">StatusOK</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">.</code><code class="nx">GroupVersion</code><code class="p">(),</code> <code class="nx">codecs</code><code class="p">,</code> <code class="nx">review</code><code class="p">,</code> <code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
<code class="p">)</code></pre>&#13;
&#13;
<p>Now, we have to implement the actual pizza conversion. After all this plumbing above, the conversion algorithm is the easiest part. It just checks that we actually got a pizza object of the known versions and then does the conversion from <code>v1beta1</code> to <code>v1alpha1</code> and vice versa:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code> <code class="nx">convert</code><code class="p">(</code><code class="nx">in</code> <code class="nx">runtime</code><code class="p">.</code><code class="nx">Object</code><code class="p">,</code> <code class="nx">apiVersion</code> <code class="kt">string</code><code class="p">)</code> <code class="p">(</code><code class="nx">runtime</code><code class="p">.</code><code class="nx">Object</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">switch</code> <code class="nx">in</code> <code class="o">:=</code> <code class="nx">in</code><code class="p">.(</code><code class="kd">type</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">case</code> <code class="o">*</code><code class="nx">v1alpha1</code><code class="p">.</code><code class="nx">Pizza</code><code class="p">:</code>&#13;
        <code class="k">if</code> <code class="nx">apiVersion</code> <code class="o">!=</code> <code class="nx">v1beta1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code><code class="p">.</code><code class="nx">String</code><code class="p">()</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"cannot convert %s to %s"</code><code class="p">,</code>&#13;
              <code class="nx">v1alpha1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code><code class="p">,</code> <code class="nx">apiVersion</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">klog</code><code class="p">.</code><code class="nx">V</code><code class="p">(</code><code class="mi">2</code><code class="p">).</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"Converting %s/%s from %s to %s"</code><code class="p">,</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Name</code><code class="p">,</code>&#13;
            <code class="nx">v1alpha1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code><code class="p">,</code> <code class="nx">apiVersion</code><code class="p">)</code>&#13;
&#13;
        <code class="nx">out</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">v1beta1</code><code class="p">.</code><code class="nx">Pizza</code><code class="p">{</code>&#13;
            <code class="nx">TypeMeta</code><code class="p">:</code> <code class="nx">in</code><code class="p">.</code><code class="nx">TypeMeta</code><code class="p">,</code>&#13;
            <code class="nx">ObjectMeta</code><code class="p">:</code> <code class="nx">in</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">,</code>&#13;
            <code class="nx">Status</code><code class="p">:</code> <code class="nx">v1beta1</code><code class="p">.</code><code class="nx">PizzaStatus</code><code class="p">{</code>&#13;
                <code class="nx">Cost</code><code class="p">:</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Cost</code><code class="p">,</code>&#13;
            <code class="p">},</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">out</code><code class="p">.</code><code class="nx">TypeMeta</code><code class="p">.</code><code class="nx">APIVersion</code> <code class="p">=</code> <code class="nx">apiVersion</code>&#13;
&#13;
        <code class="nx">idx</code> <code class="o">:=</code> <code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">int</code><code class="p">{}</code>&#13;
        <code class="k">for</code> <code class="nx">_</code><code class="p">,</code> <code class="nx">top</code> <code class="o">:=</code> <code class="k">range</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code> <code class="p">{</code>&#13;
            <code class="k">if</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">duplicate</code> <code class="o">:=</code> <code class="nx">idx</code><code class="p">[</code><code class="nx">top</code><code class="p">];</code> <code class="nx">duplicate</code> <code class="p">{</code>&#13;
                <code class="nx">out</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Quantity</code><code class="o">++</code>&#13;
                <code class="k">continue</code>&#13;
            <code class="p">}</code>&#13;
            <code class="nx">idx</code><code class="p">[</code><code class="nx">top</code><code class="p">]</code> <code class="p">=</code> <code class="nb">len</code><code class="p">(</code><code class="nx">out</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code><code class="p">)</code>&#13;
            <code class="nx">out</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code> <code class="p">=</code> <code class="nb">append</code><code class="p">(</code><code class="nx">out</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code><code class="p">,</code> <code class="nx">v1beta1</code><code class="p">.</code><code class="nx">PizzaTopping</code><code class="p">{</code>&#13;
                <code class="nx">Name</code><code class="p">:</code> <code class="nx">top</code><code class="p">,</code>&#13;
                <code class="nx">Quantity</code><code class="p">:</code> <code class="mi">1</code><code class="p">,</code>&#13;
            <code class="p">})</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="k">return</code> <code class="nx">out</code><code class="p">,</code> <code class="kc">nil</code>&#13;
&#13;
    <code class="k">case</code> <code class="o">*</code><code class="nx">v1beta1</code><code class="p">.</code><code class="nx">Pizza</code><code class="p">:</code>&#13;
        <code class="k">if</code> <code class="nx">apiVersion</code> <code class="o">!=</code> <code class="nx">v1alpha1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code><code class="p">.</code><code class="nx">String</code><code class="p">()</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"cannot convert %s to %s"</code><code class="p">,</code>&#13;
              <code class="nx">v1beta1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code><code class="p">,</code> <code class="nx">apiVersion</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">klog</code><code class="p">.</code><code class="nx">V</code><code class="p">(</code><code class="mi">2</code><code class="p">).</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"Converting %s/%s from %s to %s"</code><code class="p">,</code>&#13;
          <code class="nx">in</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Name</code><code class="p">,</code> <code class="nx">v1alpha1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code><code class="p">,</code> <code class="nx">apiVersion</code><code class="p">)</code>&#13;
&#13;
        <code class="nx">out</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">v1alpha1</code><code class="p">.</code><code class="nx">Pizza</code><code class="p">{</code>&#13;
            <code class="nx">TypeMeta</code><code class="p">:</code> <code class="nx">in</code><code class="p">.</code><code class="nx">TypeMeta</code><code class="p">,</code>&#13;
            <code class="nx">ObjectMeta</code><code class="p">:</code> <code class="nx">in</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">,</code>&#13;
            <code class="nx">Status</code><code class="p">:</code> <code class="nx">v1alpha1</code><code class="p">.</code><code class="nx">PizzaStatus</code><code class="p">{</code>&#13;
                <code class="nx">Cost</code><code class="p">:</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Cost</code><code class="p">,</code>&#13;
            <code class="p">},</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">out</code><code class="p">.</code><code class="nx">TypeMeta</code><code class="p">.</code><code class="nx">APIVersion</code> <code class="p">=</code> <code class="nx">apiVersion</code>&#13;
&#13;
        <code class="k">for</code> <code class="nx">i</code> <code class="o">:=</code> <code class="k">range</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code> <code class="p">{</code>&#13;
            <code class="k">for</code> <code class="nx">j</code> <code class="o">:=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">j</code> <code class="p">&lt;</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Quantity</code><code class="p">;</code> <code class="nx">j</code><code class="o">++</code> <code class="p">{</code>&#13;
                <code class="nx">out</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code> <code class="p">=</code> <code class="nb">append</code><code class="p">(</code>&#13;
                  <code class="nx">out</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code><code class="p">,</code> <code class="nx">in</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Name</code><code class="p">)</code>&#13;
            <code class="p">}</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="k">return</code> <code class="nx">out</code><code class="p">,</code> <code class="kc">nil</code>&#13;
&#13;
    <code class="k">default</code><code class="p">:</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">V</code><code class="p">(</code><code class="mi">2</code><code class="p">).</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"Unknown type %T"</code><code class="p">,</code> <code class="nx">in</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unknown type %T"</code><code class="p">,</code> <code class="nx">in</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Note that in both directions of the conversion, we just copy <code>TypeMeta</code> and <code>ObjectMeta</code>, change the API version to the desired one, and then convert the toppings slice, which is actually the only part of the objects which structurally differs.</p>&#13;
&#13;
<p>If there are more versions, another two-way conversion is necessary between all of them. Alternatively, of course, we could use a hub version as in<a data-primary="aggregation" data-type="indexterm" id="idm46336842902024"/> aggregated API servers (see <a data-type="xref" href="ch08.html#aggregated-apiserver-development-internal-types">“Internal Types and Conversion”</a>), instead of implementing conversions from and to all supported external versions.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deploying the Conversion Webhook" data-type="sect2"><div class="sect2" id="idm46336844081624">&#13;
<h2>Deploying the Conversion Webhook</h2>&#13;
&#13;
<p>We<a data-primary="versioning" data-secondary="conversion webhook deployment" data-type="indexterm" id="idm46336842899256"/><a data-primary="webhooks" data-secondary="conversion webhook deployment" data-type="indexterm" id="idm46336842361768"/> now want to deploy the conversion webhook. You can find all the manifests on <a href="http://bit.ly/2KEx4xo">GitHub</a>.</p>&#13;
&#13;
<p>Conversion webhooks for CRDs are launched in the cluster and put behind a service object, and that service object is referenced by the conversion webhook specification in the CRD manifest:</p>&#13;
<pre data-code-language="yaml" data-type="programlisting">&#13;
<code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">apiextensions.k8s.io/v1beta1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">CustomResourceDefinition</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">pizzas.restaurant.programming-kubernetes.info</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="l-Scalar-Plain">...</code><code>&#13;
</code><code>  </code><code class="l-Scalar-Plain">conversion</code><code class="p-Indicator">:</code><code>&#13;
</code><code>    </code><code class="nt">strategy</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Webhook</code><code>&#13;
</code><code>    </code><code class="nt">webhookClientConfig</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">caBundle</code><code class="p">:</code><code> </code><em><code class="l-Scalar-Plain">BASE64-CA-BUNDLE</code></em><code>&#13;
</code><code>      </code><code class="nt">service</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="nt">namespace</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">pizza-crd</code><code>&#13;
</code><code>        </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">webhook</code><code>&#13;
</code><code>        </code><code class="nt">path</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">/convert/v1beta1/pizza</code><code>&#13;
</code></pre>&#13;
&#13;
<p>The CA bundle must match the serving certificate used by the webhook. In our example project, we use a <a href="http://bit.ly/2FukVac">Makefile</a> to generate certificates using OpenSSL and plug them into the manifests using text replacement.</p>&#13;
&#13;
<p>Note here that the Kubernetes API server assumes that the webhook supports all specified versions of the CRD. There is also only one such webhook possible per CRD. But as CRDs and conversion webhooks are usually owned by the same team, this should be enough.</p>&#13;
&#13;
<p>Also note that the service port must be 443 in the current <em>apiextensions.k8s.io/v1beta1</em> API. The service can map this, however, to any port used by the webhook pods. In our example, we map 443 to 8443, served by the webhook binary.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Seeing Conversion in Action" data-type="sect2"><div class="sect2" id="idm46336842288408">&#13;
<h2>Seeing Conversion in Action</h2>&#13;
&#13;
<p>Now<a data-primary="versioning" data-secondary="process of" data-type="indexterm" id="idm46336842286744"/> that we understand how the conversion webhook works and how it is wired into the cluster, let’s see it in action.</p>&#13;
&#13;
<p>We assume you’ve checked out the example project. In addition, we assume that you have a cluster with webhook conversion enabled (either via feature gate in a 1.14 cluster or through a 1.15+ cluster, which has webhook conversion enabled by default). One way to get such a cluster is via the <a href="http://bit.ly/2X75lvS">kind project</a>, which provides support for Kubernetes 1.14.1 and a local <em>kind-config.yaml</em> file to enable the alpha feature gate for webhook conversion (<a data-type="xref" href="ch01.html#programming-kubernetes-meaning">“What Does Programming Kubernetes Mean?”</a> linked a number of other options for development clusters):</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">Cluster</code>&#13;
<code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">kind.sigs.k8s.io/v1alpha3</code>&#13;
<code class="nt">kubeadmConfigPatchesJson6902</code><code class="p">:</code>&#13;
<code class="p-Indicator">-</code> <code class="nt">group</code><code class="p">:</code> <code class="l-Scalar-Plain">kubeadm.k8s.io</code>&#13;
  <code class="nt">version</code><code class="p">:</code> <code class="l-Scalar-Plain">v1beta1</code>&#13;
  <code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">ClusterConfiguration</code>&#13;
  <code class="nt">patch</code><code class="p">:</code> <code class="p-Indicator">|</code>&#13;
    <code class="no">- op: add</code>&#13;
      <code class="no">path: /apiServer/extraArgs</code>&#13;
      <code class="no">value: {}</code>&#13;
    <code class="no">- op: add</code>&#13;
      <code class="no">path: /apiServer/extraArgs/feature-gates</code>&#13;
      <code class="no">value: CustomResourceWebhookConversion=true</code></pre>&#13;
&#13;
<p>Then we can create a cluster:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kind create cluster --image kindest/node-images:v1.14.1 --config kind-config.yaml&#13;
<code class="nv">$ </code><code class="nb">export </code><code class="nv">KUBECONFIG</code><code class="o">=</code><code class="s2">"</code><code class="k">$(</code>kind get kubeconfig-path --name<code class="o">=</code><code class="s2">"kind"</code><code class="k">)</code><code class="s2">"</code></pre>&#13;
&#13;
<p>Now we can deploy <a href="http://bit.ly/2KEx4xo">our manifests</a>:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code><code class="nb">cd </code>pizza-crd&#13;
<code class="nv">$ </code><code class="nb">cd </code>manifest/deployment&#13;
<code class="nv">$ </code>make&#13;
<code class="nv">$ </code>kubectl create -f ns.yaml&#13;
<code class="nv">$ </code>kubectl create -f pizza-crd.yaml&#13;
<code class="nv">$ </code>kubectl create -f topping-crd.yaml&#13;
<code class="nv">$ </code>kubectl create -f sa.yaml&#13;
<code class="nv">$ </code>kubectl create -f rbac.yaml&#13;
<code class="nv">$ </code>kubectl create -f rbac-bind.yaml&#13;
<code class="nv">$ </code>kubectl create -f service.yaml&#13;
<code class="nv">$ </code>kubectl create -f serving-cert-secret.yaml&#13;
<code class="nv">$ </code>kubectl create -f deployment.yaml</pre>&#13;
&#13;
<p>These manifests contain the following files:</p>&#13;
<dl>&#13;
<dt><em>ns.yaml</em></dt>&#13;
<dd>&#13;
<p>Creates the <code>pizza-crd</code> namespace.</p>&#13;
</dd>&#13;
<dt><em>pizza-crd.yaml</em></dt>&#13;
<dd>&#13;
<p>Specifies the pizza resource in the <code>restaurant.programming-kubernetes.info</code> API group, with the <code>v1alpha1</code> and <code>v1beta1</code> versions, and the webhook conversion configuration as shown previously.</p>&#13;
</dd>&#13;
<dt><em>topping-crd.yaml</em></dt>&#13;
<dd>&#13;
<p>Specifies the toppings CR in the same API group, but only in the <code>v1alpha1</code> <span class="keep-together">version</span>.</p>&#13;
</dd>&#13;
<dt><em>sa.yaml</em></dt>&#13;
<dd>&#13;
<p>Introduces the <code>webhook</code> service account.</p>&#13;
</dd>&#13;
<dt><em>rbac.yaml</em></dt>&#13;
<dd>&#13;
<p>Defines a role to read, list, and watch toppings.</p>&#13;
</dd>&#13;
<dt><em>rbac-bind.yaml</em></dt>&#13;
<dd>&#13;
<p>Binds the earlier RBAC role to the <code>webhook</code> service account.</p>&#13;
</dd>&#13;
<dt><em>service.yaml</em></dt>&#13;
<dd>&#13;
<p>Defines the <code>webhook</code> services, mapping port 443 to 8443 of the webhook pods.</p>&#13;
</dd>&#13;
<dt><em>serving-cert-secret.yaml</em></dt>&#13;
<dd>&#13;
<p>Contains the serving certificate and private key to be used by the webhook pods. The certificate is also used directly as the CA bundle in the preceding pizza CRD manifest.</p>&#13;
</dd>&#13;
<dt><em>deployment.yaml</em></dt>&#13;
<dd>&#13;
<p>Launches webhook pods, passing <code>--tls-cert-file</code> and <code>--tls-private-key</code> the serving certificate secret.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>After this we can create a margherita pizza finally:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>cat  ../examples/margherita-pizza.yaml&#13;
apiVersion: restaurant.programming-kubernetes.info/v1alpha1&#13;
kind: Pizza&#13;
metadata:&#13;
  name: margherita&#13;
spec:&#13;
  toppings:&#13;
  - mozzarella&#13;
  - tomato&#13;
<code class="nv">$ </code>kubectl create ../examples/margherita-pizza.yaml&#13;
pizza.restaurant.programming-kubernetes.info/margherita created</pre>&#13;
&#13;
<p>Now, with the conversion webhook in place, we can retrieve the same object in both versions. First explicitly in the <code>v1alpha1</code> version:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl get pizzas.v1alpha1.restaurant.programming-kubernetes.info <code class="se">\</code>&#13;
    margherita -o yaml&#13;
apiVersion: restaurant.programming-kubernetes.info/v1alpha1&#13;
kind: Pizza&#13;
metadata:&#13;
  creationTimestamp: <code class="s2">"2019-04-14T21:41:39Z"</code>&#13;
  generation: 1&#13;
  name: margherita&#13;
  namespace: pizza-crd&#13;
  resourceVersion: <code class="s2">"18296"</code>&#13;
  pizzas/margherita&#13;
  uid: 15c1c06a-5efe-11e9-9230-0242f24ba99c&#13;
spec:&#13;
  toppings:&#13;
  - mozzarella&#13;
  - tomato&#13;
status: <code class="o">{}</code></pre>&#13;
&#13;
<p>Then the same object as <code>v1beta1</code> shows the different toppings structure:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl get pizzas.v1beta1.restaurant.programming-kubernetes.info <code class="se">\</code>&#13;
    margherita -o yaml&#13;
apiVersion: restaurant.programming-kubernetes.info/v1beta1&#13;
kind: Pizza&#13;
metadata:&#13;
  creationTimestamp: <code class="s2">"2019-04-14T21:41:39Z"</code>&#13;
  generation: 1&#13;
  name: margherita&#13;
  namespace: pizza-crd&#13;
  resourceVersion: <code class="s2">"18296"</code>&#13;
  pizzas/margherita&#13;
  uid: 15c1c06a-5efe-11e9-9230-0242f24ba99c&#13;
spec:&#13;
  toppings:&#13;
  - name: mozzarella&#13;
    quantity: 1&#13;
  - name: tomato&#13;
    quantity: 1&#13;
status: <code class="o">{}</code></pre>&#13;
&#13;
<p>Meanwhile, in the log of the webhook pod we see this conversion call:</p>&#13;
&#13;
<pre data-type="programlisting">I0414 21:46:28.639707       1 convert.go:35] Converting pizza-crd/margherita&#13;
  from restaurant.programming-kubernetes.info/v1alpha1&#13;
  to restaurant.programming-kubernetes.info/v1beta1&#13;
10.32.0.1 - - [14/Apr/2019:21:46:28 +0000]&#13;
  "POST /convert/v1beta1/pizza?timeout=30s HTTP/2.0" 200 968</pre>&#13;
&#13;
<p>Hence, the webhook is doing its job as expected.<a data-primary="" data-startref="CRversion09" data-type="indexterm" id="idm46336842074056"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Admission Webhooks" data-type="sect1"><div class="sect1" id="admission-webhooks">&#13;
<h1>Admission Webhooks</h1>&#13;
&#13;
<p>In <a data-type="xref" href="ch08.html#uc-custom-api-server">“Use Cases for Custom API Servers”</a> we<a data-primary="custom resource definitions (CRDs)" data-secondary="admission webhooks" data-type="indexterm" id="CRadweb09"/><a data-primary="webhooks" data-secondary="admission webhooks" data-type="indexterm" id="WHad09"/><a data-primary="admission webhooks" data-secondary="overview of" data-type="indexterm" id="idm46336842067240"/> discussed the use cases in which an aggregated API server is a better choice than using CRs. A lot of the reasons given are about having the freedom to implement certain behavior using Golang instead of being restricted to declarative features in CRD manifests.</p>&#13;
&#13;
<p>We have seen in the previous section how Golang is used to build CRD conversion webhooks. A similar mechanism is used to add custom admission to CRDs, again in Golang.</p>&#13;
&#13;
<p>Basically we have the same freedom as with custom admission plug-ins in aggregated API servers (see <a data-type="xref" href="ch08.html#aggregated-apiserver-development-admission">“Admission”</a>): there are mutating and validating admission webhooks, and they are called at the same position as for native resources, as shown in <a data-type="xref" href="#crd-admission-pipeline">Figure 9-5</a>.</p>&#13;
&#13;
<figure><div class="figure" id="crd-admission-pipeline">&#13;
<img alt="Admission in the CR request pipeline" src="assets/prku_0905.png"/>&#13;
<h6><span class="label">Figure 9-5. </span>Admission in the CR request pipeline</h6>&#13;
</div></figure>&#13;
&#13;
<p>We saw CRD validation based on OpenAPI in <a data-type="xref" href="ch04.html#crd-validation">“Validating Custom Resources”</a>. In <a data-type="xref" href="#crd-admission-pipeline">Figure 9-5</a>, validation is done in the box labeled “Validation.” The validating admission webhooks are called after that, the mutating admission webhooks before.</p>&#13;
&#13;
<p>The admission webhooks are put nearly at the end of the admission plug-in order, before quota. Admission webhooks are beta in Kubernetes 1.14 and therefore available in most clusters.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>For v1 of the admission webhooks API, it is planned to allow up to two passes through the admission chain. This means that an earlier admission plug-in or webhook can depend on the output of later plug-ins or webhooks, to a certain degree. So, in the future this mechanism will get even more powerful.</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Admission Requirements in the Restaurant Example" data-type="sect2"><div class="sect2" id="idm46336841999368">&#13;
<h2>Admission Requirements in the Restaurant Example</h2>&#13;
&#13;
<p>The<a data-primary="admission webhooks" data-secondary="example" data-type="indexterm" id="idm46336841997832"/> restaurant example uses admission for multiple things:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>spec.toppings</code> defaults if it is <code>nil</code> or empty to mozzarella, tomato, and salami.</p>&#13;
</li>&#13;
<li>&#13;
<p>Unknown fields should be dropped from the CR JSON and not persisted in <code>etcd</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>spec.toppings</code> must contain only toppings that have a corresponding topping object.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The first two use cases are mutating; the third use case is purely validating. Therefore, we will use one mutating webhook and one validating webhook to implement those steps.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Work is in progress on <a href="http://bit.ly/2ZFH8JY">native defaulting via OpenAPI v3 validation schemas</a>. OpenAPI has a <code>default</code> field, and the API server will apply that in the future. Moreover, dropping unknown fields will become the standard behavior for every resource, done by the Kubernetes API server through a <a href="http://bit.ly/2Xzt2wm">mechanism called pruning</a>.</p>&#13;
&#13;
<p>Pruning is available as beta in Kubernetes 1.15. Defaulting is planned to be available as beta in 1.16. When both features are available in the target cluster, the two use cases from the preceding list can be implemented without any webhook at all.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Admission Webhook Architecture" data-type="sect2"><div class="sect2" id="idm46336841971176">&#13;
<h2>Admission Webhook Architecture</h2>&#13;
&#13;
<p>Admission webhooks<a data-primary="admission webhooks" data-secondary="architecture" data-type="indexterm" id="idm46336841969608"/> are structurally very similar to the conversion webhooks we saw earlier in the chapter.</p>&#13;
&#13;
<p>They are deployed in the cluster, put behind a service mapping port 443 to some port of the pods, and called using a review object, <code>AdmissionReview</code> in the API group <code>admission.k8s.io/v1beta1</code>:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="o">---</code>&#13;
<code class="c1">// AdmissionReview describes an admission review request/response.</code>&#13;
<code class="kd">type</code> <code class="nx">AdmissionReview</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">metav1</code><code class="p">.</code><code class="nx">TypeMeta</code> <code class="s">`json:",inline"`</code>&#13;
    <code class="c1">// Request describes the attributes for the admission request.</code>&#13;
    <code class="c1">// +optional</code>&#13;
    <code class="nx">Request</code> <code class="o">*</code><code class="nx">AdmissionRequest</code> <code class="s">`json:"request,omitempty"`</code>&#13;
    <code class="c1">// Response describes the attributes for the admission response.</code>&#13;
    <code class="c1">// +optional</code>&#13;
    <code class="nx">Response</code> <code class="o">*</code><code class="nx">AdmissionResponse</code> <code class="s">`json:"response,omitempty"`</code>&#13;
<code class="p">}</code>&#13;
<code class="o">---</code></pre>&#13;
&#13;
<p>The <code>AdmissionRequest</code> contains all the information we are used to from the admission attributes (see <a data-type="xref" href="ch08.html#admission-plug-in-implementation">“Implementation”</a>):</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// AdmissionRequest describes the admission.Attributes for the admission request.</code>&#13;
<code class="kd">type</code> <code class="nx">AdmissionRequest</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="c1">// UID is an identifier for the individual request/response. It allows us to</code>&#13;
    <code class="c1">// distinguish instances of requests which are otherwise identical (parallel</code>&#13;
    <code class="c1">// requests, requests when earlier requests did not modify etc). The UID is</code>&#13;
    <code class="c1">// meant to track the round trip (request/response) between the KAS and the</code>&#13;
    <code class="c1">// WebHook, not the user request. It is suitable for correlating log entries</code>&#13;
    <code class="c1">// between the webhook and apiserver, for either auditing or debugging.</code>&#13;
    <code class="nx">UID</code> <code class="nx">types</code><code class="p">.</code><code class="nx">UID</code> <code class="s">`json:"uid"`</code>&#13;
    <code class="c1">// Kind is the type of object being manipulated.  For example: Pod</code>&#13;
    <code class="nx">Kind</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">GroupVersionKind</code> <code class="s">`json:"kind"`</code>&#13;
    <code class="c1">// Resource is the name of the resource being requested.  This is not the</code>&#13;
    <code class="c1">// kind.  For example: pods</code>&#13;
    <code class="nx">Resource</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">GroupVersionResource</code> <code class="s">`json:"resource"`</code>&#13;
    <code class="c1">// SubResource is the name of the subresource being requested.  This is a</code>&#13;
    <code class="c1">// different resource, scoped to the parent resource, but it may have a</code>&#13;
    <code class="c1">// different kind. For instance, /pods has the resource "pods" and the kind</code>&#13;
    <code class="c1">// "Pod", while /pods/foo/status has the resource "pods", the sub resource</code>&#13;
    <code class="c1">// "status", and the kind "Pod" (because status operates on pods). The</code>&#13;
    <code class="c1">// binding resource for a pod though may be /pods/foo/binding, which has</code>&#13;
    <code class="c1">// resource "pods", subresource "binding", and kind "Binding".</code>&#13;
    <code class="c1">// +optional</code>&#13;
    <code class="nx">SubResource</code> <code class="kt">string</code> <code class="s">`json:"subResource,omitempty"`</code>&#13;
    <code class="c1">// Name is the name of the object as presented in the request.  On a CREATE</code>&#13;
    <code class="c1">// operation, the client may omit name and rely on the server to generate</code>&#13;
    <code class="c1">// the name.  If that is the case, this method will return the empty string.</code>&#13;
    <code class="c1">// +optional</code>&#13;
    <code class="nx">Name</code> <code class="kt">string</code> <code class="s">`json:"name,omitempty"`</code>&#13;
    <code class="c1">// Namespace is the namespace associated with the request (if any).</code>&#13;
    <code class="c1">// +optional</code>&#13;
    <code class="nx">Namespace</code> <code class="kt">string</code> <code class="s">`json:"namespace,omitempty"`</code>&#13;
    <code class="c1">// Operation is the operation being performed</code>&#13;
    <code class="nx">Operation</code> <code class="nx">Operation</code> <code class="s">`json:"operation"`</code>&#13;
    <code class="c1">// UserInfo is information about the requesting user</code>&#13;
    <code class="nx">UserInfo</code> <code class="nx">authenticationv1</code><code class="p">.</code><code class="nx">UserInfo</code> <code class="s">`json:"userInfo"`</code>&#13;
    <code class="c1">// Object is the object from the incoming request prior to default values</code>&#13;
    <code class="c1">// being applied</code>&#13;
    <code class="c1">// +optional</code>&#13;
    <code class="nx">Object</code> <code class="nx">runtime</code><code class="p">.</code><code class="nx">RawExtension</code> <code class="s">`json:"object,omitempty"`</code>&#13;
    <code class="c1">// OldObject is the existing object. Only populated for UPDATE requests.</code>&#13;
    <code class="c1">// +optional</code>&#13;
    <code class="nx">OldObject</code> <code class="nx">runtime</code><code class="p">.</code><code class="nx">RawExtension</code> <code class="s">`json:"oldObject,omitempty"`</code>&#13;
    <code class="c1">// DryRun indicates that modifications will definitely not be persisted</code>&#13;
    <code class="c1">// for this request.</code>&#13;
    <code class="c1">// Defaults to false.</code>&#13;
    <code class="c1">// +optional</code>&#13;
    <code class="nx">DryRun</code> <code class="o">*</code><code class="kt">bool</code> <code class="s">`json:"dryRun,omitempty"`</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The same <code>AdmissionReview</code> object is used for both mutating and validating admission webhooks. The only difference is that in the mutating case, the <code>AdmissionResponse</code> can have a field <code>patch</code> and <code>patchType</code>, to be applied inside the Kubernetes API server after the webhook response has been received there. In the validating case, these two fields are kept empty on response.</p>&#13;
&#13;
<p>The most important field for our purposes here is the <code>Object</code> field, which—as in the preceding conversion webhook—uses the <code>runtime.RawExtension</code> type to store a pizza object.</p>&#13;
&#13;
<p>We also get the old object for update requests and could, say, check for fields that are meant to be read-only but are changed in a request. We don’t do this here in our example. But you will encounter many cases in Kubernetes where such logic is implemented—for example, for most fields of a pod, as you can’t change the command of a pod after it is created.</p>&#13;
&#13;
<p>The patch returned by the mutating webhook must be of type JSON <code>Patch</code> (see RFC 6902) in Kubernetes 1.14. This patch describes how the object should be modified to fulfill the required invariant.</p>&#13;
&#13;
<p>Note that it is best practice to validate every mutating webhook change in a validating webhook at the very end, at least if those enforced properties are significant for the behavior. Imagine some other mutating webhook touches the same fields in an object. Then you cannot be sure that the mutating changes will survive until the end of the mutating admission chain.</p>&#13;
&#13;
<p>There is no order currently in mutating webhooks other than alphabetic order. There are ongoing discussions to change this in one way or another in the future.</p>&#13;
&#13;
<p>For validating webhooks the order does not matter, obviously, and the Kubernetes API server even calls validating webhooks in parallel to reduce latency. In contrast, mutating webhooks add latency to every request that passes through them, as they are called sequentially.</p>&#13;
&#13;
<p>Common latencies—of course heavily depending on the environment—are around 100ms. So running many webhooks in sequence leads to considerable latencies that the user will experience when creating or updating objects.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Registering Admission Webhooks" data-type="sect2"><div class="sect2" id="idm46336841970584">&#13;
<h2>Registering Admission Webhooks</h2>&#13;
&#13;
<p>Admission webhooks<a data-primary="admission webhooks" data-secondary="registering" data-type="indexterm" id="idm46336841761288"/> are not registered in the CRD manifest. The reason is that they apply not only to CRDs, but to any kind of resource. You can even add custom admission webhooks to standard Kubernetes resources.</p>&#13;
&#13;
<p>Instead there are registration objects: <code>MutatingWebhookRegistration</code> and <code><span class="keep-together">ValidatingWebhookRegistration</span></code>. They differ only in the kind name:</p>&#13;
<pre data-code-language="yaml" data-type="programlisting">&#13;
<code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">admissionregistration.k8s.io/v1beta1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">MutatingWebhookConfiguration</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">restaurant.programming-kubernetes.info</code><code>&#13;
</code><code class="nt">webhooks</code><code class="p">:</code><code>&#13;
</code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">restaurant.programming-kubernetes.info</code><code>&#13;
</code><code>  </code><code class="nt">failurePolicy</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Fail</code><code>&#13;
</code><code>  </code><code class="nt">sideEffects</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">None</code><code>&#13;
</code><code>  </code><code class="nt">admissionReviewVersions</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">v1beta1</code><code>&#13;
</code><code>  </code><code class="nt">rules</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="nt">apiGroups</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="s">"</code><code class="s">restaurant.programming-kubernetes.info</code><code class="s">"</code><code>&#13;
</code><code>    </code><code class="nt">apiVersions</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">v1alpha1</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">v1beta1</code><code>&#13;
</code><code>    </code><code class="nt">operations</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">CREATE</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">UPDATE</code><code>&#13;
</code><code>    </code><code class="nt">resources</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">pizzas</code><code>&#13;
</code><code>  </code><code class="nt">clientConfig</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">service</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">namespace</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">pizza-crd</code><code>&#13;
</code><code>      </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">webhook</code><code>&#13;
</code><code>      </code><code class="nt">path</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">/admit/v1beta1/pizza</code><code>&#13;
</code><code>    </code><code class="nt">caBundle</code><code class="p">:</code><code> </code><em><code class="l-Scalar-Plain">CA-BUNDLE</code></em><code>&#13;
</code></pre>&#13;
&#13;
<p>This registers our <code>pizza-crd</code> webhook from the beginning of the chapter for mutating admission for our two versions of the resource <code>pizza</code>, the API group <code>restaurant.programming-kubernetes.info</code>, and the HTTP verbs <code>CREATE</code> and <code>UPDATE</code> (which includes patches as well).</p>&#13;
&#13;
<p>There are further ways in webhook configurations to restrict the matching resources—for example, a namespace selector (to exclude, e.g., a control plane namespace to avoid bootstrapping issues) and more advanced resource patterns with wildcards and subresources.</p>&#13;
&#13;
<p>Last but not least is a failure mode, which can be either <code>Fail</code> or <code>Ignore</code>. It specifies what to do if the webhook cannot be reached or fails for other reasons.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Admission webhooks can break clusters if they are deployed in the wrong way. Admission webhook matching core types can make the whole cluster inoperable. Special care must be taken to call admission webhooks for non-CRD resources.</p>&#13;
&#13;
<p>Specifically, it is good practice to exclude the control plane and the webhook resources themselves from the webhook.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Implementing an Admission Webhook" data-type="sect2"><div class="sect2" id="idm46336841531592">&#13;
<h2>Implementing an Admission Webhook</h2>&#13;
&#13;
<p>With<a data-primary="admission webhooks" data-secondary="implementing" data-type="indexterm" id="idm46336841539048"/> the work we’ve done on the conversion webhook in the beginning of the chapter, it is not hard to add admission capabilities. We also saw that the paths <em><span class="keep-together">/admit/v1beta1/pizza</span></em> and <em>/validate/v1beta1/pizza</em> are registered in the main function of the <code>pizza-crd-webhook</code> binary:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">mux</code><code class="p">.</code><code class="nx">Handle</code><code class="p">(</code><code class="s">"/admit/v1beta1/pizza"</code><code class="p">,</code> <code class="nx">http</code><code class="p">.</code><code class="nx">HandlerFunc</code><code class="p">(</code><code class="nx">admission</code><code class="p">.</code><code class="nx">ServePizzaAdmit</code><code class="p">))</code>&#13;
<code class="nx">mux</code><code class="p">.</code><code class="nx">Handle</code><code class="p">(</code><code class="s">"/validate/v1beta1/pizza"</code><code class="p">,</code> <code class="nx">http</code><code class="p">.</code><code class="nx">HandlerFunc</code><code class="p">(</code>&#13;
<code class="nx">admission</code><code class="p">.</code><code class="nx">ServePizzaValidation</code><code class="p">(</code><code class="nx">restaurantInformers</code><code class="p">)))</code></pre>&#13;
&#13;
<p>The first part of the two HTTP handler implementations looks nearly the same as for the conversion webhook:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code> <code class="nx">ServePizzaAdmit</code><code class="p">(</code><code class="nx">w</code> <code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="nx">req</code> <code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// read body</code>&#13;
    <code class="nx">body</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">ioutil</code><code class="p">.</code><code class="nx">ReadAll</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">Body</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to read body: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// decode body as admission review</code>&#13;
    <code class="nx">reviewGVK</code> <code class="o">:=</code> <code class="nx">admissionv1beta1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code><code class="p">.</code><code class="nx">WithKind</code><code class="p">(</code><code class="s">"AdmissionReview"</code><code class="p">)</code>&#13;
    <code class="nx">decoder</code> <code class="o">:=</code> <code class="nx">codecs</code><code class="p">.</code><code class="nx">UniversalDeserializer</code><code class="p">()</code>&#13;
    <code class="nx">into</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">admissionv1beta1</code><code class="p">.</code><code class="nx">AdmissionReview</code><code class="p">{}</code>&#13;
    <code class="nx">obj</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">decoder</code><code class="p">.</code><code class="nx">Decode</code><code class="p">(</code><code class="nx">body</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">reviewGVK</code><code class="p">,</code> <code class="nx">into</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to decode body: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">review</code><code class="p">,</code> <code class="nx">ok</code> <code class="o">:=</code> <code class="nx">obj</code><code class="p">.(</code><code class="o">*</code><code class="nx">admissionv1beta1</code><code class="p">.</code><code class="nx">AdmissionReview</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="p">!</code><code class="nx">ok</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unexpected GroupVersionKind: %s"</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">if</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code> <code class="o">==</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unexpected nil request"</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="o">...</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In the case of the validating webhook, we have to wire the informer (used to check that toppings exist in the cluster). We return an internal error as long as the informer is not synced. An informer that is not synced has incomplete data, so the toppings might not be known and the pizza would be rejected although they are valid:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code> <code class="nx">ServePizzaValidation</code><code class="p">(</code><code class="nx">informers</code> <code class="nx">restaurantinformers</code><code class="p">.</code><code class="nx">SharedInformerFactory</code><code class="p">)</code>&#13;
    <code class="kd">func</code> <code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">toppingInformer</code> <code class="o">:=</code> <code class="nx">informers</code><code class="p">.</code><code class="nx">Restaurant</code><code class="p">().</code><code class="nx">V1alpha1</code><code class="p">().</code><code class="nx">Toppings</code><code class="p">().</code><code class="nx">Informer</code><code class="p">()</code>&#13;
    <code class="nx">toppingLister</code> <code class="o">:=</code> <code class="nx">informers</code><code class="p">.</code><code class="nx">Restaurant</code><code class="p">().</code><code class="nx">V1alpha1</code><code class="p">().</code><code class="nx">Toppings</code><code class="p">().</code><code class="nx">Lister</code><code class="p">()</code>&#13;
&#13;
    <code class="k">return</code> <code class="kd">func</code><code class="p">(</code><code class="nx">w</code> <code class="nx">http</code><code class="p">.</code><code class="nx">ResponseWriter</code><code class="p">,</code> <code class="nx">req</code> <code class="o">*</code><code class="nx">http</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">if</code> <code class="p">!</code><code class="nx">toppingInformer</code><code class="p">.</code><code class="nx">HasSynced</code><code class="p">()</code> <code class="p">{</code>&#13;
            <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
              <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"informers not ready"</code><code class="p">))</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="c1">// read body</code>&#13;
        <code class="nx">body</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">ioutil</code><code class="p">.</code><code class="nx">ReadAll</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">Body</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
              <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to read body: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="c1">// decode body as admission review</code>&#13;
        <code class="nx">gv</code> <code class="o">:=</code> <code class="nx">admissionv1beta1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code>&#13;
        <code class="nx">reviewGVK</code> <code class="o">:=</code> <code class="nx">gv</code><code class="p">.</code><code class="nx">WithKind</code><code class="p">(</code><code class="s">"AdmissionReview"</code><code class="p">)</code>&#13;
        <code class="nx">obj</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">codecs</code><code class="p">.</code><code class="nx">UniversalDeserializer</code><code class="p">().</code><code class="nx">Decode</code><code class="p">(</code><code class="nx">body</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">reviewGVK</code><code class="p">,</code>&#13;
            <code class="o">&amp;</code><code class="nx">admissionv1beta1</code><code class="p">.</code><code class="nx">AdmissionReview</code><code class="p">{})</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
              <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to decode body: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">review</code><code class="p">,</code> <code class="nx">ok</code> <code class="o">:=</code> <code class="nx">obj</code><code class="p">.(</code><code class="o">*</code><code class="nx">admissionv1beta1</code><code class="p">.</code><code class="nx">AdmissionReview</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="p">!</code><code class="nx">ok</code> <code class="p">{</code>&#13;
            <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
              <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unexpected GroupVersionKind: %s"</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">))</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
        <code class="k">if</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code> <code class="o">==</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
              <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unexpected nil request"</code><code class="p">))</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="o">...</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>As in the webhook conversion case, we have set up the scheme and the codec factory with the admission API group and our restaurant API group:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">var</code> <code class="p">(</code>&#13;
    <code class="nx">scheme</code> <code class="p">=</code> <code class="nx">runtime</code><code class="p">.</code><code class="nx">NewScheme</code><code class="p">()</code>&#13;
    <code class="nx">codecs</code> <code class="p">=</code> <code class="nx">serializer</code><code class="p">.</code><code class="nx">NewCodecFactory</code><code class="p">(</code><code class="nx">scheme</code><code class="p">)</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="kd">func</code> <code class="nx">init</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">utilruntime</code><code class="p">.</code><code class="nx">Must</code><code class="p">(</code><code class="nx">admissionv1beta1</code><code class="p">.</code><code class="nx">AddToScheme</code><code class="p">(</code><code class="nx">scheme</code><code class="p">))</code>&#13;
    <code class="nx">install</code><code class="p">.</code><code class="nx">Install</code><code class="p">(</code><code class="nx">scheme</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>With these two, we decode the embedded pizza object (this time only one, no slice) from the <code>AdmissionReview</code>:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// decode object</code>&#13;
<code class="k">if</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">Object</code><code class="p">.</code><code class="nx">Object</code> <code class="o">==</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="kd">var</code> <code class="nx">err</code> <code class="kt">error</code>&#13;
    <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">Object</code><code class="p">.</code><code class="nx">Object</code><code class="p">,</code> <code class="nx">_</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code>&#13;
      <code class="nx">codecs</code><code class="p">.</code><code class="nx">UniversalDeserializer</code><code class="p">().</code><code class="nx">Decode</code><code class="p">(</code><code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">Object</code><code class="p">.</code><code class="nx">Raw</code><code class="p">,</code> <code class="kc">nil</code><code class="p">,</code> <code class="kc">nil</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Result</code> <code class="p">=</code> <code class="o">&amp;</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">Status</code><code class="p">{</code>&#13;
            <code class="nx">Message</code><code class="p">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(),</code>&#13;
            <code class="nx">Status</code><code class="p">:</code>  <code class="nx">metav1</code><code class="p">.</code><code class="nx">StatusFailure</code><code class="p">,</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">WriteObject</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">StatusOK</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">.</code><code class="nx">GroupVersion</code><code class="p">(),</code>&#13;
          <code class="nx">codecs</code><code class="p">,</code> <code class="nx">review</code><code class="p">,</code> <code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Then we can do the actual mutating admission (the defaulting of <code>spec.toppings</code> for both API versions):</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">orig</code> <code class="o">:=</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">Object</code><code class="p">.</code><code class="nx">Raw</code>&#13;
<code class="kd">var</code> <code class="nx">bs</code> <code class="p">[]</code><code class="kt">byte</code>&#13;
<code class="k">switch</code> <code class="nx">pizza</code> <code class="o">:=</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">Object</code><code class="p">.</code><code class="nx">Object</code><code class="p">.(</code><code class="kd">type</code><code class="p">)</code> <code class="p">{</code>&#13;
<code class="k">case</code> <code class="o">*</code><code class="nx">v1alpha1</code><code class="p">.</code><code class="nx">Pizza</code><code class="p">:</code>&#13;
    <code class="c1">// default toppings</code>&#13;
    <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="nx">pizza</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code><code class="p">)</code> <code class="o">==</code> <code class="mi">0</code> <code class="p">{</code>&#13;
        <code class="nx">pizza</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code> <code class="p">=</code> <code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="s">"tomato"</code><code class="p">,</code> <code class="s">"mozzarella"</code><code class="p">,</code> <code class="s">"salami"</code><code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">bs</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">json</code><code class="p">.</code><code class="nx">Marshal</code><code class="p">(</code><code class="nx">pizza</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="s">"unexpected encoding error: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">case</code> <code class="o">*</code><code class="nx">v1beta1</code><code class="p">.</code><code class="nx">Pizza</code><code class="p">:</code>&#13;
    <code class="c1">// default toppings</code>&#13;
    <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="nx">pizza</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code><code class="p">)</code> <code class="o">==</code> <code class="mi">0</code> <code class="p">{</code>&#13;
        <code class="nx">pizza</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code> <code class="p">=</code> <code class="p">[]</code><code class="nx">v1beta1</code><code class="p">.</code><code class="nx">PizzaTopping</code><code class="p">{</code>&#13;
            <code class="p">{</code><code class="s">"tomato"</code><code class="p">,</code> <code class="mi">1</code><code class="p">},</code>&#13;
            <code class="p">{</code><code class="s">"mozzarella"</code><code class="p">,</code> <code class="mi">1</code><code class="p">},</code>&#13;
            <code class="p">{</code><code class="s">"salami"</code><code class="p">,</code> <code class="mi">1</code><code class="p">},</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">bs</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">json</code><code class="p">.</code><code class="nx">Marshal</code><code class="p">(</code><code class="nx">pizza</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
          <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unexpected encoding error: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">default</code><code class="p">:</code>&#13;
    <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Result</code> <code class="p">=</code> <code class="o">&amp;</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">Status</code><code class="p">{</code>&#13;
        <code class="nx">Message</code><code class="p">:</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"unexpected type %T"</code><code class="p">,</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">Object</code><code class="p">.</code><code class="nx">Object</code><code class="p">),</code>&#13;
        <code class="nx">Status</code><code class="p">:</code>  <code class="nx">metav1</code><code class="p">.</code><code class="nx">StatusFailure</code><code class="p">,</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">WriteObject</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">StatusOK</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">.</code><code class="nx">GroupVersion</code><code class="p">(),</code>&#13;
      <code class="nx">codecs</code><code class="p">,</code> <code class="nx">review</code><code class="p">,</code> <code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">)</code>&#13;
    <code class="k">return</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Alternatively, we could use the conversion algorithms from the conversion webhook and then implement defaulting only for one of the versions. Both approaches are <span class="keep-together">possible</span>, and which one makes more sense depends on the context. Here, the defaulting is simple enough to implement it twice.</p>&#13;
&#13;
<p>The final step is to compute the patch—the difference between the original object (stored in <code>orig</code> as JSON) and the new defaulted one:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// compare original and defaulted version</code>&#13;
<code class="nx">ops</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">jsonpatch</code><code class="p">.</code><code class="nx">CreatePatch</code><code class="p">(</code><code class="nx">orig</code><code class="p">,</code> <code class="nx">bs</code><code class="p">)</code>&#13;
<code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
        <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unexpected diff error: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
    <code class="k">return</code>&#13;
<code class="p">}</code>&#13;
<code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Patch</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">json</code><code class="p">.</code><code class="nx">Marshal</code><code class="p">(</code><code class="nx">ops</code><code class="p">)</code>&#13;
<code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
    <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"unexpected patch encoding error: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
    <code class="k">return</code>&#13;
<code class="p">}</code>&#13;
<code class="nx">typ</code> <code class="o">:=</code> <code class="nx">admissionv1beta1</code><code class="p">.</code><code class="nx">PatchTypeJSONPatch</code>&#13;
<code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">PatchType</code> <code class="p">=</code> <code class="o">&amp;</code><code class="nx">typ</code>&#13;
<code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Allowed</code> <code class="p">=</code> <code class="kc">true</code></pre>&#13;
&#13;
<p>We use the <a href="http://bit.ly/2IKxwIk">JSON-Patch library</a> (a fork of <a href="http://bit.ly/2xfBIsN">Matt Baird’s</a> with <a href="http://bit.ly/2XxKfWP">critical fixes</a>) to derive the patch from the original object <code>orig</code> and the modified object <code>bs</code>, both passed as JSON byte slices. Alternatively, we could operate directly on untyped JSON data and create the JSON-Patch manually. Again, it depends on the context. Using a diff library is convenient.</p>&#13;
&#13;
<p>Then, as in the webhook conversion, we conclude by writing the response to the response writer, using the codec factory created previously:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">responsewriters</code><code class="p">.</code><code class="nx">WriteObject</code><code class="p">(</code>&#13;
    <code class="nx">http</code><code class="p">.</code><code class="nx">StatusOK</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">.</code><code class="nx">GroupVersion</code><code class="p">(),</code> <code class="nx">codecs</code><code class="p">,</code> <code class="nx">review</code><code class="p">,</code> <code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
<code class="p">)</code></pre>&#13;
&#13;
<p>The validating webhook is very similar, but it uses the toppings lister from the shared informer to check for the existence of the topping objects:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="k">switch</code> <code class="nx">pizza</code> <code class="o">:=</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">Object</code><code class="p">.</code><code class="nx">Object</code><code class="p">.(</code><code class="kd">type</code><code class="p">)</code> <code class="p">{</code>&#13;
<code class="k">case</code> <code class="o">*</code><code class="nx">v1alpha1</code><code class="p">.</code><code class="nx">Pizza</code><code class="p">:</code>&#13;
    <code class="k">for</code> <code class="nx">_</code><code class="p">,</code> <code class="nx">topping</code> <code class="o">:=</code> <code class="k">range</code> <code class="nx">pizza</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code> <code class="p">{</code>&#13;
        <code class="nx">_</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">toppingLister</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">topping</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="o">&amp;&amp;</code> <code class="p">!</code><code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
              <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to lookup topping %q: %v"</code><code class="p">,</code> <code class="nx">topping</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Result</code> <code class="p">=</code> <code class="o">&amp;</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">Status</code><code class="p">{</code>&#13;
                <code class="nx">Message</code><code class="p">:</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"topping %q not known"</code><code class="p">,</code> <code class="nx">topping</code><code class="p">),</code>&#13;
                <code class="nx">Status</code><code class="p">:</code>  <code class="nx">metav1</code><code class="p">.</code><code class="nx">StatusFailure</code><code class="p">,</code>&#13;
            <code class="p">}</code>&#13;
            <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">WriteObject</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">StatusOK</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">.</code><code class="nx">GroupVersion</code><code class="p">(),</code>&#13;
              <code class="nx">codecs</code><code class="p">,</code> <code class="nx">review</code><code class="p">,</code> <code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">)</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Allowed</code> <code class="p">=</code> <code class="kc">true</code>&#13;
<code class="k">case</code> <code class="o">*</code><code class="nx">v1beta1</code><code class="p">.</code><code class="nx">Pizza</code><code class="p">:</code>&#13;
    <code class="k">for</code> <code class="nx">_</code><code class="p">,</code> <code class="nx">topping</code> <code class="o">:=</code> <code class="k">range</code> <code class="nx">pizza</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Toppings</code> <code class="p">{</code>&#13;
        <code class="nx">_</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">toppingLister</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">topping</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="o">&amp;&amp;</code> <code class="p">!</code><code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">InternalError</code><code class="p">(</code><code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code>&#13;
              <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"failed to lookup topping %q: %v"</code><code class="p">,</code> <code class="nx">topping</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Result</code> <code class="p">=</code> <code class="o">&amp;</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">Status</code><code class="p">{</code>&#13;
                <code class="nx">Message</code><code class="p">:</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"topping %q not known"</code><code class="p">,</code> <code class="nx">topping</code><code class="p">),</code>&#13;
                <code class="nx">Status</code><code class="p">:</code>  <code class="nx">metav1</code><code class="p">.</code><code class="nx">StatusFailure</code><code class="p">,</code>&#13;
            <code class="p">}</code>&#13;
            <code class="nx">responsewriters</code><code class="p">.</code><code class="nx">WriteObject</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">StatusOK</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">.</code><code class="nx">GroupVersion</code><code class="p">(),</code>&#13;
              <code class="nx">codecs</code><code class="p">,</code> <code class="nx">review</code><code class="p">,</code> <code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">)</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Allowed</code> <code class="p">=</code> <code class="kc">true</code>&#13;
<code class="k">default</code><code class="p">:</code>&#13;
    <code class="nx">review</code><code class="p">.</code><code class="nx">Response</code><code class="p">.</code><code class="nx">Result</code> <code class="p">=</code> <code class="o">&amp;</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">Status</code><code class="p">{</code>&#13;
        <code class="nx">Message</code><code class="p">:</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"unexpected type %T"</code><code class="p">,</code> <code class="nx">review</code><code class="p">.</code><code class="nx">Request</code><code class="p">.</code><code class="nx">Object</code><code class="p">.</code><code class="nx">Object</code><code class="p">),</code>&#13;
        <code class="nx">Status</code><code class="p">:</code>  <code class="nx">metav1</code><code class="p">.</code><code class="nx">StatusFailure</code><code class="p">,</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
<code class="nx">responsewriters</code><code class="p">.</code><code class="nx">WriteObject</code><code class="p">(</code><code class="nx">http</code><code class="p">.</code><code class="nx">StatusOK</code><code class="p">,</code> <code class="nx">gvk</code><code class="p">.</code><code class="nx">GroupVersion</code><code class="p">(),</code>&#13;
      <code class="nx">codecs</code><code class="p">,</code> <code class="nx">review</code><code class="p">,</code> <code class="nx">w</code><code class="p">,</code> <code class="nx">req</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Admission Webhook in Action" data-type="sect2"><div class="sect2" id="idm46336841534280">&#13;
<h2>Admission Webhook in Action</h2>&#13;
&#13;
<p>We<a data-primary="admission webhooks" data-secondary="using" data-type="indexterm" id="idm46336840443080"/> deploy the two admission webhooks by creating the two registration objects in the cluster:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl create -f validatingadmissionregistration.yaml&#13;
<code class="nv">$ </code>kubectl create -f mutatingadmissionregistration.yaml</pre>&#13;
&#13;
<p>After this, we can’t create pizzas with unknown toppings anymore:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl create -f ../examples/margherita-pizza.yaml&#13;
Error from server: error when creating <code class="s2">"../examples/margherita-pizza.yaml"</code>:&#13;
  admission webhook <code class="s2">"restaurant.programming-kubernetes.info"</code> denied the request:&#13;
    topping <code class="s2">"tomato"</code> not known</pre>&#13;
&#13;
<p>Meanwhile, in the webhook log we see:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">I0414 22:45:46.873541       1 pizzamutation.go:115] Defaulting pizza-crd/ in&#13;
  version admission.k8s.io/v1beta1, Kind=AdmissionReview&#13;
10.32.0.1 - - [14/Apr/2019:22:45:46 +0000]&#13;
  "POST /admit/v1beta1/pizza?timeout=30s HTTP/2.0" 200 871&#13;
10.32.0.1 - - [14/Apr/2019:22:45:46 +0000]&#13;
  "POST /validate/v1beta1/pizza?timeout=30s HTTP/2.0" 200 956</pre>&#13;
&#13;
<p>After creating the toppings in the example folder, we can create the margherita pizza again:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl create -f ../examples/topping-tomato.yaml&#13;
<code class="nv">$ </code>kubectl create -f ../examples/topping-salami.yaml&#13;
<code class="nv">$ </code>kubectl create -f ../examples/topping-mozzarella.yaml&#13;
<code class="nv">$ </code>kubectl create -f ../examples/margherita-pizza.yaml&#13;
pizza.restaurant.programming-kubernetes.info/margherita created</pre>&#13;
&#13;
<p>Last but not least, let’s check that defaulting works as expected. We want to create an empty pizza:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">restaurant.programming-kubernetes.info/v1alpha1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">Pizza</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">salami</code>&#13;
<code class="nt">spec</code><code class="p">:</code></pre>&#13;
&#13;
<p>This is supposed to be defaulted to a salami pizza, and it is:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="err">$</code> <code class="nx">kubectl</code> <code class="nx">create</code> <code class="o">-</code><code class="nx">f</code> <code class="p">..</code><code class="o">/</code><code class="nx">examples</code><code class="o">/</code><code class="nx">empty</code><code class="o">-</code><code class="nx">pizza</code><code class="p">.</code><code class="nx">yaml</code>&#13;
<code class="nx">pizza</code><code class="p">.</code><code class="nx">restaurant</code><code class="p">.</code><code class="nx">programming</code><code class="o">-</code><code class="nx">kubernetes</code><code class="p">.</code><code class="nx">info</code><code class="o">/</code><code class="nx">salami</code> <code class="nx">created</code>&#13;
<code class="err">$</code> <code class="nx">kubectl</code> <code class="nx">get</code> <code class="nx">pizza</code> <code class="nx">salami</code> <code class="o">-</code><code class="nx">o</code> <code class="nx">yaml</code>&#13;
<code class="nx">apiVersion</code><code class="p">:</code> <code class="nx">restaurant</code><code class="p">.</code><code class="nx">programming</code><code class="o">-</code><code class="nx">kubernetes</code><code class="p">.</code><code class="nx">info</code><code class="o">/</code><code class="nx">v1beta1</code>&#13;
<code class="nx">kind</code><code class="p">:</code> <code class="nx">Pizza</code>&#13;
<code class="nx">metadata</code><code class="p">:</code>&#13;
  <code class="nx">creationTimestamp</code><code class="p">:</code> <code class="s">"2019-04-14T22:49:40Z"</code>&#13;
  <code class="nx">generation</code><code class="p">:</code> <code class="mi">1</code>&#13;
  <code class="nx">name</code><code class="p">:</code> <code class="nx">salami</code>&#13;
  <code class="nx">namespace</code><code class="p">:</code> <code class="nx">pizza</code><code class="o">-</code><code class="nx">crd</code>&#13;
  <code class="nx">resourceVersion</code><code class="p">:</code> <code class="s">"23227"</code>&#13;
  <code class="nx">uid</code><code class="p">:</code> <code class="mf">962e2</code><code class="nx">dda</code><code class="o">-</code><code class="mi">5</code><code class="nx">f07</code><code class="o">-</code><code class="mf">11e9</code><code class="o">-</code><code class="mi">9230</code><code class="o">-</code><code class="mo">0242</code><code class="nx">f24ba99c</code>&#13;
<code class="nx">spec</code><code class="p">:</code>&#13;
  <code class="nx">toppings</code><code class="p">:</code>&#13;
  <code class="o">-</code> <code class="nx">name</code><code class="p">:</code> <code class="nx">tomato</code>&#13;
    <code class="nx">quantity</code><code class="p">:</code> <code class="mi">1</code>&#13;
  <code class="o">-</code> <code class="nx">name</code><code class="p">:</code> <code class="nx">mozzarella</code>&#13;
    <code class="nx">quantity</code><code class="p">:</code> <code class="mi">1</code>&#13;
  <code class="o">-</code> <code class="nx">name</code><code class="p">:</code> <code class="nx">salami</code>&#13;
    <code class="nx">quantity</code><code class="p">:</code> <code class="mi">1</code>&#13;
<code class="nx">status</code><code class="p">:</code> <code class="p">{}</code></pre>&#13;
&#13;
<p>Voilà, a salami pizza with all the toppings that we expect. Enjoy!</p>&#13;
&#13;
<p>Before concluding the chapter, we want to look toward an <code>apiextensions.k8s.io/v1</code> API group version (i.e., nonbeta, general availability) of CRDs—namely, the introduction of structural schemas.<a data-primary="" data-startref="CRadweb09" data-type="indexterm" id="idm46336839796264"/><a data-primary="" data-startref="WHad09" data-type="indexterm" id="idm46336839650280"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Structural Schemas and the Future of CustomResourceDefinitions" data-type="sect1"><div class="sect1" id="idm46336842072712">&#13;
<h1>Structural Schemas and the Future of CustomResourceDefinitions</h1>&#13;
&#13;
<p>From<a data-primary="schema, structural" data-type="indexterm" id="idm46336839549560"/><a data-primary="custom resource definitions (CRDs)" data-secondary="structural schemas" data-type="indexterm" id="CRstruct09"/><a data-primary="structural schemas" data-secondary="overview of" data-type="indexterm" id="idm46336839547640"/> Kubernetes 1.15 on, the OpenAPI v3 validation schema (see <a data-type="xref" href="ch04.html#crd-validation">“Validating Custom Resources”</a>) is getting a more central role for CRDs in the sense that it will be mandatory to specify a schema if any of these new features is used:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>CRD conversion (see <a data-type="xref" href="#crd-conversion-webhook">Figure 9-2</a>)</p>&#13;
</li>&#13;
<li>&#13;
<p>Pruning (see <a data-type="xref" href="#crd-pruning">“Pruning Versus Preserving Unknown Fields”</a>)</p>&#13;
</li>&#13;
<li>&#13;
<p>Defaulting (see <a data-type="xref" href="#crd-defaulting">“Default Values”</a>)</p>&#13;
</li>&#13;
<li>&#13;
<p>OpenAPI Schema <a href="http://bit.ly/2RzeA1O">Publishing</a></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Strictly speaking, the definition of a schema is still optional and every existing CRD will keep working, but without a schema your CRD is excluded from any new feature.</p>&#13;
&#13;
<p>In addition, the specified schema must follow certain rules to enforce that the specified types are actually sane in the sense of adhering to the <a href="http://bit.ly/2Nfd9Hn">Kubernetes API conventions</a>. We call these <em>structural schema</em>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before" data-pdf-bookmark="Structural Schemas" data-type="sect2"><div class="sect2" id="crd-structural-schema">&#13;
<h2>Structural Schemas</h2>&#13;
&#13;
<p>A structural schema is an OpenAPI v3 validation schema (see <a data-type="xref" href="ch04.html#crd-validation">“Validating Custom Resources”</a>) that obeys the following rules:</p>&#13;
<ol>&#13;
<li>&#13;
<p>The schema specifies a nonempty type (via <code>type</code> in OpenAPI) for the root, for each specified field of an object node (via <code>properties</code> or <code>additionalProperties</code> in OpenAPI), and for each item in an array node (via <code>items</code> in OpenAPI), with the exception of:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A node with <code>x-kubernetes-int-or-string: true</code></p>&#13;
</li>&#13;
<li>&#13;
<p>A node with <code>x-kubernetes-preserve-unknown-fields: true</code></p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>For each field in an object and each item in an array, which is set within an <code>allOf</code>, <code>anyOf</code>, <code>oneOf</code>, or <code>not</code>, the schema also specifies the field/item outside of those logical junctors.</p>&#13;
</li>&#13;
<li>&#13;
<p>The schema does not set <code>description</code>, <code>type</code>, <code>default</code>, <code>additionProperties</code>, or <code>nullable</code> within an <code>allOf</code>, <code>anyOf</code>, <code>oneOf</code>, or <code>not</code>, with the exception of the two patterns for <code>x-kubernetes-int-or-string: true</code> (see <a data-type="xref" href="#intorstring-section">“IntOrString and RawExtensions”</a>).</p>&#13;
</li>&#13;
<li>&#13;
<p>If <code>metadata</code> is specified, then only restrictions on <code>metadata.name</code> and <code><span class="keep-together">metadata.generateName</span></code> are allowed.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Here is an example that is not structural:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">properties</code><code class="p">:</code>&#13;
  <code class="nt">foo</code><code class="p">:</code>&#13;
    <code class="nt">pattern</code><code class="p">:</code> <code class="s">"abc"</code>&#13;
  <code class="nt">metadata</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
    <code class="nt">properties</code><code class="p">:</code>&#13;
      <code class="nt">name</code><code class="p">:</code>&#13;
        <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
        <code class="nt">pattern</code><code class="p">:</code> <code class="s">"^a"</code>&#13;
      <code class="nt">finalizers</code><code class="p">:</code>&#13;
        <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">array</code>&#13;
        <code class="nt">items</code><code class="p">:</code>&#13;
          <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
          <code class="nt">pattern</code><code class="p">:</code> <code class="s">"my-finalizer"</code>&#13;
<code class="nt">anyOf</code><code class="p">:</code>&#13;
<code class="p-Indicator">-</code> <code class="nt">properties</code><code class="p">:</code>&#13;
    <code class="nt">bar</code><code class="p">:</code>&#13;
      <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">integer</code>&#13;
      <code class="nt">minimum</code><code class="p">:</code> <code class="l-Scalar-Plain">42</code>&#13;
  <code class="nt">required</code><code class="p">:</code> <code class="p-Indicator">[</code><code class="s">"bar"</code><code class="p-Indicator">]</code>&#13;
  <code class="nt">description</code><code class="p">:</code> <code class="s">"foo</code><code class="nv"> </code><code class="s">bar</code><code class="nv"> </code><code class="s">object"</code></pre>&#13;
&#13;
<p>It is not a structural schema because of the following violations:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The type at the root is missing (rule 1).</p>&#13;
</li>&#13;
<li>&#13;
<p>The type of <code>foo</code> is missing (rule 1).</p>&#13;
</li>&#13;
<li>&#13;
<p><code>bar</code> inside of <code>anyOf</code> is not specified outside (rule 2).</p>&#13;
</li>&#13;
<li>&#13;
<p><code>bar</code>’s <code>type</code> is within <code>anyOf</code> (rule 3).</p>&#13;
</li>&#13;
<li>&#13;
<p>The description is set within <code>anyOf</code> (rule 3).</p>&#13;
</li>&#13;
<li>&#13;
<p><code>metadata.finalizer</code> might not be restricted (rule 4).</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In contrast, the following, corresponding schema is structural:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
<code class="nt">description</code><code class="p">:</code> <code class="s">"foo</code><code class="nv"> </code><code class="s">bar</code><code class="nv"> </code><code class="s">object"</code>&#13;
<code class="nt">properties</code><code class="p">:</code>&#13;
  <code class="nt">foo</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
    <code class="nt">pattern</code><code class="p">:</code> <code class="s">"abc"</code>&#13;
  <code class="nt">bar</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">integer</code>&#13;
  <code class="nt">metadata</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
    <code class="nt">properties</code><code class="p">:</code>&#13;
      <code class="nt">name</code><code class="p">:</code>&#13;
        <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
        <code class="nt">pattern</code><code class="p">:</code> <code class="s">"^a"</code>&#13;
<code class="nt">anyOf</code><code class="p">:</code>&#13;
<code class="p-Indicator">-</code> <code class="nt">properties</code><code class="p">:</code>&#13;
    <code class="nt">bar</code><code class="p">:</code>&#13;
      <code class="nt">minimum</code><code class="p">:</code> <code class="l-Scalar-Plain">42</code>&#13;
  <code class="nt">required</code><code class="p">:</code> <code class="p-Indicator">[</code><code class="s">"bar"</code><code class="p-Indicator">]</code></pre>&#13;
&#13;
<p>Violations of the structural schema rules are reported in the <code>NonStructural</code> condition in the CRD.</p>&#13;
&#13;
<p>Verify for yourself that the schema of the <code>cnat</code> example in <a data-type="xref" href="ch04.html#crd-validation">“Validating Custom Resources”</a> and the schemas in the <a href="http://bit.ly/31MrFcO">pizza CRD example</a> are indeed <span class="keep-together">structural</span>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pruning Versus Preserving Unknown Fields" data-type="sect2"><div class="sect2" id="crd-pruning">&#13;
<h2>Pruning Versus Preserving Unknown Fields</h2>&#13;
&#13;
<p>CRDs traditionally<a data-primary="structural schemas" data-secondary="pruning versus preserving unknown fields" data-type="indexterm" id="idm46336839336872"/><a data-primary="pruning" data-type="indexterm" id="idm46336839335800"/> store any (possibly validated) JSON as is in <code>etcd</code>. This means that unspecified fields (if there is an OpenAPI v3 validation schema at all) will be <span class="keep-together">persisted</span>. This is in contrast to native Kubernetes resources like a pod. If the user specifies a field <code>spec.randomField</code>, this will be accepted by the API server HTTPS endpoint but dropped (we call this <em>pruning</em>) before writing that pod to <code>etcd</code>.</p>&#13;
&#13;
<p>If a structural OpenAPI v3 validation schema is defined (either in the global <code>spec.validation.openAPIV3Schema</code> or for each version), we can enable pruning (which drops unspecified fields on creation and on update) by setting <code>spec.preserveUnknownFields</code> to <code>false</code>.</p>&#13;
&#13;
<p>Let’s look at the <code>cnat</code> example.<sup><a data-type="noteref" href="ch09.html#idm46336839329896" id="idm46336839329896-marker">2</a></sup> With a Kubernetes 1.15 cluster at hand, we enable pruning:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">apiextensions.k8s.io/v1beta1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">CustomResourceDefinition</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">ats.cnat.programming-kubernetes.info</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="l-Scalar-Plain">...</code>&#13;
  <code class="l-Scalar-Plain">preserveUnknownFields</code><code class="p-Indicator">:</code> <code class="l-Scalar-Plain">false</code></pre>&#13;
&#13;
<p>Then we try to create an instance with an unknown field:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">cnat.programming-kubernetes.info/v1alpha1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">At</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">example-at</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">schedule</code><code class="p">:</code> <code class="s">"2019-07-03T02:00:00Z"</code>&#13;
  <code class="nt">command</code><code class="p">:</code> <code class="l-Scalar-Plain">echo "Hello, world!"</code>&#13;
  <code class="nt">someGarbage</code><code class="p">:</code> <code class="l-Scalar-Plain">42</code></pre>&#13;
&#13;
<p>If<a data-primary="kubectl get at example-at" data-type="indexterm" id="idm46336839304952"/> we retrieve this object with <code>kubectl get at example-at</code>, we see that the <code>someGarbage</code> value is dropped:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">cnat.programming-kubernetes.info/v1alpha1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">At</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">example-at</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">schedule</code><code class="p">:</code> <code class="s">"2019-07-03T02:00:00Z"</code>&#13;
  <code class="nt">command</code><code class="p">:</code> <code class="l-Scalar-Plain">echo "Hello, world!"</code></pre>&#13;
&#13;
<p>We say that <code>someGarbage</code> has been <em>pruned</em>.</p>&#13;
&#13;
<p>As of Kubernetes 1.15, pruning is available in <em>apiextensions/v1beta1</em>, but it defaults to off; that is, <code>spec.preserveUnknownFields</code> defaults to <code>true</code>. In <em>apiextensions/v1</em>, no new CRD with <code>spec.preserveUnknownFields: true</code> will be allowed to be created.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Controlling Pruning" data-type="sect2"><div class="sect2" id="idm46336839412008">&#13;
<h2>Controlling Pruning</h2>&#13;
&#13;
<p>With <code>spec.preserveUnknownField: false</code> in<a data-primary="structural schemas" data-secondary="controlling pruning" data-type="indexterm" id="idm46336839212600"/><a data-primary="x-kubernetes-preserve-unknown-fields: true" data-type="indexterm" id="idm46336839172456"/> the CRD, pruning is enabled for all CRs of that type and in all versions. It is possible, though, to opt out of pruning for a JSON subtree via <code>x-kubernetes-preserve-unknown-fields: true</code> in the OpenAPI v3 validation schema:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
<code class="nt">properties</code><code class="p">:</code>&#13;
  <code class="nt">json</code><code class="p">:</code>&#13;
    <code class="nt">x-kubernetes-preserve-unknown-fields</code><code class="p">:</code> <code class="l-Scalar-Plain">true</code></pre>&#13;
&#13;
<p>The field <code>json</code> can store any JSON value, without anything being pruned.</p>&#13;
&#13;
<p>It is possible to partially specify the permitted JSON:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
<code class="nt">properties</code><code class="p">:</code>&#13;
  <code class="nt">json</code><code class="p">:</code>&#13;
    <code class="nt">x-kubernetes-preserve-unknown-fields</code><code class="p">:</code> <code class="l-Scalar-Plain">true</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
    <code class="nt">description</code><code class="p">:</code> <code class="l-Scalar-Plain">this is arbitrary JSON</code></pre>&#13;
&#13;
<p>With this approach, only object type values are allowed.</p>&#13;
&#13;
<p>Pruning is enabled again for each specified property (or <code>additionalProperties</code>):</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
<code class="nt">properties</code><code class="p">:</code>&#13;
  <code class="nt">json</code><code class="p">:</code>&#13;
    <code class="nt">x-kubernetes-preserve-unknown-fields</code><code class="p">:</code> <code class="l-Scalar-Plain">true</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
    <code class="nt">properties</code><code class="p">:</code>&#13;
      <code class="nt">spec</code><code class="p">:</code>&#13;
        <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
        <code class="nt">properties</code><code class="p">:</code>&#13;
          <code class="nt">foo</code><code class="p">:</code>&#13;
            <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
          <code class="nt">bar</code><code class="p">:</code>&#13;
            <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code></pre>&#13;
&#13;
<p>With this, the value:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">json</code><code class="p">:</code>&#13;
  <code class="nt">spec</code><code class="p">:</code>&#13;
    <code class="nt">foo</code><code class="p">:</code> <code class="l-Scalar-Plain">abc</code>&#13;
    <code class="nt">bar</code><code class="p">:</code> <code class="l-Scalar-Plain">def</code>&#13;
    <code class="nt">something</code><code class="p">:</code> <code class="l-Scalar-Plain">x</code>&#13;
  <code class="nt">status</code><code class="p">:</code>&#13;
    <code class="nt">something</code><code class="p">:</code> <code class="l-Scalar-Plain">x</code></pre>&#13;
&#13;
<p>will be pruned to:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">json</code><code class="p">:</code>&#13;
  <code class="nt">spec</code><code class="p">:</code>&#13;
    <code class="nt">foo</code><code class="p">:</code> <code class="l-Scalar-Plain">abc</code>&#13;
    <code class="nt">bar</code><code class="p">:</code> <code class="l-Scalar-Plain">def</code>&#13;
  <code class="nt">status</code><code class="p">:</code>&#13;
    <code class="nt">something</code><code class="p">:</code> <code class="l-Scalar-Plain">x</code></pre>&#13;
&#13;
<p>This means that the <em><code>something</code></em> field in the specified <code>spec</code> object is pruned (because “spec” is specified), but everything outside is not. <code>status</code> is not specified such that <code>status.<em>something</em></code> is not pruned.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="IntOrString and RawExtensions" data-type="sect2"><div class="sect2" id="intorstring-section">&#13;
<h2>IntOrString and RawExtensions</h2>&#13;
&#13;
<p>There<a data-primary="IntORString" data-type="indexterm" id="idm46336838940408"/><a data-primary="structural schemas" data-secondary="IntOrString and RawExtensions" data-type="indexterm" id="idm46336838939672"/> are situations where structural schemas are not expressive enough. One of those is a <em>polymorphic</em> field—one that can be of different types. We know <code><span class="keep-together">IntOrString</span></code> from native Kubernetes API types.</p>&#13;
&#13;
<p>It<a data-primary="x-kubernetes-int-or-string: true" data-type="indexterm" id="idm46336838936696"/><a data-primary="x-kubernetes-embedded-object: true" data-type="indexterm" id="idm46336838935992"/> is possible to have <code>IntOrString</code> in CRDs using the <code>x-kubernetes-int-or-string: true</code> directive inside the schema. Similarly, <code>runtime.RawExtensions</code> can be declared using the <code>x-kubernetes-embedded-object: true</code>.</p>&#13;
&#13;
<p>For example:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
<code class="nt">properties</code><code class="p">:</code>&#13;
  <code class="nt">intorstr</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
    <code class="nt">x-kubernetes-int-or-string</code><code class="p">:</code> <code class="l-Scalar-Plain">true</code>&#13;
  <code class="nt">embedded</code><code class="p">:</code>&#13;
    <code class="nt">x-kubernetes-embedded-object</code><code class="p">:</code> <code class="l-Scalar-Plain">true</code>&#13;
    <code class="nt">x-kubernetes-preserve-unknown-fields</code><code class="p">:</code> <code class="l-Scalar-Plain">true</code></pre>&#13;
&#13;
<p>This declares:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A field called <code>intorstr</code> that holds either an integer or a string</p>&#13;
</li>&#13;
<li>&#13;
<p>A field called <code>embedded</code> that holds a Kubernetes-like object such as a complete pod specification</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Refer to the <a href="http://bit.ly/2Lnmw61">official CRD documentation</a> for all the details about these directives.</p>&#13;
&#13;
<p>The last topic we want to talk about that depends on structural schemas is defaulting.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Default Values" data-type="sect2"><div class="sect2" id="crd-defaulting">&#13;
<h2>Default Values</h2>&#13;
&#13;
<p>In<a data-primary="structural schemas" data-secondary="default values" data-type="indexterm" id="idm46336838889000"/><a data-primary="defaulting" data-type="indexterm" id="idm46336838887992"/> native Kubernetes types, it is common to default certain values. Defaulting used to be possible for CRDs only by way of mutating admission webhooks (see <a data-type="xref" href="#admission-webhooks">“Admission Webhooks”</a>). As of Kubernetes 1.15, however, defaulting support is added (see the <a href="http://bit.ly/2ZFH8JY">design document</a>) to CRDs directly via the OpenAPI v3 schema described in the previous section.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>As of 1.15 this is still an alpha feature, meaning it’s disabled by default behind the<a data-primary="feature gate" data-type="indexterm" id="idm46336838884344"/> feature gate <code>CustomResourceDefaulting</code>. But with promotion to beta, probably in 1.16, it will become ubiquitous in CRDs.</p>&#13;
</div>&#13;
&#13;
<p>In order to default certain fields, just specify the default value via the <code>default</code> keyword in the OpenAPI v3 schema. This is very useful when you are adding new fields to a type.</p>&#13;
&#13;
<p>Starting with the schema of the <code>cnat</code> example from <a data-type="xref" href="ch04.html#crd-validation">“Validating Custom Resources”</a>, let’s assume we want to make the container image customizable, but default to a <code>busybox</code> image. For that we add the <code>image</code> field of string type to the OpenAPI v3 schema and set the default to <code>busybox</code>:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
<code class="nt">properties</code><code class="p">:</code>&#13;
  <code class="nt">apiVersion</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
  <code class="nt">kind</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
  <code class="nt">metadata</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
  <code class="nt">spec</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
    <code class="nt">properties</code><code class="p">:</code>&#13;
      <code class="nt">schedule</code><code class="p">:</code>&#13;
        <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
        <code class="nt">pattern</code><code class="p">:</code> <code class="s">"^</code><code class="err">\</code><code class="s">d{4}-([0]</code><code class="err">\</code><code class="s">d|1[0-2])-([0-2]</code><code class="err">\</code><code class="s">d|3[01])..."</code>&#13;
      <code class="nt">command</code><code class="p">:</code>&#13;
        <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
      <code class="nt">image</code><code class="p">:</code>&#13;
        <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
        <code class="nt">default</code><code class="p">:</code> <code class="s">"busybox"</code>&#13;
    <code class="nt">required</code><code class="p">:</code>&#13;
    <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">schedule</code>&#13;
    <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">command</code>&#13;
  <code class="nt">status</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
    <code class="nt">properties</code><code class="p">:</code>&#13;
      <code class="nt">phase</code><code class="p">:</code>&#13;
        <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
<code class="nt">required</code><code class="p">:</code>&#13;
<code class="p-Indicator">-</code> <code class="l-Scalar-Plain">metadata</code>&#13;
<code class="p-Indicator">-</code> <code class="l-Scalar-Plain">apiVersion</code>&#13;
<code class="p-Indicator">-</code> <code class="l-Scalar-Plain">kind</code>&#13;
<code class="p-Indicator">-</code> <code class="l-Scalar-Plain">spec</code></pre>&#13;
&#13;
<p>If the user creates an instance without specifying the image, the value is automatically set:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">cnat.programming-kubernetes.info/v1alpha1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">At</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">example-at</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">schedule</code><code class="p">:</code> <code class="s">"2019-07-03T02:00:00Z"</code>&#13;
  <code class="nt">command</code><code class="p">:</code> <code class="l-Scalar-Plain">echo "hello world!"</code></pre>&#13;
&#13;
<p>On creation, this turns automatically into:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">cnat.programming-kubernetes.info/v1alpha1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">At</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">example-at</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">schedule</code><code class="p">:</code> <code class="s">"2019-07-03T02:00:00Z"</code>&#13;
  <code class="nt">command</code><code class="p">:</code> <code class="l-Scalar-Plain">echo "hello world!"</code>&#13;
  <code class="nt">image</code><code class="p">:</code> <code class="l-Scalar-Plain">busybox</code></pre>&#13;
&#13;
<p>This looks super convenient and significantly improves the user experience of CRDs. What’s more, all old objects persisted in <code>etcd</code> will automatically inherit the new field when read from the API server.<sup><a data-type="noteref" href="ch09.html#idm46336838744152" id="idm46336838744152-marker">3</a></sup></p>&#13;
&#13;
<p>Note that persisted objects in <code>etcd</code> will not be rewritten (i.e., migrated automatically). In other words, on read the default values are only added on the fly and are only persisted when the object is updated for another reason.<a data-primary="" data-startref="CRstruct09" data-type="indexterm" id="idm46336838742232"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46336839550632">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>Admission and conversion webhooks take CRDs to a completely different level. Before these features, CRs were mostly used for small, not-so-serious use cases, often for configuration and for in-house applications where API compatibility was not that important.</p>&#13;
&#13;
<p>With webhooks CRs look much more like native resources, with a long lifecycle and powerful semantics. We have seen how to implement dependencies between different resources and how to set defaulting of fields.</p>&#13;
&#13;
<p>At this point you probably have a lot of ideas about where these features can be used in existing CRDs. We are curious to see the innovations of the community based on these features in the future.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm46336844085864"><sup><a href="ch09.html#idm46336844085864-marker">1</a></sup> <code>apiextensions.k8s.io</code> and <code>admissionregistration.k8s.io</code> are both scheduled to be promoted to v1 in Kubernetes 1.16.</p><p data-type="footnote" id="idm46336839329896"><sup><a href="ch09.html#idm46336839329896-marker">2</a></sup> We use the <code>cnat</code> example instead of the pizza example due to the simple structure of the former—for example, there’s only one version. Of course, all of this scales to multiple versions (i.e., one schema version).</p><p data-type="footnote" id="idm46336838744152"><sup><a href="ch09.html#idm46336838744152-marker">3</a></sup> For example, via <code>kubectl get ats -o yaml</code>.</p></div></div></section></body></html>