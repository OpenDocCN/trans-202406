<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.w3.org/2002/06/xhtml2/ http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<link href="Styles/Style00.css" rel="stylesheet" type="text/css" />
<link href="Styles/Style01.css" rel="stylesheet" type="text/css" />

<style type="text/css">body{margin:1em;background-color:transparent!important;}#sbo-rt-content *{text-indent:0pt!important;}#sbo-rt-content .bq{margin-right:1em!important;}</style></head>
<body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 8. The Finished App"><div class="chapter" id="ch8">
<h1><span class="label">Chapter 8. </span>The Finished App</h1>


<p>All the components of the new app are done and <a data-type="indexterm" data-primary="discovery tool" id="idm45779427353120"/><a data-type="indexterm" data-primary="React app" data-secondary="discovery tool in" id="idm45779427352416"/>testable in the discovery tool (<em>http://localhost:3000/discovery</em>). Now it’s time to put them all together into a working application (available in the browser as <em>http://localhost:3000/</em>). <a data-type="xref" href="#FIG0801">Figure 8-1</a> shows the <a data-type="indexterm" data-primary="React app" data-secondary="finished appearance of" id="ch8_term1"/><a data-type="indexterm" data-primary="React app" data-secondary="Whinepad example of" id="ch8_term2"/><a data-type="indexterm" data-primary="Whinepad app example" id="ch8_term3"/>desired result when the user loads the app for the first time. There is a single row of default data coming from schema’s samples to demonstrate the purpose of the app to the user.</p>

<figure><div id="FIG0801" class="figure">
<img src="Images/rur2_0801.png" alt="rur2 0801" width="600" height="190"/>
<h6><span class="label">Figure 8-1. </span>Loading the finished app for the first time</h6>
</div></figure>

<p class="pagebreak-before"><a data-type="xref" href="#FIG0802">Figure 8-2</a> shows the dialog that pops up when the user clicks the + ADD WHINE button.</p>

<figure><div id="FIG0802" class="figure">
<img src="Images/rur2_0802.png" alt="rur2 0802" width="600" height="394"/>
<h6><span class="label">Figure 8-2. </span>Adding a new record</h6>
</div></figure>

<p><a data-type="xref" href="#FIG0803">Figure 8-3</a> shows the state of the app after the user has added one more row.</p>

<figure><div id="FIG0803" class="figure">
<img src="Images/rur2_0803.png" alt="rur2 0803" width="600" height="230"/>
<h6><span class="label">Figure 8-3. </span>Two records in the table</h6>
</div></figure>

<p>Since you <a data-type="indexterm" data-startref="ch8_term1" id="idm45779427337136"/><a data-type="indexterm" data-startref="ch8_term2" id="idm45779427336400"/><a data-type="indexterm" data-startref="ch8_term3" id="idm45779427335728"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="rendering of" id="idm45779427335056"/><a data-type="indexterm" data-primary="rendering" data-secondary="of Excel app components" data-secondary-sortas="Excel app components" id="idm45779427334144"/>already have the header, body, the table component <code>Excel</code>, and the dialog component, the rendering is merely a question of assembling them, like so:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">Header</code><code class="o">/&gt;</code>
  <code class="o">&lt;</code><code class="nx">Body</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">Excel</code><code class="o">/&gt;</code>
    <code class="o">&lt;</code><code class="nx">Dialog</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">Form</code><code class="o">/&gt;</code>
    <code class="o">&lt;/</code><code class="nx">Dialog</code><code class="o">&gt;</code>
  <code class="o">&lt;/</code><code class="nx">Body</code><code class="o">&gt;</code>
<code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code></pre>

<p>Then the <a data-type="indexterm" data-primary="DataFlow component" data-secondary="goals of" id="idm45779427310880"/>main task is providing the correct props to these components and taking care of the data flow between them. Let’s create a component called <code>DataFlow</code> to take care of all this. <code>DataFlow</code> should have all the data and can <a data-type="indexterm" data-primary="callbacks" data-secondary="in Excel" data-secondary-sortas="Excel" id="idm45779427308464"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779427307216"/><a data-type="indexterm" data-primary="Header component" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779427305936"/>pass it to <code>&lt;Excel&gt;</code> and to <code>&lt;Header&gt;</code> (which needs to know the number of records for the search field’s placeholder). When the <a data-type="indexterm" data-primary="onDataChange callback prop" id="idm45779427271920"/><a data-type="indexterm" data-primary="Dialog component" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779427271312"/><a data-type="indexterm" data-primary="onAction callback" id="idm45779427270224"/>user changes the data in the table, <code>Excel</code> notifies the parent <code>DataFlow</code> via the <code>onDataChange</code> prop. When the user adds a new record using the <code>Dialog</code> in <code>DataFlow</code>, then the updated data is passed to <code>Excel</code> thanks to the <code>onAction</code> callback. <a data-type="xref" href="#FIG0804">Figure 8-4</a> shows this flow of data as a diagram.</p>

<figure><div id="FIG0804" class="figure">
<img src="Images/rur2_0804.png" alt="rur2 0804" width="600" height="391"/>
<h6><span class="label">Figure 8-4. </span>Flow of data</h6>
</div></figure>

<p>Another bit of information to be passed around by <code>DataFlow</code> is the <a data-type="indexterm" data-primary="search box" id="idm45779427262592"/><a data-type="indexterm" data-primary="filter prop" id="idm45779427261856"/><a data-type="indexterm" data-primary="search strings and data filtering" id="idm45779427261184"/><a data-type="indexterm" data-primary="filtering" data-secondary="search strings and" id="idm45779427260544"/>search (filter) string typed in the header’s search box. <code>DataFlow</code> takes it from the <code>Header</code>’s <code>onSearch</code> callback and passes it to <code>Excel</code> as the <code>filter</code> property, which is shown in <a data-type="xref" href="#FIG0805">Figure 8-5</a>.</p>

<figure><div id="FIG0805" class="figure">
<img src="Images/rur2_0805.png" alt="rur2 0805" width="600" height="261"/>
<h6><span class="label">Figure 8-5. </span>Passing the search (filter) string</h6>
</div></figure>

<p>Finally, <code>DataFlow</code> is also <a data-type="indexterm" data-primary="storage, data" id="idm45779427253744"/><a data-type="indexterm" data-primary="React app" data-secondary="with local storage" data-secondary-sortas="local storage" id="idm45779427253008"/><a data-type="indexterm" data-primary="localStorage" id="idm45779427251792"/><a data-type="indexterm" data-primary="data" data-secondary="storage of" id="idm45779427251120"/>responsible for updating the <code>localStorage</code>, which should always have the latest data.</p>






<section data-type="sect1" data-pdf-bookmark="Updated App.js"><div class="sect1" id="idm45779427249424">
<h1>Updated App.js</h1>

<p>The <code>&lt;App&gt;</code> component <a data-type="indexterm" data-primary="App.js" id="idm45779427247424"/><a data-type="indexterm" data-primary="React app" data-secondary="app configuration in" id="idm45779427246688"/><a data-type="indexterm" data-primary="React app" data-secondary="data as schema object in" id="idm45779427245744"/><a data-type="indexterm" data-primary="schema for data configuration" id="idm45779427244784"/><a data-type="indexterm" data-primary="DataFlow component" data-secondary="rendering of" id="idm45779427244096"/><a data-type="indexterm" data-primary="rendering" data-secondary="of DataFlow component" data-secondary-sortas="DataFlow component" id="idm45779427243152"/><a data-type="indexterm" data-primary="DataFlow component" data-secondary="initial data and schema for" id="idm45779427241936"/>needs a bit of an update. It imports the <code>schema</code>, then looks for data in <code>localStorage</code>. If there is none, it takes the first sample from the <code>schema</code> and uses it as initial data. Then it renders the new component-to-be <code>DataFlow</code> passing the data and the schema:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">import</code> <code class="s1">'./App.css'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Discovery</code> <code class="nx">from</code> <code class="s1">'./components/Discovery'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">DataFlow</code> <code class="nx">from</code> <code class="s1">'./components/DataFlow'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">schema</code> <code class="nx">from</code> <code class="s1">'./config/schema'</code><code class="o">;</code>

<code class="kd">const</code> <code class="nx">isDiscovery</code> <code class="o">=</code> <code class="nx">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">pathname</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\//g</code><code class="o">,</code> <code class="s1">''</code><code class="p">)</code> <code class="o">===</code> <code class="s1">'discovery'</code><code class="o">;</code>

<code class="nx">let</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">localStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="s1">'data'</code><code class="p">));</code>

<code class="c1">// default example data, read from the schema</code>
<code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">data</code> <code class="o">=</code> <code class="p">[{}];</code>
  <code class="nb">Object</code><code class="p">.</code><code class="nx">keys</code><code class="p">(</code><code class="nx">schema</code><code class="p">).</code><code class="nx">forEach</code><code class="p">((</code><code class="nx">key</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="nx">data</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="nx">key</code><code class="p">]</code> <code class="o">=</code> <code class="nx">schema</code><code class="p">[</code><code class="nx">key</code><code class="p">].</code><code class="nx">samples</code><code class="p">[</code><code class="mi">0</code><code class="p">]));</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">isDiscovery</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">Discovery</code> <code class="o">/&gt;;</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">DataFlow</code> <code class="nx">schema</code><code class="o">=</code><code class="p">{</code><code class="nx">schema</code><code class="p">}</code> <code class="nx">initialData</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code> <code class="o">/&gt;;</code>
<code class="p">}</code>

<code class="nx">export</code> <code class="k">default</code> <code class="nx">App</code><code class="o">;</code></pre>
</div></section>













<section data-type="sect1" data-pdf-bookmark="DataFlow Component"><div class="sect1" id="idm45779427238608">
<h1>DataFlow Component</h1>

<p>Now that the goals of the <code>&lt;DataFlow&gt;</code> component are clear and you see how it’s been used in the <code>&lt;App&gt;</code> component, let’s <a data-type="indexterm" data-primary="DataFlow component" data-secondary="implementation of" id="ch8_term4"/>see how to go about implementing it.</p>

<p>The overall structure, as you’d expect, is <a data-type="indexterm" data-primary="import/export/props structure" id="idm45779427059248"/><a data-type="indexterm" data-primary="PropTypes" id="idm45779427058480"/>about import/export and prop types:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">import</code> <code class="p">{</code><code class="nx">useState</code><code class="o">,</code> <code class="nx">useReducer</code><code class="o">,</code> <code class="nx">useRef</code><code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">PropTypes</code> <code class="nx">from</code> <code class="s1">'prop-types'</code><code class="o">;</code>

<code class="kd">import</code> <code class="nx">Header</code> <code class="nx">from</code> <code class="s1">'./Header'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Body</code> <code class="nx">from</code> <code class="s1">'./Body'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Dialog</code> <code class="nx">from</code> <code class="s1">'./Dialog'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Excel</code> <code class="nx">from</code> <code class="s1">'./Excel'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Form</code> <code class="nx">from</code> <code class="s1">'./Form'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">clone</code> <code class="nx">from</code> <code class="s1">'../modules/clone'</code><code class="o">;</code>

<code class="kd">function</code> <code class="nx">commitToStorage</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// TODO</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">reducer</code><code class="p">(</code><code class="nx">data</code><code class="o">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// TODO</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">({</code><code class="nx">schema</code><code class="o">,</code> <code class="nx">initialData</code><code class="p">})</code> <code class="p">{</code>
  <code class="c1">// TODO</code>
<code class="p">}</code>

<code class="nx">DataFlow</code><code class="p">.</code><code class="nx">propTypes</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">schema</code><code class="o">:</code> <code class="nx">PropTypes</code><code class="p">.</code><code class="nx">object</code><code class="p">.</code><code class="nx">isRequired</code><code class="o">,</code>
  <code class="nx">initialData</code><code class="o">:</code> <code class="nx">PropTypes</code><code class="p">.</code><code class="nx">arrayOf</code><code class="p">(</code><code class="nx">PropTypes</code><code class="p">.</code><code class="nx">object</code><code class="p">).</code><code class="nx">isRequired</code><code class="o">,</code>
<code class="p">};</code>

<code class="nx">export</code> <code class="k">default</code> <code class="nx">DataFlow</code><code class="o">;</code></pre>

<p>Now let’s see about these <code>TODO</code> comments.</p>

<p>The first one is a just a one-liner that takes whatever is passed to it (the latest <code>data</code>, the whole point of the app) and <a data-type="indexterm" data-primary="data" data-secondary="storage of" id="idm45779427055856"/><a data-type="indexterm" data-primary="storage, data" id="idm45779427054912"/><a data-type="indexterm" data-primary="localStorage" id="idm45779426896848"/><a data-type="indexterm" data-primary="React app" data-secondary="with local storage" data-secondary-sortas="local storage" id="idm45779426896176"/>writes it to <code>localStorage</code> to be used in the next session in case the user closes the browser tab:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">commitToStorage</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
<code class="p">}</code></pre>

<p>Next, the <a data-type="indexterm" data-primary="reducers" data-secondary="with DataFlow" data-secondary-sortas="DataFlow" id="ch8_term5"/>reducer. It’s responsible for only two types of events (actions):</p>
<dl>
<dt><code>save</code></dt>
<dd>
<p>This will create a new record in <code>data</code> when the user clicks the + ADD WHINE button.</p>
</dd>
<dt><code>excelchange</code></dt>
<dd>
<p>This <a data-type="indexterm" data-primary="excelchange event" id="idm45779426873472"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779426872736"/>handles any data change coming from <code>Excel</code>. This action doesn’t modify the data, just commits it to storage and returns it as-is:</p>
</dd>
</dl>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">reducer</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'save'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">unshift</code><code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">formData</code><code class="p">);</code>
    <code class="nx">commitToStorage</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
    <code class="k">return</code> <code class="nx">data</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'excelchange'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">commitToStorage</code><code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">updatedData</code><code class="p">);</code>
    <code class="k">return</code> <code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">updatedData</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>Why is it necessary <a data-type="indexterm" data-primary="reducers" data-secondary="double-calling of" id="idm45779426839664"/><a data-type="indexterm" data-primary="double-calling of reducer" id="idm45779426838816"/><a data-type="indexterm" data-primary="copying data" id="idm45779426737552"/><a data-type="indexterm" data-primary="cloning" data-secondary="reducer and" id="idm45779426736912"/>to clone the data before adding to it (via array’s <code>unshift()</code>)? It’s because the reducer is called twice in development (see <a data-type="xref" href="ch07.xhtml#ch7">Chapter 7</a>) and the same record would be added twice otherwise.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>With such a simple <a data-type="indexterm" data-primary="reducers" data-secondary="state as alternative to" id="idm45779426733520"/><a data-type="indexterm" data-primary="state" data-secondary="for data management" data-secondary-sortas="data management" id="idm45779426732512"/>reducer, is it really a good idea to opt for a reducer as opposed to state when it comes to <code>data</code> management? Probably not. In fact, an alternative implementation using only state is available in the book’s code repo as <em>DataFlow1.js</em> and it’s a bit shorter in terms of lines of code. The potential benefit of using a reducer is that it’s simpler to expand on if future new actions are expected.</p>
</div>

<p>Let’s dive into the body of the function that defines the <code>DataFlow</code> component.</p>








<section data-type="sect2" data-pdf-bookmark="DataFlow Body"><div class="sect2" id="idm45779426728848">
<h2>DataFlow Body</h2>

<p>Similarly to how <code>Excel</code> manages its state, let’s <a data-type="indexterm" data-primary="hooks" data-secondary="useReducer()" id="idm45779426726512"/><a data-type="indexterm" data-primary="hooks" data-secondary="useState()" id="idm45779426725504"/><a data-type="indexterm" data-primary="useReducer() hook" id="idm45779426724560"/><a data-type="indexterm" data-primary="useState() hook" id="idm45779426723888"/>try a combination of <code>useState()</code> and <code>useReducer()</code>. Let’s have a reducer for <code>data</code> since it’s potentially more involved and for everything else, stick with state. <a data-type="indexterm" data-primary="addNEW state" id="ch8_term6"/>The <code>addNew</code> state is a toggle whether or not to show an Add dialog, and <code>filter</code> is for the string the user types in the search box:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">({</code><code class="nx">schema</code><code class="o">,</code> <code class="nx">initialData</code><code class="p">})</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">data</code><code class="o">,</code> <code class="nx">dispatch</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useReducer</code><code class="p">(</code><code class="nx">reducer</code><code class="o">,</code> <code class="nx">initialData</code><code class="p">);</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">addNew</code><code class="o">,</code> <code class="nx">setAddNew</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">filter</code><code class="o">,</code> <code class="nx">setFilter</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>

  <code class="kd">const</code> <code class="nx">form</code> <code class="o">=</code> <code class="nx">useRef</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>

  <code class="kd">function</code> <code class="nx">saveNew</code><code class="p">(</code><code class="nx">action</code><code class="p">)</code> <code class="p">{</code><code class="cm">/* TODO */</code><code class="p">}</code>

  <code class="kd">function</code> <code class="nx">onExcelDataChange</code><code class="p">(</code><code class="nx">updatedData</code><code class="p">)</code> <code class="p">{</code><code class="cm">/* TODO */</code><code class="p">}</code>

  <code class="kd">function</code> <code class="nx">onSearch</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code><code class="cm">/* TODO */</code><code class="p">}</code>

  <code class="k">return</code> <code class="p">(</code>
    <code class="c1">// TODO: render</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>The <code>form</code> ref is <a data-type="indexterm" data-primary="Add dialog" id="idm45779426718816"/><a data-type="indexterm" data-primary="form ref" id="idm45779426596672"/><a data-type="indexterm" data-primary="refs, passing of" id="idm45779426596064"/>used similarly to <code>Excel</code> in <a data-type="xref" href="ch07.xhtml#ch7">Chapter 7</a> to harvest the data from the form shown in the Add dialog.</p>

<p>Next, let’s <a data-type="indexterm" data-startref="ch8_term5" id="idm45779426593504"/><a data-type="indexterm" data-primary="rendering" data-secondary="of DataFlow component" data-secondary-sortas="DataFlow component" id="idm45779426592800"/><a data-type="indexterm" data-primary="rendering" data-secondary="of Excel app components" data-secondary-sortas="Excel app components" id="idm45779426591552"/><a data-type="indexterm" data-primary="DataFlow component" data-secondary="rendering of" id="idm45779426590336"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="rendering of" id="idm45779426589392"/><a data-type="indexterm" data-primary="Header component" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779426588480"/>address the rendering <code>TODO</code>. Its task is to combine all the main components (<code>&lt;Header&gt;</code>, <code>&lt;Excel&gt;</code>, etc.) and pass around the <code>data</code> and callbacks. Conditionally, if the <a data-type="indexterm" data-primary="Add button" id="idm45779426585328"/>user clicks the Add button, a <code>&lt;Dialog&gt;</code> is constructed too.</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="k">return</code> <code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"DataFlow"</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">Header</code>
      <code class="nx">onAdd</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="nx">setAddNew</code><code class="p">(</code><code class="kc">true</code><code class="p">)}</code>
      <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">onSearch</code><code class="p">}</code>
      <code class="nx">count</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">}</code>
    <code class="o">/&gt;</code>
    <code class="o">&lt;</code><code class="nx">Body</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">Excel</code>
        <code class="nx">schema</code><code class="o">=</code><code class="p">{</code><code class="nx">schema</code><code class="p">}</code>
        <code class="nx">initialData</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code>
        <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code>
        <code class="nx">onDataChange</code><code class="o">=</code><code class="p">{(</code><code class="nx">updatedData</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">onExcelDataChange</code><code class="p">(</code><code class="nx">updatedData</code><code class="p">)}</code>
        <code class="nx">filter</code><code class="o">=</code><code class="p">{</code><code class="nx">filter</code><code class="p">}</code>
      <code class="o">/&gt;</code>
      <code class="p">{</code><code class="nx">addNew</code> <code class="o">?</code> <code class="p">(</code>
        <code class="o">&lt;</code><code class="nx">Dialog</code>
          <code class="nx">modal</code><code class="o">=</code><code class="p">{</code><code class="kc">true</code><code class="p">}</code>
          <code class="nx">header</code><code class="o">=</code><code class="s2">"Add new item"</code>
          <code class="nx">confirmLabel</code><code class="o">=</code><code class="s2">"Add"</code>
          <code class="nx">onAction</code><code class="o">=</code><code class="p">{(</code><code class="nx">action</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">saveNew</code><code class="p">(</code><code class="nx">action</code><code class="p">)}</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">Form</code> <code class="nx">ref</code><code class="o">=</code><code class="p">{</code><code class="nx">form</code><code class="p">}</code> <code class="nx">fields</code><code class="o">=</code><code class="p">{</code><code class="nx">schema</code><code class="p">}</code> <code class="o">/&gt;</code>
        <code class="o">&lt;/</code><code class="nx">Dialog</code><code class="o">&gt;</code>
      <code class="p">)</code> <code class="o">:</code> <code class="kc">null</code><code class="p">}</code>
    <code class="o">&lt;/</code><code class="nx">Body</code><code class="o">&gt;</code>
  <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
<code class="p">);</code></pre>

<p>The other three <code>TODO</code> comments are about the inline helper function, none of which should look complicated at this point.</p>

<p><code>onSearch()</code> takes <a data-type="indexterm" data-primary="onSearch() function" id="idm45779426582512"/><a data-type="indexterm" data-primary="filtering" data-secondary="search strings and" id="idm45779426581808"/><a data-type="indexterm" data-primary="search strings and data filtering" id="idm45779426407728"/>the search string from the header and updates the <code>filter</code> state, which (by way of rerendering) is passed to <code>Excel</code>, where it’s used to show only matching data records:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">onSearch</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">setFilter</code><code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">}</code></pre>

<p><code>onExcelDataChange()</code> is another <a data-type="indexterm" data-primary="onExcelDataChange() function" id="idm45779426393648"/><a data-type="indexterm" data-primary="callbacks" data-secondary="in Excel" data-secondary-sortas="Excel" id="idm45779426393040"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779426391856"/>one-liner. It’s a callback that takes any data updates from <code>Excel</code> and dispatches an action to be handled by the reducer:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">onExcelDataChange</code><code class="p">(</code><code class="nx">updatedData</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">dispatch</code><code class="p">({</code>
    <code class="nx">type</code><code class="o">:</code> <code class="s1">'excelchange'</code><code class="p">,</code>
    <code class="nx">payload</code><code class="o">:</code> <code class="p">{</code><code class="nx">updatedData</code><code class="p">},</code>
  <code class="p">});</code>
<code class="p">}</code></pre>

<p>Finally, <a data-type="indexterm" data-primary="saveNew() function" id="idm45779426346480"/>the <code>saveNew()</code> helper that <a data-type="indexterm" data-primary="Dialog component" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779426345360"/>handles dialog actions. It closes the dialog unconditionally (by setting the <code>addNew</code> state) and if the dialog wasn’t simply dismissed, it collects the form data from the dialog and dispatches the appropriate <code>save</code> action for the reducer <a data-type="indexterm" data-startref="ch8_term6" id="idm45779426343008"/>to handle.</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">saveNew</code><code class="p">(</code><code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">setAddNew</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'dismiss'</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="kr">const</code> <code class="nx">formData</code> <code class="o">=</code> <code class="p">{};</code>
  <code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">form</code><code class="p">.</code><code class="nx">current</code><code class="p">).</code><code class="nx">forEach</code><code class="p">(</code>
    <code class="p">(</code><code class="nx">input</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="nx">formData</code><code class="p">[</code><code class="nx">input</code><code class="p">.</code><code class="nx">id</code><code class="p">]</code> <code class="o">=</code> <code class="nx">input</code><code class="p">.</code><code class="nx">value</code><code class="p">),</code>
  <code class="p">);</code>

  <code class="nx">dispatch</code><code class="p">({</code>
    <code class="nx">type</code><code class="o">:</code> <code class="s1">'save'</code><code class="p">,</code>
    <code class="nx">payload</code><code class="o">:</code> <code class="p">{</code><code class="nx">formData</code><code class="p">},</code>
  <code class="p">});</code>
<code class="p">}</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Job Done"><div class="sect1" id="idm45779427238144">
<h1>Job Done</h1>

<p>And with <a data-type="indexterm" data-startref="ch8_term4" id="idm45779426213760"/>that, the app is complete. You can build it, deploy it to a server near you, and make it available to the world.</p>

<p>As you can see, the task was to create all necessary components (<a data-type="xref" href="ch07.xhtml#ch7">Chapter 7</a>), keeping them as small and general-purpose as possible and then making them all work together by rendering the top-level ones (<code>Header</code>, <code>Body</code>, <code>Excel</code>) and making sure the <a data-type="indexterm" data-primary="child-parent data communication" id="idm45779426210496"/><a data-type="indexterm" data-primary="parent-child data communication" id="idm45779426209888"/>data flows between children and parents.</p>

<p>So far you’ve learned about one way of passing data around using props and callbacks. This is a valid way but it can <a data-type="indexterm" data-primary="callbacks" data-secondary="limitations of" id="ch8_term7"/>reach a point of becoming difficult to maintain for two main reasons:</p>

<ul>
<li>
<p>Children can <a data-type="indexterm" data-primary="components" data-secondary="nested" id="idm45779426206288"/><a data-type="indexterm" data-primary="nested components" id="idm45779426205280"/>become deeply nested, resulting in long, clumsy chains of passing props and callbacks.</p>
</li>
<li>
<p>When you pass several callbacks to a component (when a lot happens in this component), defining all these callbacks soon loses its elegance.</p>
</li>
</ul>

<p>Props <a data-type="indexterm" data-primary="properties (props)" data-secondary="limitations of" id="idm45779426202720"/>and callbacks were the original way of communication between components in earlier React applications and it’s still a valid way for many cases. As React matured, developers started thinking of ways to fix the resulting complexity. <a data-type="indexterm" data-primary="APIs with React" id="idm45779426201328"/><a data-type="indexterm" data-primary="data" data-secondary="storage of" id="ch8_term8"/><a data-type="indexterm" data-primary="global storage of data" id="ch8_term9"/><a data-type="indexterm" data-primary="storage, data" id="ch8_term10"/>One popular approach is using a more global storage of data and then providing an API for components to read and write the data.</p>

<p class="pagebreak-before">Consider this example (from earlier ways of understanding how we build apps with React) of a deeply nested child using callback for communication:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// index.js</code>
<code class="kd">let</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[];</code>
<code class="kd">function</code> <code class="nx">dataChange</code><code class="p">(</code><code class="nx">newData</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">data</code> <code class="o">=</code> <code class="nx">newData</code>
<code class="p">}</code>
<code class="o">&lt;</code><code class="nx">App</code> <code class="nx">data</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code> <code class="nx">onDataChange</code><code class="o">=</code><code class="p">{</code><code class="nx">dataChange</code><code class="p">}</code> <code class="o">/&gt;</code>

<code class="c1">// &lt;App&gt; in app.js</code>
<code class="o">&lt;</code><code class="nx">Body</code> <code class="nx">data</code><code class="o">=</code><code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">data</code><code class="p">}</code> <code class="nx">onDataChange</code><code class="o">=</code><code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">onDataChange</code><code class="p">}</code> <code class="o">/&gt;</code>

<code class="c1">// &lt;Body&gt;</code>
<code class="o">&lt;</code><code class="nx">Table</code>
  <code class="nx">data</code><code class="o">=</code><code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">data</code><code class="p">}</code>
  <code class="nx">onDataChange</code><code class="o">=</code><code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">onDataChange</code><code class="p">}</code>
  <code class="nx">onSorting</code><code class="o">=</code><code class="p">{</code><code class="cm">/* ... */</code><code class="p">}</code>
  <code class="nx">onPaging</code><code class="o">=</code><code class="p">{</code><code class="cm">/* ... */</code><code class="p">}</code>
<code class="err">/&gt;</code>

<code class="c1">// In &lt;Table&gt;</code>
<code class="nx">props</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">((</code><code class="nx">row</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code><code class="cm">/* render */</code><code class="p">});</code>
<code class="c1">// later in &lt;Table&gt;</code>
<code class="nx">props</code><code class="p">.</code><code class="nx">onDataChange</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code></pre>

<p>Now, with some sort of <code>Storage</code> module, you can do the following:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// index.js</code>
<code class="o">&lt;</code><code class="nx">App</code> <code class="o">/&gt;</code>

<code class="c1">// &lt;App&gt; in app.js</code>
<code class="o">&lt;</code><code class="nx">Body</code> <code class="o">/&gt;</code>

<code class="c1">// &lt;Body&gt;</code>
<code class="o">&lt;</code><code class="nx">Table</code> <code class="o">/&gt;</code>

<code class="c1">// In &lt;Table&gt;</code>
<code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">Storage</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'data'</code><code class="p">);</code>
<code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">((</code><code class="nx">row</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code><code class="cm">/* render */</code><code class="p">});</code>
<code class="c1">// later in &lt;Table&gt;</code>
<code class="nx">Storage</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">newData</code><code class="p">);</code></pre>

<p>You can agree that the second option looks much cleaner and more succinct.</p>

<p>Initially, this <a data-type="indexterm" data-primary="Flux" id="idm45779425984352"/><a data-type="indexterm" data-primary="Redux" id="idm45779425983520"/><a data-type="indexterm" data-primary="callbacks" data-secondary="context as alternative to" id="idm45779425982880"/>idea of global storage was called <em>Flux</em> and a lot of implementations appeared in the open-source world. One of the implementations, a library called <em>Redux</em>, won a significant developer mind-share. A different implementation was part of the first edition of this book. Today, the same idea is part of React’s core, implemented as <em>context</em>.</p>

<p>Let’s see <a data-type="indexterm" data-primary="Whinepad app example" id="idm45779425979920"/><a data-type="indexterm" data-primary="React app" data-secondary="Whinepad example of" id="idm45779425979184"/><a data-type="indexterm" data-primary="React app" data-secondary="versions of" id="idm45779425978240"/>how the Whinepad app can transition to its version 2 and move away from callbacks in favor of <a data-type="indexterm" data-startref="ch8_term7" id="idm45779425977056"/><a data-type="indexterm" data-startref="ch8_term8" id="idm45779425976384"/><a data-type="indexterm" data-startref="ch8_term9" id="idm45779425975712"/><a data-type="indexterm" data-startref="ch8_term10" id="idm45779425975040"/>context.</p>








<section data-type="sect2" data-pdf-bookmark="Whinepad v2"><div class="sect2" id="idm45779425974112">
<h2>Whinepad v2</h2>

<p>To start with v2, you <a data-type="indexterm" data-primary="directories, creating" id="idm45779425972192"/><a data-type="indexterm" data-primary="node_modules" id="idm45779425971488"/><a data-type="indexterm" data-primary="package.json" id="idm45779425970784"/><a data-type="indexterm" data-primary="React app" data-secondary="node_modules for" id="idm45779425970112"/><a data-type="indexterm" data-primary="React app" data-secondary="directories for" id="idm45779425969168"/>need a copy of the <em>whinepad</em> directory without the <em>node_​mod⁠ules/</em> directory (where all npm-downloaded dependencies are stored) and without the <em>package-lock.json</em>:</p>
<pre data-type="programlisting">$ <strong>cd ~/reactbook/whinepad</strong>
$ <strong>rm -rf node_modules/</strong>
$ <strong>rm package-lock.json</strong></pre>

<p>These two are artifacts of installing your app, so when you distribute the app (e.g., sharing with others on GitHub or just putting it in source control) you don’t need them.</p>

<p>Copy the <em>whinepad</em> (v1) and you’re ready for v2:</p>
<pre data-type="programlisting">$ <strong>cd ~/reactbook/</strong>
$ <strong>cp -r whinepad whinepad2</strong></pre>

<p>Install the <a data-type="indexterm" data-primary="dependencies" data-secondary="version 2 location for" id="idm45779425961696"/>dependencies in the new location:</p>
<pre data-type="programlisting">$ <strong>cd ~/reactbook/whinepad2</strong>
$ <strong>npm i</strong></pre>

<p>Start the <a data-type="indexterm" data-primary="Create React App (CRA)" id="idm45779425958704"/><a data-type="indexterm" data-primary="React app" data-secondary="Create React App (CRA) for" id="idm45779425957968"/>CRA for development:</p>
<pre data-type="programlisting">$ <strong>npm start .</strong></pre>

<p>Now, let’s rewrite the app so it uses contexts.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Context"><div class="sect1" id="idm45779426310400">
<h1>Context</h1>

<p>The first <a data-type="indexterm" data-primary="context/DataContext" data-secondary="creating" id="ch8_term11"/>step is to create a context. That’s best done in a separate module so it can be shared between components. And since chances are you may have more than one context, you can store them in a separate directory, sibling to <em>/components</em> and <span class="keep-together"><em>/modules</em></span>.</p>
<pre data-type="programlisting">$ <strong>cd ~/reactbook/whinepad2/src</strong>
$ <strong>mkdir contexts</strong>
$ <strong>touch contexts/DataContext.js</strong></pre>

<p>Not much is happening in <em>DataContext.js</em>, just a call to create the context:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">DataContext</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">createContext</code><code class="p">();</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">DataContext</code><code class="p">;</code></pre>

<p>The <a data-type="indexterm" data-primary="createContext() function" id="idm45779425934752"/>call to <code>createContext()</code> accepts a default value. Its purpose is mostly for testing, documentation, and type safety. Let’s provide the default value:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">DataContext</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">createContext</code><code class="p">({</code>
  <code class="nx">data</code><code class="o">:</code> <code class="p">[],</code>
  <code class="nx">updateData</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{},</code>
<code class="p">});</code></pre>

<p>You can have any value stored in a context, but a common pattern is to have an object with two properties: a piece of data and a function that can update the data.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Next Steps"><div class="sect1" id="idm45779425890912">
<h1>Next Steps</h1>

<p>Now that a context is created, the <a data-type="indexterm" data-primary="Excel component in React app" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779425889408"/><a data-type="indexterm" data-primary="Header component" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779425888192"/>next steps are to use the context where required in the components. The <code>data</code> is used in <code>Excel</code> and in <code>Header</code>, so these two components need an update. Also passing the data around was done in <code>DataFlow</code> and that’s where the most changes are to be done.</p>

<p>But first, an <a data-type="indexterm" data-primary="App.js" id="idm45779425884640"/><a data-type="indexterm" data-primary="React app" data-secondary="app configuration in" id="idm45779425883904"/><a data-type="indexterm" data-primary="React app" data-secondary="versions of" id="idm45779425882960"/>update and simplification to <em>App.js</em> is in order. In v1, that’s where the initial (or default) data was being figured out and then passed as props to <code>&lt;DataFlow&gt;</code>. In v2, let’s have any and all data management happen in <code>&lt;DataFlow&gt;</code>. The updated <em>App.js</em> looks a little bare-bones:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">import</code> <code class="s1">'./App.css'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Discovery</code> <code class="nx">from</code> <code class="s1">'./components/Discovery'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">DataFlow</code> <code class="nx">from</code> <code class="s1">'./components/DataFlow'</code><code class="o">;</code>

<code class="kd">const</code> <code class="nx">isDiscovery</code> <code class="o">=</code> <code class="nx">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">pathname</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\//g</code><code class="o">,</code> <code class="s1">''</code><code class="p">)</code> <code class="o">===</code> <code class="s1">'discovery'</code><code class="o">;</code>

<code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">isDiscovery</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">Discovery</code> <code class="o">/&gt;;</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">DataFlow</code> <code class="o">/&gt;;</code>
<code class="p">}</code>

<code class="nx">export</code> <code class="k">default</code> <code class="nx">App</code><code class="o">;</code></pre>

<p>The <a data-type="indexterm" data-primary="DataFlow component" data-secondary="goals of" id="idm45779425850816"/><a data-type="indexterm" data-primary="child-parent data communication" id="idm45779425762288"/><a data-type="indexterm" data-primary="parent-child data communication" id="idm45779425761632"/>job of <code>DataFlow</code> is to figure out the initial data when the app is loaded, update that data in the context, and make sure the children <code>&lt;Excel&gt;</code> and <code>&lt;Header&gt;</code> can get the data from the context. The children should also be able to update the data. That’s surprisingly uncomplicated as you’ll see shortly, but first, a word on how the data flow in v2 is going to be different <a data-type="indexterm" data-startref="ch8_term11" id="idm45779425759200"/>than v1.</p>








<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="Circular Data"><div class="sect2" id="idm45779425758368">
<h2>Circular Data</h2>

<p>In v1 (also see <a data-type="xref" href="#FIG0804">Figure 8-4</a>), <code>Excel</code> manages the <code>data</code> in its state. This is a great way to build standalone components that can be dropped anywhere in any app. <a data-type="indexterm" data-primary="circular data flow" id="idm45779425754112"/><a data-type="indexterm" data-primary="data" data-secondary="circular flow of" id="idm45779425753408"/>But the parent <code>DataFlow</code> also keeps the data in its state because the data needs to be shared between <code>Header</code> and <code>Excel</code>. So there are two “sources of truth” that need to be synchronized. This was <a data-type="indexterm" data-primary="onDataChange callback prop" id="idm45779425751056"/>done by passing the <code>data</code> prop from <code>DataFlow</code> to <code>Excel</code>	and by using the <code>onDataChange</code> callback to communicate from the child <code>Excel</code> to the parent <code>DataFlow</code>. That creates a <a data-type="indexterm" data-primary="rendering" data-secondary="in React lifecycle" data-secondary-sortas="React lifecycle" id="idm45779425747520"/>circular flow of data, which may lead to an infinite rendering loop. The <code>data</code> changes in <code>Excel</code>, which means it’s rerendered. <code>DataFlow</code> receives the new data via <code>onDataChange</code> and updates its state, which means it’s rerendered, which causes a new render of <code>Excel</code> (it’s a child).</p>

<p>React prevents this by refusing to update state during a rendering phase. That’s <a data-type="indexterm" data-primary="setTimeout() function" id="idm45779425755648"/><a data-type="indexterm" data-primary="timeout hack" id="idm45779425743280"/>why the <code>setTimeout</code> hack was required in <code>Excel</code> when invoking the <code>onDataChange</code> callback in the reducer:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">reducer</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// ...</code>
  <code class="nx">setTimeout</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">onDataChange</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
  <code class="k">return</code> <code class="nx">data</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>This works just fine. The timeout allows React to finish rendering before updating the state again. This hack is the price paid to have a completely standalone <code>Excel</code> that manages its own data.</p>

<p>Let’s change this in v2 and have a single source of truth (<code>data</code> in <code>DataFlow</code>). This avoids the hack but comes with the drawback that <code>Excel</code> now needs someone else to manage the data. That’s not difficult, but it is a change and it requires the test area <code>&lt;Discovery&gt;</code> to be a bit more involved.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Providing Context"><div class="sect1" id="idm45779425718208">
<h1>Providing Context</h1>

<p>Let’s see <a data-type="indexterm" data-primary="context/DataContext" data-secondary="in DataFlow component" data-secondary-sortas="DataFlow component" id="ch8_term12"/><a data-type="indexterm" data-primary="DataFlow component" data-secondary="DataContext in" id="ch8_term13"/>how the context <code>DataContext</code> created by <code>React.createContext()</code> can be used. The heavy lifting enabling this happens in <code>DataFlow</code>, so let’s examine its v2.</p>

<p>Requiring <a data-type="indexterm" data-primary="DataFlow.js" id="idm45779425681376"/>the context in <em>DataFlow.js</em>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">import</code> <code class="nx">schema</code> <code class="nx">from</code> <code class="s1">'../config/schema'</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">DataContext</code> <code class="nx">from</code> <code class="s1">'../contexts/DataContext'</code><code class="p">;</code></pre>

<p>Figuring out the initial state of the world, either from the storage or from <code>schema</code> samples, can happen at the top of the module, not even in the body of the <code>DataFlow</code> function:</p>

<pre data-type="programlisting" data-code-language="javascript" class="pagebreak-before"><code class="kd">let</code> <code class="nx">initialData</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">localStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="s1">'data'</code><code class="p">));</code>

<code class="c1">// default example data, read from the schema</code>
<code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">initialData</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">initialData</code> <code class="o">=</code> <code class="p">[{}];</code>
  <code class="nb">Object</code><code class="p">.</code><code class="nx">keys</code><code class="p">(</code><code class="nx">schema</code><code class="p">).</code><code class="nx">forEach</code><code class="p">(</code>
    <code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="nx">initialData</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="nx">key</code><code class="p">]</code> <code class="o">=</code> <code class="nx">schema</code><code class="p">[</code><code class="nx">key</code><code class="p">].</code><code class="nx">samples</code><code class="p">[</code><code class="mi">0</code><code class="p">]),</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>The <code>data</code> is kept in the state just like before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">()</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>The <code>data</code> is going to be a part of the context. The <a data-type="indexterm" data-primary="updateData() function" id="idm45779425545520"/><a data-type="indexterm" data-primary="context/DataContext" data-secondary="updating data in" id="ch8_term14"/>context also needs a function to update the data. This function is defined inline in <code>DataFlow</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">updateData</code><code class="p">(</code><code class="nx">newData</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">newData</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
  <code class="nx">commitToStorage</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
  <code class="nx">setData</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The three steps of <a data-type="indexterm" data-primary="cloning" data-secondary="in DataContext" data-secondary-sortas="DataContext" id="idm45779425497728"/><a data-type="indexterm" data-primary="data" data-secondary="storage of" id="idm45779425496720"/><a data-type="indexterm" data-primary="localStorage" id="idm45779425495776"/><a data-type="indexterm" data-primary="React app" data-secondary="with local storage" data-secondary-sortas="local storage" id="idm45779425495104"/><a data-type="indexterm" data-primary="storage, data" id="idm45779425493888"/>updating the data are:</p>
<ol>
<li>
<p>Clone the data so it’s always immutable.</p>
</li>
<li>
<p>Save it to <code>localStorage</code> for the next time the app is loaded.</p>
</li>
<li>
<p>Update the state.</p>
</li>

</ol>

<p>Armed with <code>data</code> and <code>updateData</code>, the last <a data-type="indexterm" data-primary="context providers" id="ch8_term15"/><a data-type="indexterm" data-primary="DataContext.Provider component" id="ch8_term16"/><a data-type="indexterm" data-primary="provider components" id="ch8_term17"/>step is to wrap any children (<code>Excel</code> and <code>Header</code>) that require the context in a <em>provider</em> component:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code> <code class="nx">value</code><code class="o">=</code><code class="p">{{</code><code class="nx">data</code><code class="o">,</code> <code class="nx">updateData</code><code class="p">}}</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">Header</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">onSearch</code><code class="p">}</code> <code class="o">/&gt;</code>
  <code class="o">&lt;</code><code class="nx">Body</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">Excel</code> <code class="nx">filter</code><code class="o">=</code><code class="p">{</code><code class="nx">filter</code><code class="p">}</code> <code class="o">/&gt;</code>
  <code class="o">&lt;/</code><code class="nx">Body</code><code class="o">&gt;</code>
<code class="o">&lt;/</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code><code class="o">&gt;</code></pre>

<p>The provider component <code>&lt;DataContext.Provider&gt;</code> is available <a data-type="indexterm" data-primary="createContext() function" id="idm45779425425328"/>thanks to the call to <code>createContext()</code>, which created the <code>DataContext</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">DataContext</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">createContext</code><code class="p">({</code>
  <code class="nx">data</code><code class="o">:</code> <code class="p">[],</code>
  <code class="nx">updateData</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{},</code>
<code class="p">});</code></pre>

<p>The provider must set a <code>value</code> prop, which could be anything. Here the value is the common pattern: “data plus a way to change the data.”</p>

<p>Now any <a data-type="indexterm" data-primary="DataContext.Consumer component" id="idm45779425371600"/><a data-type="indexterm" data-primary="hooks" data-secondary="useContext()" id="idm45779425371056"/><a data-type="indexterm" data-primary="useContext() hook" id="idm45779425370112"/><a data-type="indexterm" data-primary="context/DataContext" data-secondary="consumers of" id="idm45779425369440"/>child of <code>&lt;DataContext.Provider&gt;</code> such as <code>&lt;Excel&gt;</code> or <code>&lt;Header&gt;</code> can be a <em>consumer</em> of the context value set by the <em>provider</em>. The way to consume is either via a <code>&lt;DataContext.Consumer&gt;</code> component or via a <code>useContext()</code> hook.</p>

<p>Before taking a look at consuming the context, the <a data-type="indexterm" data-primary="DataFlow.js" id="idm45779425364896"/><a data-type="indexterm" data-primary="React app" data-secondary="versions of" id="idm45779425364192"/><a data-type="indexterm" data-primary="React app" data-secondary="Whinepad example of" id="ch8_term18"/><a data-type="indexterm" data-primary="Whinepad app example" id="ch8_term19"/>following is a complete listing of the new <em>DataFlow.js</em>. For the complete code of the v2 of Whinepad, consult the <span class="keep-together"><em>whinepad2</em></span> directory in the book’s repo.</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">import</code> <code class="p">{</code><code class="nx">useState</code><code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="o">;</code>

<code class="kd">import</code> <code class="nx">Header</code> <code class="nx">from</code> <code class="s1">'./Header'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Body</code> <code class="nx">from</code> <code class="s1">'./Body'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Excel</code> <code class="nx">from</code> <code class="s1">'./Excel'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">schema</code> <code class="nx">from</code> <code class="s1">'../config/schema'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">DataContext</code> <code class="nx">from</code> <code class="s1">'../contexts/DataContext'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">clone</code> <code class="nx">from</code> <code class="s1">'../modules/clone'</code><code class="o">;</code>

<code class="nx">let</code> <code class="nx">initialData</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">localStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="s1">'data'</code><code class="p">));</code>

<code class="c1">// default example data, read from the schema</code>
<code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">initialData</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">initialData</code> <code class="o">=</code> <code class="p">[{}];</code>
  <code class="nb">Object</code><code class="p">.</code><code class="nx">keys</code><code class="p">(</code><code class="nx">schema</code><code class="p">).</code><code class="nx">forEach</code><code class="p">(</code>
    <code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="nx">initialData</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="nx">key</code><code class="p">]</code> <code class="o">=</code> <code class="nx">schema</code><code class="p">[</code><code class="nx">key</code><code class="p">].</code><code class="nx">samples</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code><code class="o">,</code>
  <code class="p">);</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">commitToStorage</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="s1">'data'</code><code class="o">,</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">()</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">data</code><code class="o">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">filter</code><code class="o">,</code> <code class="nx">setFilter</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>

  <code class="kd">function</code> <code class="nx">updateData</code><code class="p">(</code><code class="nx">newData</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">newData</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
    <code class="nx">commitToStorage</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
    <code class="nx">setData</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="kd">function</code> <code class="nx">onSearch</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">const</code> <code class="nx">s</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">value</code><code class="o">;</code>
    <code class="nx">setFilter</code><code class="p">(</code><code class="nx">s</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"DataFlow"</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code> <code class="nx">value</code><code class="o">=</code><code class="p">{{</code><code class="nx">data</code><code class="o">,</code> <code class="nx">updateData</code><code class="p">}}</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">Header</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">onSearch</code><code class="p">}</code> <code class="o">/&gt;</code>
        <code class="o">&lt;</code><code class="nx">Body</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">Excel</code> <code class="nx">filter</code><code class="o">=</code><code class="p">{</code><code class="nx">filter</code><code class="p">}</code> <code class="o">/&gt;</code>
        <code class="o">&lt;/</code><code class="nx">Body</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code>

<code class="nx">export</code> <code class="k">default</code> <code class="nx">DataFlow</code><code class="o">;</code></pre>

<p>As you can see, <code>filter</code> is still passed as a prop to <code>&lt;Excel&gt;</code>. Even <a data-type="indexterm" data-primary="properties (props)" data-secondary="contexts and use of" id="idm45779425315968"/>though you’re using a context, prop passing is still an option. It could be the preferred approach for many scenarios when components <a data-type="indexterm" data-startref="ch8_term14" id="idm45779425314704"/><a data-type="indexterm" data-startref="ch8_term15" id="idm45779425314032"/><a data-type="indexterm" data-startref="ch8_term16" id="idm45779425313360"/><a data-type="indexterm" data-startref="ch8_term17" id="idm45779425312688"/><a data-type="indexterm" data-startref="ch8_term18" id="idm45779425006016"/><a data-type="indexterm" data-startref="ch8_term19" id="idm45779425005408"/>need to communicate.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Consuming Context"><div class="sect1" id="idm45779425717264">
<h1>Consuming Context</h1>

<p>If you consult the v1 of <code>DataFlow</code> from <a data-type="indexterm" data-primary="React app" data-secondary="versions of" id="idm45779425003040"/><a data-type="indexterm" data-primary="reducers" data-secondary="with DataFlow" data-secondary-sortas="DataFlow" id="idm45779425002064"/><a data-type="indexterm" data-primary="reducers" data-secondary="replacement of" id="idm45779425000816"/>earlier in this chapter, you may notice that the <code>reducer()</code> is gone <a data-type="indexterm" data-startref="ch8_term12" id="idm45779424999296"/><a data-type="indexterm" data-startref="ch8_term13" id="idm45779424998560"/>in v2. The reducer’s job was to handle data changes from <code>Excel</code> and adding new records from the header. These <a data-type="indexterm" data-primary="Excel component in React app" data-secondary="context/DataContext in" id="idm45779424997312"/><a data-type="indexterm" data-primary="Header component" data-secondary="context/DataContext in" id="ch8_term25"/><a data-type="indexterm" data-primary="context/DataContext" data-secondary="consumers of" id="ch8_term28"/>tasks can now be performed in each responsible child. <code>Excel</code> can handle any changes and <a data-type="indexterm" data-primary="updateData() function" id="ch8_term22"/>then update the context using the provided <code>updateData()</code>. And <code>Header</code> can handle adding new records and use the same function to update the data in the context. Let’s see how.</p>








<section data-type="sect2" data-pdf-bookmark="Context in the Header"><div class="sect2" id="idm45779425003504">
<h2>Context in the Header</h2>

<p>The new <a data-type="indexterm" data-primary="Dialog component" data-secondary="and Header component" data-secondary-sortas="Header component" id="ch8_term23"/><a data-type="indexterm" data-primary="forms in React app" data-secondary="and Header component" data-secondary-sortas="Header component" id="ch8_term24"/>header is going to be responsible for more of the UI, <a data-type="indexterm" data-primary="Dialog component" data-secondary="in DataContext" data-secondary-sortas="DataContext" id="ch8_term21"/>namely the <code>Form</code> in a <code>Dialog</code> to add new records, so the list of imports is a little longer. Note that the new <code>DataContext</code> is imported too:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">import</code> <code class="nx">Logo</code> <code class="nx">from</code> <code class="s1">'./Logo'</code><code class="p">;</code>
<code class="kr">import</code> <code class="s1">'./Header.css'</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code><code class="nx">useContext</code><code class="p">,</code> <code class="nx">useState</code><code class="p">,</code> <code class="nx">useRef</code><code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>

<code class="kr">import</code> <code class="nx">Button</code> <code class="nx">from</code> <code class="s1">'./Button'</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">FormInput</code> <code class="nx">from</code> <code class="s1">'./FormInput'</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">Dialog</code> <code class="nx">from</code> <code class="s1">'./Dialog'</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">Form</code> <code class="nx">from</code> <code class="s1">'./Form'</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">schema</code> <code class="nx">from</code> <code class="s1">'../config/schema'</code><code class="p">;</code>

<code class="kr">import</code> <code class="nx">DataContext</code> <code class="nx">from</code> <code class="s1">'../contexts/DataContext'</code><code class="p">;</code>

<code class="kd">function</code> <code class="nx">Header</code><code class="p">({</code><code class="nx">onSearch</code><code class="p">})</code> <code class="p">{</code>
 <code class="c1">// TODO</code>
<code class="p">}</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">Header</code><code class="p">;</code></pre>

<p class="pagebreak-before">The pieces of <a data-type="indexterm" data-primary="Header component" data-secondary="rendering of" id="ch8_term26"/><a data-type="indexterm" data-primary="rendering" data-secondary="of Header component" data-secondary-sortas="Header component" id="ch8_term27"/>data needed to render the header are:</p>

<ul>
<li>
<p><code>data</code> coming from the context</p>
</li>
<li>
<p><code>addNew</code> flag <a data-type="indexterm" data-primary="addNEW state" id="ch8_term20"/>whether or not the <a data-type="indexterm" data-primary="Add button" id="idm45779424873712"/><a data-type="indexterm" data-primary="Add dialog" id="idm45779424873008"/>Add dialog is shown (when the user clicks the Add button)</p>
</li>
</ul>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">Header</code><code class="p">({</code><code class="nx">onSearch</code><code class="p">})</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code><code class="nx">data</code><code class="p">,</code> <code class="nx">updateData</code><code class="p">}</code> <code class="o">=</code> <code class="nx">useContext</code><code class="p">(</code><code class="nx">DataContext</code><code class="p">);</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">addNew</code><code class="p">,</code> <code class="nx">setAddNew</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>

  <code class="kr">const</code> <code class="nx">form</code> <code class="o">=</code> <code class="nx">useRef</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>

  <code class="kr">const</code> <code class="nx">count</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">placeholder</code> <code class="o">=</code> <code class="nx">count</code> <code class="o">&gt;</code> <code class="mi">1</code> <code class="o">?</code> <code class="sb">`Search </code><code class="si">${</code><code class="nx">count</code><code class="si">}</code><code class="sb"> items`</code> <code class="o">:</code> <code class="s1">'Search'</code><code class="p">;</code>

  <code class="kd">function</code> <code class="nx">saveNew</code><code class="p">(</code><code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// TODO</code>
  <code class="p">}</code>

  <code class="kd">function</code> <code class="nx">onAdd</code><code class="p">()</code> <code class="p">{</code>
    <code class="c1">// TODO</code>
  <code class="p">}</code>

  <code class="c1">// TODO: render</code>
<code class="p">}</code></pre>

<p>The <code>addNew</code> state is copied verbatim from v1 of <code>DataFlow</code>. The new code is the <a data-type="indexterm" data-primary="DataContext.Provider component" id="idm45779424754448"/><a data-type="indexterm" data-primary="hooks" data-secondary="useContext()" id="idm45779424753792"/><a data-type="indexterm" data-primary="useContext() hook" id="idm45779424752912"/>consumption of the <code>DataContext</code>. You can see how using the hook <code>useContext()</code> you get access to the <code>value</code> prop passed by the <code>&lt;DataContext.Provider&gt;</code>. It’s an object that has a <code>data</code> property and a function <code>updateData()</code>.</p>

<p>In v1 there <a data-type="indexterm" data-primary="counting, data.length for" id="idm45779424749104"/><a data-type="indexterm" data-primary="data.length count" id="idm45779424748352"/>was a <code>count</code> prop passed to the <code>&lt;Header&gt;</code>. Now the header can access all of the data and get the count from there (<code>data.length</code>). Now that all the pieces required for rendering are available, it’s time to <a data-type="indexterm" data-primary="Excel component in React app" data-secondary="rendering of" id="idm45779424746272"/><a data-type="indexterm" data-primary="rendering" data-secondary="of Excel app components" data-secondary-sortas="Excel app components" id="idm45779424745280"/>work on the rendering:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">Header</code><code class="p">({</code><code class="nx">onSearch</code><code class="p">})</code> <code class="p">{</code>

  <code class="c1">// ....</code>

  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"Header"</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">Logo</code> <code class="o">/&gt;</code>
        <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">FormInput</code>
            <code class="nx">placeholder</code><code class="o">=</code><code class="p">{</code><code class="nx">placeholder</code><code class="p">}</code>
            <code class="nx">id</code><code class="o">=</code><code class="s2">"search"</code>
            <code class="nx">onChange</code><code class="o">=</code><code class="p">{</code><code class="nx">onSearch</code><code class="p">}</code>
          <code class="o">/&gt;</code>
        <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">Button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="nx">onAdd</code><code class="p">}</code><code class="o">&gt;</code>
            <code class="o">&lt;</code><code class="nx">b</code><code class="o">&gt;&amp;</code><code class="err">#</code><code class="mi">65291</code><code class="o">;&lt;/</code><code class="nx">b</code><code class="o">&gt;</code> <code class="nx">Add</code> <code class="nx">whine</code>
          <code class="o">&lt;/</code><code class="nx">Button</code><code class="o">&gt;</code>
        <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
      <code class="p">{</code><code class="nx">addNew</code> <code class="o">?</code> <code class="p">(</code>
        <code class="o">&lt;</code><code class="nx">Dialog</code>
          <code class="nx">modal</code><code class="o">=</code><code class="p">{</code><code class="kc">true</code><code class="p">}</code>
          <code class="nx">header</code><code class="o">=</code><code class="s2">"Add new item"</code>
          <code class="nx">confirmLabel</code><code class="o">=</code><code class="s2">"Add"</code>
          <code class="nx">onAction</code><code class="o">=</code><code class="p">{(</code><code class="nx">action</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">saveNew</code><code class="p">(</code><code class="nx">action</code><code class="p">)}</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">Form</code> <code class="nx">ref</code><code class="o">=</code><code class="p">{</code><code class="nx">form</code><code class="p">}</code> <code class="nx">fields</code><code class="o">=</code><code class="p">{</code><code class="nx">schema</code><code class="p">}</code> <code class="o">/&gt;</code>
        <code class="o">&lt;/</code><code class="nx">Dialog</code><code class="o">&gt;</code>
      <code class="p">)</code> <code class="o">:</code> <code class="kc">null</code><code class="p">}</code>
    <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>The main difference from the previous version is that now the <code>Dialog</code> and the <code>Form</code> it contains are implemented here in the <a data-type="indexterm" data-startref="ch8_term23" id="idm45779424741872"/><a data-type="indexterm" data-startref="ch8_term24" id="idm45779424741200"/><a data-type="indexterm" data-startref="ch8_term25" id="idm45779424561504"/><a data-type="indexterm" data-startref="ch8_term26" id="idm45779424560896"/><a data-type="indexterm" data-startref="ch8_term27" id="idm45779424560224"/>header.</p>

<p>The last two things to take a look at are the <a data-type="indexterm" data-primary="onAdd() function" id="idm45779424559104"/><a data-type="indexterm" data-primary="saveNew() function" id="idm45779424558368"/>helper functions <code>onAdd()</code> and <code>saveNew()</code>. The first one merely updates the <code>addNew</code> state:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">onAdd</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">setAddNew</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The job of <code>saveNew()</code> is to gather the new record from the form and add it to <code>data</code>. Then comes the <a data-type="indexterm" data-primary="context/DataContext" data-secondary="in DataFlow component" data-secondary-sortas="DataFlow component" id="idm45779424532592"/><a data-type="indexterm" data-primary="DataFlow component" data-secondary="DataContext in" id="idm45779424548496"/><a data-type="indexterm" data-primary="DataContext.Provider component" id="idm45779424547552"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="context/DataContext in" id="idm45779424546912"/>key moment: invoking <code>updateData()</code> with the updated <code>data</code>. This <span class="keep-together">is the function</span> that comes from the <code>&lt;DataContext.Provider&gt;</code> and was defined in <code>DataFlow</code> as:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">updateData</code><code class="p">(</code><code class="nx">newData</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">newData</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
  <code class="nx">commitToStorage</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
  <code class="nx">setData</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>What happens <a data-type="indexterm" data-startref="ch8_term20" id="idm45779424500432"/><a data-type="indexterm" data-startref="ch8_term21" id="idm45779424499936"/><a data-type="indexterm" data-startref="ch8_term22" id="idm45779424499296"/>here is the parent <code>DataFlow</code> receives the new data and updates the state (with <code>setData()</code>), and this causes React to rerender. This means <code>Excel</code> and <code>Header</code> are going rerender but this time with the latest data. So the new record appears in the <code>Excel</code> table and the <a data-type="indexterm" data-primary="search box" id="idm45779424496144"/>search box in the header has an accurate count of the records.</p>

<p>Here’s <a data-type="indexterm" data-primary="Header.js" id="idm45779424495024"/>the <em>Header.js</em> file in its entirety:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">import</code> <code class="nx">Logo</code> <code class="nx">from</code> <code class="s1">'./Logo'</code><code class="o">;</code>
<code class="kd">import</code> <code class="s1">'./Header.css'</code><code class="o">;</code>
<code class="kd">import</code> <code class="p">{</code><code class="nx">useContext</code><code class="o">,</code> <code class="nx">useState</code><code class="o">,</code> <code class="nx">useRef</code><code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="o">;</code>

<code class="kd">import</code> <code class="nx">Button</code> <code class="nx">from</code> <code class="s1">'./Button'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">FormInput</code> <code class="nx">from</code> <code class="s1">'./FormInput'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Dialog</code> <code class="nx">from</code> <code class="s1">'./Dialog'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">Form</code> <code class="nx">from</code> <code class="s1">'./Form'</code><code class="o">;</code>
<code class="kd">import</code> <code class="nx">schema</code> <code class="nx">from</code> <code class="s1">'../config/schema'</code><code class="o">;</code>

<code class="kd">import</code> <code class="nx">DataContext</code> <code class="nx">from</code> <code class="s1">'../contexts/DataContext'</code><code class="o">;</code>

<code class="kd">function</code> <code class="nx">Header</code><code class="p">({</code><code class="nx">onSearch</code><code class="p">})</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">{</code><code class="nx">data</code><code class="o">,</code> <code class="nx">updateData</code><code class="p">}</code> <code class="o">=</code> <code class="nx">useContext</code><code class="p">(</code><code class="nx">DataContext</code><code class="p">);</code>
  <code class="kd">const</code> <code class="nx">count</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="o">;</code>

  <code class="kd">const</code> <code class="p">[</code><code class="nx">addNew</code><code class="o">,</code> <code class="nx">setAddNew</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>

  <code class="kd">const</code> <code class="nx">form</code> <code class="o">=</code> <code class="nx">useRef</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>

  <code class="kd">function</code> <code class="nx">saveNew</code><code class="p">(</code><code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">setAddNew</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'dismiss'</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code><code class="o">;</code>
    <code class="p">}</code>

    <code class="kd">const</code> <code class="nx">formData</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">form</code><code class="p">.</code><code class="nx">current</code><code class="p">).</code><code class="nx">forEach</code><code class="p">(</code>
      <code class="p">(</code><code class="nx">input</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="nx">formData</code><code class="p">[</code><code class="nx">input</code><code class="p">.</code><code class="nx">id</code><code class="p">]</code> <code class="o">=</code> <code class="nx">input</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code><code class="o">,</code>
    <code class="p">);</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">unshift</code><code class="p">(</code><code class="nx">formData</code><code class="p">);</code>
    <code class="nx">updateData</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="kd">function</code> <code class="nx">onAdd</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">setAddNew</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="kd">const</code> <code class="nx">placeholder</code> <code class="o">=</code> <code class="nx">count</code> <code class="o">&gt;</code> <code class="mi">1</code> <code class="o">?</code> <code class="err">`</code><code class="nx">Search</code> <code class="nx">$</code><code class="p">{</code><code class="nx">count</code><code class="p">}</code> <code class="nx">items</code><code class="err">`</code> <code class="o">:</code> <code class="s1">'Search'</code><code class="o">;</code>
  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"Header"</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">Logo</code> <code class="o">/&gt;</code>
        <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">FormInput</code>
            <code class="nx">placeholder</code><code class="o">=</code><code class="p">{</code><code class="nx">placeholder</code><code class="p">}</code>
            <code class="nx">id</code><code class="o">=</code><code class="s2">"search"</code>
            <code class="nx">onChange</code><code class="o">=</code><code class="p">{</code><code class="nx">onSearch</code><code class="p">}</code>
          <code class="o">/&gt;</code>
        <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">Button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="nx">onAdd</code><code class="p">}</code><code class="o">&gt;</code>
            <code class="o">&lt;</code><code class="nx">b</code><code class="o">&gt;&amp;</code><code class="err">#</code><code class="mi">65291</code><code class="o">;&lt;/</code><code class="nx">b</code><code class="o">&gt;</code> <code class="nx">Add</code> <code class="nx">whine</code>
          <code class="o">&lt;/</code><code class="nx">Button</code><code class="o">&gt;</code>
        <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
      <code class="p">{</code><code class="nx">addNew</code> <code class="o">?</code> <code class="p">(</code>
        <code class="o">&lt;</code><code class="nx">Dialog</code>
          <code class="nx">modal</code><code class="o">=</code><code class="p">{</code><code class="kc">true</code><code class="p">}</code>
          <code class="nx">header</code><code class="o">=</code><code class="s2">"Add new item"</code>
          <code class="nx">confirmLabel</code><code class="o">=</code><code class="s2">"Add"</code>
          <code class="nx">onAction</code><code class="o">=</code><code class="p">{(</code><code class="nx">action</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">saveNew</code><code class="p">(</code><code class="nx">action</code><code class="p">)}</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">Form</code> <code class="nx">ref</code><code class="o">=</code><code class="p">{</code><code class="nx">form</code><code class="p">}</code> <code class="nx">fields</code><code class="o">=</code><code class="p">{</code><code class="nx">schema</code><code class="p">}</code> <code class="o">/&gt;</code>
        <code class="o">&lt;/</code><code class="nx">Dialog</code><code class="o">&gt;</code>
      <code class="p">)</code> <code class="o">:</code> <code class="kc">null</code><code class="p">}</code>
    <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code>

<code class="nx">export</code> <code class="k">default</code> <code class="nx">Header</code><code class="o">;</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Context in the Data Table"><div class="sect2" id="idm45779424990720">
<h2>Context in the Data Table</h2>

<p>The last thing before v2 is fully <a data-type="indexterm" data-primary="DataContext.Provider component" id="idm45779424447120"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="context/DataContext in" id="idm45779424446352"/>operational is to update <code>Excel</code> so it doesn’t maintain its own state but uses the data from the <code>&lt;DataContext.Provider&gt;</code>. There are no rendering changes required, only the data management.</p>

<p>Since there’s no need for a <code>data</code> state in <code>Excel</code> anymore, the <code>reducer()</code> is no longer required. However, the <a data-type="indexterm" data-primary="dataMangler() function" id="ch8_term29"/><a data-type="indexterm" data-primary="reducers" data-secondary="replacement of" id="ch8_term30"/>idea of all data manipulation happening in a central place is too appealing not to adopt. So let’s just rename <code>reducer()</code> to <code>dataMangler()</code>.</p>

<p>Here is the before state:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">reducer</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'sort'</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code><code class="nx">column</code><code class="p">,</code> <code class="nx">descending</code><code class="p">}</code> <code class="o">=</code> <code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">;</code>
    <code class="c1">// ...</code>
  <code class="p">}</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>Here it is after the changes:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">dataMangler</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">action</code><code class="p">,</code> <code class="nx">payload</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'sort'</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code><code class="nx">column</code><code class="p">,</code> <code class="nx">descending</code><code class="p">}</code> <code class="o">=</code> <code class="nx">payload</code><code class="p">;</code>
    <code class="c1">// ...</code>
  <code class="p">}</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>As you can see, <code>dataMangler()</code> doesn’t need to follow the reducer API, so the <code>action</code> can now be a string and the payload can be a separate argument to the function. This is just a little less typing and also hopefully avoids any confusion: <code>dataMangler()</code> is <em>not</em> a reducer, just a convenient helper function.</p>

<p>The complete <code>dataMangler()</code> is as follows:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">dataMangler</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">action</code><code class="p">,</code> <code class="nx">payload</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'sort'</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code><code class="nx">column</code><code class="p">,</code> <code class="nx">descending</code><code class="p">}</code> <code class="o">=</code> <code class="nx">payload</code><code class="p">;</code>
    <code class="k">return</code> <code class="nx">data</code><code class="p">.</code><code class="nx">sort</code><code class="p">((</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">===</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">])</code> <code class="p">{</code>
        <code class="k">return</code> <code class="mi">0</code><code class="p">;</code>
      <code class="p">}</code>
      <code class="k">return</code> <code class="nx">descending</code>
        <code class="o">?</code> <code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">&lt;</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code>
          <code class="o">?</code> <code class="mi">1</code>
          <code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
        <code class="o">:</code> <code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">&gt;</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code>
          <code class="o">?</code> <code class="mi">1</code>
          <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
    <code class="p">});</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'save'</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code><code class="kr">int</code><code class="p">,</code> <code class="nx">edit</code><code class="p">}</code> <code class="o">=</code> <code class="nx">payload</code><code class="p">;</code>
    <code class="nx">data</code><code class="p">[</code><code class="nx">edit</code><code class="p">.</code><code class="nx">row</code><code class="p">][</code><code class="nx">edit</code><code class="p">.</code><code class="nx">column</code><code class="p">]</code> <code class="o">=</code> <code class="kr">int</code>
      <code class="o">?</code> <code class="nb">parseInt</code><code class="p">(</code><code class="nx">payload</code><code class="p">.</code><code class="nx">value</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
      <code class="o">:</code> <code class="nx">payload</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'delete'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">splice</code><code class="p">(</code><code class="nx">payload</code><code class="p">.</code><code class="nx">rowidx</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'saveForm'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">payload</code><code class="p">.</code><code class="nx">form</code><code class="p">.</code><code class="nx">current</code><code class="p">).</code><code class="nx">forEach</code><code class="p">(</code>
      <code class="p">(</code><code class="nx">input</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="nx">data</code><code class="p">[</code><code class="nx">payload</code><code class="p">.</code><code class="nx">rowidx</code><code class="p">][</code><code class="nx">input</code><code class="p">.</code><code class="nx">id</code><code class="p">]</code> <code class="o">=</code> <code class="nx">input</code><code class="p">.</code><code class="nx">value</code><code class="p">),</code>
    <code class="p">);</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="nx">data</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Note the <a data-type="indexterm" data-primary="setTimeout() function" id="idm45779423915392"/><a data-type="indexterm" data-primary="timeout hack" id="idm45779423914784"/><a data-type="indexterm" data-primary="onDataChange callback prop" id="idm45779423914144"/>missing <code>setTimeout(() =&gt; action.payload.onDataChange(data)</code> at the end of the function. There’s no need for <code>onDataChange</code> prop anymore, nor for the <code>setTimeout</code> hack.</p>

<p>When using a <a data-type="indexterm" data-primary="DataFlow component" data-secondary="rendering of" id="idm45779423633456"/><a data-type="indexterm" data-primary="rendering" data-secondary="of DataFlow component" data-secondary-sortas="DataFlow component" id="idm45779423632064"/><a data-type="indexterm" data-primary="updateData() function" id="idm45779423630848"/><a data-type="indexterm" data-primary="dispatch() function" id="idm45779423630176"/>reducer, returning <code>data</code> was enough to cause a rerendering of <code>Excel</code>. Now you need the <code>updateData()</code> from the provider, so the parent <code>DataFlow</code> can be responsible for rerendering. Additionally, there are no more calls to <code>dispatch()</code> which magically call the reducer. All the <code>dispatch()</code> callsites now have two tasks: call the <code>dataMangler()</code> and then pass its return value to <code>updateData()</code>.</p>

<p>Here it is before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">dispatch</code><code class="p">({</code><code class="nx">type</code><code class="o">:</code> <code class="s1">'sort'</code><code class="p">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="p">{</code><code class="nx">column</code><code class="p">,</code> <code class="nx">descending</code><code class="p">}});</code></pre>

<p>Here is the updated version:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">newData</code> <code class="o">=</code> <code class="nx">dataMangler</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="s1">'sort'</code><code class="p">,</code> <code class="p">{</code><code class="nx">column</code><code class="p">,</code> <code class="nx">descending</code><code class="p">});</code>
<code class="nx">updateData</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code></pre>

<p>Alternatively, a one-liner:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">updateData</code><code class="p">(</code><code class="nx">dataMangler</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="s1">'sort'</code><code class="p">,</code> <code class="p">{</code><code class="nx">column</code><code class="p">,</code> <code class="nx">descending</code><code class="p">}));</code></pre>

<p>Replace the 4 <code>dispatch()</code> callsites, and v2 of Whinepad is complete and operational. For a full code listing, consult the <a data-type="indexterm" data-startref="ch8_term28" id="idm45779423537504"/><a data-type="indexterm" data-startref="ch8_term29" id="idm45779423537008"/><a data-type="indexterm" data-startref="ch8_term30" id="idm45779423536336"/>book’s code repo.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Updating Discovery"><div class="sect1" id="idm45779423535408">
<h1>Updating Discovery</h1>

<p>At this point the <a data-type="indexterm" data-primary="Header component" data-secondary="context/DataContext in" id="idm45779423533456"/><a data-type="indexterm" data-primary="context/DataContext" data-secondary="discovery tool updating for" id="ch8_term31"/><a data-type="indexterm" data-primary="discovery tool" id="ch8_term32"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="context/DataContext in" id="ch8_term33"/><a data-type="indexterm" data-primary="React app" data-secondary="discovery tool in" id="ch8_term34"/>changes to <code>Excel</code> and <code>Header</code> have affected the discovery tool too. While not technically broken, it’s a little muddled. For example, the data table is empty and the search input doesn’t show a count. To use <code>Discovery</code> to its full potential, you need to set up the environment where <code>Excel</code> and <code>Header</code> live. Here, “environment” means a <code>&lt;DataConsumer.Provider&gt;</code> wrapper around the examples.</p>

<p>Here is <a data-type="indexterm" data-primary="Excel component in React app" data-secondary="discovery tool update for" id="idm45779423500416"/>the code before (inline example and sample data coming from the schema and passed as a prop):</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">h2</code><code class="o">&gt;</code><code class="nx">Excel</code><code class="o">&lt;/</code><code class="nx">h2</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="nx">Excel</code>
  <code class="nx">schema</code><code class="o">=</code><code class="p">{</code><code class="nx">schema</code><code class="p">}</code>
  <code class="nx">initialData</code><code class="o">=</code><code class="p">{</code><code class="nx">schema</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">samples</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">_</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kd">const</code> <code class="nx">element</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="k">for</code> <code class="p">(</code><code class="nx">let</code> <code class="nx">key</code> <code class="k">in</code> <code class="nx">schema</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">element</code><code class="p">[</code><code class="nx">key</code><code class="p">]</code> <code class="o">=</code> <code class="nx">schema</code><code class="p">[</code><code class="nx">key</code><code class="p">].</code><code class="nx">samples</code><code class="p">[</code><code class="nx">idx</code><code class="p">];</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">element</code><code class="o">;</code>
  <code class="p">})}</code>
  <code class="nx">onDataChange</code><code class="o">=</code><code class="p">{(</code><code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
  <code class="p">}}</code>
<code class="o">/&gt;</code></pre>

<p>Here it is after the transformation (into a whole new example component):</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">h2</code><code class="o">&gt;</code><code class="nx">Excel</code><code class="o">&lt;/</code><code class="nx">h2</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="nx">ExcelExample</code> <code class="o">/&gt;</code></pre>

<p>The example <a data-type="indexterm" data-primary="context providers" id="ch8_term35"/><a data-type="indexterm" data-primary="provider components" id="ch8_term36"/><a data-type="indexterm" data-primary="updateData() function" id="ch8_term37"/>component gets the sample data from the <code>schema</code> too and uses it to maintain state. A simpler <code>updateData()</code> is created and passed as part of the context in the context provider:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">ExcelExample</code><code class="p">()</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="nx">initialData</code> <code class="o">=</code> <code class="nx">schema</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">samples</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">_</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kd">const</code> <code class="nx">element</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="k">for</code> <code class="p">(</code><code class="nx">let</code> <code class="nx">key</code> <code class="k">in</code> <code class="nx">schema</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">element</code><code class="p">[</code><code class="nx">key</code><code class="p">]</code> <code class="o">=</code> <code class="nx">schema</code><code class="p">[</code><code class="nx">key</code><code class="p">].</code><code class="nx">samples</code><code class="p">[</code><code class="nx">idx</code><code class="p">];</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">element</code><code class="o">;</code>
  <code class="p">});</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">data</code><code class="o">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code>
  <code class="kd">function</code> <code class="nx">updateData</code><code class="p">(</code><code class="nx">newData</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">setData</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code> <code class="nx">value</code><code class="o">=</code><code class="p">{{</code><code class="nx">data</code><code class="o">,</code> <code class="nx">updateData</code><code class="p">}}</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">Excel</code> <code class="o">/&gt;</code>
    <code class="o">&lt;/</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>Now the <code>Excel</code> example is fully operational in the discovery tool. Without this update, when <code>Excel</code> tries to use the context, it gets the default <code>data</code> and <code>updateData()</code> as defined in <code>createContext()</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// In DataContext.js</code>
<code class="kr">const</code> <code class="nx">DataContext</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">createContext</code><code class="p">({</code>
  <code class="nx">data</code><code class="o">:</code> <code class="p">[],</code>
  <code class="nx">updateData</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{},</code>
<code class="p">});</code>


<code class="c1">// In Excel.js</code>
<code class="kr">const</code> <code class="p">{</code><code class="nx">data</code><code class="p">,</code> <code class="nx">updateData</code><code class="p">}</code> <code class="o">=</code> <code class="nx">useContext</code><code class="p">(</code><code class="nx">DataContext</code><code class="p">);</code>

<code class="c1">// `data` is now an empty array and `updateData` is a no-op function</code></pre>

<p>Updating <a data-type="indexterm" data-primary="Header component" data-secondary="context/DataContext in" id="idm45779423192992"/><a data-type="indexterm" data-primary="Header component" data-secondary="discovery tool update for" id="idm45779423174192"/><a data-type="indexterm" data-primary="counting, data.length for" id="idm45779423173280"/><a data-type="indexterm" data-primary="data.length count" id="idm45779423172592"/>the <code>&lt;Header&gt;</code> example in <code>&lt;Discovery&gt;</code> can be simpler since you know that <code>Header</code> only worries about the <code>data.length</code> count.</p>

<p>Here it is before:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">h2</code><code class="o">&gt;</code><code class="nx">Header</code><code class="o">&lt;/</code><code class="nx">h2</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="nx">Header</code>
  <code class="nx">onSearch</code><code class="o">=</code><code class="p">{(</code><code class="nx">e</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">e</code><code class="p">)}</code>
  <code class="nx">onAdd</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="nx">alert</code><code class="p">(</code><code class="s1">'add'</code><code class="p">)}</code>
  <code class="nx">count</code><code class="o">=</code><code class="p">{</code><code class="mi">3</code><code class="p">}</code>
<code class="o">/&gt;</code></pre>

<p>And here it is for v2:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">h2</code><code class="o">&gt;</code><code class="nx">Header</code><code class="o">&lt;/</code><code class="nx">h2</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code> <code class="nx">value</code><code class="o">=</code><code class="p">{{</code><code class="nx">data</code><code class="o">:</code> <code class="p">[</code><code class="mi">1</code><code class="o">,</code> <code class="mi">2</code><code class="o">,</code> <code class="mi">3</code><code class="p">]}}</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">Header</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{(</code><code class="nx">e</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">e</code><code class="p">)}</code> <code class="o">/&gt;</code>
<code class="o">&lt;/</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code><code class="o">&gt;</code></pre>

<p>Wrapping the <code>Header</code> in a provider now causes the <code>value</code> to be used in the context and <a data-type="indexterm" data-primary="createContext() function" id="idm45779422999632"/>not the defaults from <code>createContext()</code>. As a <a data-type="indexterm" data-primary="Add button" id="idm45779422998384"/>result, if you test the “Add” button in the header, you’ll get an error because <code>updateData()</code> doesn’t exist. To fix the error and make the button testable, a no-op <code>updateData()</code> is sufficient:</p>

<pre data-type="programlisting" data-code-language="actionscript" class="pagebreak-before"><code class="o">&lt;</code><code class="nx">h2</code><code class="o">&gt;</code><code class="nx">Header</code><code class="o">&lt;/</code><code class="nx">h2</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code> <code class="nx">value</code><code class="o">=</code><code class="p">{{</code><code class="nx">data</code><code class="o">:</code> <code class="p">[</code><code class="mi">1</code><code class="o">,</code> <code class="mi">2</code><code class="o">,</code> <code class="mi">3</code><code class="p">]</code><code class="o">,</code> <code class="nx">updateData</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{}}}</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">Header</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{(</code><code class="nx">e</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">e</code><code class="p">)}</code> <code class="o">/&gt;</code>
<code class="o">&lt;/</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code><code class="o">&gt;</code></pre>

<p>Now you have a working v2 of Whinepad as well as a working discovery area for playing with the components <a data-type="indexterm" data-startref="ch8_term31" id="idm45779422994768"/><a data-type="indexterm" data-startref="ch8_term32" id="idm45779422913968"/><a data-type="indexterm" data-startref="ch8_term33" id="idm45779422913360"/><a data-type="indexterm" data-startref="ch8_term34" id="idm45779422912688"/><a data-type="indexterm" data-startref="ch8_term35" id="idm45779422912016"/><a data-type="indexterm" data-startref="ch8_term36" id="idm45779422911344"/><a data-type="indexterm" data-startref="ch8_term37" id="idm45779422910672"/>individually.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Routing"><div class="sect1" id="idm45779423534784">
<h1>Routing</h1>

<p>It’s time to wrap up the chapter and the book by <a data-type="indexterm" data-primary="bookmarkable URLs" id="ch8_term38"/><a data-type="indexterm" data-primary="URLs, bookmarkable" id="ch8_term39"/><a data-type="indexterm" data-primary="weblinks, routing and" id="ch8_term40"/><a data-type="indexterm" data-primary="context/DataContext" data-secondary="routing with" id="ch8_term41"/><a data-type="indexterm" data-primary="React app" data-secondary="routing in" id="ch8_term42"/><a data-type="indexterm" data-primary="routing" id="ch8_term43"/>implementing one more feature—bookmarkable URLs—and along the way learn about multiple contexts and the <span class="keep-together"><code>useCallback()</code></span> hook.</p>

<p>Single-page <a data-type="indexterm" data-primary="single-page applications (SPAs)" id="idm45779422900640"/><a data-type="indexterm" data-primary="SPAs (single-page applications)" id="idm45779422900032"/>applications (SPAs) such as Whinepad do not refresh the page, so the URLs to different states of the app don’t need to change. But it’s nice when they do, as this allows users to share links and have the app already in a certain state. For example, it’s friendlier to send your coworker a URL such as <em>https://whinepad.com/filter/merlot</em> rather than instructions like “Go to <em>https://whinepad.com/</em> and type <em>merlot</em> in the search box at the top.”</p>

<p>The ability of an app to recreate a state from a URL is often called <em>routing</em> and there are a number of third-party libraries that can offer you routing in one way or another. But let’s take a do-it-yourself approach one more time and come up with a custom solution.</p>

<p>Let’s offer 4 types of bookmarkable URLs:</p>

<ul>
<li>
<p><em>/filter/merlot</em> to bookmark searches for “merlot”</p>
</li>
<li>
<p><em>/add</em> to have an open “Add” dialog for adding records</p>
</li>
<li>
<p><em>/info/1</em> to show the info (non-editable) dialog for record with ID 1</p>
</li>
<li>
<p><em>/edit/1</em> for an editable version</p>
</li>
</ul>

<p>The first URL is to be handled in <code>DataFlow</code> since this is where the filtering is passed around; the second in <code>Header</code>; and the last two in <code>Excel</code>. Since various components need to know the URL, a new context seems appropriate.</p>








<section data-type="sect2" data-pdf-bookmark="Route Context"><div class="sect2" id="idm45779422888960">
<h2>Route Context</h2>

<p>The new <a data-type="indexterm" data-primary="RouteContext" id="ch8_term44"/>context lives in <em>contexts/RouteContext.js</em>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">RouteContext</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">createContext</code><code class="p">({</code>
  <code class="nx">route</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">add</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">edit</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
    <code class="nx">info</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
    <code class="nx">filter</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
  <code class="p">},</code>
  <code class="nx">updateRoute</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{},</code>
<code class="p">});</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">RouteContext</code><code class="p">;</code></pre>

<p>Again you see a familiar pattern—the <a data-type="indexterm" data-primary="updateRoute() function" id="idm45779422883616"/>context consists of a piece of data (<code>route</code>) and a way to update it (<code>updateRoute</code>).</p>

<p>As before, the <a data-type="indexterm" data-primary="context/DataContext" data-secondary="in DataFlow component" data-secondary-sortas="DataFlow component" id="ch8_term45"/><a data-type="indexterm" data-primary="DataFlow component" data-secondary="DataContext in" id="ch8_term46"/><a data-type="indexterm" data-primary="DataFlow component" data-secondary="routing in" id="ch8_term47"/>job of replacing the context defaults with working values falls to the parent component <code>DataFlow</code>. It requires the new context and attempts to <a data-type="indexterm" data-primary="window.location.pathname" id="idm45779422802640"/>read the routing information from the URL (<code>window.location.pathname</code>):</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// ...</code>
<code class="kr">import</code> <code class="nx">RouteContext</code> <code class="nx">from</code> <code class="s1">'../contexts/RouteContext'</code><code class="p">;</code>
<code class="c1">//...</code>

<code class="c1">// read state from the URL "route"</code>
<code class="kr">const</code> <code class="nx">route</code> <code class="o">=</code> <code class="p">{};</code>
<code class="kd">function</code> <code class="nx">resetRoute</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">route</code><code class="p">.</code><code class="nx">add</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
  <code class="nx">route</code><code class="p">.</code><code class="nx">edit</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="nx">route</code><code class="p">.</code><code class="nx">info</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="nx">route</code><code class="p">.</code><code class="nx">filter</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">resetRoute</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">path</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">pathname</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\//</code><code class="p">,</code> <code class="s1">''</code><code class="p">);</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">path</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">action</code><code class="p">,</code> <code class="nx">id</code><code class="p">]</code> <code class="o">=</code> <code class="nx">path</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'add'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">route</code><code class="p">.</code><code class="nx">add</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
  <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'edit'</code> <code class="o">&amp;&amp;</code> <code class="nx">id</code> <code class="o">!==</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">route</code><code class="p">.</code><code class="nx">edit</code> <code class="o">=</code> <code class="nb">parseInt</code><code class="p">(</code><code class="nx">id</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'info'</code> <code class="o">&amp;&amp;</code> <code class="nx">id</code> <code class="o">!==</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">route</code><code class="p">.</code><code class="nx">info</code> <code class="o">=</code> <code class="nb">parseInt</code><code class="p">(</code><code class="nx">id</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'filter'</code> <code class="o">&amp;&amp;</code> <code class="nx">id</code> <code class="o">!==</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">route</code><code class="p">.</code><code class="nx">filter</code> <code class="o">=</code> <code class="nx">id</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// ...</code>

<code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>Now, if the app is loaded with the URL <em>/filter/merlot</em>, then <code>route</code> becomes:</p>

<pre data-type="programlisting" data-code-language="javascript" class="pagebreak-before"><code class="p">{</code>
  <code class="nx">add</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
  <code class="nx">edit</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
  <code class="nx">info</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
  <code class="nx">filter</code><code class="o">:</code> <code class="s1">'merlot'</code><code class="p">,</code>
<code class="p">};</code></pre>

<p>If the app is loaded with the URL <em>/edit/1</em>, <code>route</code> becomes:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="nx">add</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
  <code class="nx">edit</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
  <code class="nx">info</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
  <code class="nx">filter</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
<code class="p">};</code></pre>

<p>It’s also up to <code>DataFlow</code> to define a <a data-type="indexterm" data-primary="updateRoute() function" id="idm45779422502784"/>function that updates the route:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">()</code> <code class="p">{</code>

  <code class="c1">// ...</code>

  <code class="kd">function</code> <code class="nx">updateRoute</code><code class="p">(</code><code class="nx">action</code> <code class="o">=</code> <code class="s1">''</code><code class="p">,</code> <code class="nx">id</code> <code class="o">=</code> <code class="s1">''</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">resetRoute</code><code class="p">();</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">route</code><code class="p">[</code><code class="nx">action</code><code class="p">]</code> <code class="o">=</code> <code class="nx">action</code> <code class="o">===</code> <code class="s1">'add'</code> <code class="o">?</code> <code class="kc">true</code> <code class="o">:</code> <code class="nx">id</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">id</code> <code class="o">=</code> <code class="nx">id</code> <code class="o">!==</code> <code class="s1">''</code> <code class="o">?</code> <code class="s1">'/'</code> <code class="o">+</code> <code class="nx">id</code> <code class="o">:</code> <code class="s1">''</code><code class="p">;</code>
    <code class="nb">window</code><code class="p">.</code><code class="nx">history</code><code class="p">.</code><code class="nx">replaceState</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="sb">`/</code><code class="si">${</code><code class="nx">action</code><code class="si">}${</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>In the <a href="https://developer.mozilla.org/en-US/docs/Web/API/History"><code>History</code> API</a>, using <code>replaceState()</code> is an <a data-type="indexterm" data-primary="History API" id="idm45779422360048"/><a data-type="indexterm" data-primary="pushState() function" id="idm45779422359344"/><a data-type="indexterm" data-primary="replaceState() function" id="idm45779422358640"/>alternative to <code>pushState()</code> that doesn’t create history entries (for the use with the browser’s Back button). This is preferable in this case as the URL is going to be updated frequently and has the potential to pollute the history stack. For example, having six history entries (<span class="keep-together">/filter/m</span>, /filter/me, /filter/mer, etc.) as the user types “merlot” renders the Back button <a data-type="indexterm" data-startref="ch8_term44" id="idm45779422356352"/>unusable.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Using the Filter URL"><div class="sect2" id="idm45779422888336">
<h2>Using the Filter URL</h2>

<p>The next step is to <a data-type="indexterm" data-primary="RouteContext.Provider" id="idm45779422353472"/><a data-type="indexterm" data-primary="context providers" id="ch8_term48"/><a data-type="indexterm" data-primary="provider components" id="ch8_term49"/><a data-type="indexterm" data-primary="DataFlow component" data-secondary="filtering in" id="ch8_term50"/><a data-type="indexterm" data-primary="filtering" data-secondary="with URL routing" data-secondary-sortas="URL routing" id="ch8_term51"/>wrap any consumers of the new context in a provider component (<code>&lt;RouteContext.Provider&gt;</code> in this case). But for the purposes of the filtering, it’s not yet necessary, because all filtering happens in <code>DataFlow</code>.</p>

<p>To use the new routing functionality, only <a data-type="indexterm" data-primary="onSearch() function" id="idm45779422346768"/><a data-type="indexterm" data-primary="search box" id="idm45779422346064"/>two changes are necessary. One is in the <code>onSearch</code> callback, which is invoked whenever the user types in the search box.</p>

<p class="pagebreak-before">Before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">onSearch</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">s</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
  <code class="nx">setFilter</code><code class="p">(</code><code class="nx">s</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>After:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">onSearch</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">s</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
  <code class="nx">setFilter</code><code class="p">(</code><code class="nx">s</code><code class="p">);</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">s</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">updateRoute</code><code class="p">(</code><code class="s1">'filter'</code><code class="p">,</code> <code class="nx">s</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="nx">updateRoute</code><code class="p">();</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>Now when the user types “m” in the search box, the URL changes to <em>/filter/m</em>. When the user deletes the search string, the URL goes back to <em>/</em>.</p>

<p>Updating the URL is half the job. The other <a data-type="indexterm" data-primary="inputs" data-secondary="prefilled text for" id="idm45779422230816"/><a data-type="indexterm" data-primary="prefilled text for inputs" id="idm45779422229968"/><a data-type="indexterm" data-primary="search box" id="idm45779422229312"/><a data-type="indexterm" data-primary="filter prop" id="idm45779422228640"/><a data-type="indexterm" data-primary="search strings and data filtering" id="idm45779422227968"/><a data-type="indexterm" data-primary="filtering" data-secondary="search strings and" id="idm45779422227280"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="routing in" id="idm45779422226528"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="filtering content of" id="ch8_term52"/>half is prefilling the search box <em>and</em> doing the searching when the app is loaded. Doing the searching means making sure the correct <code>filter</code> prop is passed to <code>Excel</code>. Luckily, this is trivial.</p>

<p>Before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">()</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">filter</code><code class="p">,</code> <code class="nx">setFilter</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>After:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">()</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">filter</code><code class="p">,</code> <code class="nx">setFilter</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">filter</code><code class="p">);</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>This is sufficient. Now, <a data-type="indexterm" data-primary="DataFlow component" data-secondary="rendering of" id="idm45779422163392"/><a data-type="indexterm" data-primary="rendering" data-secondary="of DataFlow component" data-secondary-sortas="DataFlow component" id="idm45779422162544"/>whenever <code>DataFlow</code> renders, it’s passing <code>&lt;Excel filter=​{fil⁠ter}&gt;</code> where the filter value comes from the <code>route</code>. And as a result, <code>Excel</code> shows only the matching rows. If there’s no filter in the <code>route</code> object then the <code>filter</code> prop is <code>null</code> and <code>Excel</code> shows everything.</p>

<p>To also prefill the <a data-type="indexterm" data-primary="Header component" data-secondary="in DataFlow" data-secondary-sortas="DataFlow" id="idm45779422157360"/><a data-type="indexterm" data-primary="Header component" data-secondary="context/DataContext in" id="ch8_term53"/>search box (which is found in the <code>Header</code>), you need to wrap the header in a route context provider. This happens in the <code>DataFlow</code> rendering.</p>

<p>Before:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// ...</code>
  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"DataFlow"</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code> <code class="nx">value</code><code class="o">=</code><code class="p">{{</code><code class="nx">data</code><code class="o">,</code> <code class="nx">updateData</code><code class="p">}}</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">Header</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">onSearch</code><code class="p">}</code> <code class="o">/&gt;</code>
        <code class="o">&lt;</code><code class="nx">Body</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">Excel</code> <code class="nx">filter</code><code class="o">=</code><code class="p">{</code><code class="nx">filter</code><code class="p">}</code> <code class="o">/&gt;</code>
        <code class="o">&lt;/</code><code class="nx">Body</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>After:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">DataFlow</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// ...</code>
  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"DataFlow"</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code> <code class="nx">value</code><code class="o">=</code><code class="p">{{</code><code class="nx">data</code><code class="o">,</code> <code class="nx">updateData</code><code class="p">}}</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">RouteContext</code><code class="p">.</code><code class="nx">Provider</code> <code class="nx">value</code><code class="o">=</code><code class="p">{{</code><code class="nx">route</code><code class="o">,</code> <code class="nx">updateRoute</code><code class="p">}}</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">Header</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">onSearch</code><code class="p">}</code> <code class="o">/&gt;</code>
          <code class="o">&lt;</code><code class="nx">Body</code><code class="o">&gt;</code>
            <code class="o">&lt;</code><code class="nx">Excel</code> <code class="nx">filter</code><code class="o">=</code><code class="p">{</code><code class="nx">filter</code><code class="p">}</code> <code class="o">/&gt;</code>
          <code class="o">&lt;/</code><code class="nx">Body</code><code class="o">&gt;</code>
        <code class="o">&lt;/</code><code class="nx">RouteContext</code><code class="p">.</code><code class="nx">Provider</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">DataContext</code><code class="p">.</code><code class="nx">Provider</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>As you can see, it’s OK to <a data-type="indexterm" data-primary="components" data-secondary="nested" id="idm45779422031040"/><a data-type="indexterm" data-primary="nested components" id="idm45779421921360"/><a data-type="indexterm" data-primary="wrappers" id="idm45779421920752"/>have as many context provider wrappers as you need. They can be nested as you see above, or they can wrap different components, only where they are <a data-type="indexterm" data-startref="ch8_term45" id="idm45779421919824"/><a data-type="indexterm" data-startref="ch8_term46" id="idm45779421919152"/><a data-type="indexterm" data-startref="ch8_term47" id="idm45779421918480"/><a data-type="indexterm" data-startref="ch8_term48" id="idm45779421917808"/><a data-type="indexterm" data-startref="ch8_term49" id="idm45779421917136"/><a data-type="indexterm" data-startref="ch8_term50" id="idm45779421916464"/><a data-type="indexterm" data-startref="ch8_term51" id="idm45779421915792"/><a data-type="indexterm" data-startref="ch8_term52" id="idm45779421915120"/>needed.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Consuming the Route Context in the Header"><div class="sect2" id="idm45779422354736">
<h2>Consuming the Route Context in the Header</h2>

<p>The <code>Header</code> component <a data-type="indexterm" data-primary="Header component" data-secondary="routing in" id="ch8_term54"/><a data-type="indexterm" data-primary="RouteContext" id="ch8_term56"/>can gain access to the route via the <code>RouteContext</code>.</p>

<p>Before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// ...</code>
<code class="kr">import</code> <code class="nx">DataContext</code> <code class="nx">from</code> <code class="s1">'../contexts/DataContext'</code><code class="p">;</code>

<code class="kd">function</code> <code class="nx">Header</code><code class="p">({</code><code class="nx">onSearch</code><code class="p">})</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code><code class="nx">data</code><code class="p">,</code> <code class="nx">updateData</code><code class="p">}</code> <code class="o">=</code> <code class="nx">useContext</code><code class="p">(</code><code class="nx">DataContext</code><code class="p">);</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">addNew</code><code class="p">,</code> <code class="nx">setAddNew</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
  <code class="c1">// ...</code></pre>

<p>And after:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// ...</code>
<code class="kr">import</code> <code class="nx">DataContext</code> <code class="nx">from</code> <code class="s1">'../contexts/DataContext'</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">RouteContext</code> <code class="nx">from</code> <code class="s1">'../contexts/RouteContext'</code><code class="p">;</code>

<code class="kd">function</code> <code class="nx">Header</code><code class="p">({</code><code class="nx">onSearch</code><code class="p">})</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code><code class="nx">data</code><code class="p">,</code> <code class="nx">updateData</code><code class="p">}</code> <code class="o">=</code> <code class="nx">useContext</code><code class="p">(</code><code class="nx">DataContext</code><code class="p">);</code>
  <code class="kr">const</code> <code class="p">{</code><code class="nx">route</code><code class="p">,</code> <code class="nx">updateRoute</code><code class="p">}</code> <code class="o">=</code> <code class="nx">useContext</code><code class="p">(</code><code class="nx">RouteContext</code><code class="p">);</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">addNew</code><code class="p">,</code> <code class="nx">setAddNew</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">add</code><code class="p">);</code></pre>

<p>Note how <a data-type="indexterm" data-primary="route.add" id="idm45779421838880"/><a data-type="indexterm" data-primary="addNEW state" id="ch8_term55"/>passing <code>route.add</code> as a default to the <code>addNew</code> state makes the <em>/add</em> URL work automatically. Setting <code>addNew</code> to <code>true</code> makes the rendering part of the component show a <code>Dialog</code>.</p>

<p>Making <a data-type="indexterm" data-primary="inputs" data-secondary="prefilled text for" id="idm45779421752464"/><a data-type="indexterm" data-primary="prefilled text for inputs" id="idm45779421751456"/><a data-type="indexterm" data-primary="search box" id="idm45779421750720"/>sure the search box has a prefilled value coming from the route is also a <span class="keep-together">one-liner</span>.</p>

<p>Before:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">FormInput</code>
  <code class="nx">placeholder</code><code class="o">=</code><code class="p">{</code><code class="nx">placeholder</code><code class="p">}</code>
  <code class="nx">id</code><code class="o">=</code><code class="s2">"search"</code>
  <code class="nx">onChange</code><code class="o">=</code><code class="p">{</code><code class="nx">onSearch</code><code class="p">}</code>
<code class="o">/&gt;</code></pre>

<p>After:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">FormInput</code>
  <code class="nx">placeholder</code><code class="o">=</code><code class="p">{</code><code class="nx">placeholder</code><code class="p">}</code>
  <code class="nx">id</code><code class="o">=</code><code class="s2">"search"</code>
  <code class="nx">onChange</code><code class="o">=</code><code class="p">{</code><code class="nx">onSearch</code><code class="p">}</code>
  <code class="nx">defaultValue</code><code class="o">=</code><code class="p">{</code><code class="nx">route</code><code class="p">.</code><code class="nx">filter</code><code class="p">}</code>
<code class="o">/&gt;</code></pre>

<p>The other thing the header needs to do is <a data-type="indexterm" data-primary="updateRoute() function" id="ch8_term57"/>update the routing context whenever a user makes an appropriate action. When the <a data-type="indexterm" data-primary="Add button" id="idm45779421689488"/>user clicks the “Add” button, the URL should change to <em>/add</em>. This is done by calling the <code>updateRoute()</code> from the context.</p>

<p>Before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">onAdd</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">setAddNew</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>After:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">onAdd</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">setAddNew</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>
  <code class="nx">updateRoute</code><code class="p">(</code><code class="s1">'add'</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>And when the user dismisses the dialog (or submits the form and the dialog disappears), the <em>/add</em> should be removed from <a data-type="indexterm" data-startref="ch8_term53" id="idm45779421613680"/>the URL.</p>

<p>Before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">saveNew</code><code class="p">(</code><code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">setAddNew</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>After:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">saveNew</code><code class="p">(</code><code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">setAddNew</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
  <code class="nx">updateRoute</code><code class="p">();</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Consuming the Route Context in the Data Table"><div class="sect2" id="idm45779421913664">
<h2>Consuming the Route Context in the Data Table</h2>

<p>Using the <a data-type="indexterm" data-startref="ch8_term54" id="idm45779421539968"/><a data-type="indexterm" data-startref="ch8_term55" id="idm45779421539264"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="context/DataContext in" id="idm45779421538592"/><a data-type="indexterm" data-primary="Excel component in React app" data-secondary="routing in" id="idm45779421537680"/>routing context in <code>Excel</code> looks familiar:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// ...</code>
<code class="kr">import</code> <code class="nx">RouteContext</code> <code class="nx">from</code> <code class="s1">'../contexts/RouteContext'</code><code class="p">;</code>

<code class="kd">function</code> <code class="nx">Excel</code><code class="p">({</code><code class="nx">filter</code><code class="p">})</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code><code class="nx">route</code><code class="p">,</code> <code class="nx">updateRoute</code><code class="p">}</code> <code class="o">=</code> <code class="nx">useContext</code><code class="p">(</code><code class="nx">RouteContext</code><code class="p">);</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>A lot in this component <a data-type="indexterm" data-primary="Excel component in React app" data-secondary="handleAction() function in" id="ch8_term58"/><a data-type="indexterm" data-primary="handleAction() function" id="ch8_term59"/><a data-type="indexterm" data-primary="Dialog component" data-secondary="handleAction() and" id="idm45779421493456"/>happens in the <code>handleAction()</code> helper (see <a data-type="xref" href="ch07.xhtml#ch7">Chapter 7</a>). It’s responsible for opening and closing dialogs as well as for the content of the dialogs. This helper can be used for the purposes of routing as long as it’s invoked with the correct arguments.</p>

<p>With the <a data-type="indexterm" data-primary="useEffect() hook" id="idm45779421490496"/><a data-type="indexterm" data-primary="hooks" data-secondary="useEffect()" id="idm45779421489760"/>help of <code>useEffect()</code>, this helper can be called when the data table renders and the result is opening a dialog whenever the URL is <em>/edit/[ID]</em> or <em>/info/[ID]</em>. The following code shows how to accomplish this:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">edit</code> <code class="o">!==</code> <code class="kc">null</code> <code class="o">&amp;&amp;</code> <code class="nx">route</code><code class="p">.</code><code class="nx">edit</code> <code class="o">&lt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">handleAction</code><code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">edit</code><code class="p">,</code> <code class="s1">'edit'</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">info</code> <code class="o">!==</code> <code class="kc">null</code> <code class="o">&amp;&amp;</code> <code class="nx">route</code><code class="p">.</code><code class="nx">info</code> <code class="o">&lt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">handleAction</code><code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">info</code><code class="p">,</code> <code class="s1">'info'</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">},</code> <code class="p">[</code><code class="nx">route</code><code class="p">,</code> <code class="nx">handleAction</code><code class="p">,</code> <code class="nx">data</code><code class="p">]);</code></pre>

<p>Here <code>route</code>, <code>handleAction</code>, and <code>data</code> are the effect’s dependencies, so it’s not invoked too often. A quick <a data-type="indexterm" data-primary="counting, data.length for" id="idm45779421351328"/><a data-type="indexterm" data-primary="data.length count" id="idm45779421350656"/>check for <code>data.length</code> prevents opening the dialog with IDs that are out of range (e.g., you cannot edit ID 5 when only 3 records exist). Then <code>handleAction()</code> is invoked, for example <code>handleAction(2, 'info')</code> when the URL is <span class="keep-together"><em>/info/2</em></span>.</p>

<p>So <code>handleAction()</code> is responsible for reading the routing info and creating the correct dialog. But it’s also responsible for updating the URL on user actions. This part is simple.</p>

<p>Closing the dialog before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">setDialog</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code></pre>

<p>And after:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">setDialog</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
<code class="nx">updateRoute</code><code class="p">();</code> <code class="c1">// clean up the URL</code></pre>

<p>Opening the dialog before:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">const</code> <code class="nx">isEdit</code> <code class="o">=</code> <code class="nx">type</code> <code class="o">===</code> <code class="s1">'edit'</code><code class="o">;</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'info'</code> <code class="o">||</code> <code class="nx">isEdit</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="nx">formPrefill</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">rowidx</code><code class="p">];</code>
  <code class="nx">setDialog</code><code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">Dialog</code> <code class="p">...</code>
<code class="c1">// ...</code></pre>

<p>And after:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">const</code> <code class="nx">isEdit</code> <code class="o">=</code> <code class="nx">type</code> <code class="o">===</code> <code class="s1">'edit'</code><code class="o">;</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'info'</code> <code class="o">||</code> <code class="nx">isEdit</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="nx">formPrefill</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">rowidx</code><code class="p">];</code>
  <code class="nx">updateRoute</code><code class="p">(</code><code class="nx">type</code><code class="o">,</code> <code class="nx">rowidx</code><code class="p">);</code> <code class="c1">// makes the URL e.g., /edit/3</code>
  <code class="nx">setDialog</code><code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">Dialog</code> <code class="p">...</code>
<code class="c1">// ...</code></pre>

<p>With that, the functionality is complete; there’s just <a data-type="indexterm" data-startref="ch8_term38" id="idm45779421264960"/><a data-type="indexterm" data-startref="ch8_term39" id="idm45779421168960"/><a data-type="indexterm" data-startref="ch8_term40" id="idm45779421168352"/><a data-type="indexterm" data-startref="ch8_term56" id="idm45779421167744"/><a data-type="indexterm" data-startref="ch8_term57" id="idm45779421167136"/>one more step.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="useCallback()"><div class="sect2" id="idm45779421540560">
<h2>useCallback()</h2>

<p>When <a data-type="indexterm" data-primary="useEffect() hook" id="idm45779421164736"/><a data-type="indexterm" data-primary="hooks" data-secondary="useEffect()" id="idm45779421164000"/><a data-type="indexterm" data-primary="dependencies" data-secondary="handleAction() and" id="ch8_term62"/>setting up <code>useEffect</code>, <code>handleAction()</code> was passed as a dependency:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">edit</code> <code class="o">!==</code> <code class="kc">null</code> <code class="o">&amp;&amp;</code> <code class="nx">route</code><code class="p">.</code><code class="nx">edit</code> <code class="o">&lt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">handleAction</code><code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">edit</code><code class="p">,</code> <code class="s1">'edit'</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">info</code> <code class="o">!==</code> <code class="kc">null</code> <code class="o">&amp;&amp;</code> <code class="nx">route</code><code class="p">.</code><code class="nx">info</code> <code class="o">&lt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">handleAction</code><code class="p">(</code><code class="nx">route</code><code class="p">.</code><code class="nx">info</code><code class="p">,</code> <code class="s1">'info'</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">},</code> <code class="p">[</code><code class="nx">route</code><code class="p">,</code> <code class="nx">handleAction</code><code class="p">,</code> <code class="nx">data</code><code class="p">]);</code></pre>

<p>But since <code>handleAction()</code> is an <a data-type="indexterm" data-primary="Excel component in React app" data-secondary="rendering of" id="idm45779421156176"/><a data-type="indexterm" data-primary="inline functions" id="idm45779421055376"/><a data-type="indexterm" data-primary="optimization of performance" id="idm45779421054704"/><a data-type="indexterm" data-primary="React app" data-secondary="efficiency with" id="idm45779421054016"/><a data-type="indexterm" data-primary="rendering" data-secondary="of Excel app components" data-secondary-sortas="Excel app components" id="idm45779421053072"/><a data-type="indexterm" data-primary="rendering" data-secondary="React's efficiency with" id="idm45779421051856"/>inline function inside <code>Excel()</code>, this means every time <code>Excel()</code> is invoked to rerender, a new <code>handleAction()</code> is created. And <code>useEffect()</code> sees the updated dependency. This is not efficient. There’s no point in having a function dependency that changes every time even though the function does the same thing.</p>

<p>React <a data-type="indexterm" data-primary="hooks" data-secondary="useCallback()" id="ch8_term60"/><a data-type="indexterm" data-primary="useCallback() hook" id="ch8_term61"/>provides a <code>useCallback()</code> hook to help with just that. It <em>memoizes</em> a callback function with its dependencies. So if a new <code>handleAction()</code> is created on a rerender of <code>Excel</code>, but its dependencies have not changed, then there’s no need for <code>use​Ef⁠fect()</code> to see a new dependency. The old memoized <code>handleAction</code> should do the trick.</p>

<p>Wrapping the <code>handleAction</code> with a <code>useCallback()</code> should look somewhat familiar to <code>useEffect()</code> where the pattern is: first argument is a function, the second is an array of dependencies.</p>

<p>Before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">handleAction</code><code class="p">(</code><code class="nx">rowidx</code><code class="p">,</code> <code class="nx">type</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>After:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">handleAction</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="p">(</code>
  <code class="p">(</code><code class="nx">rowidx</code><code class="p">,</code> <code class="nx">type</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// ...</code>
  <code class="p">},</code>
  <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">updateData</code><code class="p">,</code> <code class="nx">updateRoute</code><code class="p">],</code>
<code class="p">);</code></pre>

<p>The <a data-type="indexterm" data-primary="updateData() function" id="idm45779420985776"/><a data-type="indexterm" data-primary="updateRoute() function" id="idm45779420985280"/>dependencies <code>data</code>, <code>updateData</code>, and <code>updateRoute</code> are the only external pieces of info that <code>handleAction</code> requires to work properly. So if these do not change between rerenders, an older memoized <code>handleAction</code> is sufficient. Here’s the <a data-type="indexterm" data-startref="ch8_term62" id="idm45779420982208"/>complete and final version of <code>handleAction()</code> after all the routing changes:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">const</code> <code class="nx">handleAction</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="p">(</code>
  <code class="p">(</code><code class="nx">rowidx</code><code class="o">,</code> <code class="nx">type</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'delete'</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">setDialog</code><code class="p">(</code>
        <code class="o">&lt;</code><code class="nx">Dialog</code>
          <code class="nx">modal</code>
          <code class="nx">header</code><code class="o">=</code><code class="s2">"Confirm deletion"</code>
          <code class="nx">confirmLabel</code><code class="o">=</code><code class="s2">"Delete"</code>
          <code class="nx">onAction</code><code class="o">=</code><code class="p">{(</code><code class="nx">action</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">setDialog</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">action</code> <code class="o">===</code> <code class="s1">'confirm'</code><code class="p">)</code> <code class="p">{</code>
              <code class="nx">updateData</code><code class="p">(</code>
                <code class="nx">dataMangler</code><code class="p">(</code><code class="nx">data</code><code class="o">,</code> <code class="s1">'delete'</code><code class="o">,</code> <code class="p">{</code>
                  <code class="nx">rowidx</code><code class="o">,</code>
                  <code class="nx">updateData</code><code class="o">,</code>
                <code class="p">})</code><code class="o">,</code>
              <code class="p">);</code>
            <code class="p">}</code>
          <code class="p">}}</code><code class="o">&gt;</code>
          <code class="p">{</code><code class="err">`</code><code class="nx">Are</code> <code class="nx">you</code> <code class="nx">sure</code> <code class="nx">you</code> <code class="nx">want</code> <code class="nx">to</code> <code class="nx">delete</code> <code class="s2">"${data[rowidx].name}"</code><code class="o">?</code><code class="err">`</code><code class="p">}</code>
        <code class="o">&lt;/</code><code class="nx">Dialog</code><code class="o">&gt;,</code>
      <code class="p">);</code>
    <code class="p">}</code>
    <code class="kd">const</code> <code class="nx">isEdit</code> <code class="o">=</code> <code class="nx">type</code> <code class="o">===</code> <code class="s1">'edit'</code><code class="o">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'info'</code> <code class="o">||</code> <code class="nx">isEdit</code><code class="p">)</code> <code class="p">{</code>
      <code class="kd">const</code> <code class="nx">formPrefill</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">rowidx</code><code class="p">];</code>
      <code class="nx">updateRoute</code><code class="p">(</code><code class="nx">type</code><code class="o">,</code> <code class="nx">rowidx</code><code class="p">);</code>
      <code class="nx">setDialog</code><code class="p">(</code>
        <code class="o">&lt;</code><code class="nx">Dialog</code>
          <code class="nx">modal</code>
          <code class="nx">extendedDismiss</code><code class="o">=</code><code class="p">{</code><code class="o">!</code><code class="nx">isEdit</code><code class="p">}</code>
          <code class="nx">header</code><code class="o">=</code><code class="p">{</code><code class="nx">isEdit</code> <code class="o">?</code> <code class="s1">'Edit item'</code> <code class="o">:</code> <code class="s1">'Item details'</code><code class="p">}</code>
          <code class="nx">confirmLabel</code><code class="o">=</code><code class="p">{</code><code class="nx">isEdit</code> <code class="o">?</code> <code class="s1">'Save'</code> <code class="o">:</code> <code class="s1">'ok'</code><code class="p">}</code>
          <code class="nx">hasCancel</code><code class="o">=</code><code class="p">{</code><code class="nx">isEdit</code><code class="p">}</code>
          <code class="nx">onAction</code><code class="o">=</code><code class="p">{(</code><code class="nx">action</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">setDialog</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
            <code class="nx">updateRoute</code><code class="p">();</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">isEdit</code> <code class="o">&amp;&amp;</code> <code class="nx">action</code> <code class="o">===</code> <code class="s1">'confirm'</code><code class="p">)</code> <code class="p">{</code>
              <code class="nx">updateData</code><code class="p">(</code>
                <code class="nx">dataMangler</code><code class="p">(</code><code class="nx">data</code><code class="o">,</code> <code class="s1">'saveForm'</code><code class="o">,</code> <code class="p">{</code>
                  <code class="nx">rowidx</code><code class="o">,</code>
                  <code class="nx">form</code><code class="o">,</code>
                  <code class="nx">updateData</code><code class="o">,</code>
                <code class="p">})</code><code class="o">,</code>
              <code class="p">);</code>
            <code class="p">}</code>
          <code class="p">}}</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">Form</code>
            <code class="nx">ref</code><code class="o">=</code><code class="p">{</code><code class="nx">form</code><code class="p">}</code>
            <code class="nx">fields</code><code class="o">=</code><code class="p">{</code><code class="nx">schema</code><code class="p">}</code>
            <code class="nx">initialData</code><code class="o">=</code><code class="p">{</code><code class="nx">formPrefill</code><code class="p">}</code>
            <code class="nx">readonly</code><code class="o">=</code><code class="p">{</code><code class="o">!</code><code class="nx">isEdit</code><code class="p">}</code>
          <code class="o">/&gt;</code>
        <code class="o">&lt;/</code><code class="nx">Dialog</code><code class="o">&gt;,</code>
      <code class="p">);</code>
    <code class="p">}</code>
  <code class="p">}</code><code class="o">,</code>
  <code class="p">[</code><code class="nx">data</code><code class="o">,</code> <code class="nx">updateData</code><code class="o">,</code> <code class="nx">updateRoute</code><code class="p">]</code><code class="o">,</code>
<code class="p">);</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="The End"><div class="sect1" id="idm45779422909408">
<h1>The End</h1>

<p>I’m happy you <a data-type="indexterm" data-startref="ch8_term41" id="idm45779420939968"/><a data-type="indexterm" data-startref="ch8_term42" id="idm45779420939232"/><a data-type="indexterm" data-startref="ch8_term43" id="idm45779420938560"/><a data-type="indexterm" data-startref="ch8_term58" id="idm45779420937888"/><a data-type="indexterm" data-startref="ch8_term59" id="idm45779420937216"/><a data-type="indexterm" data-startref="ch8_term60" id="idm45779420936544"/><a data-type="indexterm" data-startref="ch8_term61" id="idm45779420627840"/>got this far, dear reader. I hope you’re a more confident programmer now, someone who knows how to get a new React project off the ground or join an existing one and take it into the future.</p>

<p>A programming book is like a snapshot in time. Technologies change and evolve while the book remains the same. I did my best to focus on evergreen content and let the evolution take its place. But it is my goal to attempt to bring new additions to this book (in the form of PDF appendixes) before a new edition is due. If you’d <a data-type="indexterm" data-primary="React" data-secondary="updated information about" id="idm45779420626272"/>like to keep up with the new content, please join the <a href="https://react.stoyanstefanov.com">mailing list</a>.</p>
</div></section>







</div></section></div></body>
</html>