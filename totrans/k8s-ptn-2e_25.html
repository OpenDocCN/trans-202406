<html><head></head><body><section data-pdf-bookmark="Chapter 20. Configuration Resource" data-type="chapter" epub:type="chapter"><div class="chapter" id="ConfigurationResource">&#13;
<h1><span class="label">Chapter 20. </span>Configuration Resource</h1>&#13;
&#13;
&#13;
<p>Kubernetes provides<a data-primary="Configuration Resource" data-type="indexterm" id="cfgrsrc20"/> native configuration resources for regular and confidential data, which allows you to decouple the configuration lifecycle from the application lifecycle.&#13;
The <em>Configuration Resource</em> pattern explains the concepts of ConfigMap and Secret resources and how we can use them, as well as their limitations.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect1"><div class="sect1" id="idm45902090187152">&#13;
<h1>Problem</h1>&#13;
&#13;
<p>One significant disadvantage of the<a data-primary="problems" data-secondary="ConfigMap and Secrets, using" data-type="indexterm" id="idm45902090185824"/><a data-primary="EnvVar Configuration" data-secondary="Configuration Resource" data-type="indexterm" id="idm45902090184784"/><a data-primary="EnvVar Configuration" data-type="indexterm" id="idm45902090183840"/> <em>EnvVar Configuration</em> pattern, discussed in <a data-type="xref" href="ch19.html#EnvVarConfiguration">Chapter 19</a>, is that it’s suitable for only a handful of variables and simple configurations. Another disadvantage is that because environment variables can be defined in various places, it is often hard to find the definition of a variable. And even if you find it, you can’t be entirely sure it won’t be overridden in another location. For example, environment variables defined within a OCI image can be replaced during runtime in a Kubernetes Deployment resource.</p>&#13;
&#13;
<p>Often, it is better<a data-primary="configuration information" data-secondary="best approach to handling" data-type="indexterm" id="idm45902090181376"/> to keep all the configuration data in a single place and not scattered around in various resource definition files. But it does not make sense to put the content of a whole configuration file into an environment variable. So some extra indirection would allow more flexibility, which is what Kubernetes configuration resources offer.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect1"><div class="sect1" id="idm45902090179952">&#13;
<h1>Solution</h1>&#13;
&#13;
<p>Kubernetes<a data-primary="ConfigMaps" data-secondary="versus EnvVar Configuration pattern" data-secondary-sortas="EnvVar Configuration pattern" data-type="indexterm" id="idm45902090178000"/> provides dedicated configuration Resources that are more flexible than pure environment variables. These are the<a data-primary="environment variables" data-secondary="versus ConfigMaps" data-secondary-sortas="ConfigMaps" data-type="indexterm" id="idm45902090176432"/> ConfigMap and<a data-primary="Secrets" data-secondary="similarities to ConfigMap" data-type="indexterm" id="idm45902090175088"/> Secret objects for general-purpose and sensitive data, respectively.</p>&#13;
&#13;
<p>We can use both in the same way, as both provide storage and management of key-value pairs. When we are describing ConfigMaps, the same can be applied most of the time to Secrets too. Besides the actual data encoding (which is Base64 for Secrets), there<a data-primary="ConfigMaps" data-secondary="similarities to Secrets" data-type="indexterm" id="idm45902090173504"/> is no technical difference for the use of ConfigMaps and Secrets.</p>&#13;
&#13;
<p>Once a ConfigMap is created and holding data, we can use the keys of a ConfigMap in two ways:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>As a reference for <em>environment variables</em>, where the key is the name of the environment variable.</p>&#13;
</li>&#13;
<li>&#13;
<p>As <em>files</em> that are mapped to a volume mounted in a Pod. The key is used as the filename.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The file in a mounted ConfigMap volume is updated when the ConfigMap is updated via the Kubernetes API. So, if an application supports hot reload of configuration files, it can immediately benefit from such an update. However, with ConfigMap entries used as environment variables, updates are not reflected because environment variables can’t be changed after a process has been started.</p>&#13;
&#13;
<p>In addition to ConfigMap and Secret, another alternative is to store configuration directly in external volumes that are then mounted.</p>&#13;
&#13;
<p>The following examples concentrate on<a data-primary="ConfigMaps" data-secondary="using" data-type="indexterm" id="idm45902090167024"/> ConfigMap usage, but they can also be used for Secrets. There is one big difference, though: values<a data-primary="Secrets" data-secondary="value encoding for" data-type="indexterm" id="idm45902090165808"/> for Secrets have to be Base64 encoded.</p>&#13;
&#13;
<p>A ConfigMap resource contains key-value pairs in its <code>data</code> section, as shown in <a data-type="xref" href="#ex-config-resource">Example 20-1</a>.</p>&#13;
<div data-type="example" id="ex-config-resource">&#13;
<h5><span class="label">Example 20-1. </span>ConfigMap resource</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ConfigMap</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator-config</code><code class="w">&#13;
</code><code class="nt">data</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">PATTERN</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Configuration</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Resource</code><code class="w">  </code><a class="co" href="#callout_configuration_resource_CO1-1" id="co_configuration_resource_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">  </code><code class="nt">application.properties</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w">&#13;
</code><code class="w">    </code><code class="no"># Random Generator config</code><code class="w">&#13;
</code><code class="w">    </code><code class="no">log.file=/tmp/generator.log</code><code class="w">&#13;
</code><code class="w">    </code><code class="no">server.port=7070</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">EXTRA_OPTIONS</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">high-secure,native</code><code class="s">"</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">SEED</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">432576345</code><code class="s">"</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_configuration_resource_CO1-1" id="callout_configuration_resource_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>ConfigMaps can be accessed as environment variables and as a mounted file. We recommend using uppercase keys in the ConfigMap to indicate an EnvVar usage and proper filenames when used as mounted files.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>We see here that a ConfigMap can also carry the content of complete configuration files, like the<a data-primary="Spring Boot" data-type="indexterm" id="idm45902090106736"/> Spring Boot <code>application.properties</code> in this example.&#13;
You can imagine that for a nontrivial use case, this section could get quite large!</p>&#13;
&#13;
<p>Instead<a data-primary="Secrets" data-secondary="creating" data-type="indexterm" id="idm45902090104768"/> of manually creating the full resource descriptor, we can use<a data-primary="kubectl" data-secondary="creating ConfigMaps" data-type="indexterm" id="idm45902090103632"/><a data-primary="kubectl" data-secondary="creating Secrets" data-type="indexterm" id="idm45902090102688"/> <code>kubectl</code> to create ConfigMaps or Secrets too. For the preceding example, the equivalent <code>kubectl</code> command looks like that in <a data-type="xref" href="#ex-config-map-apply">Example 20-2</a>.</p>&#13;
<div data-type="example" id="ex-config-map-apply">&#13;
<h5><span class="label">Example 20-2. </span>Create a ConfigMap from a file</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">kubectl<code class="w"> </code>create<code class="w"> </code>cm<code class="w"> </code>spring-boot-config<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">   </code>--from-literal<code class="o">=</code><code class="nv">PATTERN</code><code class="o">=</code><code class="s2">"Configuration Resource"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">   </code>--from-literal<code class="o">=</code><code class="nv">EXTRA_OPTIONS</code><code class="o">=</code><code class="s2">"high-secure,native"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">   </code>--from-literal<code class="o">=</code><code class="nv">SEED</code><code class="o">=</code><code class="s2">"432576345"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">   </code>--from-file<code class="o">=</code>application.properties<code class="w"/></pre></div>&#13;
&#13;
<p>This ConfigMap then can be read in various places—everywhere environment variables are defined, as demonstrated <a data-type="xref" href="#ex-config-map-env">Example 20-3</a>.</p>&#13;
<div data-type="example" id="ex-config-map-env">&#13;
<h5><span class="label">Example 20-3. </span>Environment variable set from ConfigMap</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">env</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">PATTERN</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">configMapKeyRef</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator-config</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">PATTERN</code><code class="w"/>&#13;
<code class="p">...</code><code class="l-Scalar-Plain">.</code><code class="w"/></pre></div>&#13;
&#13;
<p>If a ConfigMap has many entries that you want to consume as environment variables, using a certain syntax can save a lot of typing. Rather than specifying each entry individually, as shown in the preceding example in the <code>env</code> section, <code>envFrom</code> allows you to expose all ConfigMap entries that have a key that also can be used as a valid environment variable. We can prepend this with a prefix, as shown in <a data-type="xref" href="#ex-config-map-env-from">Example 20-4</a>.&#13;
Any key that cannot be used as an environment variable is ignored (e.g., <code>"illeg.al"</code>).&#13;
When multiple ConfigMaps are specified with duplicate keys, the last entry in <code>envFrom</code> takes precedence. Also, any same-named environment variable set directly with <code>env</code> has higher priority.</p>&#13;
<div data-type="example" id="ex-config-map-env-from">&#13;
<h5><span class="label">Example 20-4. </span>Setting all entries of a ConfigMap as environment variables</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">envFrom</code><code class="p">:</code><code class="w">                          </code><a class="co" href="#callout_configuration_resource_CO2-1" id="co_configuration_resource_CO2-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">configMapRef</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator-config</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">prefix</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CONFIG_</code><code class="w">                 </code><a class="co" href="#callout_configuration_resource_CO2-2" id="co_configuration_resource_CO2-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_configuration_resource_CO2-1" id="callout_configuration_resource_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Pick up all keys from the ConfigMap <code>random-generator-config</code> that can be used as environment variable names.</p></dd>&#13;
<dt><a class="co" href="#co_configuration_resource_CO2-2" id="callout_configuration_resource_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Prefix all suitable ConfigMap keys with <code>CONFIG_</code>. With the ConfigMap defined in <a data-type="xref" href="#ex-config-resource">Example 20-1</a>, this leads to three exposed environment variables: <code>CONFIG_​PAT⁠TERN_NAME</code>, <code>CONFIG_EXTRA_OPTIONS</code>, and <code>CONFIG_SEED</code>.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Secrets, as with ConfigMaps, can also be consumed as environment variables, either per entry or for all entries. To access a Secret instead of a ConfigMap, replace <code>configMapKeyRef</code> with <code>secretKeyRef</code>.</p>&#13;
&#13;
<p>When a ConfigMap is used as a volume, its complete content is projected into this volume, with the keys used as filenames. See <a data-type="xref" href="#ex-config-map-volume">Example 20-5</a>.</p>&#13;
<div data-type="example" id="ex-config-map-volume">&#13;
<h5><span class="label">Example 20-5. </span>Mount a ConfigMap as a volume</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">k8spatterns/random-generator:1.0</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">config-volume</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/config</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">volumes</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">config-volume</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">configMap</code><code class="p">:</code><code class="w">  </code><a class="co" href="#callout_configuration_resource_CO3-1" id="co_configuration_resource_CO3-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator-config</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_configuration_resource_CO3-1" id="callout_configuration_resource_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>A ConfigMap-backed volume will contain as many files as entries, with the map’s keys as filenames and the map’s values as file content.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>The configuration in <a data-type="xref" href="#ex-config-resource">Example 20-1</a> that is mounted as a volume results in four files in the <em>/config</em> folder: an <em>application.properties</em> file with the content defined in the ConfigMap and the files <em>PATTERN</em>, <em>EXTRA_OPTIONS</em>, and <em>SEED</em>, each with a single line of content.</p>&#13;
&#13;
<p>The mapping of configuration data can be fine-tuned more granularly by adding additional properties to the volume declaration. Rather than mapping all entries as files, you can also individually select every key that should be exposed, the filename, and permissions under which it should be available. <a data-type="xref" href="#ex-config-map-volume-items">Example 20-6</a> demonstrates how you can granularly select which parts of a ConfigMap are exposed as volumes.</p>&#13;
<div data-type="example" id="ex-config-map-volume-items">&#13;
<h5><span class="label">Example 20-6. </span>Expose ConfigMap entries selectively as volumes</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">k8spatterns/random-generator:1.0</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">config-volume</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/config</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">volumes</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">config-volume</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">configMap</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator-config</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">items</code><code class="p">:</code><code class="w">                          </code><a class="co" href="#callout_configuration_resource_CO4-1" id="co_configuration_resource_CO4-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">application.properties</code><code class="w">   </code><a class="co" href="#callout_configuration_resource_CO4-2" id="co_configuration_resource_CO4-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="w">        </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">spring/myapp.properties</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">mode</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0400</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_configuration_resource_CO4-1" id="callout_configuration_resource_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>List of ConfigMap entries to expose as volumes.</p></dd>&#13;
<dt><a class="co" href="#co_configuration_resource_CO4-2" id="callout_configuration_resource_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Expose only <code>application.properties</code> from the ConfigMap under the path <code>spring/myapp.properties</code> with file mode 0400.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>As you have seen, changes to a ConfigMap are directly reflected in a projected volume that contains the ConfigMap’s content as files. An application can watch those files and immediately pick up any changes. This hot reload is very useful to avoid a redeployment of an application, which can cause an interruption of the service. On the other hand, such live changes are not tracked anywhere and can easily get lost during a restart. These ad hoc chances can cause configuration drift that is hard to detect and analyze. That is one of the reasons many people prefer an <em>immutable configuration</em> that stays constant once deployed. We<a data-primary="Immutable Configuration" data-type="indexterm" id="idm45902089595744"/><a data-primary="Immutable Configuration" data-secondary="Configuration Resource" data-type="indexterm" id="idm45902089595040"/> have dedicated a whole pattern in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch21.html#ImmutableConfiguration">Chapter 21, “Immutable Configuration”</a>, to this paradigm, but there is a cheap way to easily achieve this with ConfigMap and Secrets too.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="config-resource-secrets-secure">&#13;
<h1>How Secure Are Secrets?</h1>&#13;
<p>Secrets<a data-primary="Secrets" data-secondary="security of" data-type="indexterm" id="idm45902089541104"/> hold Base64-encoded data and decode it before passing it to a Pod either as environment variables or mounted volume.&#13;
This is very often confused as a security feature. Base64 encoding is not an encryption method, and from a security perspective, it is considered the same as plain text.&#13;
Base64 encoding in Secrets allows you to store binary data, so why are Secrets considered more secure than ConfigMaps?&#13;
There are a number of other implementation details of Secrets that make them secure. Constant improvements are occurring in this area, but the main implementation details currently are as follows:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A Secret is distributed only to nodes running Pods that need access to the Secret.</p>&#13;
</li>&#13;
<li>&#13;
<p>On the nodes, Secrets are stored in memory in a <code>tmpfs</code> and never written to physical storage, and they are removed when the Pod is removed.</p>&#13;
</li>&#13;
<li>&#13;
<p>In etcd, the backend storage for the Kubernetes API, Secrets can be stored in <a href="https://oreil.ly/idOot">encrypted form</a>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Regardless of all that, there are still ways to get access to Secrets as a root user, or even by creating a Pod and mounting a Secret. You can apply<a data-primary="RBAC (role-based access control)" data-type="indexterm" id="idm45902089535216"/><a data-primary="role-based access control (RBAC)" data-type="indexterm" id="idm45902089534544"/> role-based access control (RBAC) to Secrets (as you can do to ConfigMaps or other resources) and allow only certain Pods with predefined service accounts to read them. We explain RBAC in great length in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch26.html#AccessControl">Chapter 26, “Access Control”</a>. But users who have the ability to create Pods in a namespace can still escalate their privileges within that namespace by creating Pods. They can run a Pod under a greater-privileged service account and still read Secrets. A user or a controller with Pod-creation access in a namespace can impersonate any service account and access all Secrets and ConfigMaps in that namespace. Thus, additional encryption of sensitive information is often done at the application level too. In <a data-type="xref" data-xrefstyle="chap-num-title" href="ch25.html#SecureConfiguration">Chapter 25, “Secure Configuration”</a>, you’ll learn several ways to make Secrets more secure, especially in a GitOps context.</p>&#13;
</div></aside>&#13;
&#13;
<p>Since version 1.21, Kubernetes supports an <code>immutable</code> field for ConfigMaps and Secrets that, if set to <code>true</code>, prevents the resource from being updated once created.&#13;
Besides preventing unwanted updates, using immutable ConfigMaps and Secrets considerably improves a cluster’s performance as the Kubernetes API server does not need to monitor changes on those immutable objects.&#13;
<a data-type="xref" href="#ex-secret-immutable">Example 20-7</a> shows how to declare a Secret immutable.&#13;
The only way to change such a Secret after it has been stored on the cluster is to delete and recreate the updated Secret.&#13;
Any running Pod referencing this secret needs to be restarted too.</p>&#13;
<div data-type="example" id="ex-secret-immutable">&#13;
<h5><span class="label">Example 20-7. </span>Immutable Secret</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Secret</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-config</code><code class="w">&#13;
</code><code class="nt">data</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">user</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cm9sYW5k</code><code class="w">&#13;
</code><code class="nt">immutable</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w">  </code><a class="co" href="#callout_configuration_resource_CO5-1" id="co_configuration_resource_CO5-1"><img alt="1" src="assets/1.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_configuration_resource_CO5-1" id="callout_configuration_resource_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Boolean flag declaring the mutability of the Secret (default is <code>false</code>).</p></dd>&#13;
</dl></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect1"><div class="sect1" id="idm45902090179040">&#13;
<h1>Discussion</h1>&#13;
&#13;
<p>ConfigMaps and Secrets allow you to store configuration information in dedicated resource objects that are easy to manage with the Kubernetes API. The<a data-primary="configuration information" data-secondary="decoupling definition of from usage" data-type="indexterm" id="idm45902089493712"/> most significant advantage of using ConfigMaps and Secrets is that they decouple the <em>definition</em> of configuration data from its <em>usage</em>. This decoupling allows us to manage the objects that use the configuration independently of the configuration definition. Another benefit of ConfigMaps and Secrets is that they are intrinsic features of the platform. No custom construct like that in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch21.html#ImmutableConfiguration">Chapter 21, “Immutable Configuration”</a>, is required.</p>&#13;
&#13;
<p>However, these<a data-primary="Init Container" data-secondary="Configuration Resource" data-type="indexterm" id="idm45902089490192"/> configuration resources also have their restrictions: with a 1 MB size limit for Secrets, they can’t store arbitrarily large data and are not well suited for nonconfiguration application data. You can also store binary data in Secrets, but since they have to be Base64 encoded, you can use only around 700 KB data for it. Real-world Kubernetes clusters also put an individual quota on the number of ConfigMaps that can be used per namespace or project, so ConfigMap is not a golden hammer.</p>&#13;
&#13;
<p>The next two chapters show how to deal with large configuration data by using the <em>Immutable Configuration</em> and <em>Configuration Template</em> patterns.<a data-primary="" data-startref="cfgrsrc20" data-type="indexterm" id="idm45902089458240"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="More Information" data-type="sect1"><div class="sect1" id="idm45902089456976">&#13;
<h1>More Information</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/-_jDa">Configuration Resource Example</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/oRN9a">Configure a Pod to Use a ConfigMap</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/mvoXO">Secrets</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/GrL0_">Encrypting Secret Data at Rest</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/Im-R9">Distribute Credentials Securely Using Secrets</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/9PvQ5">Immutable Secrets</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/ndYd0">How to Create Immutable ConfigMaps and Secrets</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/JUDZU">Size Limit for a ConfigMap</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section></body></html>