<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.w3.org/2002/06/xhtml2/ http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<link href="Styles/Style00.css" rel="stylesheet" type="text/css" />
<link href="Styles/Style01.css" rel="stylesheet" type="text/css" />

<style type="text/css">body{margin:1em;background-color:transparent!important;}#sbo-rt-content *{text-indent:0pt!important;}#sbo-rt-content .bq{margin-right:1em!important;}</style></head>
<body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 3. Excel: A Fancy Table Component"><div class="chapter" id="ch3">
<h1><span class="label">Chapter 3. </span>Excel: A Fancy Table Component</h1>


<p>Now you know how to create custom React components, compose UI using generic DOM components as well as your own custom ones, set properties, maintain state, hook into the lifecycle of a component, and optimize performance by not rerendering when not necessary.</p>

<p>Let’s put all of this together (and learn more about React while you’re at it) by <a data-type="indexterm" data-primary="Excel component, class" id="ch3_term1"/>creating a more powerful component—a data table. Something like an early prototype of Microsoft Excel that lets you edit the contents of a data table, and also sort, search, and export the data as downloadable files.</p>






<section data-type="sect1" data-pdf-bookmark="Data First"><div class="sect1" id="idm45779450990080">
<h1>Data First</h1>

<p>Tables are all about the data, so the fancy table component (why not call it <code>Excel</code>?) should <a data-type="indexterm" data-primary="data" data-secondary="initial" id="idm45779450988176"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="and data, initial" data-secondary-sortas="data, initial" id="idm45779450987168"/>take an array of data and an array of headers that describe each column of data. For testing, let’s grab a list of best-selling books from <a href="https://en.wikipedia.org/wiki/List_of_best-selling_books">Wikipedia</a>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">headers</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'Book'</code><code class="p">,</code> <code class="s1">'Author'</code><code class="p">,</code> <code class="s1">'Language'</code><code class="p">,</code> <code class="s1">'Published'</code><code class="p">,</code> <code class="s1">'Sales'</code><code class="p">];</code>

<code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">[</code>
    <code class="s1">'A Tale of Two Cities'</code><code class="p">,</code> <code class="s1">'Charles Dickens'</code><code class="p">,</code>
      <code class="s1">'English'</code><code class="p">,</code> <code class="s1">'1859'</code><code class="p">,</code> <code class="s1">'200 million'</code><code class="p">,</code>
  <code class="p">],</code>
  <code class="p">[</code>
    <code class="s1">'Le Petit Prince (The Little Prince)'</code><code class="p">,</code> <code class="s1">'Antoine de Saint-Exupéry'</code><code class="p">,</code>
      <code class="s1">'French'</code><code class="p">,</code> <code class="s1">'1943'</code><code class="p">,</code> <code class="s1">'150 million'</code><code class="p">,</code>
  <code class="p">],</code>
  <code class="p">[</code>
    <code class="s2">"Harry Potter and the Philosopher's Stone"</code><code class="p">,</code> <code class="s1">'J. K. Rowling'</code><code class="p">,</code>
      <code class="s1">'English'</code><code class="p">,</code> <code class="s1">'1997'</code><code class="p">,</code> <code class="s1">'120 million'</code><code class="p">,</code>
  <code class="p">],</code>
  <code class="p">[</code>
    <code class="s1">'And Then There Were None'</code><code class="p">,</code> <code class="s1">'Agatha Christie'</code><code class="p">,</code>
      <code class="s1">'English'</code><code class="p">,</code> <code class="s1">'1939'</code><code class="p">,</code> <code class="s1">'100 million'</code><code class="p">,</code>
  <code class="p">],</code>
  <code class="p">[</code>
    <code class="s1">'Dream of the Red Chamber'</code><code class="p">,</code> <code class="s1">'Cao Xueqin'</code><code class="p">,</code>
      <code class="s1">'Chinese'</code><code class="p">,</code> <code class="s1">'1791'</code><code class="p">,</code> <code class="s1">'100 million'</code><code class="p">,</code>
  <code class="p">],</code>
  <code class="p">[</code>
    <code class="s1">'The Hobbit'</code><code class="p">,</code> <code class="s1">'J. R. R. Tolkien'</code><code class="p">,</code>
      <code class="s1">'English'</code><code class="p">,</code> <code class="s1">'1937'</code><code class="p">,</code> <code class="s1">'100 million'</code><code class="p">,</code>
  <code class="p">],</code>
<code class="p">];</code></pre>

<p>Now, how should you go <a data-type="indexterm" data-primary="Excel component, class" data-secondary="rendering data for" id="ch3_term5"/><a data-type="indexterm" data-primary="rendering" data-secondary="of Excel class component" data-secondary-sortas="Excel class component" id="ch3_term6"/>about rendering this data in a table?</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Table Headers Loop"><div class="sect1" id="idm45779450839120">
<h1>Table Headers Loop</h1>

<p>The first step, just to get the new component off the ground, is to <a data-type="indexterm" data-primary="Excel component, class" data-secondary="headers" id="ch3_term2"/><a data-type="indexterm" data-primary="headers, table" id="ch3_term3"/><a data-type="indexterm" data-primary="tables" data-secondary="headers of" id="ch3_term4"/><a data-type="indexterm" data-primary="loops, table" id="ch3_term13"/>display only the headers of the table. Here’s what a bare-bones implementation might look like (<em>03.01.table-th-loop.html</em> in the book’s repository):</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">class</code> <code class="nx">Excel</code> <code class="kd">extends</code> <code class="nx">React</code><code class="p">.</code><code class="nx">Component</code> <code class="p">{</code>
  <code class="nx">render</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">const</code> <code class="nx">headers</code> <code class="o">=</code> <code class="p">[];</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">const</code> <code class="nx">title</code> <code class="nx">of</code> <code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">headers</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="p">(</code>
      <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">thead</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">headers</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
        <code class="o">&lt;/</code><code class="nx">thead</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
    <code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>Now that you have a working component, here’s how to use it:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">Excel</code> <code class="nx">headers</code><code class="o">=</code><code class="p">{</code><code class="nx">headers</code><code class="p">}</code> <code class="o">/&gt;,</code>
  <code class="nx">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'app'</code><code class="p">)</code><code class="o">,</code>
<code class="p">);</code></pre>

<p>The result of this get-off-the-ground example is shown in <a data-type="xref" href="#FIG0301">Figure 3-1</a>. There’s a little bit of CSS, which is of no concern for the purposes of this discussion, but you can find it in <code>03.table.css</code> in the book’s repo.</p>

<figure><div id="FIG0301" class="figure">
<img src="Images/rur2_0301.png" alt="rur2 0301" width="600" height="68"/>
<h6><span class="label">Figure 3-1. </span>Rendering table headers</h6>
</div></figure>

<p>The <code>return</code> part of the component is fairly simple. It looks just like an HTML table except for the <code>headers</code> array.</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="k">return</code> <code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">thead</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">headers</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">thead</code><code class="o">&gt;</code>
  <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
<code class="p">);</code></pre>

<p>As you saw in the previous chapter, you can <a data-type="indexterm" data-primary="JavaScript" data-secondary="JSX and" id="idm45779450659424"/><a data-type="indexterm" data-primary="JSX (JavaScript XML)" data-secondary="curly braces, use of" id="idm45779450658576"/><a data-type="indexterm" data-primary="{} (curly braces)" id="idm45779450657664"/><a data-type="indexterm" data-primary="curly braces ({})" id="idm45779450656992"/>open curly braces in your JSX and put any JavaScript value or expression in there. If this value happens to be an array as in the previous case, the JSX parser treats it as if you passed each element of the array individually, like <code>{headers[0]}{headers[1]}...</code>.</p>

<p>In this example the elements of the <code>headers</code> array contain more JSX content and this is perfectly fine. The loop before the <code>return</code> populates the <code>headers</code> array with JSX values which, if you were hardcoding the data, would look like:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">const</code> <code class="nx">headers</code> <code class="o">=</code> <code class="p">[</code>
  <code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="nx">Book</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;,</code>
  <code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="nx">Author</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;,</code>
  <code class="c1">// ...</code>
<code class="p">];</code></pre>

<p>You can have JavaScript expressions in curly braces within JSX and you can nest them as deep as you need. This is <a data-type="indexterm" data-primary="React" data-secondary="UI-building and DOM capabilities of" id="idm45779450607200"/>part of the beauty of React—all the power of JavaScript is available to you to create your UI. Loops and conditions all work as usual, and you don’t need to learn another “templating” language or syntax to build the UI.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Table Headers Loop, a Terse Version"><div class="sect1" id="idm45779450838528">
<h1>Table Headers Loop, a Terse Version</h1>

<p>The preceding example worked fine (let’s call it “v1” for “version 1”) but let’s see how you can accomplish the same with less code. Let’s move <a data-type="indexterm" data-primary="JSX (JavaScript XML)" data-secondary="table header loop options with" id="ch3_term7"/>the loop inside the JSX returned at the end. In essence the whole <code>render()</code> method becomes a single <code>return</code> (see <em>03.02.table-th-map.html</em> in the book’s repo).</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">class</code> <code class="nx">Excel</code> <code class="kd">extends</code> <code class="nx">React</code><code class="p">.</code><code class="nx">Component</code> <code class="p">{</code>
  <code class="nx">render</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">(</code>
      <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">thead</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code>
            <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">title</code> <code class="o">=&gt;</code> <code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">)}</code>
          <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
        <code class="o">&lt;/</code><code class="nx">thead</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
    <code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>See how the array of header content is <a data-type="indexterm" data-primary="map() function" id="idm45779450599840"/><a data-type="indexterm" data-primary="this.props object" data-secondary="this.props.headers" id="idm45779450485696"/><a data-type="indexterm" data-primary="props.headers" id="idm45779450484848"/>produced by calling <code>map()</code> on the data passed via <code>this.props.headers</code>. A <code>map()</code> call takes an input array, executes a callback function on each element, and creates a new array.</p>

<p>In the preceding example, the <a data-type="indexterm" data-primary="arrow functions syntax" id="idm45779450482352"/>callback uses the tersest <em>arrow functions</em> syntax. If this is a little too cryptic for your taste, let’s call it v2 and explore a few other options.</p>

<p>Here’s v3: a more <a data-type="indexterm" data-primary="function expressions" id="idm45779450480512"/>verbose <code>map()</code> loop using generous indentation and a <em>function expression</em> instead of an arrow function:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="p">{</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code>
    <code class="kd">function</code><code class="p">(</code><code class="nx">title</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;;</code>
    <code class="p">}</code>
  <code class="p">)</code>
<code class="p">}</code></pre>

<p>Next, a v4 which is a little less verbose, going back to using an arrow function:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="p">{</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code>
    <code class="p">(</code><code class="nx">title</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="k">return</code> <code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;;</code>
    <code class="p">}</code>
  <code class="p">)</code>
<code class="p">}</code></pre>

<p>This can be formatted with less indentation to v5:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">title</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;;</code>
<code class="p">})}</code></pre>

<p>You can choose your preferred way of iterating over arrays to produce JSX output based on personal preference and complexity of the content to be rendered. Simple data is conveniently looped over inline in the JSX (v2 through v5). If the <a data-type="indexterm" data-primary="inline versions in JSX" id="idm45779450352608"/>type of data is a little too much for an inline <code>map()</code> you may find it more readable to have the content generated at the top of the render function and keep the JSX simple, in a way separating data from presentation (v1 is an example). Sometimes too many inline expressions can be confusing when keeping track of all closing parentheses and curly braces.</p>

<p>As to v2 versus v5, they are the same except v5 has extra parentheses around the callback arguments and curly braces wrapping the callback function body. While both of these are optional, they make future changes a little easier to parse in a diff/code review context or while debugging. For example, adding a new line to the function body (maybe a temporary <code>console.log()</code>) in v5 is just that simple—adding a new line. While in v2 a new line also requires adding curly braces and reformatting and reindenting the<a data-type="indexterm" data-primary="JSX (JavaScript XML)" data-secondary="curly braces, use of" id="idm45779450349984"/><a data-type="indexterm" data-primary="{} (curly braces)" id="idm45779450349008"/><a data-type="indexterm" data-primary="curly braces ({})" id="idm45779450348336"/> <a data-type="indexterm" data-startref="ch3_term7" id="idm45779450347536"/>code.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Debugging the Console Warning"><div class="sect1" id="idm45779450605296">
<h1>Debugging the Console Warning</h1>

<p>If you look in the the <a data-type="indexterm" data-primary="debugging" id="idm45779450345200"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="console warning, debugging" id="idm45779450316336"/><a data-type="indexterm" data-primary="properties (props)" data-secondary="debugging warnings about" id="idm45779450315440"/>browser console  when loading the previous two examples (<em>03.01.table-th-loop.html</em> and <em>03.01.table-th-map.html</em>) you can see a warning. It states:</p>

<pre data-type="programlisting">Warning: Each child in a list should have a unique "key" prop.
Check the render method of `Excel`.</pre>

<p>What is it about and how do you fix it? As the warning message reads, React wants you to provide a unique identifier for the array elements so it can update them more efficiently later on. To <a data-type="indexterm" data-primary="“key” identifiers for properties" data-primary-sortas="key identifiers for properties" id="idm45779450312112"/><a data-type="indexterm" data-primary="properties (props)" data-secondary="unique “key” identifiers for" id="idm45779450311056"/>fix the warning, you add a <code>key</code> property to each header. The values of this new property can be anything as long they are unique for each element. Here you can use the index of the array element (0, 1, 2…):</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="c1">// before</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">const</code> <code class="nx">title</code> <code class="nx">of</code> <code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">headers</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">);</code>
<code class="p">}</code>

<code class="c1">// after - 03.03.table-th-loop-key.html</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">const</code> <code class="nx">idx</code> <code class="k">in</code> <code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="nx">title</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">[</code><code class="nx">idx</code><code class="p">];</code>
  <code class="nx">headers</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="o">&lt;</code><code class="nx">th</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The keys need to be unique only inside each array loop, not unique in the whole React application, so values of 0, 1, and so on are perfectly acceptable.</p>

<p>The same fix for the <a data-type="indexterm" data-primary="inline versions in JSX" id="idm45779450308448"/>inline version (v5) takes the element index from the second argument passed to the callback <a data-type="indexterm" data-startref="ch3_term2" id="idm45779450198464"/><a data-type="indexterm" data-startref="ch3_term3" id="idm45779450197792"/><a data-type="indexterm" data-startref="ch3_term4" id="idm45779450197120"/><a data-type="indexterm" data-startref="ch3_term13" id="idm45779450196448"/>function:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="c1">// before</code>
<code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code>
  <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">title</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;;</code>
  <code class="p">})}</code>
<code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>

<code class="c1">// after - 03.04.table-th-map-key.html</code>
<code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code>
  <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">title</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">th</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;;</code>
  <code class="p">})}</code>
<code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code></pre>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Adding &lt;td&gt; Content"><div class="sect1" id="idm45779450192064">
<h1>Adding &lt;td&gt; Content</h1>

<p>Now that you have a pretty table head, it’s time to add the body. The <a data-type="indexterm" data-primary="tables" data-secondary="body of" id="ch3_term14"/><a data-type="indexterm" data-primary="data" data-secondary="two-dimensional (td)" id="ch3_term8"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="and data, two-dimensional (td)" data-secondary-sortas="data, two-dimensional (td)" id="ch3_term9"/><a data-type="indexterm" data-primary="tables" data-secondary="td data of" id="ch3_term10"/><a data-type="indexterm" data-primary="td (two-dimensional) data" id="ch3_term11"/><a data-type="indexterm" data-primary="two-dimensional (td) data" id="ch3_term12"/><a data-type="indexterm" data-primary="tables" data-secondary="array, td data as" id="ch3_term43"/>data to be rendered is a two-dimensional array (rows and columns) that looks like the following:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">[</code>
    <code class="s1">'A Tale of Two Cities'</code><code class="p">,</code> <code class="s1">'Charles Dickens'</code><code class="p">,</code>
      <code class="s1">'English'</code><code class="p">,</code> <code class="s1">'1859'</code><code class="p">,</code> <code class="s1">'200 million'</code><code class="p">,</code>
  <code class="p">],</code>
  <code class="p">....</code>
<code class="p">];</code></pre>

<p>To pass the data to the <code>&lt;Excel&gt;</code>, let’s use a <a data-type="indexterm" data-primary="data" data-secondary="initial" id="idm45779450065056"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="and data, initial" data-secondary-sortas="data, initial" id="idm45779450064176"/><a data-type="indexterm" data-primary="initialData prop" id="idm45779450062960"/><a data-type="indexterm" data-primary="properties (props)" data-secondary="initializing components with" id="idm45779450062288"/><a data-type="indexterm" data-primary="this.props object" data-secondary="this.props.initialData" id="idm45779450061280"/><a data-type="indexterm" data-primary="props.initialData" id="idm45779450060336"/><a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.data" id="idm45779450059664"/>new prop called <code>initialData</code>. Why “initial” and not just “data”? As touched on briefly in the previous chapter, it’s about managing expectations. The caller of your <code>Excel</code> component should be able to pass data to initialize the table. But later, as the table lives on, the data will change, because the user is able to sort, edit, and so on. In other words, the <em>state</em> of the component will change. So let’s use <code>this.state.data</code> to keep track of the changes and use <code>this.props.initialData</code> to let the caller initialize the component.</p>

<p>Rendering a new <code>Excel</code> component would look like:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">Excel</code> <code class="nx">headers</code><code class="o">=</code><code class="p">{</code><code class="nx">headers</code><code class="p">}</code> <code class="nx">initialData</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code> <code class="o">/&gt;,</code>
  <code class="nx">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'app'</code><code class="p">)</code><code class="o">,</code>
<code class="p">);</code></pre>

<p>Next you need to <a data-type="indexterm" data-primary="constructor()" id="idm45779450006528"/>add a constructor to set the initial state from the given data. The constructor receives <code>props</code> as an argument and also needs to call its parent’s constructor via <code>super()</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">constructor</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">super</code><code class="p">();</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">state</code> <code class="o">=</code> <code class="p">{</code><code class="nx">data</code><code class="o">:</code> <code class="nx">props</code><code class="p">.</code><code class="nx">initialData</code><code class="p">};</code>
<code class="p">}</code></pre>

<p class="pagebreak-after">On to rendering <code>this.state.data</code>. The data is two-dimensional, so you <a data-type="indexterm" data-primary="loops, table" id="idm45779449957792"/>need two loops: one that goes through rows and one that goes through the data (cells) for each row. This can be accomplished using two of the same <code>.map()</code> loops you already know how to use:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="p">{</code><code class="nx">row</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">cell</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
      <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;</code>
    <code class="p">))}</code>
  <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
<code class="p">))}</code></pre>

<p>As you can see, both <a data-type="indexterm" data-primary="“key” identifiers for properties" data-primary-sortas="key identifiers for properties" id="idm45779449954784"/><a data-type="indexterm" data-primary="properties (props)" data-secondary="unique “key” identifiers for" id="idm45779449844176"/>loops need <code>key={idx}</code>, and in this case the name <code>idx</code> was recycled for use as local variables within each loop.</p>

<p>A complete implementation could look like this (and the result is shown in <a data-type="xref" href="#FIG0302">Figure 3-2</a>):</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">class</code> <code class="nx">Excel</code> <code class="kd">extends</code> <code class="nx">React</code><code class="p">.</code><code class="nx">Component</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">super</code><code class="p">();</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">state</code> <code class="o">=</code> <code class="p">{</code><code class="nx">data</code><code class="o">:</code> <code class="nx">props</code><code class="p">.</code><code class="nx">initialData</code><code class="p">};</code>
  <code class="p">}</code>
  <code class="nx">render</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">(</code>
      <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">thead</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code>
            <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">title</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
              <code class="o">&lt;</code><code class="nx">th</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;</code>
            <code class="p">))}</code>
          <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
        <code class="o">&lt;/</code><code class="nx">thead</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">tbody</code><code class="o">&gt;</code>
          <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
            <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code>
              <code class="p">{</code><code class="nx">row</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">cell</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
                <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;</code>
              <code class="p">))}</code>
            <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
          <code class="p">))}</code>
        <code class="o">&lt;/</code><code class="nx">tbody</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
    <code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<figure><div id="FIG0302" class="figure">
<img src="Images/rur2_0302.png" alt="rur2 0302" width="600" height="202"/>
<h6><span class="label">Figure 3-2. </span>Rendering the whole table (<em>03.05.table-th-td.html</em>)</h6>
</div></figure>








<section data-type="sect2" data-pdf-bookmark="Prop Types"><div class="sect2" id="idm45779449838480">
<h2>Prop Types</h2>

<p>The ability <a data-type="indexterm" data-startref="ch3_term5" id="idm45779449638976"/><a data-type="indexterm" data-startref="ch3_term6" id="idm45779449638272"/><a data-type="indexterm" data-primary="PropTypes" id="ch3_term15"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="prop types for" id="ch3_term16"/>to specify the types of variables you work with (string, number, boolean, etc.) doesn’t exist in the JavaScript language. But developers coming from other languages, and those working on larger projects with many other developers, do miss it. Two <a data-type="indexterm" data-primary="Flow" id="idm45779449635008"/><a data-type="indexterm" data-primary="TypeScript" id="idm45779449634336"/><a data-type="indexterm" data-primary="JavaScript" data-secondary="options for prop types with" id="idm45779449633664"/>popular options exist that allow you to write JavaScript with types: Flow and TypeScript. You can certainly use these to write React applications. But another option exists, which is limited to only specifying the types of props your component expects with <em>prop types</em>. They were a part of React itself, initially, but have been moved to a separate library as of React v15.5.</p>

<p>Prop types allow you to be more specific as to what data <code>Excel</code> takes and as a result surface an error to the developer early on. You can set up the prop types like so (<em>03.06.table-th-td-prop-types.html</em>):</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">Excel</code><code class="p">.</code><code class="nx">propTypes</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">headers</code><code class="o">:</code> <code class="nx">PropTypes</code><code class="p">.</code><code class="nx">arrayOf</code><code class="p">(</code><code class="nx">PropTypes</code><code class="p">.</code><code class="nx">string</code><code class="p">),</code>
  <code class="nx">initialData</code><code class="o">:</code> <code class="nx">PropTypes</code><code class="p">.</code><code class="nx">arrayOf</code><code class="p">(</code><code class="nx">PropTypes</code><code class="p">.</code><code class="nx">arrayOf</code><code class="p">(</code><code class="nx">PropTypes</code><code class="p">.</code><code class="nx">string</code><code class="p">)),</code>
<code class="p">};</code></pre>

<p>This means that the <code>headers</code> prop is expected to be an array of strings and <code>initialData</code> is expected to be an array where each element is another array of string <span class="keep-together">elements</span>.</p>

<p>To make this code work you need to <a data-type="indexterm" data-primary="global variables" id="idm45779449604672"/>grab the library that exposes the <code>PropTypes</code> global variable, just like you did in the beginning of <a data-type="xref" href="ch01.xhtml#ch1">Chapter 1</a>:</p>
<pre data-type="programlisting">
$ <strong>curl -L https://unpkg.com/prop-types/prop-types.js &gt; ~/reactbook/react/prop-types.js</strong>
</pre>

<p>Then, in the HTML, you include the new library together with the other ones:</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"react/react.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"react/react-dom.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"react/babel.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"react/prop-types.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/babel"</code><code class="nt">&gt;</code>
  <code class="kr">class</code> <code class="nx">Excel</code> <code class="kr">extends</code> <code class="nx">React</code><code class="p">.</code><code class="nx">Component</code> <code class="p">{</code>
    <code class="cm">/* ... */</code>
  <code class="p">}</code>
<code class="nt">&lt;/script&gt;</code></pre>

<p>Now you can test how it all works by changing <code>headers</code>, for example:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// before</code>
<code class="kr">const</code> <code class="nx">headers</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'Book'</code><code class="p">,</code> <code class="s1">'Author'</code><code class="p">,</code> <code class="s1">'Language'</code><code class="p">,</code> <code class="s1">'Published'</code><code class="p">,</code> <code class="s1">'Sales'</code><code class="p">];</code>
<code class="c1">// after</code>
<code class="kr">const</code> <code class="nx">headers</code> <code class="o">=</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="s1">'Author'</code><code class="p">,</code> <code class="s1">'Language'</code><code class="p">,</code> <code class="s1">'Published'</code><code class="p">,</code> <code class="s1">'Sales'</code><code class="p">];</code></pre>

<p>Now when you load the page (<em>03.06.table-th-td-prop-types.html</em> in the repo) you can see in the console:</p>

<pre data-type="programlisting">Warning: Failed prop type: Invalid prop `headers[0]` of type `number` supplied to `Excel`, expected `string`.</pre>

<p>Now that’s strict!</p>

<p>To explore other <code>PropTypes</code>, type <strong><code>PropTypes</code></strong> in the console (as shown in <a data-type="xref" href="#FIG0303">Figure 3-3</a>).</p>

<figure><div id="FIG0303" class="figure">
<img src="Images/rur2_0303.png" alt="rur2 0303" width="600" height="505"/>
<h6><span class="label">Figure 3-3. </span>Exploring <code>PropTypes</code></h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Can You Improve the Component?"><div class="sect2" id="idm45779449640144">
<h2>Can You Improve the Component?</h2>

<p>Allowing only <a data-type="indexterm" data-startref="ch3_term8" id="idm45779449443888"/><a data-type="indexterm" data-startref="ch3_term9" id="idm45779449443184"/><a data-type="indexterm" data-startref="ch3_term10" id="idm45779449442480"/><a data-type="indexterm" data-startref="ch3_term11" id="idm45779449441808"/><a data-type="indexterm" data-startref="ch3_term12" id="idm45779449441136"/><a data-type="indexterm" data-startref="ch3_term14" id="idm45779449440464"/><a data-type="indexterm" data-startref="ch3_term15" id="idm45779449439792"/><a data-type="indexterm" data-startref="ch3_term16" id="idm45779449439120"/><a data-type="indexterm" data-startref="ch3_term43" id="idm45779449438448"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="improving" id="idm45779449437776"/>string data is a bit too restrictive for a generic Microsoft Excel spreadsheet. As an exercise for your own amusement, you can change this example to allow more data types (<code>PropTypes.any</code>) and then render differently depending on the type (e.g., align numbers to the right).</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Sorting"><div class="sect1" id="idm45779450191472">
<h1>Sorting</h1>

<p>How many times have you seen a table on a web page that you wished was sorted differently? Luckily, it’s trivial to do this with React. Actually, this is an example where React shines, because <a data-type="indexterm" data-primary="sort() method/function" id="ch3_term20"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="sorting content of" id="ch3_term21"/><a data-type="indexterm" data-primary="sorting table data" id="ch3_term22"/>all you need to do is sort the <code>data</code> array and all the UI updates are handled for you.</p>

<p>For convenience and readability, all the sorting logic is in a <code>sort()</code> method in the <code>Excel</code> class. Once you create it, two bits of plumbing are necessary. First, add a <a data-type="indexterm" data-primary="onClick handler" id="idm45779449428976"/>click handler to the header row:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">thead</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">sort</code><code class="p">}</code><code class="o">&gt;</code></pre>

<p>And then <a data-type="indexterm" data-primary="this.sort object" id="idm45779449422704"/><a data-type="indexterm" data-primary="binding of method" id="idm45779449422096"/><a data-type="indexterm" data-primary="method, binding of" id="idm45779449421424"/>bind <code>this.sort</code> in the constructor as you did in <a data-type="xref" href="ch02.xhtml#ch2">Chapter 2</a>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">Excel</code> <code class="kr">extends</code> <code class="nx">React</code><code class="p">.</code><code class="nx">Component</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">super</code><code class="p">();</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">state</code> <code class="o">=</code> <code class="p">{</code><code class="nx">data</code><code class="o">:</code> <code class="nx">props</code><code class="p">.</code><code class="nx">initialData</code><code class="p">};</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">sort</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">sort</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="nx">sort</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// TODO: implement me</code>
  <code class="p">}</code>
  <code class="nx">render</code><code class="p">()</code> <code class="p">{</code> <code class="cm">/* ...*/</code><code class="p">}</code>
<code class="p">}</code></pre>

<p>Now let’s implement the <code>sort()</code> method. You need to know which column to sort by, which can <a data-type="indexterm" data-primary="cellIndex DOM property" id="idm45779449308240"/><a data-type="indexterm" data-primary="e.target.cellIndex" id="idm45779449307632"/><a data-type="indexterm" data-primary="columns, table" id="idm45779449307024"/><a data-type="indexterm" data-primary="tables" data-secondary="columns in" id="idm45779449306384"/>conveniently be retrieved by using the <code>cellIndex</code> DOM property of the event target (the event target is a table header <code>&lt;th&gt;</code>):</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">column</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">cellIndex</code><code class="p">;</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You may have rarely seen <code>cellIndex</code> used in app development. It’s a property defined as early as DOM Level 1 (circa 1998) as “The index of this cell in the row” and later on made read-only in DOM Level 2.</p>
</div>

<p>You also <a data-type="indexterm" data-primary="cloning" data-secondary="for protection of this.state" data-secondary-sortas="protection of this.state" id="ch3_term17"/><a data-type="indexterm" data-primary="copying data" id="ch3_term18"/><a data-type="indexterm" data-primary="state" data-secondary="protection of" id="ch3_term19"/>need a <em>copy</em> of the data to be sorted. Otherwise, if you use the array’s <code>sort()</code> method directly, it modifies the array. Meaning that calling <code>this.state.data.sort()</code> will modify <code>this.state</code>. As you <a data-type="indexterm" data-primary="setState()" id="ch3_term23"/><a data-type="indexterm" data-primary="this.setState() method/function" id="ch3_term24"/>know already, <code>this.state</code> should not be modified directly, but only through <code>setState()</code>.</p>

<p>Various ways <a data-type="indexterm" data-primary="JavaScript" data-secondary="shallow cloning in" id="idm45779449288272"/><a data-type="indexterm" data-primary="shallow cloning" id="idm45779449287264"/><a data-type="indexterm" data-primary="spread operator/attributes" id="idm45779449286592"/>exist in JavaScript to make a <em>shallow copy</em> of an object or an array (arrays are objects in JavaScript, e.g., <code>Object.assign()</code>) or using the spread operator <code>{...state}</code>. However there is no built-in way to do a <em>deep copy</em> of an object. A quick solution is to encode an object to a JSON string and then decode it back to an object. Let’s use this approach for brevity, though be aware that it fails if your object/array contains <code>Date</code> objects.</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">o</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">return</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">o</code><code class="p">));</code>
<code class="p">}</code></pre>

<p>With the <a data-type="indexterm" data-primary="clone() function" id="idm45779449244672"/>handy <code>clone()</code> utility function you make a copy of the array before you start manipulating it:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// copy the data</code>
<code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">);</code></pre>

<p>The actual sorting is done via a callback to array’s <code>sort()</code> method:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">data</code><code class="p">.</code><code class="nx">sort</code><code class="p">((</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">===</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">])</code> <code class="p">{</code>
    <code class="k">return</code> <code class="mi">0</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">&gt;</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">?</code> <code class="mi">1</code> <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
<code class="p">});</code></pre>

<p>Finally, this line <a data-type="indexterm" data-startref="ch3_term17" id="idm45779449204560"/><a data-type="indexterm" data-startref="ch3_term18" id="idm45779449106352"/><a data-type="indexterm" data-startref="ch3_term19" id="idm45779449105712"/>sets the state with the new, sorted data:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code>
  <code class="nx">data</code><code class="p">,</code>
<code class="p">});</code></pre>

<p>Now, when you click a header, the contents get sorted alphabetically (as shown in <a data-type="xref" href="#FIG0304">Figure 3-4</a>).</p>

<figure><div id="FIG0304" class="figure">
<img src="Images/rur2_0304.png" alt="rur2 0304" width="600" height="202"/>
<h6><span class="label">Figure 3-4. </span>Sorting by book title (<em>03.07.table-sort.html</em>)</h6>
</div></figure>

<p>And this is it—you don’t have to touch the UI rendering at all. <a data-type="indexterm" data-primary="render() method/function" id="idm45779449091104"/><a data-type="indexterm" data-primary="React" data-secondary="UI-building and DOM capabilities of" id="idm45779449090384"/>In the <code>render()</code> method, you’ve already defined once and for all how the component should look given some data. When the data changes, so does the UI; however, this is no longer your concern.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The example <a data-type="indexterm" data-primary="ECMAScript" data-secondary="property value shorthands" id="idm45779449087456"/>used the ECMAScript <em>property value shorthands</em> feature where <code>this.setState({data})</code> is a shorter way of expressing <code>this.setState({data: data})</code> by skipping the key when it has the same name as a <a data-type="indexterm" data-startref="ch3_term23" id="idm45779449084944"/><a data-type="indexterm" data-startref="ch3_term24" id="idm45779449060496"/>variable.</p>
</div>








<section data-type="sect2" data-pdf-bookmark="Can You Improve the Component?"><div class="sect2" id="idm45779449059632">
<h2>Can You Improve the Component?</h2>

<p>The example <a data-type="indexterm" data-primary="Excel component, class" data-secondary="improving" id="idm45779449058400"/>above uses pretty simple sorting, just enough to be relevant to the React discussion. You can go as fancy as you need, parsing the content to see if the values are numeric, with or without a unit of measure and so on.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Sorting UI Cues"><div class="sect1" id="idm45779449435216">
<h1>Sorting UI Cues</h1>

<p>The table is nicely sorted, but it’s not clear which column it’s sorted by. Let’s <a data-type="indexterm" data-primary="ascending/descending sorting" id="ch3_term25"/><a data-type="indexterm" data-primary="descending/ascending sorting" id="ch3_term26"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="UI cues in" id="ch3_term27"/><a data-type="indexterm" data-primary="tables" data-secondary="UI cues for sorting in" id="ch3_term28"/>update the UI to show arrows based on the column being sorted. And while you’re at it, let’s implement descending sorting too.</p>

<p>To keep track of the <a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.descending" id="idm45779449050400"/><a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.sortby" id="idm45779449049392"/>new state, you need two new properties added to <code>this.state</code>:</p>
<dl>
<dt><code>this.state.sortby</code></dt>
<dd>
<p>The index of the column currently being sorted</p>
</dd>
<dt><code>this.state.descending</code></dt>
<dd>
<p>A boolean to determine ascending versus descending sorting</p>
</dd>
</dl>

<p>The <a data-type="indexterm" data-primary="constructor()" id="idm45779449044096"/>constructor can now look like this:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">constructor</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">super</code><code class="p">();</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">state</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">data</code><code class="o">:</code> <code class="nx">props</code><code class="p">.</code><code class="nx">initialData</code><code class="p">,</code>
    <code class="nx">sortby</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
    <code class="nx">descending</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
  <code class="p">};</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">sort</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">sort</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
<code class="p">}</code></pre>

<p class="pagebreak-before">In the <code>sort()</code> function, you have to figure out which way to sort. Default is ascending (A to Z), unless the index of the new column is the same as the current sort-by column and the sorting is not already descending from a previous click on the header:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">column</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">cellIndex</code><code class="p">;</code>
<code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">);</code>
<code class="kr">const</code> <code class="nx">descending</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">sortby</code> <code class="o">===</code> <code class="nx">column</code> <code class="o">&amp;&amp;</code> <code class="o">!</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">descending</code><code class="p">;</code></pre>

<p>You also need a small tweak to the sorting callback:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">data</code><code class="p">.</code><code class="nx">sort</code><code class="p">((</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">===</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">])</code> <code class="p">{</code>
    <code class="k">return</code> <code class="mi">0</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="nx">descending</code>
    <code class="o">?</code> <code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">&lt;</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code>
      <code class="o">?</code> <code class="mi">1</code>
      <code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
    <code class="o">:</code> <code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">&gt;</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code>
      <code class="o">?</code> <code class="mi">1</code>
      <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
<code class="p">});</code></pre>

<p>And finally, you need to set the new state:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code>
  <code class="nx">data</code><code class="p">,</code>
  <code class="nx">sortby</code><code class="o">:</code> <code class="nx">column</code><code class="p">,</code>
  <code class="nx">descending</code><code class="p">,</code>
<code class="p">});</code></pre>

<p>At this point, the descending ordering works. Clicking on the table headers sorts the data first in ascending order, then descending, and then toggles between the two.</p>

<p>The only remaining task is to update the <code>render()</code> function to indicate sorting direction. For the currently sorted column, let’s just add an arrow symbol to the title. Now the <code>headers</code> loop looks like the following:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">title</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">sortby</code> <code class="o">===</code> <code class="nx">idx</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">title</code> <code class="o">+=</code> <code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">descending</code> <code class="o">?</code> <code class="s1">' \u2191'</code> <code class="o">:</code> <code class="s1">' \u2193'</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">th</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;</code>
<code class="p">})}</code></pre>

<p>The sorting is feature-complete—people can sort by any column, they can click once for ascending and once more for descending ordering, and the UI updates with the visual cue (as depicted in <a data-type="xref" href="#FIG0305">Figure 3-5</a>).</p>

<figure><div id="FIG0305" class="figure">
<img src="Images/rur2_0305.png" alt="rur2 0305" width="600" height="198"/>
<h6><span class="label">Figure 3-5. </span>Ascending/descending sorting (note the arrow next to “Published”)</h6>
</div></figure>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Editing Data"><div class="sect1" id="idm45779449056640">
<h1>Editing Data</h1>

<p>The next <a data-type="indexterm" data-startref="ch3_term20" id="idm45779448678352"/><a data-type="indexterm" data-startref="ch3_term21" id="idm45779448677648"/><a data-type="indexterm" data-startref="ch3_term22" id="idm45779448676944"/><a data-type="indexterm" data-startref="ch3_term25" id="idm45779448676272"/><a data-type="indexterm" data-startref="ch3_term26" id="idm45779448675600"/><a data-type="indexterm" data-startref="ch3_term27" id="idm45779448674928"/><a data-type="indexterm" data-startref="ch3_term28" id="idm45779448674256"/><a data-type="indexterm" data-primary="cells, editing" id="ch3_term30"/><a data-type="indexterm" data-primary="editing/tweaking table data" id="ch3_term31"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="editing content of" id="ch3_term32"/><a data-type="indexterm" data-primary="tables" data-secondary="cells, editing" id="ch3_term40"/><a data-type="indexterm" data-primary="tables" data-secondary="body of" id="ch3_term41"/>step for the <code>Excel</code> component is to give people the option to edit the data in the table. One solution could work like so:</p>
<ol>
<li>
<p>You <a data-type="indexterm" data-primary="double-clicks, event handling with" id="ch3_term29"/>double-click a cell. <code>Excel</code> figures out which cell was clicked and turns its content from simple text into an <a data-type="indexterm" data-primary="inputs" data-secondary="prefilled text for" id="idm45779448664880"/><a data-type="indexterm" data-primary="prefilled text for inputs" id="idm45779448663904"/>input field prefilled with the content (as shown in <a data-type="xref" href="#FIG0306">Figure 3-6</a>).</p>
</li>
<li>
<p>You edit the content (as shown in <a data-type="xref" href="#FIG0307">Figure 3-7</a>).</p>
</li>
<li>
<p>You hit Enter. The input field is gone, and the table is updated with the new text (as shown in <a data-type="xref" href="#FIG0308">Figure 3-8</a>).</p>
</li>

</ol>

<figure><div id="FIG0306" class="figure">
<img src="Images/rur2_0306.png" alt="rur2 0306" width="600" height="87"/>
<h6><span class="label">Figure 3-6. </span>Table cell turns into an input field on double-click</h6>
</div></figure>

<figure><div id="FIG0307" class="figure">
<img src="Images/rur2_0307.png" alt="rur2 0307" width="600" height="87"/>
<h6><span class="label">Figure 3-7. </span>Edit the content</h6>
</div></figure>

<figure><div id="FIG0308" class="figure">
<img src="Images/rur2_0308.png" alt="rur2 0308" width="600" height="98"/>
<h6><span class="label">Figure 3-8. </span>Content updated on pressing Enter</h6>
</div></figure>








<section data-type="sect2" data-pdf-bookmark="Editable Cell"><div class="sect2" id="idm45779448652288">
<h2>Editable Cell</h2>

<p>The first thing to do is <a data-type="indexterm" data-primary="cellIndex DOM property" id="idm45779448650576"/><a data-type="indexterm" data-primary="clicks, event handling with" id="idm45779448649872"/><a data-type="indexterm" data-primary="e.target.cellIndex" id="idm45779448649136"/><a data-type="indexterm" data-primary="events handlers" id="idm45779448648464"/><a data-type="indexterm" data-primary="onDoubleClick" id="idm45779448647792"/><a data-type="indexterm" data-primary="showEditor() method/function" id="ch3_term39"/><a data-type="indexterm" data-primary="columns, table" id="ch3_term36"/><a data-type="indexterm" data-primary="tables" data-secondary="columns in" id="ch3_term37"/>set up a simple event handler. On double-click, the component “remembers” the selected cell:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">tbody</code> <code class="nx">onDoubleClick</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">showEditor</code><code class="p">}</code><code class="o">&gt;</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Note the friendlier, easier-to-read <code>onDoubleClick</code>, as opposed to W3C’s <code>ondblclick</code>.</p>
</div>

<p>Let’s see what <code>showEditor</code> looks like:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">showEditor</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code>
    <code class="nx">edit</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">row</code><code class="o">:</code> <code class="nb">parseInt</code><code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">parentNode</code><code class="p">.</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">row</code><code class="p">,</code> <code class="mi">10</code><code class="p">),</code>
      <code class="nx">column</code><code class="o">:</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">cellIndex</code><code class="p">,</code>
    <code class="p">},</code>
  <code class="p">});</code>
<code class="p">}</code></pre>

<p>What’s happening here?</p>

<ul>
<li>
<p>The function <a data-type="indexterm" data-primary="edit property" id="idm45779448541536"/><a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.edit" id="ch3_term33"/>sets the <code>edit</code> property of <code>this.state</code>. This property is <code>null</code> when editing is not occurring and then turns into an object with properties <code>row</code> and <code>column</code>, which contain the row index and the column index of the cell being edited. So if you double-click the very first cell, <code>this.state.edit</code> gets the value <code>{row: 0, column: 0}</code>.</p>
</li>
<li>
<p>To figure out the column index, you use the same <code>e.target.cellIndex</code> as before, where <code>e.target</code> is the <code>&lt;td&gt;</code> that was <a data-type="indexterm" data-startref="ch3_term29" id="idm45779448534144"/>double-clicked.</p>
</li>
<li>
<p>There’s <a data-type="indexterm" data-primary="data-row property" id="ch3_term34"/><a data-type="indexterm" data-primary="row indexes" id="ch3_term35"/><a data-type="indexterm" data-primary="tables" data-secondary="row indexes for" id="ch3_term38"/>no <code>rowIndex</code> coming for free in the DOM, so you need to do it yourself via a <code>data-</code> attribute. Each row should have a <code>data-row</code> attribute with the row index, which you can <code>parseInt()</code> to get the index back.</p>
</li>
</ul>

<p>Let’s take care of a few prerequisites. First, the <code>edit</code> property didn’t exist before and should also be <a data-type="indexterm" data-primary="constructor()" id="idm45779448525824"/>initialized in the constructor. While dealing with the constructor, let’s <a data-type="indexterm" data-primary="save() method/function" id="idm45779448524992"/><a data-type="indexterm" data-primary="binding of method" id="idm45779448524320"/><a data-type="indexterm" data-primary="method, binding of" id="idm45779448523648"/>bind the <code>showEditor()</code> and <code>save()</code> methods. The <code>save()</code> is the one to do the data update once the user is done editing. The updated constructor looks like this:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">constructor</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">super</code><code class="p">();</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">state</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">data</code><code class="o">:</code> <code class="nx">props</code><code class="p">.</code><code class="nx">initialData</code><code class="p">,</code>
    <code class="nx">sortby</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
    <code class="nx">descending</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">edit</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code> <code class="c1">// {row: index, column: index}</code>
  <code class="p">};</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">sort</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">sort</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">showEditor</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">showEditor</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">save</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">save</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The property <code>data-row</code> is something you need so you can keep track of row indexes. You can get the index from the array index while looping. Previously you saw how <code>idx</code> was reused as a local variable by both row and column loops. Let’s rename it and use <code>rowidx</code> and <code>columnidx</code> for clarity.</p>

<p>The whole <code>&lt;tbody&gt;</code> construction could look like:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">tbody</code> <code class="nx">onDoubleClick</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">showEditor</code><code class="p">}</code><code class="o">&gt;</code>
  <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="o">,</code> <code class="nx">rowidx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">rowidx</code><code class="p">}</code> <code class="nx">data</code><code class="o">-</code><code class="nx">row</code><code class="o">=</code><code class="p">{</code><code class="nx">rowidx</code><code class="p">}</code><code class="o">&gt;</code>
      <code class="p">{</code><code class="nx">row</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">cell</code><code class="o">,</code> <code class="nx">columnidx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>

        <code class="c1">// TODO - turn `cell` into an input if the `columnidx`</code>
        <code class="c1">// and the `rowidx` match the one being edited;</code>
        <code class="c1">// otherwise, just show it as text</code>

        <code class="k">return</code> <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">columnidx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;;</code>
      <code class="p">})}</code>
    <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
  <code class="p">))}</code>
<code class="o">&lt;/</code><code class="nx">tbody</code><code class="o">&gt;</code></pre>

<p>Finally, let’s do what the <code>TODO</code> says—make an input field when required. The whole <code>render()</code> function is called again just because of the <code>setState()</code> call that sets the <code>edit</code> property. React rerenders the table, which gives you the chance to update the table cell that was <a data-type="indexterm" data-startref="ch3_term34" id="idm45779448294544"/><a data-type="indexterm" data-startref="ch3_term35" id="idm45779448293840"/><a data-type="indexterm" data-startref="ch3_term36" id="idm45779448293168"/><a data-type="indexterm" data-startref="ch3_term37" id="idm45779448292496"/><a data-type="indexterm" data-startref="ch3_term38" id="idm45779448291824"/><a data-type="indexterm" data-startref="ch3_term39" id="idm45779448291152"/>double-clicked.</p>
</div></section>













<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="Input Field Cell"><div class="sect2" id="idm45779448651664">
<h2>Input Field Cell</h2>

<p>Let’s look at the code to replace the <code>TODO</code> comment. First, remember the edit state for brevity:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">edit</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">edit</code><code class="p">;</code></pre>

<p>Check if the <code>edit</code> is set and if so, whether this is the exact cell being edited:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">if</code> <code class="p">(</code><code class="nx">edit</code> <code class="o">&amp;&amp;</code> <code class="nx">edit</code><code class="p">.</code><code class="nx">row</code> <code class="o">===</code> <code class="nx">rowidx</code> <code class="o">&amp;&amp;</code> <code class="nx">edit</code><code class="p">.</code><code class="nx">column</code> <code class="o">===</code> <code class="nx">columnidx</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>If this is the <a data-type="indexterm" data-primary="inputs" data-secondary="text fields for" id="idm45779448235728"/><a data-type="indexterm" data-primary="text fields" id="idm45779448234992"/>target cell, let’s make a form and an input field with the content of the cell:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="nx">cell</code> <code class="o">=</code> <code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">form</code> <code class="nx">onSubmit</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">save</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"text"</code> <code class="nx">defaultValue</code><code class="o">=</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code> <code class="o">/&gt;</code>
  <code class="o">&lt;/</code><code class="nx">form</code><code class="o">&gt;</code>
<code class="p">);</code></pre>

<p>As you see, it’s a <a data-type="indexterm" data-startref="ch3_term30" id="idm45779448187504"/><a data-type="indexterm" data-startref="ch3_term40" id="idm45779448187008"/><a data-type="indexterm" data-startref="ch3_term41" id="idm45779448186368"/><a data-type="indexterm" data-primary="inputs" data-secondary="prefilled text for" id="idm45779448185696"/><a data-type="indexterm" data-primary="prefilled text for inputs" id="idm45779448184752"/>form with a single input and the input is prefilled with the text content. When the form is submitted, the submission event is trapped in the <code>save()</code> method.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Saving"><div class="sect2" id="idm45779448183216">
<h2>Saving</h2>

<p>The last <a data-type="indexterm" data-primary="Excel component, class" data-secondary="saving changes to" id="idm45779448151056"/><a data-type="indexterm" data-primary="save() method/function" id="idm45779448150208"/><a data-type="indexterm" data-primary="saving changes to data tables" id="idm45779448149568"/>piece of the editing puzzle is saving the content changes after the user is done typing and has submitted the form (via the Enter key):</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">save</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">e</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>
  <code class="c1">// ... do the save</code>
<code class="p">}</code></pre>

<p>After preventing the default behavior (so the page doesn’t reload), you need to get a reference to the input field. The <a data-type="indexterm" data-primary="e.target.firstchild" id="idm45779448141248"/>event target <code>e.target</code> is the form and its first and only child is the input:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">firstChild</code><code class="p">;</code></pre>

<p>Clone the <a data-type="indexterm" data-primary="clone() function" id="idm45779448136448"/><a data-type="indexterm" data-primary="cloning" data-secondary="for protection of this.state" data-secondary-sortas="protection of this.state" id="idm45779448135952"/><a data-type="indexterm" data-primary="copying data" id="idm45779448134752"/><a data-type="indexterm" data-primary="state" data-secondary="protection of" id="idm45779448101216"/>data, so you don’t manipulate <code>this.state</code> directly:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">);</code></pre>

<p>Update the <a data-type="indexterm" data-primary="edit property" id="idm45779448093232"/>piece of data given the new value and the column and row indices stored in the <code>edit</code> property of the <code>state</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">data</code><code class="p">[</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">edit</code><code class="p">.</code><code class="nx">row</code><code class="p">][</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">edit</code><code class="p">.</code><code class="nx">column</code><code class="p">]</code> <code class="o">=</code> <code class="nx">input</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code></pre>

<p class="pagebreak-before">Finally, <a data-type="indexterm" data-primary="this.setState() method/function" id="idm45779448026112"/><a data-type="indexterm" data-primary="setState()" id="idm45779448025456"/>set the state, which causes rerendering of the UI:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code>
  <code class="nx">edit</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
  <code class="nx">data</code><code class="p">,</code>
<code class="p">});</code></pre>

<p>And with this, the table is now editable. For a complete listing, see <em>03.09.table-editable.html</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Conclusion and Virtual DOM Diffs"><div class="sect2" id="idm45779448182560">
<h2>Conclusion and Virtual DOM Diffs</h2>

<p>At this point, the editing feature is complete. It didn’t take too much code. All you needed was to:</p>

<ul>
<li>
<p>Keep track of which <a data-type="indexterm" data-startref="ch3_term33" id="idm45779447987760"/>cell to edit via <code>this.state.edit</code>.</p>
</li>
<li>
<p>Render an input field when displaying the table if the row and column indices match the cell the user double-clicked.</p>
</li>
<li>
<p>Update the data array with the new value from the input field.</p>
</li>
</ul>

<p>As soon as you <code>setState()</code> with the new data, <a data-type="indexterm" data-primary="DOM (Document Object Model)" data-secondary="minimal changes in browser of" id="ch3_term44"/><a data-type="indexterm" data-primary="optimization of performance" id="ch3_term45"/><a data-type="indexterm" data-primary="React" data-secondary="UI-building and DOM capabilities of" id="ch3_term46"/><a data-type="indexterm" data-primary="React app" data-secondary="efficiency with" id="ch3_term47"/><a data-type="indexterm" data-primary="rendering" data-secondary="React's efficiency with" id="ch3_term48"/>React calls the component’s <code>render()</code> method and the UI magically updates. It may look like it won’t be particularly efficient to render the whole table for just one cell’s content change. And in fact, React only updates a single cell in the browser’s DOM.</p>

<p>If you open your browser’s dev tools, you can see which parts of the DOM tree are updated as you interact with your application. In <a data-type="xref" href="#FIG0309">Figure 3-9</a>, you can see the dev tools highlighting the DOM change after changing <em>The Hobbit</em>’s language from English to Elvish.</p>

<p>Behind the scenes, <a data-type="indexterm" data-primary="DOM (Document Object Model)" data-secondary="virtual tree" id="idm45779447948704"/><a data-type="indexterm" data-primary="virtual DOM tree" id="idm45779447947856"/>React calls your <code>render()</code> method and creates a lightweight tree representation of the desired DOM result. This is known as a <em>virtual DOM tree</em>. When the <code>render()</code> method is called again (after a call to <code>setState()</code>, for example), React takes the virtual tree before and after and computes a diff. Based on this diff, React figures out the minimum required DOM operations (e.g., <code>appendChild()</code>, <code>textContent</code>, etc.) to carry on that change into the browser’s DOM.</p>

<p>In <a data-type="xref" href="#FIG0309">Figure 3-9</a>, there is only one change required to the cell and it’s not necessary to rerender the whole table. By computing the minimum set of changes and batching DOM operations, React “touches” the DOM lightly, as it’s a known problem that DOM operations are slow (compared to pure JavaScript operations, function calls, etc.) and are often the bottleneck in rich web applications’ rendering <a data-type="indexterm" data-startref="ch3_term31" id="idm45779447942672"/><a data-type="indexterm" data-startref="ch3_term32" id="idm45779447942000"/>performance.</p>

<figure><div id="FIG0309" class="figure">
<img src="Images/rur2_0309.png" alt="rur2 0309" width="600" height="329"/>
<h6><span class="label">Figure 3-9. </span>Highlighting DOM changes</h6>
</div></figure>

<p>React has <a data-type="indexterm" data-primary="event delegation" id="idm45779447938816"/>your back when it comes to performance and updating the UI by:</p>

<ul>
<li>
<p>Touching the DOM lightly</p>
</li>
<li>
<p>Using event delegation for user <a data-type="indexterm" data-startref="ch3_term44" id="idm45779447936064"/><a data-type="indexterm" data-startref="ch3_term45" id="idm45779447935360"/><a data-type="indexterm" data-startref="ch3_term46" id="idm45779447934688"/><a data-type="indexterm" data-startref="ch3_term47" id="idm45779447934016"/><a data-type="indexterm" data-startref="ch3_term48" id="idm45779447933344"/>interactions</p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Search"><div class="sect1" id="idm45779448679744">
<h1>Search</h1>

<p>Next, let’s <a data-type="indexterm" data-primary="filtering" data-secondary="of table data" data-secondary-sortas="table data" id="ch3_term49"/><a data-type="indexterm" data-primary="matching content, filtering for" id="ch3_term50"/><a data-type="indexterm" data-primary="row for search/filter inputs" id="ch3_term51"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="searching/filtering content of" id="ch3_term52"/><a data-type="indexterm" data-primary="searching table data" id="ch3_term53"/>add a search feature to the <code>Excel</code> component that allows users to filter the contents of the table. Here’s the plan:</p>
<ol>
<li>
<p>Add a <a data-type="indexterm" data-primary="button, search" id="idm45779447923648"/><a data-type="indexterm" data-primary="search button" id="idm45779447922912"/>button to toggle the new feature on and off (as in <a data-type="xref" href="#FIG0309_2">Figure 3-10</a>).</p>
</li>
<li>
<p>If the search is on, add a row of inputs where each one searches in the corresponding column (as in <a data-type="xref" href="#FIG0310">Figure 3-11</a>).</p>
</li>
<li>
<p>As a user types in an input box, filter the array of <code>state.data</code> to show only the matching content (as in <a data-type="xref" href="#FIG0311">Figure 3-12</a>).</p>
</li>

</ol>

<figure><div id="FIG0309_2" class="figure">
<img src="Images/rur2_0310.png" alt="rur2 0310" width="600" height="219"/>
<h6><span class="label">Figure 3-10. </span>Search button</h6>
</div></figure>

<figure><div id="FIG0310" class="figure">
<img src="Images/rur2_0311.png" alt="rur2 0311" width="600" height="205"/>
<h6><span class="label">Figure 3-11. </span>Row of search/filter inputs</h6>
</div></figure>

<figure><div id="FIG0311" class="figure">
<img src="Images/rur2_0312.png" alt="rur2 0312" width="600" height="123"/>
<h6><span class="label">Figure 3-12. </span>Search results</h6>
</div></figure>








<section data-type="sect2" data-pdf-bookmark="State and UI"><div class="sect2" id="idm45779447910832">
<h2>State and UI</h2>

<p>The first <a data-type="indexterm" data-startref="ch3_term49" id="idm45779447909136"/><a data-type="indexterm" data-startref="ch3_term50" id="idm45779447908400"/><a data-type="indexterm" data-startref="ch3_term51" id="idm45779447907728"/><a data-type="indexterm" data-primary="constructor()" id="idm45779447907056"/>thing to do is update the constructor by:</p>

<ul>
<li>
<p>Adding a <code>search</code> property <a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.search" id="idm45779447904720"/>to the <code>this.state</code> object to keep track of whether the search feature is on</p>
</li>
<li>
<p>Binding two <a data-type="indexterm" data-primary="toggleSearch() function" id="idm45779447902144"/>new methods: <code>this.toggleSearch()</code> to turn search boxes on and off and <code>this.search()</code> to do the actual searching</p>
</li>
<li>
<p>Setting up a <a data-type="indexterm" data-primary="this.preSearchData" id="idm45779447899536"/><a data-type="indexterm" data-primary="preSearchData" id="idm45779447898800"/>new class property <code>this.preSearchData</code></p>
</li>
<li>
<p>Updating the incoming initial data with a consecutive ID to help identify the rows when editing contents of filtered data</p>
</li>
</ul>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">constructor</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">super</code><code class="p">();</code>
  <code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">props</code><code class="p">.</code><code class="nx">initialData</code><code class="p">).</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="p">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">row</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">idx</code><code class="p">);</code>
    <code class="k">return</code> <code class="nx">row</code><code class="p">;</code>
  <code class="p">});</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">state</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">,</code>
    <code class="nx">sortby</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
    <code class="nx">descending</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">edit</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code> <code class="c1">// {row: index, column: index}</code>
    <code class="nx">search</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
  <code class="p">};</code>

  <code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>

  <code class="k">this</code><code class="p">.</code><code class="nx">sort</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">sort</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">showEditor</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">showEditor</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">save</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">save</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">toggleSearch</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">toggleSearch</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">search</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">search</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The cloning <a data-type="indexterm" data-primary="clone() function" id="idm45779447895296"/><a data-type="indexterm" data-primary="data" data-secondary="initial" id="idm45779447894688"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="and data, initial" data-secondary-sortas="data, initial" id="idm45779447893776"/><a data-type="indexterm" data-primary="initialData prop" id="idm45779447713728"/><a data-type="indexterm" data-primary="IDs" data-secondary="data table record" id="idm45779447713056"/><a data-type="indexterm" data-primary="record IDs in data tables" id="idm45779447712112"/><a data-type="indexterm" data-primary="map() function" id="idm45779447711376"/>and updating of the <code>initialData</code> changes the data used in the state by adding a sort of <em>record ID</em>. This will prove handy when editing data that was already filtered. You <code>map()</code> the data, adding an additional column which is an integer ID.</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">props</code><code class="p">.</code><code class="nx">initialData</code><code class="p">).</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="p">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code>
  <code class="nx">row</code><code class="p">.</code><code class="nx">concat</code><code class="p">(</code><code class="nx">idx</code><code class="p">),</code>
<code class="p">);</code></pre>

<p>As a <a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.data" id="idm45779447690336"/>result, <code>this.state.data</code> now looks like the following:</p>

<pre data-type="programlisting" data-code-language="javascript">  <code class="p">[</code>
    <code class="s1">'A Tale of Two Cities'</code><code class="p">,</code> <code class="p">...,</code> <code class="mi">0</code>
  <code class="p">],</code>
  <code class="p">[</code>
    <code class="s1">'Le Petit Prince (The Little Prince)'</code><code class="p">,</code> <code class="p">...,</code> <code class="mi">1</code>
  <code class="p">],</code>
  <code class="c1">// ...</code></pre>

<p>This change also <a data-type="indexterm" data-primary="render() method/function" id="idm45779447651280"/>requires changes in the <code>render()</code> method, namely to use this record ID to identify rows, regardless of whether we’re looking at all the data or a filtered subset of it (as a result of a search):</p>

<pre data-type="programlisting" data-code-language="actionscript" class="pagebreak-before"><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="o">,</code> <code class="nx">rowidx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// the last piece of data in a row is the ID</code>
  <code class="kd">const</code> <code class="nx">recordId</code> <code class="o">=</code> <code class="nx">row</code><code class="p">[</code><code class="nx">row</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">];</code>
  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">recordId</code><code class="p">}</code> <code class="nx">data</code><code class="o">-</code><code class="nx">row</code><code class="o">=</code><code class="p">{</code><code class="nx">recordId</code><code class="p">}</code><code class="o">&gt;</code>
      <code class="p">{</code><code class="nx">row</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">cell</code><code class="o">,</code> <code class="nx">columnidx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">columnidx</code> <code class="o">===</code> <code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
          <code class="c1">// do not show the record ID in the table UI</code>
          <code class="k">return</code><code class="o">;</code>
        <code class="p">}</code>
        <code class="kd">const</code> <code class="nx">edit</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">edit</code><code class="o">;</code>
        <code class="k">if</code> <code class="p">(</code>
          <code class="nx">edit</code> <code class="o">&amp;&amp;</code>
          <code class="nx">edit</code><code class="p">.</code><code class="nx">row</code> <code class="o">===</code> <code class="nx">recordId</code> <code class="o">&amp;&amp;</code>
          <code class="nx">edit</code><code class="p">.</code><code class="nx">column</code> <code class="o">===</code> <code class="nx">columnidx</code>
        <code class="p">)</code> <code class="p">{</code>
          <code class="nx">cell</code> <code class="o">=</code> <code class="p">(</code>
            <code class="o">&lt;</code><code class="nx">form</code> <code class="nx">onSubmit</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">save</code><code class="p">}</code><code class="o">&gt;</code>
              <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"text"</code> <code class="nx">defaultValue</code><code class="o">=</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code> <code class="o">/&gt;</code>
            <code class="o">&lt;/</code><code class="nx">form</code><code class="o">&gt;</code>
          <code class="p">);</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">columnidx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;;</code>
      <code class="p">})}</code>
    <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">})}</code></pre>

<p>Next comes <a data-type="indexterm" data-primary="button, search" id="idm45779447649392"/><a data-type="indexterm" data-primary="search button" id="idm45779447648784"/>updating the UI with a search button. Where before there was a <code>&lt;table&gt;</code> as the root, now let’s have a <code>&lt;div&gt;</code> with a search button and the same table.</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"toolbar"</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">toggleSearch</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">search</code> <code class="o">?</code> <code class="s1">'Hide search'</code> <code class="o">:</code> <code class="s1">'Show search'</code><code class="p">}</code>
  <code class="o">&lt;/</code><code class="nx">button</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
    <code class="p">{</code><code class="cm">/* ... */</code><code class="p">}</code>
  <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
<code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code></pre>

<p>As you <a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.search" id="idm45779447407168"/>see, the search button label is dynamic, to reflect whether the search is on or off (<code>this.state.search</code> is <code>true</code> or <code>false</code>).</p>

<p>Next comes the <a data-type="indexterm" data-primary="row for search/filter inputs" id="idm45779447334272"/><a data-type="indexterm" data-primary="searchRow" id="idm45779447333472"/>row of search boxes. You can add it to the increasingly large chunk of JSX, or you can have it composed up front and added to a constant which is to be included in the main JSX. Let’s go the second route. If the search feature is not on, you don’t need to render anything, so <code>searchRow</code> is just <code>null</code>. Otherwise a new table row is created where each cell is an input element.</p>

<pre data-type="programlisting" data-code-language="actionscript" class="pagebreak-before"><code class="kd">const</code> <code class="nx">searchRow</code> <code class="o">=</code> <code class="o">!</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">search</code> <code class="o">?</code> <code class="kc">null</code> <code class="o">:</code> <code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">onChange</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">search</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">_</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
      <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"text"</code> <code class="nx">data</code><code class="o">-</code><code class="nx">idx</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code> <code class="o">/&gt;</code>
      <code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;</code>
    <code class="p">))}</code>
  <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
<code class="p">);</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Using <code>(_, idx)</code> is an illustration of a convention where an unused variable in a callback is <a data-type="indexterm" data-primary="callbacks" data-secondary="unused variables in" id="idm45779447330144"/><a data-type="indexterm" data-primary="underscore (“_”) as function argument" id="idm45779447225568"/><a data-type="indexterm" data-primary="“_” (underscore) as function argument" data-primary-sortas="_ (underscore) as function argument" id="idm45779447224800"/>named with an underscore <code>_</code> to signal to the reader of the code that it’s not used.</p>
</div>

<p>The row of search inputs is just another child node before the main <code>data</code> loop (the one that creates all the table rows and cells). Include <code>searchRow</code> there:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">tbody</code> <code class="nx">onDoubleClick</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">showEditor</code><code class="p">}</code><code class="o">&gt;</code>
  <code class="p">{</code><code class="nx">searchRow</code><code class="p">}</code>
  <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="o">,</code> <code class="nx">rowidx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(....</code></pre>

<p>At this point, that’s all for the UI updates. Let’s take a look at the meat of the feature, the “business logic,” if you will: the actual search.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Filtering Content"><div class="sect2" id="idm45779447910176">
<h2>Filtering Content</h2>

<p>The search <a data-type="indexterm" data-primary="filtering" data-secondary="of table data" data-secondary-sortas="table data" id="ch3_term56"/><a data-type="indexterm" data-primary="matching content, filtering for" id="ch3_term57"/><a data-type="indexterm" data-primary="preSearchData" id="ch3_term58"/><a data-type="indexterm" data-primary="this.preSearchData" id="ch3_term59"/><a data-type="indexterm" data-primary="filtering" data-secondary="search strings and" id="ch3_term54"/><a data-type="indexterm" data-primary="search strings and data filtering" id="ch3_term55"/><a data-type="indexterm" data-primary="Array.prototype.filter() method" id="idm45779447159616"/><a data-type="indexterm" data-primary="filter() method/function" id="idm45779447159008"/><a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.data" id="idm45779447158400"/>feature is going to be fairly simple: call the <code>Array.prototype.filter()</code> method on the array of data, and return a filtered array with the elements that match the search string. The UI still uses <code>this.state.data</code> to do the rendering, but <code>this.state.data</code> is a reduced version of itself.</p>

<p>You need a <a data-type="indexterm" data-primary="save() method/function" id="idm45779447155584"/>reference to the data before the search, so that you don’t lose the data forever. This allows the user to go back to the full table or change the search string to get different matches. Let’s call this reference <code>this.preSearchData</code>. Now that there’s data in two places, the <code>save()</code> method will need an update, so both places are updated should the user decide to edit the data, regardless of whether it’s been filtered or not.</p>

<p>When the <a data-type="indexterm" data-primary="button, search" id="idm45779447153040"/><a data-type="indexterm" data-primary="search button" id="idm45779447152304"/><a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.search" id="idm45779447151632"/><a data-type="indexterm" data-primary="toggleSearch() function" id="idm45779447150688"/>user clicks the “search” button, the <code>toggleSearch()</code> function is invoked. This function’s task is to turn the search feature on and off. It does its task by:</p>

<ul>
<li>
<p>Setting the <code>this.state.search</code> to <code>true</code> or <code>false</code> accordingly</p>
</li>
<li>
<p>When enabling the search, “remembering” the current data</p>
</li>
<li>
<p>When disabling the search, reverting to the remembered data</p>
</li>
</ul>

<p>Here’s how this function can be written:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">toggleSearch</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">search</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code>
      <code class="nx">data</code><code class="o">:</code> <code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code><code class="p">,</code>
      <code class="nx">search</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="p">});</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code>
      <code class="nx">search</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="p">});</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>The last <a data-type="indexterm" data-primary="row for search/filter inputs" id="idm45779447140224"/><a data-type="indexterm" data-primary="search() function" id="idm45779447139568"/>thing to do is implement the <code>search()</code> function, which is called every time something in the search row changes, meaning the user is typing in one of the inputs. Here’s the complete implementation, followed by some more details:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">search</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">needle</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">value</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">();</code>
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">needle</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code><code class="nx">data</code><code class="o">:</code> <code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code><code class="p">});</code>
    <code class="k">return</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="kr">const</code> <code class="nx">idx</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">idx</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">searchdata</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code><code class="p">.</code><code class="nx">filter</code><code class="p">((</code><code class="nx">row</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">row</code><code class="p">[</code><code class="nx">idx</code><code class="p">].</code><code class="nx">toString</code><code class="p">().</code><code class="nx">toLowerCase</code><code class="p">().</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">needle</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
  <code class="p">});</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code><code class="nx">data</code><code class="o">:</code> <code class="nx">searchdata</code><code class="p">});</code>
<code class="p">}</code></pre>

<p>You get the search string from the change event’s target (which is the input box). Let’s call it “needle” as we’re looking for a needle in a haystack of data:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">needle</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">value</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">();</code></pre>

<p>If there’s no search string (the user erased what they typed), the function takes the original, cached data, and this data becomes the new state:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">needle</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code><code class="nx">data</code><code class="o">:</code> <code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code><code class="p">});</code>
  <code class="k">return</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>If there is a search string, filter the original data and set the filtered results as the new state of the data:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">idx</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">idx</code><code class="p">;</code>
<code class="kr">const</code> <code class="nx">searchdata</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code><code class="p">.</code><code class="nx">filter</code><code class="p">((</code><code class="nx">row</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">return</code> <code class="nx">row</code><code class="p">[</code><code class="nx">idx</code><code class="p">].</code><code class="nx">toString</code><code class="p">().</code><code class="nx">toLowerCase</code><code class="p">().</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">needle</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
<code class="p">});</code>
<code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code><code class="nx">data</code><code class="o">:</code> <code class="nx">searchdata</code><code class="p">});</code></pre>

<p>And with this, the <a data-type="indexterm" data-startref="ch3_term54" id="idm45779446867072"/><a data-type="indexterm" data-startref="ch3_term55" id="idm45779446764400"/>search feature is complete. To implement the feature, all you needed to do was:</p>

<ul>
<li>
<p>Add search UI</p>
</li>
<li>
<p>Show/hide the new UI upon request</p>
</li>
<li>
<p>The actual “business logic”: a <a data-type="indexterm" data-primary="filter() method/function" id="idm45779446760800"/><a data-type="indexterm" data-primary="Array.prototype.filter() method" id="idm45779446760032"/>simple array <code>filter()</code> call</p>
</li>
</ul>

<p>As always, you <a data-type="indexterm" data-startref="ch3_term52" id="idm45779446758000"/><a data-type="indexterm" data-startref="ch3_term53" id="idm45779446757264"/><a data-type="indexterm" data-startref="ch3_term56" id="idm45779446756592"/><a data-type="indexterm" data-startref="ch3_term57" id="idm45779446755920"/><a data-type="indexterm" data-startref="ch3_term58" id="idm45779446755248"/><a data-type="indexterm" data-startref="ch3_term59" id="idm45779446754576"/>worry only about the state of your data and let React take care of rendering (and all the associated grunt DOM work) whenever the state of the data changes.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Update the save() Method"><div class="sect2" id="idm45779447198192">
<h2>Update the save() Method</h2>

<p>Previously there <a data-type="indexterm" data-primary="record IDs in data tables" id="idm45779446752192"/><a data-type="indexterm" data-primary="IDs" data-secondary="data table record" id="idm45779446751440"/>was only <code>state.data</code> to be cloned and updated, but now you also have the “remembered” <code>preSearchData</code>. If the user is editing (even while searching), now the two pieces of data need an update. That’s the whole reason for adding a record ID—so you can find the real row even in a filtered state.</p>

<p>Updating the <code>preSearchData</code> is just <a data-type="indexterm" data-primary="save() method/function" id="idm45779446748464"/>like in the previous <code>save()</code> implementation; just find the row and column. Updating the state data requires the additional step of finding the record ID of the row and matching it to the row currently being edited (<code>this.state.edit.row</code>).</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">save</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">e</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>
  <code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">firstChild</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">).</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">row</code><code class="p">[</code><code class="nx">row</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">]</code> <code class="o">===</code> <code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">edit</code><code class="p">.</code><code class="nx">row</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">row</code><code class="p">[</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">edit</code><code class="p">.</code><code class="nx">column</code><code class="p">]</code> <code class="o">=</code> <code class="nx">input</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">row</code><code class="p">;</code>
  <code class="p">});</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">logSetState</code><code class="p">({</code>
    <code class="nx">edit</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
    <code class="nx">data</code><code class="p">,</code>
  <code class="p">});</code>
  <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">preSearchData</code><code class="p">[</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">edit</code><code class="p">.</code><code class="nx">row</code><code class="p">][</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">edit</code><code class="p">.</code><code class="nx">column</code><code class="p">]</code> <code class="o">=</code>
      <code class="nx">input</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>See <em>03.10.table-search.html</em> in the book’s repo for the complete code.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Can You Improve the Search?"><div class="sect2" id="idm45779446741888">
<h2>Can You Improve the Search?</h2>

<p>This was a <a data-type="indexterm" data-primary="Excel component, class" data-secondary="improving" id="idm45779446574448"/>simple working example for illustration. Can you improve the feature?</p>

<p>Try to implement an <em>additive search</em> in multiple boxes, filtering the already filtered data. If the user types “Eng” in the language row and then searches using a different search box, why not search in the search results of the previous search only? How would you implement this feature?</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Instant Replay"><div class="sect1" id="idm45779447931696">
<h1>Instant Replay</h1>

<p>As you know now, your <a data-type="indexterm" data-primary="Excel component, class" data-secondary="replay/undo feature with" id="ch3_term66"/><a data-type="indexterm" data-primary="replay feature" id="ch3_term67"/>components worry about their state and let React render and rerender whenever appropriate. This <a data-type="indexterm" data-primary="debugging" id="idm45779446567728"/>means that given the same data (state and properties), the application will look exactly the same, no matter what changed before or after this particular data state. This gives you a great debugging-in-the-wild <span class="keep-together">opportunity</span>.</p>

<p>Imagine someone <a data-type="indexterm" data-primary="bug report feature" id="idm45779446565568"/><a data-type="indexterm" data-primary="this.props object" id="idm45779446564832"/><a data-type="indexterm" data-primary="this.state object" id="idm45779446564160"/><a data-type="indexterm" data-primary="undo/redo feature" id="idm45779446563488"/>encounters a bug while using your app—they can click a button to report the bug without needing to explain what happened. The bug report can just send you back a copy of <code>this.state</code> and <code>this.props</code>, and you should be able to re-create the exact application state and see the visual result.</p>

<p>An “undo” could be another feature, since React renders your app the same way given the same props and state. In fact, the “undo” implementation is somewhat trivial: you just need to go back to the previous state.</p>

<p>Let’s take that idea a bit further, just for fun. Let’s <a data-type="indexterm" data-primary="logging state of components" id="ch3_term60"/><a data-type="indexterm" data-primary="logSetState() method" id="ch3_term61"/><a data-type="indexterm" data-primary="replay() function" id="ch3_term62"/><a data-type="indexterm" data-primary="setState()" id="ch3_term63"/><a data-type="indexterm" data-primary="this.log array" id="ch3_term64"/><a data-type="indexterm" data-primary="this.setState() method/function" id="ch3_term65"/>record each state change in the <code>Excel</code> component and then replay it. It’s fascinating to watch all your actions played back in front of you. The question of <em>when</em> the change occurred is not that important, so let’s “play” the app state changes at 1-second intervals.</p>

<p>To implement this feature, you need to add a <code>logSetState()</code> method which first logs the new state to a <code>this.log</code> array and then calls <code>setState()</code>. Everywhere in the code you called <code>setState()</code> should now be changed to call <code>logSetState()</code>. First, search and replace all calls to <code>setState()</code> with calls to the new function.</p>

<p>All calls to…</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">(...);</code></pre>

<p>…become:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">this</code><code class="p">.</code><code class="nx">logSetState</code><code class="p">(...);</code></pre>

<p>Now let’s move on to the constructor. You need to bind the two new functions, <code>logSetState()</code> and <code>replay()</code>, declare <code>this.log</code> array, and assign the initial state to it.</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">constructor</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// ...</code>

  <code class="c1">// log the initial state</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">log</code> <code class="o">=</code> <code class="p">[</code><code class="nx">clone</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">)];</code>

  <code class="c1">// ...</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">replay</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">replay</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">logSetState</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">logSetState</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The <code>logSetState</code> needs to do two things: log the new state and then pass it over to <code>setState()</code>. Here’s one example implementation where you make a deep copy of the state and append it to <code>this.log</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">logSetState</code><code class="p">(</code><code class="nx">newState</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// remember the old state in a clone</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">log</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">clone</code><code class="p">(</code><code class="nx">newState</code><code class="p">));</code>
  <code class="c1">// now set it</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">(</code><code class="nx">newState</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>Now that all state changes are logged, let’s play them back. To <a data-type="indexterm" data-primary="componentDidMount() method" id="idm45779446406736"/><a data-type="indexterm" data-primary="event listeners" id="idm45779446406032"/>trigger the playback, let’s add a simple event listener that captures keyboard actions and invokes the <code>replay()</code> function. The place for events listeners like this is in the <code>componentDidMount()</code> lifecycle method:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">componentDidMount</code><code class="p">()</code> <code class="p">{</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="nx">e</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">altKey</code> <code class="o">&amp;&amp;</code> <code class="nx">e</code><code class="p">.</code><code class="nx">shiftKey</code> <code class="o">&amp;&amp;</code> <code class="nx">e</code><code class="p">.</code><code class="nx">keyCode</code> <code class="o">===</code> <code class="mi">82</code><code class="p">)</code> <code class="p">{</code>
      <code class="c1">// ALT+SHIFT+R(eplay)</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">replay</code><code class="p">();</code>
    <code class="p">}</code>
  <code class="p">});</code>
<code class="p">}</code></pre>

<p>Finally, consider <a data-type="indexterm" data-primary="setInterval() function" id="ch3_term68"/>the <code>replay()</code> method. It uses <code>setInterval()</code> and once per second it reads the next object from the log and passes it to <code>setState()</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">replay</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">log</code><code class="p">.</code><code class="nx">length</code> <code class="o">===</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">warn</code><code class="p">(</code><code class="s1">'No state changes to replay yet'</code><code class="p">);</code>
    <code class="k">return</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="kd">let</code> <code class="nx">idx</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">interval</code> <code class="o">=</code> <code class="nx">setInterval</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">++</code><code class="nx">idx</code> <code class="o">===</code> <code class="k">this</code><code class="p">.</code><code class="nx">log</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
      <code class="c1">// the end</code>
      <code class="nx">clearInterval</code><code class="p">(</code><code class="nx">interval</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">log</code><code class="p">[</code><code class="nx">idx</code><code class="p">]);</code>
  <code class="p">},</code> <code class="mi">1000</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>And with this, the new feature is complete (<em>03.11.table-replay.html</em> in the repo). Play around with the component, sort, edit… Then press Alt+Shift+R (or Option-Shift-R on Mac) to see the past unfold <a data-type="indexterm" data-startref="ch3_term60" id="idm45779446303616"/><a data-type="indexterm" data-startref="ch3_term61" id="idm45779446193360"/><a data-type="indexterm" data-startref="ch3_term62" id="idm45779446192752"/><a data-type="indexterm" data-startref="ch3_term63" id="idm45779446192112"/><a data-type="indexterm" data-startref="ch3_term64" id="idm45779446191440"/><a data-type="indexterm" data-startref="ch3_term65" id="idm45779446190768"/>before you.</p>








<section data-type="sect2" data-pdf-bookmark="Cleaning Up Event Handlers"><div class="sect2" id="idm45779446189840">
<h2>Cleaning Up Event Handlers</h2>

<p>The replay <a data-type="indexterm" data-primary="cleanup work" id="ch3_term69"/><a data-type="indexterm" data-primary="events handlers" id="ch3_term70"/>feature needs a bit of cleanup. When this component is the only thing happening on the page, cleanup isn’t necessary; in a real application, components get added and removed from the DOM more frequently. When removing from the DOM a “good citizen” component should clean up after itself. In the example above there are <a data-type="indexterm" data-primary="event listeners" id="idm45779446185520"/><a data-type="indexterm" data-primary="keydown event listener" id="idm45779446184848"/><a data-type="indexterm" data-primary="callbacks" data-secondary="interval" id="ch3_term71"/><a data-type="indexterm" data-primary="interval callbacks" id="ch3_term72"/><a data-type="indexterm" data-primary="memory leaks" id="ch3_term73"/><a data-type="indexterm" data-primary="replay interval callbacks" id="ch3_term74"/>two items that need cleaning up: the <code>keydown</code> event listener and the replay interval callback.</p>

<p>If you don’t clean up the <code>keydown</code> event listener function, it will linger on in memory after the component is gone. And because it’s using <code>this</code>, the whole <code>Excel</code> instance needs to be retained in memory. This is in effect a memory leak. Too many of those and the user may run out of memory and your application may crash the browser tab. As to the interval, well, the callback function will continue executing after the component is gone and cause another memory leak. The callback will also attempt to call <code>setState()</code> on a non-existing component (which React handles gracefully by giving you a warning).</p>

<p>You can test the latter behavior by removing the component from the DOM while the replay is still going. To <a data-type="indexterm" data-primary="Hello World app" id="idm45779446176512"/>remove the component from the DOM you can just replace it (e.g., run the “Hello world” from <a data-type="xref" href="ch01.xhtml#ch1">Chapter 1</a> in the console):</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code>
  <code class="nx">React</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'h1'</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="s1">'Hello world!'</code><code class="p">),</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'app'</code><code class="p">),</code>
<code class="p">);</code></pre>

<p>You can also log a timestamp to the console in the interval callback to see that it keeps on being executed.</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">interval</code> <code class="o">=</code> <code class="nx">setInterval</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// ...</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">());</code>
  <code class="c1">// ...</code>
<code class="p">},</code> <code class="mi">1000</code><code class="p">);</code></pre>

<p>Now when you <a data-type="indexterm" data-startref="ch3_term68" id="idm45779446111328"/>replace the component during replay, you see an error from React and the timestamps of the interval callback still being logged as evidence that the callback is still running (as shown in <a data-type="xref" href="#FIG0313">Figure 3-13</a>).</p>

<figure><div id="FIG0313" class="figure">
<img src="Images/rur2_0313.png" alt="rur2 0313" width="600" height="435"/>
<h6><span class="label">Figure 3-13. </span>Memory leak in action</h6>
</div></figure>

<p>Similarly, you can <a data-type="indexterm" data-primary="event listeners" id="idm45779446107312"/>test the event listener memory leak by pressing Alt+Shift+R after the component has been removed from the DOM.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Cleaning Solution"><div class="sect2" id="idm45779446189216">
<h2>Cleaning Solution</h2>

<p>Taking care of these memory leaks is fairly straightforward. You need to keep references to the handlers and intervals/timeouts you want to clean up. <a data-type="indexterm" data-primary="componentWillUnmount() method" id="idm45779446104464"/>Then clean them up in <code>componentWillUnmount()</code>.</p>

<p>For the event handler, have it as a class method, as <a data-type="indexterm" data-primary="inline event handlers" id="idm45779446102704"/><a data-type="indexterm" data-primary="inline functions" id="idm45779446075344"/>opposed to an inline function:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">keydownHandler</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">altKey</code> <code class="o">&amp;&amp;</code> <code class="nx">e</code><code class="p">.</code><code class="nx">shiftKey</code> <code class="o">&amp;&amp;</code> <code class="nx">e</code><code class="p">.</code><code class="nx">keyCode</code> <code class="o">===</code> <code class="mi">82</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// ALT+SHIFT+R(eplay)</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">replay</code><code class="p">();</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>Then <code>componentDidMount()</code> becomes <a data-type="indexterm" data-primary="componentDidMount() method" id="idm45779446050768"/>the simpler:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">componentDidMount</code><code class="p">()</code> <code class="p">{</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="k">this</code><code class="p">.</code><code class="nx">keydownHandler</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>For the interval replay ID, have it as a class property as opposed to a local variable:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">this</code><code class="p">.</code><code class="nx">replayID</code> <code class="o">=</code> <code class="nx">setInterval</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="o">++</code><code class="nx">idx</code> <code class="o">===</code> <code class="k">this</code><code class="p">.</code><code class="nx">log</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// the end</code>
    <code class="nx">clearInterval</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">replayID</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">log</code><code class="p">[</code><code class="nx">idx</code><code class="p">]);</code>
<code class="p">},</code> <code class="mi">1000</code><code class="p">);</code></pre>

<p>You need to, of course, <a data-type="indexterm" data-primary="constructor()" id="idm45779446002368"/>bind the new method and add the new property in the <span class="keep-together">constructor</span>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">constructor</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// ...</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">replayID</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>

  <code class="c1">// ...</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">keydownHandler</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">keydownHandler</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>And, finally, the <a data-type="indexterm" data-primary="componentWillUnmount() method" id="idm45779445884384"/>cleanup in the <code>componentWillUnmount()</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">componentWillUnmount</code><code class="p">()</code> <code class="p">{</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">removeEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="k">this</code><code class="p">.</code><code class="nx">keydownHandler</code><code class="p">);</code>
  <code class="nx">clearInterval</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">replayID</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>Now all the leaks are plugged (See <em>03.12.table-replay-clean.html</em> in the book’s <span class="keep-together">repository</span>).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Can You Improve the Replay?"><div class="sect2" id="idm45779446105728">
<h2>Can You Improve the Replay?</h2>

<p>How about implementing an undo/redo feature? Say, when the <a data-type="indexterm" data-startref="ch3_term66" id="idm45779445832400"/><a data-type="indexterm" data-startref="ch3_term67" id="idm45779445831696"/><a data-type="indexterm" data-startref="ch3_term69" id="idm45779445831024"/><a data-type="indexterm" data-startref="ch3_term70" id="idm45779445830352"/><a data-type="indexterm" data-startref="ch3_term71" id="idm45779445829680"/><a data-type="indexterm" data-startref="ch3_term72" id="idm45779445829008"/><a data-type="indexterm" data-startref="ch3_term73" id="idm45779445828336"/><a data-type="indexterm" data-startref="ch3_term74" id="idm45779445827664"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="improving" id="idm45779445826992"/><a data-type="indexterm" data-primary="undo/redo feature" id="idm45779445826048"/>person uses the <span class="keep-together">Alt+Z</span> keyboard shortcut, you go back one step in the state log and on Alt+Shift+Z you go forward.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="An Alternative Implementation?"><div class="sect2" id="idm45779445797504">
<h2>An Alternative Implementation?</h2>

<p>Is there another way to implement replay/undo functionality  without changing all your <code>setState()</code> calls? Maybe use an appropriate lifecycle method (<a data-type="xref" href="ch02.xhtml#ch2">Chapter 2</a>)? Try this on your own.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Download the Table Data"><div class="sect1" id="idm45779446571168">
<h1>Download the Table Data</h1>

<p>After all the <a data-type="indexterm" data-primary="downloading table data" id="ch3_term76"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="downloading" id="ch3_term77"/>sorting, editing, and searching, the user is finally happy with the state of the data in the table. It would be nice if they could download the data, the result of all their labor, to use at a later time.</p>

<p>Luckily, there’s nothing easier in React. All you <a data-type="indexterm" data-primary="JSON" id="idm45779445790800"/><a data-type="indexterm" data-primary="this.state object" data-secondary="this.state.data" id="idm45779445790096"/><a data-type="indexterm" data-primary="comma-separated value (CSV)" id="ch3_term78"/><a data-type="indexterm" data-primary="CSV (comma-separated value)" id="ch3_term79"/>need to do is grab the current <code>this.state.data</code> and give it back—for example in JSON or comma-separated value (CSV) format.</p>

<p><a data-type="xref" href="#FIG0314">Figure 3-14</a> shows the end result when a user clicks “Export CSV,” downloads the file called <em>data.csv</em> (see the bottom left of the browser window), and opens this file in Numbers (on a Mac, or Microsoft Excel on a PC or Mac).</p>

<figure><div id="FIG0314" class="figure">
<img src="Images/rur2_0314.png" alt="rur2 0314" width="600" height="328"/>
<h6><span class="label">Figure 3-14. </span>Export table data to Numbers via CSV</h6>
</div></figure>

<p>The first thing to do is add new options to the toolbar (where the Search button is). Let’s use some HTML magic that forces <code>&lt;a&gt;</code> links to trigger file downloads, so the new “buttons” have to be links disguised as buttons with some CSS:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"toolbar"</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">toggleSearch</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">search</code> <code class="o">?</code> <code class="s1">'Hide search'</code> <code class="o">:</code> <code class="s1">'Show search'</code><code class="p">}</code>
  <code class="o">&lt;/</code><code class="nx">button</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">a</code> <code class="nx">href</code><code class="o">=</code><code class="s2">"data.json"</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">downloadJSON</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="nx">Export</code> <code class="nx">JSON</code>
  <code class="o">&lt;/</code><code class="nx">a</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">a</code> <code class="nx">href</code><code class="o">=</code><code class="s2">"data.csv"</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">downloadCSV</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="nx">Export</code> <code class="nx">CSV</code>
  <code class="o">&lt;/</code><code class="nx">a</code><code class="o">&gt;</code>
<code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code></pre>

<p>As you <a data-type="indexterm" data-primary="downloadCSV() method" id="idm45779445781072"/><a data-type="indexterm" data-primary="downloadJSON() method" id="idm45779445780464"/>see, you need <code>downloadJSON()</code> and <code>downloadCSV()</code> methods. These <a data-type="indexterm" data-primary="download() method" id="ch3_term80"/>have some repeating logic, so they can be done by a single <code>download()</code> function bound with the <code>format</code> (meaning file type) argument. The <code>download()</code> method’s signature could be like:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">download</code><code class="p">(</code><code class="nx">format</code><code class="p">,</code> <code class="nx">ev</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// TODO: implement me</code>
<code class="p">}</code></pre>

<p>In the constructor you can bind this method twice, like so:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">this</code><code class="p">.</code><code class="nx">downloadJSON</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">download</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="s1">'json'</code><code class="p">);</code>
<code class="k">this</code><code class="p">.</code><code class="nx">downloadCSV</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">download</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="s1">'csv'</code><code class="p">);</code></pre>

<p>All the React work is done. Now for the <code>download()</code> function. While exporting to JSON is trivial, CSV needs a little bit more work. In essence, it’s just a loop over all rows and all cells in a row, producing a long string. Once this is done, the function initiates the downloads via the <code>download</code> attribute and the <code>href</code> blob created by <span class="keep-together"><code>window.URL</code></span>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">download</code><code class="p">(</code><code class="nx">format</code><code class="p">,</code> <code class="nx">ev</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">).</code><code class="nx">map</code><code class="p">(</code><code class="nx">row</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">row</code><code class="p">.</code><code class="nx">pop</code><code class="p">();</code> <code class="c1">// drop the last column, the recordId</code>
    <code class="k">return</code> <code class="nx">row</code><code class="p">;</code>
  <code class="p">});</code>
  <code class="kr">const</code> <code class="nx">contents</code> <code class="o">=</code>
    <code class="nx">format</code> <code class="o">===</code> <code class="s1">'json'</code>
      <code class="o">?</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="s1">'  '</code><code class="p">)</code>
      <code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">reduce</code><code class="p">((</code><code class="nx">result</code><code class="p">,</code> <code class="nx">row</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">return</code> <code class="p">(</code>
            <code class="nx">result</code> <code class="o">+</code>
            <code class="nx">row</code><code class="p">.</code><code class="nx">reduce</code><code class="p">((</code><code class="nx">rowcontent</code><code class="p">,</code> <code class="nx">cellcontent</code><code class="p">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="kr">const</code> <code class="nx">cell</code> <code class="o">=</code> <code class="nx">cellcontent</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/"/g</code><code class="p">,</code> <code class="s1">'""'</code><code class="p">);</code>
              <code class="kr">const</code> <code class="nx">delimiter</code> <code class="o">=</code> <code class="nx">idx</code> <code class="o">&lt;</code> <code class="nx">row</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code> <code class="o">?</code> <code class="s1">','</code> <code class="o">:</code> <code class="s1">''</code><code class="p">;</code>
              <code class="k">return</code> <code class="sb">`</code><code class="si">${</code><code class="nx">rowcontent</code><code class="si">}</code><code class="sb">"</code><code class="si">${</code><code class="nx">cellcontent</code><code class="si">}</code><code class="sb">"</code><code class="si">${</code><code class="nx">delimiter</code><code class="si">}</code><code class="sb">`</code><code class="p">;</code>
            <code class="p">},</code> <code class="s1">''</code><code class="p">)</code> <code class="o">+</code>
            <code class="s1">'\n'</code>
          <code class="p">);</code>
        <code class="p">},</code> <code class="s1">''</code><code class="p">);</code>

  <code class="kr">const</code> <code class="nx">URL</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">URL</code> <code class="o">||</code> <code class="nb">window</code><code class="p">.</code><code class="nx">webkitURL</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">blob</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Blob</code><code class="p">([</code><code class="nx">contents</code><code class="p">],</code> <code class="p">{</code><code class="nx">type</code><code class="o">:</code> <code class="s1">'text/'</code> <code class="o">+</code> <code class="nx">format</code><code class="p">});</code>
  <code class="nx">ev</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">href</code> <code class="o">=</code> <code class="nx">URL</code><code class="p">.</code><code class="nx">createObjectURL</code><code class="p">(</code><code class="nx">blob</code><code class="p">);</code>
  <code class="nx">ev</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">download</code> <code class="o">=</code> <code class="s1">'data.'</code> <code class="o">+</code> <code class="nx">format</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>The complete <a data-type="indexterm" data-startref="ch3_term76" id="idm45779445612000"/><a data-type="indexterm" data-startref="ch3_term77" id="idm45779445611504"/><a data-type="indexterm" data-startref="ch3_term78" id="idm45779445610864"/><a data-type="indexterm" data-startref="ch3_term79" id="idm45779445610192"/><a data-type="indexterm" data-startref="ch3_term80" id="idm45779445333264"/>code is in <em>03.13.table-download.html</em> in the repo.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Fetching Data"><div class="sect1" id="idm45779445794800">
<h1>Fetching Data</h1>

<p>All through the chapter, the <code>Excel</code> component had access to the <code>data</code> in the same file. But what if the <a data-type="indexterm" data-primary="componentDidMount() method" id="ch3_term81"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="fetching data for" id="ch3_term82"/><a data-type="indexterm" data-primary="fetching table data" id="ch3_term83"/>data lives elsewhere, on a server, and needs to be fetched? There are various solutions to this and you’ll see more later in the book, but let’s try one of the simplest—fetching the data in <code>componentDidMount()</code>.</p>

<p>Let’s say the <code>Excel</code> component is <a data-type="indexterm" data-primary="data" data-secondary="initial" id="idm45779445324608"/><a data-type="indexterm" data-primary="initialData prop" id="idm45779445323792"/><a data-type="indexterm" data-primary="Excel component, class" data-secondary="and data, initial" data-secondary-sortas="data, initial" id="idm45779445323184"/>created with an empty <code>initialData</code> property:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">Excel</code> <code class="nx">headers</code><code class="o">=</code><code class="p">{</code><code class="nx">headers</code><code class="p">}</code> <code class="nx">initialData</code><code class="o">=</code><code class="p">{[]}</code> <code class="o">/&gt;</code><code class="p">,</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'app'</code><code class="p">),</code>
<code class="p">);</code></pre>

<p>The component can <a data-type="indexterm" data-primary="render() method/function" id="idm45779445302448"/>gracefully render an intermediate state to let the user know that data is coming. In the <code>render()</code> method you can have a condition and render a different table body if data is not there:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">length</code> <code class="o">===</code> <code class="mi">0</code> <code class="o">?</code> <code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">tbody</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">colSpan</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">props</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">length</code><code class="p">}</code><code class="o">&gt;</code>
        <code class="nx">Loading</code> <code class="nx">data</code><code class="p">...</code>
      <code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
  <code class="o">&lt;/</code><code class="nx">tbody</code><code class="o">&gt;</code>
<code class="p">)</code> <code class="o">:</code> <code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">tbody</code> <code class="nx">onDoubleClick</code><code class="o">=</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">showEditor</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="p">{</code><code class="cm">/* ... same as before ...*/</code><code class="p">}</code>
  <code class="o">&lt;/</code><code class="nx">tbody</code><code class="o">&gt;</code>
<code class="p">)}</code></pre>

<p>While waiting for the data, the user sees a <a data-type="indexterm" data-primary="“loading data” indicator" data-primary-sortas="loading data indicator" id="idm45779445297024"/>loading indicator (as in <a data-type="xref" href="#FIG0315">Figure 3-15</a>), in this case a simple text, though you can have an animation if you like.</p>

<figure><div id="FIG0315" class="figure">
<img src="Images/rur2_0315.png" alt="rur2 0315" width="600" height="213"/>
<h6><span class="label">Figure 3-15. </span>Waiting for the data to be fetched</h6>
</div></figure>

<p>Now let’s <a data-type="indexterm" data-primary="Fetch API" id="idm45779445168080"/><a data-type="indexterm" data-primary="IDs" data-secondary="data table record" id="idm45779445167376"/><a data-type="indexterm" data-primary="record IDs in data tables" id="idm45779445166400"/>fetch the data. Using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a>, make a request to a server and once <span class="keep-together">the response</span> arrives, set the state with the new data. You also need to take care of adding the record ID, which was previously the job of the constructor. The updated <span class="keep-together"><code>componentDidMount()</code></span> can look like:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">componentDidMount</code><code class="p">()</code> <code class="p">{</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="k">this</code><code class="p">.</code><code class="nx">keydownHandler</code><code class="p">);</code>
  <code class="nx">fetch</code><code class="p">(</code><code class="s1">'https://www.phpied.com/files/reactbook/table-data.json'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">((</code><code class="nx">response</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">response</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">((</code><code class="nx">initialData</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">initialData</code><code class="p">).</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="p">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="nx">row</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">idx</code><code class="p">);</code>
        <code class="k">return</code> <code class="nx">row</code><code class="p">;</code>
      <code class="p">});</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code><code class="nx">data</code><code class="p">});</code>
    <code class="p">});</code>
<code class="p">}</code></pre>

<p>The complete <a data-type="indexterm" data-startref="ch3_term1" id="idm45779445162944"/><a data-type="indexterm" data-startref="ch3_term81" id="idm45779445162336"/><a data-type="indexterm" data-startref="ch3_term82" id="idm45779445057552"/><a data-type="indexterm" data-startref="ch3_term83" id="idm45779445056880"/>code is in <em>03.14.table-fetch.html</em> in the repo.</p>
</div></section>







</div></section></div></body>
</html>