<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 8. Advanced Topics" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_Advanced_Topics">
<h1><span class="label">Chapter 8. </span>Advanced Topics</h1>
<p>In the previous chapter, you had an overview of implementing GitOps workflows using Argo CD recipes. Argo CD is a famous and influential open source project that helps with both simple use cases and more advanced ones. In this chapter, we will discuss topics needed when you move forward in your GitOps journey, and you need to manage security, automation, and advanced deployment models for multicluster scenarios.</p>
<p>Security is a critical aspect of automation and DevOps. <a data-primary="DevSecOps" data-type="indexterm" id="idm45120822231632"/>DevSecOps is a new definition of an approach where security is a shared responsibility throughout the entire IT lifecycle. Furthermore, the <a href="https://www.devsecops.org">DevSecOps Manifesto</a> specifies security as code to operate and contribute value with less friction. And this goes in the same direction as GitOps principles, where everything is declarative.</p>
<p>On the other hand, this also poses the question of avoiding storing unencrypted plain-text credentials in Git. As stated in the book <em>Path to GitOps</em> by Christian Hernandez, Argo CD <a data-primary="Argo CD" data-secondary="security management, GitOps workflows" data-type="indexterm" id="idm45120822229344"/><a data-primary="security, GitOps workflows" data-type="indexterm" id="idm45120822228400"/><a data-primary="GitOps" data-secondary="security" data-type="indexterm" id="idm45120822227760"/>luckily currently provides two patterns to manage security in GitOps workflows:</p>
<ul>
<li>
<p>Storing encrypted secrets in Git, such as with a Sealed Secret (see <a data-type="xref" href="#recipe_8_1">Recipe 8.1</a>)</p>
</li>
<li>
<p>Storing secrets in external services or vaults, then storing only the reference to such secrets in Git (see <a data-type="xref" href="#recipe_8_2">Recipe 8.2</a>)</p>
</li>
</ul>
<p>The chapter then moves to advanced deployment techniques, showing how to manage webhooks with Argo CD (see <a data-type="xref" href="#recipe_8_3">Recipe 8.3</a>) and with ApplicationSets (see <a data-type="xref" href="#recipe_8_4">Recipe 8.4</a>). ApplicationSets <a data-primary="ApplicationSets" data-type="indexterm" id="idm45120822206304"/><a data-primary="Argo CD" data-secondary="ApplicationSets" data-type="indexterm" id="idm45120822205600"/>is a component of Argo CD that allows management deployments of many applications, repositories, or clusters from a single Kubernetes resource. In essence, a templating system for the GitOps application is ready to be deployed and synced in multiple Kubernetes clusters (see <a data-type="xref" href="#recipe_8_5">Recipe 8.5</a>).</p>
<p>Last but not least, the book ends with a recipe on Progressive Delivery for Kubernetes with <a data-primary="Argo Rollouts" data-type="indexterm" id="idm45120822191008"/>Argo Rollouts (<a data-type="xref" href="#recipe_8_6">Recipe 8.6</a>), useful for deploying the application using an advanced deployment technique such as blue-green or canary.</p>
<section data-pdf-bookmark="8.1 Encrypt Sensitive Data (Sealed Secrets)" data-type="sect1"><div class="sect1" id="recipe_8_1">
<h1>8.1 Encrypt Sensitive Data (Sealed Secrets)</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120822188160">
<h2>Problem</h2>
<p>You want to manage <a data-primary="Kubernetes Secrets" data-secondary="managing" data-type="indexterm" id="KSec_manage"/><a data-primary="Git" data-secondary="managing Kubernetes Secrets" data-type="indexterm" id="Git_KSec_manage"/>Kubernetes Secrets and encrypted objects in Git.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120822184080">
<h2>Solution</h2>
<p><a href="https://oreil.ly/MWTNB">Sealed Secrets</a> <a data-primary="Sealed Secrets" data-type="indexterm" id="idm45120822181568"/>is an open source project by Bitnami used to encrypt a Kubernetes Secrets into a <code>SealedSecret</code> Kubernetes Custom Resource, representing an encrypted object safe to store in Git.</p>
<p>Sealed Secrets uses public-key cryptography and consists of two main components:</p>
<ul>
<li>
<p>A Kubernetes controller that has knowledge about the private and public key used to decrypt and encrypt encrypted secrets and is responsible for reconciliation. The controller also supports automatic secret rotation for the private key and key expiration management in order to enforce the re-encryption of secrets.</p>
</li>
<li>
<p><code>kubeseal</code>, a CLI used by developers to encrypt their secrets before committing them to a Git repository.</p>
</li>
</ul>
<p>The <code>SealedSecret</code> object is encrypted and decrypted only by the <code>SealedSecret</code> controller running in the target Kubernetes cluster. This operation is exclusive only to this component, thus nobody else can decrypt the object. The <code>kubeseal</code> CLI allows the developer to take a normal Kubernetes Secret resource and convert it to a <code>SealedSecret</code> resource definition as shown in <a data-type="xref" href="#fig8-1">Figure 8-1</a>.</p>
<p>In your Kubernetes cluster <a data-primary="Sealed Secrets" data-secondary="installing" data-type="indexterm" id="idm45120822173792"/><a data-primary="Argo CD" data-secondary="Sealed Secrets, installing" data-type="indexterm" id="idm45120822172784"/>with Argo CD, you can install the <code>kubeseal</code> CLI for your operating system from the <a href="https://oreil.ly/zmEh3">GitHub project’s releases</a>. At the time of writing this book, we are using version 0.18.2.</p>
<div data-type="tip"><h6>Tip</h6>
<p>On macOS, <code>kubeseal</code> is available through <a href="https://brew.sh">Homebrew</a> as follows:</p>
<pre data-type="programlisting">brew install kubeseal</pre>
</div>
<figure><div class="figure" id="fig8-1">
<img alt="Sealed Secrets with GitOps" height="793" src="assets/gocb_0801.png" width="1124"/>
<h6><span class="label">Figure 8-1. </span>Sealed Secrets with GitOps</h6>
</div></figure>
<p>After you install the CLI, you can install the controller as follows:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create <code class="se">\</code>
-f https://github.com/bitnami-labs/sealed-secrets/releases/download/0.18.2/controller.yaml</pre>
<p>You should have output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">serviceaccount/sealed-secrets-controller created
deployment.apps/sealed-secrets-controller created
customresourcedefinition.apiextensions.k8s.io/sealedsecrets.bitnami.com created
service/sealed-secrets-controller created
rolebinding.rbac.authorization.k8s.io/sealed-secrets-controller created
rolebinding.rbac.authorization.k8s.io/sealed-secrets-service-proxier created
role.rbac.authorization.k8s.io/sealed-secrets-service-proxier created
role.rbac.authorization.k8s.io/sealed-secrets-key-admin created
clusterrolebinding.rbac.authorization.k8s.io/sealed-secrets-controller created
clusterrole.rbac.authorization.k8s.io/secrets-unsealer created</pre>
<p>As an example, let’s create a <a data-primary="Sealed Secrets" data-secondary="Secrets, creating" data-type="indexterm" id="SS_sec_creat"/>Secret for the Pac-Man game deployed in <a data-type="xref" href="ch05.xhtml#ch_Helm">Chapter 5</a>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create secret generic pacman-secret <code class="se">\</code>
--from-literal<code class="o">=</code><code class="nv">user</code><code class="o">=</code>pacman <code class="se">\</code>
--from-literal<code class="o">=</code><code class="nv">pass</code><code class="o">=</code>pacman</pre>
<p>You should have the following output:</p>
<pre data-code-language="bash" data-type="programlisting">secret/pacman-secret created</pre>
<p>And here you can see the YAML representation:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get secret pacman-secret  -o yaml</pre>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">data</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">pass</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cGFjbWFu</code><code class="w"/>
<code class="w">  </code><code class="nt">user</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cGFjbWFu</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Secret</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman-secret</code><code class="w"/>
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"/>
<code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Opaque</code><code class="w"/></pre>
<p>Now, you can convert the Secret into a <code>SealedSecret</code> in this way:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get secret pacman-secret -o yaml <code class="se">\</code>
<code class="p">|</code> kubeseal -o yaml &gt; pacman-sealedsecret.yaml</pre>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bitnami.com/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">SealedSecret</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">creationTimestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman-secret</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">encryptedData</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO1-1" id="co_advanced_topics_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">pass</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">AgBJR1AgZ5Gu5NOVsG1E8SKBcdB3QSDdzZka3RRYuWV7z8g7ccQ0dGc1suVOP8wX/ZpPmIMp8+urPYG62k4EZRUjuu/Vg2E1nSbsGBh9eKu3NaO6tGSF3eGk6PzN6XtRhDeER4u7MG5pj/+FXRAKcy8Z6RfzbVEGq/QJQ4z0ecSNdJmG07ERMm1Q+lPNGvph2Svx8aCgFLqRsdLhFyvwbTyB3XnmFHrPr+2DynxeN8XVMoMkRYXgVc6GAoxUK7CnC3Elpuy7lIdPwc5QBx9kUVfra83LX8/KxeaJwyCqvscIGjtcxUtpTpF5jm1t1DSRRNbc4m+7pTwTmnRiUuaMVeujaBco4521yTkh5iEPjnjvUt+VzK01NVoeNunqIazp15rFwTvmiQ5PAtbiUXpT733zCr60QBgSxPg31vw98+u+RcIHvaMIoDCqaXxUdcn2JkUF+bZXtxNmIRTAiQVQ1vEPmrZxpvZcUh/PPC4L/RFWrQWnOzKRyqLq9wRoSLPbKyvMXnaxH0v3USGIktmtJlGjlXoW/i+HIoSeMFS0mUAzOF5M5gweOhtxKGh3Y74ZDn5PbVA/9kbkuWgvPNGDZL924Dm6AyM5goHECr/RRTm1e22K9BfPASARZuGA6paqb9h1XEqyqesZgM0R8PLiyLuu+tpqydR0SiYLc5VltdjzpIyyy9Xmw6Aa3/4SB+4tSwXSUUrB5yc=</code><code class="w">
</code><code class="w">    </code><code class="nt">user</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">AgBhYDZQzOwinetPceZL897aibTYp4QPGFvP6ZhDyuUAxOWXBQ7jBA3KPUqLvP8vBcxLAcS7HpKcDSgCdi47D2WhShdBR4jWJufwKmR3j+ayTdw72t3ALpQhTYI0iMYTiNdR0/o3vf0jeNMt/oWCRsifqBxZaIShE53rAFEjEA6D7CuCDXu8BHk1DpSr79d5Au4puzpHVODh+v1T+Yef3k7DUoSnbYEh3CvuRweiuq5lY8G0oob28j38wdyxm3GIrexa+M/ZIdO1hxZ6jz4edv6ejdZfmQNdru3c6lmljWwcO+0Ue0MqFi4ZF/YNUsiojI+781n1m3K/giKcyPLn0skD7DyeKPoukoN6W5P71OuFSkF+VgIeejDaxuA7bK3PEaUgv79KFC9aEEnBr/7op7HY7X6aMDahmLUc/+zDhfzQvwnC2wcj4B8M2OBFa2ic2PmGzrIWhlBbs1OgnpehtGSETq+YRDH0alWOdFBq1U8qn6QA8Iw6ewu8GTele3zlPLaADi5O6LrJbIZNlY0+PutWfjs9ScVVEJy+I9BGdyT6tiA/4v4cxH6ygG6NzWkqxSaYyNrWWXtLhOlqyCpTZtUwHnF+OLB3gCpDZPx+NwTe2Kn0jY0c83LuLh5PJ090AsWWqZaRQyELeL6y6mVekQFWHGfK6t57Vb7Z3+5XJCgQn+xFLkj3SIz0ME5D4+DSsUDS1fyL8uI=</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">data</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">creationTimestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman-secret</code><code class="w">
</code><code class="w">      </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Opaque</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_advanced_topics_CO1-1" id="callout_advanced_topics_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Here you find the data encrypted by the Sealed Secrets <a data-primary="Sealed Secrets" data-secondary="Secrets, creating" data-startref="SS_sec_creat" data-type="indexterm" id="idm45120821845792"/>controller.</p></dd>
</dl>
<p>Now you can safely push your <code>SealedSecret</code> to your Kubernetes manifests repo and create the Argo CD application. Here’s <a data-primary="Git" data-secondary="managing Kubernetes Secrets" data-startref="Git_KSec_manage" data-type="indexterm" id="idm45120821867904"/>an example from <a href="https://oreil.ly/TXHRa">this book’s repository</a>:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app create pacman <code class="se">\</code>
--repo https://github.com/gitops-cookbook/pacman-kikd-manifests.git <code class="se">\</code>
--path <code class="s1">'k8s/sealedsecrets'</code> <code class="se">\</code>
--dest-server https://kubernetes.default.svc <code class="se">\</code>
--dest-namespace default <code class="se">\</code>
--sync-policy auto</pre>
<p>Check if the app is running and healthy:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app list</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME    CLUSTER                         NAMESPACE  PROJECT  STATUS  HEALTH ↳
 SYNCPOLICY  CONDITIONS  REPO                                                           PATH TARGET
pacman  https://kubernetes.default.svc  default    default  Synced  Healthy↳
 &lt;none&gt;      &lt;none&gt;      https://github.com/gitops-cookbook/pacman-kikd-manifests.git  k8s/sealedsecrets</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="8.2 Encrypt Secrets with ArgoCD (ArgoCD + HashiCorp Vault + External Secret)" data-type="sect1"><div class="sect1" id="recipe_8_2">
<h1>8.2 Encrypt Secrets with ArgoCD (ArgoCD + HashiCorp Vault + External Secret)</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120822182912">
<h2>Problem</h2>
<p>You want to avoid storing <a data-primary="secrets" data-secondary="encrypting with Argo CD" data-type="indexterm" id="sec_encrypt_Argo"/><a data-primary="Argo CD" data-secondary="secrets, encrypting" data-type="indexterm" id="Argo_sec_encrypt"/><a data-primary="credentials" data-secondary="managing in external resources" data-type="indexterm" id="cred_manag_extresourc"/><a data-primary="External Secrets, managing credentials" data-type="indexterm" id="ExtSec_managcred"/>credentials in Git and you want to manage them in external services or vaults.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120821794400">
<h2>Solution</h2>
<p>In <a data-type="xref" href="#recipe_8_1">Recipe 8.1</a> you saw how to manage encrypted data in Git following the GitOps declarative way, but how do you avoid storing even encrypted credentials with GitOps?</p>
<p>One solution is <a href="https://oreil.ly/ytBeU">External Secrets</a>, an open source project initially created by GoDaddy, which aims at storing secrets in external services or vaults from different vendors, then storing only the reference to such secrets in Git.</p>
<p>Today, External Secrets supports systems such as AWS Secrets Manager, HashiCorp Vault, Google Secrets Manager, Azure Key Vault, and more. The idea is to provide a user-friendly abstraction for the external API that stores and manages the lifecycles of the secrets.</p>
<p>In depth, ExternalSecrets is a <a data-primary="Kubernetes" data-secondary="ExternalSecrets" data-type="indexterm" id="idm45120821789584"/>Kubernetes controller that reconciles Secrets into the cluster from a Custom Resource that includes a reference to a secret in an external key management system. The Custom Resource <code>SecretStore</code> specifies the backend containing the confidential data, and how it should be transformed into a Secret by defining a template, as you can see in <a data-type="xref" href="#fig8-2">Figure 8-2</a>. The SecretStore has the configuration to connect to the external secret manager.</p>
<p>Thus, the <code>ExternalSecrets</code> objects can be safely stored in Git, as they do not contain any confidential information, but just the references to the external services managing credentials.</p>
<figure><div class="figure" id="fig8-2">
<img alt="External Secrets with Argo CD" height="782" src="assets/gocb_0802.png" width="1427"/>
<h6><span class="label">Figure 8-2. </span>External Secrets with Argo CD</h6>
</div></figure>
<p>You can install External Secrets with a <a data-primary="Helm" data-secondary="Charts" data-tertiary="installing External Secrets" data-type="indexterm" id="idm45120821750800"/><a data-primary="Charts" data-secondary="External Secrets, installing" data-type="indexterm" id="idm45120821749712"/>Helm Chart as follows. At the time of writing this book, we are using version 0.5.9:</p>
<pre data-code-language="bash" data-type="programlisting">helm repo add external-secrets https://charts.external-secrets.io

helm install external-secrets <code class="se">\</code>
  external-secrets/external-secrets <code class="se">\</code>
  -n external-secrets <code class="se">\</code>
  --create-namespace</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME: external-secrets
LAST DEPLOYED: Fri Sep  <code class="m">2</code> <code class="m">13</code>:09:53 <code class="m">2022</code>
NAMESPACE: external-secrets
STATUS: deployed
REVISION: <code class="m">1</code>
TEST SUITE: None
NOTES:
external-secrets has been deployed successfully!</pre>
<p>In order to begin using ExternalSecrets, you will need to set up a <a data-primary="SecretStore resources" data-type="indexterm" id="ss_resource"/><a data-primary="ClusterSecretStore resource" data-type="indexterm" id="css_resource"/>SecretStore
or ClusterSecretStore resource (for example, by creating a <em>vault</em> SecretStore).</p>
<p>More information on the different types of SecretStores and how to configure them
can be found in our <a href="https://oreil.ly/LQzEh">GitHub page</a>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>You can also install the External Secrets Operator with OLM from <a href="https://oreil.ly/w3x71">OperatorHub.io</a>.</p>
</div>
<p>As an example with one of the providers supported, such as <a href="https://oreil.ly/sg7yS">HashiCorp Vault</a>, you can do the following.</p>
<p>First download and install <a href="https://oreil.ly/vjGSq">HashiCorp Vault</a> for your operating system and  get your <a href="https://oreil.ly/6Y5cS">Vault Token</a>. Then create a Kubernetes Secret as follows:</p>
<pre data-code-language="bash" data-type="programlisting"><code class="nb">export</code> <code class="nv">VAULT_TOKEN</code><code class="o">=</code>&lt;YOUR_TOKEN&gt;
kubectl create secret generic vault-token <code class="se">\</code>
  --from-literal<code class="o">=</code><code class="nv">token</code><code class="o">=</code><code class="nv">$VAULT_TOKEN</code> <code class="se">\</code>
  -n external-secrets</pre>
<p>Then create a <code>SecretStore</code> as a reference to this external system:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">external-secrets.io/v1beta1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">SecretStore</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">vault-secretstore</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">provider</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">vault</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">http://vault.local:8200</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO2-1" id="co_advanced_topics_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">secret</code><code class="s">"</code><code class="w">
</code><code class="w">      </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">v2</code><code class="s">"</code><code class="w">
</code><code class="w">      </code><code class="nt">auth</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">tokenSecretRef</code><code class="p">:</code><code class="w">
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">vault-token</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO2-2" id="co_advanced_topics_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">          </code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">token</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO2-3" id="co_advanced_topics_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">          </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">external-secrets</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_advanced_topics_CO2-1" id="callout_advanced_topics_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Hostname where your Vault is running</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO2-2" id="callout_advanced_topics_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Name of the Kubernetes Secret containing the vault token</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO2-3" id="callout_advanced_topics_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Key to address the value in the Kubernetes Secret containing the vault token content:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f vault-secretstore.yaml</pre></dd>
</dl>
<p>Now you can create a Secret in your Vault as follows:</p>
<pre data-code-language="bash" data-type="programlisting">vault kv put secret/pacman-secrets <code class="nv">pass</code><code class="o">=</code>pacman</pre>
<p>And then reference it from the <code>ExternalSecret</code> as follows:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">external-secrets.io/v1beta1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ExternalSecret</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman-externalsecrets</code><code class="w"/>
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">refreshInterval</code><code class="p">:</code><code class="w"> </code><code class="s">"15s"</code><code class="w"/>
<code class="w">  </code><code class="nt">secretStoreRef</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">vault-secretstore</code><code class="w"/>
<code class="w">    </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">SecretStore</code><code class="w"/>
<code class="w">  </code><code class="nt">target</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman-externalsecrets</code><code class="w"/>
<code class="w">  </code><code class="nt">data</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">secretKey</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">token</code><code class="w"/>
<code class="w">    </code><code class="nt">remoteRef</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">secret/pacman-secrets</code><code class="w"/>
<code class="w">      </code><code class="nt">property</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pass</code><code class="w"/></pre>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f pacman-externalsecrets.yaml</pre>
<p>Now you can deploy the Pac-Man game with Argo CD using External <a data-primary="SecretStore resources" data-startref="ss_resource" data-type="indexterm" id="idm45120821483488"/><a data-primary="ClusterSecretStore resource" data-startref="css_resource" data-type="indexterm" id="idm45120821375616"/><a data-primary="credentials" data-secondary="managing in external resources" data-startref="cred_manag_extresourc" data-type="indexterm" id="idm45120821378480"/><a data-primary="External Secrets, managing credentials" data-startref="ExtSec_managcred" data-type="indexterm" id="idm45120821377392"/><a data-primary="secrets" data-secondary="encrypting with Argo CD" data-startref="sec_encrypt_Argo" data-type="indexterm" id="idm45120821387392"/><a data-primary="Argo CD" data-secondary="secrets, encrypting" data-startref="Argo_sec_encrypt" data-type="indexterm" id="idm45120821386176"/>Secrets as follows:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app create pacman <code class="se">\</code>
--repo https://github.com/gitops-cookbook/pacman-kikd-manifests.git <code class="se">\</code>
--path <code class="s1">'k8s/externalsecrets'</code> <code class="se">\</code>
--dest-server https://kubernetes.default.svc <code class="se">\</code>
--dest-namespace default <code class="se">\</code>
--sync-policy auto</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="8.3 Trigger the Deployment of an Application Automatically (Argo CD Webhooks)" data-type="sect1"><div class="sect1" id="recipe_8_3">
<h1>8.3 Trigger the Deployment of an Application Automatically (Argo CD Webhooks)</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120821381408">
<h2>Problem</h2>
<p>You don’t want <a data-primary="Argo CD" data-secondary="application deployment" data-tertiary="automatic with webhooks" data-type="indexterm" id="Argo_appdeploy_webhook"/><a data-primary="applications" data-secondary="deployment" data-tertiary="automatic with webhooks" data-type="indexterm" id="app_deploy_webhook"/><a data-primary="deployment" data-secondary="automatic with webhooks" data-type="indexterm" id="deploy_webhook"/><a data-primary="webhooks" data-secondary="application deployment" data-type="indexterm" id="webhook_appdeploy"/>to wait for Argo CD syncs and you want to immediately deploy an application when a change occurs in Git.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120821306672">
<h2>Solution</h2>
<p>While Argo CD polls Git repositories every three minutes to detect changes to the monitored Kubernetes manifests, it also supports an event-driven approach with  webhooks notifications from popular Git servers such as  GitHub, GitLab, or Bitbucket.</p>
<p><a href="https://oreil.ly/3Ab46">Argo CD Webhooks</a> are enabled in your Argo CD installation and available at the endpoint <code>/api/webhooks</code>.</p>
<p>To test webhooks with Argo CD using <a data-primary="Minikube" data-secondary="application deployment, Argo CD webhooks" data-type="indexterm" id="idm45120821303136"/>Minikube you can use Helm to install a local Git server such as <a href="https://docs.gitea.io">Gitea</a>, an open source lightweight server written in Go, as follows:</p>
<pre data-code-language="bash" data-type="programlisting">helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea</pre>
<p>You should have output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">helm install gitea gitea-charts/gitea
<code class="s2">"gitea-charts"</code> has been added to your repositories
NAME: gitea
LAST DEPLOYED: Fri Sep  <code class="m">2</code> <code class="m">15</code>:04:04 <code class="m">2022</code>
NAMESPACE: default
STATUS: deployed
REVISION: <code class="m">1</code>
NOTES:
<code class="m">1</code>. Get the application URL by running these commands:
  <code class="nb">echo</code> <code class="s2">"Visit http://127.0.0.1:3000 to use your application"</code>
  kubectl --namespace default port-forward svc/gitea-http <code class="m">3000</code>:3000</pre>
<div data-type="tip"><h6>Tip</h6>
<p>Log in to the Gitea server with the default credentials you find the in the <em>values.yaml</em> file from the Helm Chart <a href="https://oreil.ly/Nkaeu">here</a> or define new ones via overriding them.</p>
</div>
<p>Import the <a href="https://oreil.ly/LwTaC">Pac-Man</a> manifests repo into Gitea.</p>
<p>Configure the Argo app:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app create pacman-webhook <code class="se">\</code>
--repo http://gitea-http.default.svc:3000/gitea_admin/pacman-kikd-manifests.git <code class="se">\</code>
--dest-server https://kubernetes.default.svc <code class="se">\</code>
--dest-namespace default <code class="se">\</code>
--path k8s <code class="se">\</code>
--sync-policy auto</pre>
<p>To add a webhook to Gitea, navigate to the top-right corner and click Settings. Select the Webhooks tab and configure it as shown in <a data-type="xref" href="#fig8-3">Figure 8-3</a>:</p>
<ul>
<li>
<p>Payload URL: <code>http://localhost:9090/api/webhooks</code></p>
</li>
<li>
<p>Content type: <code>application/json</code></p>
</li>
</ul>
<figure><div class="figure" id="fig8-3">
<img alt="Gitea Webhooks" height="883" src="assets/gocb_0803.png" width="1163"/>
<h6><span class="label">Figure 8-3. </span>Gitea Webhooks</h6>
</div></figure>
<div data-type="tip"><h6>Tip</h6>
<p>You can omit the Secret for this example; however, it’s best practice to configure secrets for your webhooks. Read more from the <a href="https://oreil.ly/udDkS">docs</a>.</p>
</div>
<p>Save it and push your change to the repo<a data-primary="Argo CD" data-secondary="application deployment" data-startref="Argo_appdeploy_webhook" data-tertiary="automatic with webhooks" data-type="indexterm" id="idm45120821217104"/><a data-primary="applications" data-secondary="deployment" data-startref="app_deploy_webhook" data-tertiary="automatic with webhooks" data-type="indexterm" id="idm45120821215584"/><a data-primary="deployment" data-secondary="automatic with webhooks" data-startref="deploy_webhook" data-type="indexterm" id="idm45120821195440"/><a data-primary="webhooks" data-secondary="application deployment" data-startref="webhook_appdeploy" data-type="indexterm" id="idm45120821194352"/> on Gitea. You will see a new sync from Argo CD immediately after your push.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="8.4 Deploy to Multiple Clusters" data-type="sect1"><div class="sect1" id="recipe_8_4">
<h1>8.4 Deploy to Multiple Clusters</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120821191584">
<h2>Problem</h2>
<p>You want to deploy <a data-primary="Argo CD" data-secondary="applications" data-tertiary="deploying to multiple clusters" data-type="indexterm" id="Argo_app_deploymulticlust"/><a data-primary="applications" data-secondary="deployment" data-tertiary="to multiple clusters" data-tertiary-sortas="multiple clusters" data-type="indexterm" id="app_deploy_Ku"/><a data-primary="deployment" data-secondary="applications" data-tertiary="to multiple clusters" data-type="indexterm" id="deploy_app_multiclust"/>an application to different clusters.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120821185104">
<h2>Solution</h2>
<p>Argo CD supports the <code>ApplicationSet</code> resource to “templetarize” an Argo CD 
<span class="keep-together"><code>Application</code></span> resource.
It covers different use cases, but the most important are:</p>
<ul>
<li>
<p>Use a Kubernetes manifest to target multiple Kubernetes clusters.</p>
</li>
<li>
<p>Deploy multiple applications from one or multiple Git repositories.</p>
</li>
</ul>
<p>Since the <code>ApplicationSet</code> is a template file with placeholders to substitute at runtime, we need to feed these with some values.
For this purpose, <code>ApplicationSet</code> has the concept of <em>generators</em>.</p>
<p>A <a data-primary="generators (ApplicationSet resource)" data-type="indexterm" id="gen_AppSet"/>generator is responsible for generating the parameters, which will finally be replaced in the template placeholders to generate a valid Argo CD <code>Application</code>.</p>
<p>Create the <a data-primary="Argo CD" data-secondary="ApplicationSet resource, creating" data-type="indexterm" id="Argo_AppSet_creat"/><a data-primary="ApplicationSets" data-type="indexterm" id="AppSet_creat"/>following <code>ApplicationSet</code>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ApplicationSet</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-app</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">generators</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO3-1" id="co_advanced_topics_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">list</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">elements</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO3-2" id="co_advanced_topics_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">cluster</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">staging</code><code class="w">
</code><code class="w">        </code><code class="nt">url</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w">
</code><code class="w">        </code><code class="nt">location</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">cluster</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">prod</code><code class="w">
</code><code class="w">        </code><code class="nt">url</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w">
</code><code class="w">        </code><code class="nt">location</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO3-3" id="co_advanced_topics_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">{{cluster}}-app</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO3-4" id="co_advanced_topics_CO3-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w">
</code><code class="w">      </code><code class="nt">source</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w">
</code><code class="w">        </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w">
</code><code class="w">        </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch08/bgd-gen/{{cluster}}</code><code class="w">
</code><code class="w">      </code><code class="nt">destination</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">{{url}}</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO3-5" id="co_advanced_topics_CO3-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">{{location}}</code><code class="s">'</code><code class="w">
</code><code class="w">      </code><code class="nt">syncPolicy</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">syncOptions</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">CreateNamespace=true</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_advanced_topics_CO3-1" id="callout_advanced_topics_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Defines a generator</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO3-2" id="callout_advanced_topics_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Sets the value of the parameters</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO3-3" id="callout_advanced_topics_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Defines the <code>Application</code> resource as a template</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO3-4" id="callout_advanced_topics_CO3-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p><code>cluster</code> placeholder</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO3-5" id="callout_advanced_topics_CO3-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p><code>url</code> placeholder</p></dd>
</dl>
<p>Apply the previous file by running the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgd-application-set.yaml</pre>
<p>When this <code>ApplicationSet</code> is applied to the cluster, Argo CD generates and automatically registers two <code>Application</code> resources. The first one is:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">staging-app</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"/>
<code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch08/bgd-gen/staging</code><code class="w"/>
<code class="w">    </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/example/app.git</code><code class="w"/>
<code class="w">    </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">HEAD</code><code class="w"/>
<code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"/>
<code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w"/>
<code class="w">    </code><code class="p">...</code><code class="w"/></pre>
<p>And the second one:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">prod-app</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"/>
<code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch08/bgd-gen/prod</code><code class="w"/>
<code class="w">    </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/example/app.git</code><code class="w"/>
<code class="w">    </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">HEAD</code><code class="w"/>
<code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app</code><code class="w"/>
<code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w"/>
<code class="w">    </code><code class="p">...</code><code class="w"/></pre>
<p>Inspect the creation of both <code>Application</code> resources by running the following 
<span class="keep-together">command</span>:</p>
<pre data-code-language="bash" data-type="programlisting"><code class="c1"># Remember to login first</code>
argocd login --insecure --grpc-web <code class="nv">$argoURL</code>  --username admin --password <code class="nv">$argoPass</code>

argocd app list</pre>
<p>And the output should be similar to (trunked):</p>
<pre data-code-language="bash" data-type="programlisting">NAME         CLUSTER                         NAMESPACE
prod-app     https://kubernetes.default.svc  app
staging-app  https://kubernetes.default.svc  default</pre>
<p>Delete both applications by deleting the <code>ApplicationSet</code> file:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl delete -f bgd-application-set.yaml</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120820688880">
<h2>Discussion</h2>
<p>We’ve <a data-primary="Argo CD" data-secondary="ApplicationSet resource, creating" data-startref="Argo_AppSet_creat" data-type="indexterm" id="idm45120820681664"/><a data-primary="ApplicationSets" data-startref="AppSet_creat" data-type="indexterm" id="idm45120820774240"/>seen the simplest generator, but there are eight generators in total at the time of writing this book:</p>
<dl>
<dt>List</dt>
<dd>
<p>Generates<a data-primary="list generator" data-type="indexterm" id="idm45120820771424"/> <code>Application</code> definitions through a fixed list of clusters. (It’s the one we’ve seen previously).</p>
</dd>
<dt>Cluster</dt>
<dd>
<p>Similar to <em>List</em> but based <a data-primary="cluster generator" data-type="indexterm" id="idm45120820710656"/>on the list of clusters defined in Argo CD.</p>
</dd>
<dt>Git</dt>
<dd>
<p>Generates <a data-primary="git generator" data-type="indexterm" id="idm45120820663664"/><code>Application</code> definitions based on a JSON/YAML properties file within a Git repository or based on the directory layout of the repository.</p>
</dd>
<dt>SCM Provider</dt>
<dd>
<p>Generates <a data-primary="scm provider generator" data-type="indexterm" id="idm45120820661232"/><code>Application</code> definitions from repositories within an organization.</p>
</dd>
<dt>Pull Request</dt>
<dd>
<p>Generates <code>Application</code> definitions<a data-primary="pull request generator" data-type="indexterm" id="idm45120820658352"/> from open pull requests.</p>
</dd>
<dt>Cluster Decision Resource</dt>
<dd>
<p>Generates<a data-primary="cluster decision resource generator" data-type="indexterm" id="idm45120820643920"/> <code>Application</code> definitions using <a href="https://oreil.ly/kpRkV">duck-typing</a>.</p>
</dd>
<dt>Matrix</dt>
<dd>
<p>Combines <a data-primary="matrix generator" data-type="indexterm" id="idm45120820641024"/>values of two separate generators.</p>
</dd>
<dt>Merge</dt>
<dd>
<p>Merges <a data-primary="merge generator" data-type="indexterm" id="idm45120820638976"/>values from two or more generators.</p>
</dd>
</dl>
<p>In the<a data-primary="generators (ApplicationSet resource)" data-startref="gen_AppSet" data-type="indexterm" id="idm45120820637504"/> previous example, we created the <code>Application</code> objects from a fixed list of elements. This is fine when the number of configurable environments is small; in the example, two clusters refer to two Git folders (<code>ch08/bgd-gen/staging</code> and <code>ch08/bgd-gen/prod</code>).
In the case of multiple environments (which means various folders), we can dynamically use the <em>Git</em> generator to generate one <code>Application</code> per directory.</p>
<p>Let’s migrate the previous example to use the Git generator.
As a reminder, the Git directory layout used was:</p>
<pre data-type="programlisting">bgd-gen
├── staging
│   ├── ...yaml
└── prod
    ├── ...yaml</pre>
<p>Create a new file of type <code>ApplicationSet</code> generating an <code>Application</code> for each directory of the configured Git repo:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ApplicationSet</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cluster-addons</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">openshift-gitops</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">generators</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">git</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO4-1" id="co_advanced_topics_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w">
</code><code class="w">      </code><code class="nt">revision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w">
</code><code class="w">      </code><code class="nt">directories</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch08/bgd-gen/*</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO4-2" id="co_advanced_topics_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO4-3" id="co_advanced_topics_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">{{path[0]}}{{path[2]}}</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO4-4" id="co_advanced_topics_CO4-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w">
</code><code class="w">      </code><code class="nt">source</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w">
</code><code class="w">        </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w">
</code><code class="w">        </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">{{path}}</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO4-5" id="co_advanced_topics_CO4-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">destination</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w">
</code><code class="w">        </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">{{path.basename}}</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO4-6" id="co_advanced_topics_CO4-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_advanced_topics_CO4-1" id="callout_advanced_topics_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Configures the Git repository to read layout</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO4-2" id="callout_advanced_topics_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Initial path to start scanning directories</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO4-3" id="callout_advanced_topics_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p><code>Application</code> definition</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO4-4" id="callout_advanced_topics_CO4-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>The directory paths within the Git repository matching the path wildcard (<code>staging</code> or <code>prod</code>)</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO4-5" id="callout_advanced_topics_CO4-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Directory path (full path)</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO4-6" id="callout_advanced_topics_CO4-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p>The rightmost pathname</p></dd>
</dl>
<p>Apply the resource:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgd-git-application-set.yaml</pre>
<p>Argo CD creates two applications as there are two directories:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app list

NAME         CLUSTER                         NAMESPACE
ch08prod     https://kubernetes.default.svc  prod
ch08staging  https://kubernetes.default.svc  staging</pre>
<p>Also, this generator is handy when your application is composed of different components (service, database, distributed cache, email server, etc.), and deployment files for each element are placed in other directories.
Or, for example, a repository with all operators required to be installed in the cluster:</p>
<pre data-type="programlisting">app
├── tekton-operator
│   ├── ...yaml
├── prometheus-operator
│   ├── ...yaml
└── istio-operator
    ├── ...yaml</pre>
<p>Instead of reacting to directories, Git generator can create <code>Application</code> objects with parameters specified in JSON/YAML files.</p>
<p>The following snippet shows an example JSON file:</p>
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="nt">"cluster"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"staging"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"address"</code><code class="p">:</code><code class="w"> </code><code class="s2">"https://1.2.3.4"</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>This is an excerpt of the <code>ApplicationSet</code> to react to these files:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ApplicationSet</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">guestbook</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">generators</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">git</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/example/app.git</code><code class="w">
</code><code class="w">      </code><code class="nt">revision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">HEAD</code><code class="w">
</code><code class="w">      </code><code class="nt">files</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">app/**/config.json</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO5-1" id="co_advanced_topics_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">{{cluster.name}}-app</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO5-2" id="co_advanced_topics_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="p">...</code><code class="l-Scalar-Plain">.</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_advanced_topics_CO5-1" id="callout_advanced_topics_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Finds all <em>config.json</em> files placed in all subdirectories of the <code>app</code></p></dd>
<dt><a class="co" href="#co_advanced_topics_CO5-2" id="callout_advanced_topics_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Injects the value set in <em>config.json</em></p></dd>
</dl>
<p>This <code>ApplicationSet</code> will generate one <code>Application</code> for each <em>config.json</em> file in the folders matching <a data-primary="Argo CD" data-secondary="applications" data-startref="Argo_app_deploymulticlust" data-tertiary="deploying to multiple clusters" data-type="indexterm" id="idm45120820267440"/><a data-primary="applications" data-secondary="deployment" data-startref="app_deploy_Ku" data-tertiary="to multiple clusters" data-tertiary-sortas="multiple clusters" data-type="indexterm" id="idm45120820265840"/><a data-primary="deployment" data-secondary="applications" data-startref="deploy_app_multiclust" data-tertiary="to multiple clusters" data-type="indexterm" id="idm45120820220864"/>the <code>path</code> expression.</p>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120820682320">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/EnOfl">Argo CD Generators</a></p>
</li>
<li>
<p><a href="https://oreil.ly/tEFQW">Duck Types</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="8.5 Deploy a Pull Request to a Cluster" data-type="sect1"><div class="sect1" id="recipe_8_5">
<h1>8.5 Deploy a Pull Request to a Cluster</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120820214176">
<h2>Problem</h2>
<p>You want to deploy a <a data-primary="pull requests" data-secondary="deploying to clusters" data-type="indexterm" id="pullreq_deploy"/>preview of the application when a pull request is created.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120820211184">
<h2>Solution</h2>
<p>Use the <em>pull request</em> generator <a data-primary="pull request generator" data-type="indexterm" id="idm45120820209104"/>to automatically discover open pull requests within a repository and create an <code>Application</code> object.</p>
<p>Let’s create an <code>ApplicationSet</code> reacting to any GitHub pull request annotated with the <code>preview</code> label created on the configured repository.</p>
<p>Create a new file named <em>bgd-pr-application-set.yaml</em> with the following content:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ApplicationSet</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">myapps</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">openshift-gitops</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">generators</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">pullRequest</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">github</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO6-1" id="co_advanced_topics_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">owner</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gitops-cookbook</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO6-2" id="co_advanced_topics_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">repo</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gitops-cookbook-sc</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO6-3" id="co_advanced_topics_CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">labels</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO6-4" id="co_advanced_topics_CO6-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">preview</code><code class="w">
</code><code class="w">      </code><code class="nt">requeueAfterSeconds</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">60</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO6-5" id="co_advanced_topics_CO6-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">myapp-{{branch}}-{{number}}</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO6-6" id="co_advanced_topics_CO6-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">source</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="s">'</code><code class="w">
</code><code class="w">        </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">{{head_sha}}</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO6-7" id="co_advanced_topics_CO6-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch08/bgd-pr</code><code class="w">
</code><code class="w">      </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w">
</code><code class="w">      </code><code class="nt">destination</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w">
</code><code class="w">        </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">{{branch}}-{{number}}</code><code class="s">'</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_advanced_topics_CO6-1" id="callout_advanced_topics_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>GitHub pull request generator</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO6-2" id="callout_advanced_topics_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Organization/user</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO6-3" id="callout_advanced_topics_CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Repository</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO6-4" id="callout_advanced_topics_CO6-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Select the target PRs</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO6-5" id="callout_advanced_topics_CO6-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Polling time in seconds to check if there is a new PR (60 seconds)</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO6-6" id="callout_advanced_topics_CO6-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p>Sets the name with branch name and number</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO6-7" id="callout_advanced_topics_CO6-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a></dt>
<dd><p>Sets the Git SHA number</p></dd>
</dl>
<p>Apply the previous file by running the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgd-pr-application-set.yaml</pre>
<p>Now, if you list the Argo CD applications, you’ll see that none are registered.
The reason is there is no pull request yet in the repository labeled with <code>preview</code>:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app list
NAME  CLUSTER  NAMESPACE  PROJECT  STATUS</pre>
<p>Create a pull request <a data-primary="pull requests" data-secondary="creating" data-type="indexterm" id="idm45120819988480"/>against the repository and label it with <code>preview</code>.</p>
<p>In GitHub, the pull request window should be similar to <a data-type="xref" href="#fig-851">Figure 8-4</a>.</p>
<figure><div class="figure" id="fig-851">
<img alt="Pull request in GitHub" height="1226" src="assets/gocb_0804.png" width="2679"/>
<h6><span class="label">Figure 8-4. </span>Pull request in GitHub</h6>
</div></figure>
<p>Wait for one minute until the <code>ApplicationSet</code> detects the change and creates the <code>Application</code> object.</p>
<p>Run the following command to inspect that the change has been detected and 
<span class="keep-together">registered</span>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl describe applicationset myapps -n argocd

...
Events:
  Type    Reason     Age                From                       Message
  ----    ------     ----               ----                       -------
  Normal  created    23s                applicationset-controller  created Application <code class="s2">"myapp-lordofthejars-patch-1-1"</code>
  Normal  unchanged  23s <code class="o">(</code>x2 over 23s<code class="o">)</code>  applicationset-controller  unchanged Application <code class="s2">"myapp-lordofthejars-patch-1-1"</code></pre>
<p>Check the registration of the <code>Application</code> to the pull request:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app list
NAME                           CLUSTER                         NAMESPACE
myapp-lordofthejars-patch-1-1  https://kubernetes.default.svc  lordofthejars-patch-1-1</pre>
<p>The <code>Application</code> object is automatically removed when the pull request is closed.</p>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120819930160">
<h2>Discussion</h2>
<p>At the time of writing this book, the following pull request providers are supported:</p>
<ul>
<li>
<p>GitHub</p>
</li>
<li>
<p>Bitbucket</p>
</li>
<li>
<p>Gitea</p>
</li>
<li>
<p>GitLab</p>
</li>
</ul>
<p>The ApplicationSet controller polls every <code>requeueAfterSeconds</code> interval to detect changes but also supports using webhook events.</p>
<p>To configure it, follow <a data-type="xref" href="#recipe_8_3">Recipe 8.3</a>, but also enable sending pull <a data-primary="pull requests" data-secondary="deploying to clusters" data-startref="pullreq_deploy" data-type="indexterm" id="idm45120819931408"/>requests events too in the Git provider.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="8.6 Use Advanced Deployment Techniques" data-type="sect1"><div class="sect1" id="recipe_8_6">
<h1>8.6 Use Advanced Deployment Techniques</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120819900464">
<h2>Problem</h2>
<p>You want to deploy the application <a data-primary="applications" data-secondary="deployment" data-tertiary="Argo Rollouts" data-type="indexterm" id="app_deploy_ArgoRoll"/><a data-primary="deployment" data-secondary="applications" data-tertiary="Argo Rollouts" data-type="indexterm" id="deploy_app_ArgoRoll"/><a data-primary="Argo Rollouts" data-secondary="applications, deploying" data-type="indexterm" id="ArgoRoll_app_deploy"/>using an advanced deployment technique such as blue-green or canary.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120819882160">
<h2>Solution</h2>
<p>Use the <a href="https://oreil.ly/g4mlf">Argo Rollouts</a> project to roll out updates to an 
<span class="keep-together">application</span>.</p>
<p>Argo Rollouts is a <a data-primary="Kubernetes" data-secondary="advanced deployment techniques" data-type="indexterm" id="idm45120819878576"/>Kubernetes controller providing advanced <a data-primary="advanced deployment techniques" data-type="indexterm" id="idm45120819877600"/>deployment techniques such as blue-green, canary, mirroring, dark canaries, traffic analysis, etc. to Kubernetes.
It integrates with many Kubernetes projects like Ambassador, Istio, AWS Load Balancer Controller, NGNI, SMI, or Traefik for traffic management, and projects like Prometheus, Datadog, and New Relic to perform analysis to drive progressive delivery.</p>
<p>To install Argo Rollouts to the <a data-primary="clusters" data-secondary="Argo Rollouts, installing" data-type="indexterm" id="idm45120819876480"/>cluster, run the following command in a terminal window:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create namespace argo-rollouts

kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/download/v1.2.2/install.yaml
...
clusterrolebinding.rbac.authorization.k8s.io/argo-rollouts created
secret/argo-rollouts-notification-secret created
service/argo-rollouts-metrics created
deployment.apps/argo-rollouts created</pre>
<p>Although it’s not mandatory, we recommend you install the Argo Rollouts Kubectl Plugin <a data-primary="Argo Rollouts" data-secondary="Kubectl Plugin" data-type="indexterm" id="idm45120819874880"/><a data-primary="Kubectl Plugin (Argo Rollouts)" data-type="indexterm" id="idm45120819865568"/>to visualize rollouts.
Follow the <a href="https://oreil.ly/1GWsz">instructions</a> to install it. With everything in place, let’s deploy the initial version of the BGD application.</p>
<p>Argo Rollouts doesn’t use the standard Kubernetes <code>Deployment</code> file, but a specific new Kubernetes resource named <code>Rollout</code>.
It’s like a <code>Deployment</code> object, hence all its options are supported, but it adds some fields to configure the rolling update.</p>
<p>Let’s deploy the first version of the application.
We’ll define the <a data-primary="canary release process" data-type="indexterm" id="canary_update"/>canary release process when Kubernetes executes a rolling update, which in this case follows these steps:</p>
<ol>
<li>
<p>Forward 20% of traffic to the new version.</p>
</li>
<li>
<p>Wait until a human decides to proceed with the process.</p>
</li>
<li>
<p>Forward 40%, 60%, 80% of the traffic to the new version automatically, waiting 30 seconds between every increase.</p>
</li>
</ol>
<p>Create a new file named <em>bgd-rollout.yaml</em> with the following content:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Rollout</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-rollouts</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">5</code><code class="w">
</code><code class="w">  </code><code class="nt">strategy</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">canary</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO7-1" id="co_advanced_topics_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">steps</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO7-2" id="co_advanced_topics_CO7-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">setWeight</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">20</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO7-3" id="co_advanced_topics_CO7-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">pause</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO7-4" id="co_advanced_topics_CO7-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">setWeight</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">40</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">pause</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="nt">duration</code><code class="p">:</code><code class="w"> </code><code class="nv">30s</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO7-5" id="co_advanced_topics_CO7-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">setWeight</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">60</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">pause</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="nt">duration</code><code class="p">:</code><code class="w"> </code><code class="nv">30s</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">setWeight</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">80</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">pause</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="nt">duration</code><code class="p">:</code><code class="w"> </code><code class="nv">30s</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">  </code><code class="nt">revisionHistoryLimit</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">2</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-rollouts</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO7-6" id="co_advanced_topics_CO7-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">creationTimestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-rollouts</code><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/rhdevelopers/bgd:1.0.0</code><code class="w">
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w">
</code><code class="w">        </code><code class="nt">env</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">COLOR</code><code class="w">
</code><code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">blue</code><code class="s">"</code><code class="w">
</code><code class="w">        </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_advanced_topics_CO7-1" id="callout_advanced_topics_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Canary release</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO7-2" id="callout_advanced_topics_CO7-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>List of steps to execute</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO7-3" id="callout_advanced_topics_CO7-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Sets the ratio of canary</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO7-4" id="callout_advanced_topics_CO7-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Rollout is paused</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO7-5" id="callout_advanced_topics_CO7-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Pauses the rollout for 30 seconds</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO7-6" id="callout_advanced_topics_CO7-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p><code>template</code> Deployment definition</p></dd>
</dl>
<p>Apply the resource to deploy the application.
Since there is no previous deployment, the canary part is ignored:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgd-rollout.yaml</pre>
<p>Currently, there are five pods as specified in the <code>replicas</code> field:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods

NAME                           READY   STATUS    RESTARTS   AGE
bgd-rollouts-679cdfcfd-6z2zf   <code class="m">1</code>/1     Running   <code class="m">0</code>          12m
bgd-rollouts-679cdfcfd-8c6kl   <code class="m">1</code>/1     Running   <code class="m">0</code>          12m
bgd-rollouts-679cdfcfd-8tb4v   <code class="m">1</code>/1     Running   <code class="m">0</code>          12m
bgd-rollouts-679cdfcfd-f4p7f   <code class="m">1</code>/1     Running   <code class="m">0</code>          12m
bgd-rollouts-679cdfcfd-tljfr   <code class="m">1</code>/1     Running   <code class="m">0</code>          12m</pre>
<p>And using the Argo Rollout Kubectl Plugin:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl argo rollouts get rollout bgd-rollouts

Name:            bgd-rollouts
Namespace:       default
Status:          ✔ Healthy
Strategy:        Canary
  Step:          <code class="m">8</code>/8
  SetWeight:     <code class="m">100</code>
  ActualWeight:  <code class="m">100</code>
Images:          quay.io/rhdevelopers/bgd:1.0.0 <code class="o">(</code>stable<code class="o">)</code>
Replicas:
  Desired:       <code class="m">5</code>
  Current:       <code class="m">5</code>
  Updated:       <code class="m">5</code>
  Ready:         <code class="m">5</code>
  Available:     <code class="m">5</code>

NAME                                     KIND        STATUS      AGE  INFO
⟳ bgd-rollouts                           Rollout     ✔ Healthy  13m
└──# revision:1
   └──⧉ bgd-rollouts-679cdfcfd          ReplicaSet  ✔ Healthy  13m  stable
      ├──□ bgd-rollouts-679cdfcfd-6z2zf  Pod         ✔ Running  13m  ready:1/1
      ├──□ bgd-rollouts-679cdfcfd-8c6kl  Pod         ✔ Running  13m  ready:1/1
      ├──□ bgd-rollouts-679cdfcfd-8tb4v  Pod         ✔ Running  13m  ready:1/1
      ├──□ bgd-rollouts-679cdfcfd-f4p7f  Pod         ✔ Running  13m  ready:1/1
      └──□ bgd-rollouts-679cdfcfd-tljfr  Pod         ✔ Running  13m  ready:1/1</pre>
<p>Let’s deploy a new version to trigger a canary rolling update.
Create a new file named <em>bgd-rollout-v2.yaml</em> with exactly the same content as the previous one, but change the environment variable <code>COLOR</code> value to <code>green</code>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="p">...</code><code class="w"/>
<code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w"/>
<code class="nt">env</code><code class="p">:</code><code class="w"/>
<code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">COLOR</code><code class="w"/>
<code class="w">  </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"green"</code><code class="w"/>
<code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre>
<p>Apply the previous resource and check how Argo Rollouts executes the rolling update.
List the pods again to check that 20% of the pods are new while the other 80% are the old version:</p>
<pre data-code-language="bash" data-type="programlisting"><code>kubectl</code><code> </code><code>get</code><code> </code><code>pods</code><code>

</code><code>NAME</code><code>                           </code><code>READY</code><code>   </code><code>STATUS</code><code>    </code><code>RESTARTS</code><code>   </code><code>AGE</code><code>
</code><code>bgd-rollouts-679cdfcfd-6z2zf</code><code>   </code><code class="m">1</code><code>/1</code><code>     </code><code>Running</code><code>   </code><code class="m">0</code><code>          </code><code>27m</code><code>
</code><code>bgd-rollouts-679cdfcfd-8c6kl</code><code>   </code><code class="m">1</code><code>/1</code><code>     </code><code>Running</code><code>   </code><code class="m">0</code><code>          </code><code>27m</code><code>
</code><code>bgd-rollouts-679cdfcfd-8tb4v</code><code>   </code><code class="m">1</code><code>/1</code><code>     </code><code>Running</code><code>   </code><code class="m">0</code><code>          </code><code>27m</code><code>
</code><code>bgd-rollouts-679cdfcfd-tljfr</code><code>   </code><code class="m">1</code><code>/1</code><code>     </code><code>Running</code><code>   </code><code class="m">0</code><code>          </code><code>27m</code><code>
</code><code>bgd-rollouts-c5495c6ff-zfgvn</code><code>   </code><code class="m">1</code><code>/1</code><code>     </code><code>Running</code><code>   </code><code class="m">0</code><code>          </code><code>13s</code><code> </code><a class="co" href="#callout_advanced_topics_CO8-1" id="co_advanced_topics_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_advanced_topics_CO8-1" id="callout_advanced_topics_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>New version pod</p></dd>
</dl>
<p>And do the same using the Argo Rollout Kubectl Plugin:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl argo rollouts get rollout bgd-rollouts

...
NAME                                     KIND        STATUS      AGE    INFO
⟳ bgd-rollouts                           Rollout     ॥ Paused    31m
├──# revision:2
│  └──⧉ bgd-rollouts-c5495c6ff          ReplicaSet  ✔ Healthy  3m21s  canary
│     └──□ bgd-rollouts-c5495c6ff-zfgvn  Pod         ✔ Running  3m21s  ready:1/1
└──# revision:1
   └──⧉ bgd-rollouts-679cdfcfd          ReplicaSet  ✔ Healthy  31m    stable
      ├──□ bgd-rollouts-679cdfcfd-6z2zf  Pod         ✔ Running  31m    ready:1/1
      ├──□ bgd-rollouts-679cdfcfd-8c6kl  Pod         ✔ Running  31m    ready:1/1
      ├──□ bgd-rollouts-679cdfcfd-8tb4v  Pod         ✔ Running  31m    ready:1/1
      └──□ bgd-rollouts-679cdfcfd-tljfr  Pod         ✔ Running  31m    ready:1/1</pre>
<p>Remember that the rolling update process is paused until the operator executes a manual step to let the process continue.
In a terminal window, run the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl argo rollouts promote bgd-rollouts</pre>
<p>The rollout is promoted and continues with the following steps, which is substituting the old version pods with new versions every 30 seconds:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods

NAME                           READY   STATUS    RESTARTS   AGE
bgd-rollouts-c5495c6ff-2g7r8   <code class="m">1</code>/1     Running   <code class="m">0</code>          89s
bgd-rollouts-c5495c6ff-7mdch   <code class="m">1</code>/1     Running   <code class="m">0</code>          122s
bgd-rollouts-c5495c6ff-d9828   <code class="m">1</code>/1     Running   <code class="m">0</code>          13s
bgd-rollouts-c5495c6ff-h4t6f   <code class="m">1</code>/1     Running   <code class="m">0</code>          56s
bgd-rollouts-c5495c6ff-zfgvn   <code class="m">1</code>/1     Running   <code class="m">0</code>          11m</pre>
<p>The rolling update finishes with the new version progressively deployed to the cluster.</p>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120819881248">
<h2>Discussion</h2>
<p>Kubernetes doesn’t implement advanced deployment techniques natively.
For this reason, Argo Rollouts uses the number of deployed pods to implement the canary release.</p>
<p>As mentioned before, Argo Rollouts integrates with Kubernetes products that offer advanced traffic management capabilities like  <a href="https://istio.io">Istio</a>.</p>
<p>Using Istio, the traffic splitting is done correctly at the infrastructure level instead of playing with replica numbers like in the first example.
Argo Rollouts integrates with Istio to execute a canary release, automatically updating the Istio <code>VirtualService</code> object.</p>
<p>Assuming you already know Istio and have a Kubernetes cluster with Istio installed, you can perform integration between Argo Rollouts and Istio by setting the 
<span class="keep-together"><code>trafficRouting</code></span> from <code>Rollout</code> resource to <code>Istio</code>.</p>
<p>First, create a <code>Rollout</code> file with Istio configured:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Rollout</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdapp</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdapp</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">strategy</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">canary</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO9-1" id="co_advanced_topics_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">steps</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">setWeight</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">20</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">pause</code><code class="p">:</code><code class="w">
</code><code class="w">          </code><code class="nt">duration</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">1m</code><code class="s">"</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">setWeight</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">50</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">pause</code><code class="p">:</code><code class="w">
</code><code class="w">          </code><code class="nt">duration</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">2m</code><code class="s">"</code><code class="w">
</code><code class="w">      </code><code class="nt">canaryService</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-canary</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO9-2" id="co_advanced_topics_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">stableService</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO9-3" id="co_advanced_topics_CO9-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">trafficRouting</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">istio</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO9-4" id="co_advanced_topics_CO9-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">           </code><code class="nt">virtualService</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO9-5" id="co_advanced_topics_CO9-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO9-6" id="co_advanced_topics_CO9-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">routes</code><code class="p">:</code><code class="w">
</code><code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">primary</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO9-7" id="co_advanced_topics_CO9-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">
</code><code class="w">  </code><code class="nt">revisionHistoryLimit</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">2</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdapp</code><code class="w">
</code><code class="w">      </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdapp</code><code class="w">
</code><code class="w">        </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="w">      </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">sidecar.istio.io/inject</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">true</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO9-8" id="co_advanced_topics_CO9-8"><img alt="8" height="12" src="assets/8.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/rhdevelopers/bgd:1.0.0</code><code class="w">
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w">
</code><code class="w">        </code><code class="nt">env</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">COLOR</code><code class="w">
</code><code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">blue</code><code class="s">"</code><code class="w">
</code><code class="w">        </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" href="#co_advanced_topics_CO9-1" id="callout_advanced_topics_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Canary section</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO9-2" id="callout_advanced_topics_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Reference to a Kubernetes Service pointing to the new service version</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO9-3" id="callout_advanced_topics_CO9-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Reference to a Kubernetes Service pointing to the old service version</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO9-4" id="callout_advanced_topics_CO9-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Configures Istio</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO9-5" id="callout_advanced_topics_CO9-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Reference to the <code>VirtualService</code> where weight is updated</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO9-6" id="callout_advanced_topics_CO9-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p>Name of the <code>VirtualService</code></p></dd>
<dt><a class="co" href="#co_advanced_topics_CO9-7" id="callout_advanced_topics_CO9-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a></dt>
<dd><p>Route name within <code>VirtualService</code></p></dd>
<dt><a class="co" href="#co_advanced_topics_CO9-8" id="callout_advanced_topics_CO9-8"><img alt="8" height="12" src="assets/8.png" width="12"/></a></dt>
<dd><p>Deploys the Istio sidecar container</p></dd>
</dl>
<p>Then, we create two Kubernetes Services pointing to the same deployment used to redirect traffic to the old or the new one.</p>
<p>The following Kubernetes Service is used in the <code>stableService</code> field:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdapp</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w"/>
<code class="w">    </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdapp</code><code class="w"/></pre>
<p>And the Canary one is the same but with a different name.
It’s the one used in the <code>canaryService</code> field:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-canary</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdapp</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w"/>
<code class="w">    </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdapp</code><code class="w"/></pre>
<p>Finally, create the Istio Virtual Service to be updated by Argo Rollouts to update the canary traffic for each service:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">networking.istio.io/v1alpha3</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">VirtualService</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">hosts</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w">
</code><code class="w">  </code><code class="nt">http</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">route</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">destination</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">host</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO10-1" id="co_advanced_topics_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">weight</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">100</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">destination</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">host</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-canary</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO10-2" id="co_advanced_topics_CO10-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">weight</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">primary</code><code class="w"> </code><a class="co" href="#callout_advanced_topics_CO10-3" id="co_advanced_topics_CO10-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_advanced_topics_CO10-1" id="callout_advanced_topics_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Stable Kubernetes Service</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO10-2" id="callout_advanced_topics_CO10-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Canary Kubernetes Service</p></dd>
<dt><a class="co" href="#co_advanced_topics_CO10-3" id="callout_advanced_topics_CO10-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Route name</p></dd>
</dl>
<p>After applying these resources, we’ll get the first version of the application up and running:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgd-virtual-service.yaml
kubectl apply -f service.yaml
kubectl apply -f service-canary.yaml
kubectl apply -f bgd-isio-rollout.yaml</pre>
<p>When any update occurs on the <code>Rollout</code> object, the canary release will start as described in the Solution. Now, Argo Rollouts updates the <em>bgd virtual service</em> weights automatically instead of playing with pod <a data-primary="applications" data-secondary="deployment" data-startref="app_deploy_ArgoRoll" data-tertiary="Argo Rollouts" data-type="indexterm" id="idm45120818622464"/><a data-primary="deployment" data-secondary="applications" data-startref="deploy_app_ArgoRoll" data-tertiary="Argo Rollouts" data-type="indexterm" id="idm45120818621360"/><a data-primary="Argo Rollouts" data-secondary="applications, deploying" data-startref="ArgoRoll_app_deploy" data-type="indexterm" id="idm45120818620032"/><a data-primary="canary release process" data-startref="canary_update" data-type="indexterm" id="idm45120818618944"/>numbers.</p>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120819367280">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/XQ64b">Argo Rollouts - Kubernetes Progressive Delivery Controller</a></p>
</li>
<li>
<p><a href="https://oreil.ly/lKDYH">Istio - Argo Rollouts</a></p>
</li>
<li>
<p><a href="https://istio.io">Istio</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Vzk9G">Istio Tutorial from Red Hat</a></p>
</li>
</ul>
</div></section>
</div></section>
</div></section></div></body></html>