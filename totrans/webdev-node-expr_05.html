<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 5. Quality Assurance"><div class="chapter" id="ch_qa">
<h1><span class="label">Chapter 5. </span>Quality Assurance</h1>


<p><a data-type="indexterm" data-primary="quality assurance (QA)" id="ix_ch-05-qa-asciidoc0"/><em>Quality assurance</em> is a phrase that is prone to send shivers down the
spines of developers—which is unfortunate. After all, don’t you want to make
quality software? Of course you do. So it’s not the end goal that’s the
sticking point; it’s the politics of the matter. I’ve found that two common situations arise in web development:</p>
<dl>
<dt>Large or well-funded organizations</dt>
<dd>
<p> There’s usually a QA department, and, unfortunately, an adversarial
relationship springs up between QA and development. This is the worst thing that can happen.
Both departments are playing on the same team, for the same goal, but QA
often defines success as finding more bugs, while development defines
success as generating fewer bugs, and that serves as the basis for conflict
and competition.</p>
</dd>
<dt>Small organizations and organizations on a budget</dt>
<dd>
<p> Often, there is no QA department; the development staff is expected to
serve the dual role of establishing QA and developing software. This is not a
ridiculous stretch of the imagination or a conflict of interest. However,
QA is a very different discipline than development, and it attracts
different personalities and talents. This is not an impossible situation,
and certainly there are developers out there who have the QA mind-set, but
when deadlines loom, it’s usually QA that gets the short shrift, to the
project’s detriment.</p>
</dd>
</dl>

<p>With most real-world endeavors, multiple skills are required, and
increasingly, it’s harder to be an expert in all of those skills. However,
some competency in the areas for which you are not directly responsible
will make you more valuable to the team and make the team function more
effectively. A developer acquiring QA skills offers a great example: these
two disciplines are so tightly intertwined that cross-disciplinary
understanding is extremely valuable.</p>

<p>It is also common to shift activities traditionally done by QA to
development, making developers responsible for QA. In this paradigm,
software engineers who specialize in QA act <span class="keep-together">almost</span> as consultants to developers, helping
them build QA into their development workflow. Whether QA roles are
divided or integrated, it is clear that understanding QA is beneficial to
developers.</p>

<p>This book is not for QA professionals; it is aimed at developers. So my
goal is not to make you a QA expert but to give you some experience in
that area. If your organization has a dedicated QA staff, it will make it
easier for you to communicate and collaborate with them. If you do not, it
will give you a starting point to establishing a comprehensive QA plan for
your project.</p>

<p>In this chapter, you’ll learn the following:</p>

<ul>
<li>
<p>Quality fundamentals and effective habits</p>
</li>
<li>
<p>The types of tests (unit and integration)</p>
</li>
<li>
<p>How to write unit tests with Jest</p>
</li>
<li>
<p>How to write integration tests with Puppeteer</p>
</li>
<li>
<p>How to configure ESLint to help prevent common errors</p>
</li>
<li>
<p>What continuous integration is and where to start learning about it</p>
</li>
</ul>






<section data-type="sect1" data-pdf-bookmark="The QA Plan"><div class="sect1" id="idm45053598243656">
<h1>The QA Plan</h1>

<p><a data-type="indexterm" data-primary="quality assurance (QA)" data-secondary="creating a plan for" id="idm45053598242408"/>Development is, by and large, a creative process: envisioning something
and then translating it into reality. QA, in contrast, lives more in the
realm of validation and order. As such, a large part of QA is simply a
matter of <em>knowing what needs to be done</em> and <em>making sure it gets done</em>.
It is a discipline well-suited for checklists, procedures, and
documentation. I would go so far as to say the primary activity of QA is not
the testing of software itself but the <em>creation of a comprehensive,
repeatable QA plan</em>.</p>

<p>I recommend the creation of a QA plan for every project, no matter how big
or small (yes, even your weekend “fun” project!). The QA plan doesn’t have
to be big or elaborate; you can put it in a text file or a word processing
document or a wiki. The objective of the QA plan is to record all of the
steps you’ll take to ensure that your product is functioning as intended.</p>

<p>In whatever form it takes, the QA plan is a living document. You will
update it in response to the following:</p>

<ul>
<li>
<p>New features</p>
</li>
<li>
<p>Changes in existing features</p>
</li>
<li>
<p>Removed features</p>
</li>
<li>
<p>Changes in testing technologies or techniques</p>
</li>
<li>
<p>Defects that were missed by the QA plan</p>
</li>
</ul>

<p>That last point deserves special mention. No matter how robust your QA is,
defects will happen. And when they do, you should ask yourself, “How could
we have prevented this?” When you answer that question, you can modify
your QA plan accordingly to prevent future instances of this type of
defect.</p>

<p>By now you might be getting a feel for the not insignificant effort
involved in QA, and you might be reasonably wondering how much effort you
want to put into it.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="QA: Is It Worth It?"><div class="sect1" id="idm45053598232840">
<h1>QA: Is It Worth It?</h1>

<p><a data-type="indexterm" data-primary="quality assurance (QA)" data-secondary="value of" id="idm45053598231592"/>QA can be expensive—sometimes <em>very</em> expensive. So is it worth it? It’s a
complicated formula with complicated inputs. Most organizations operate on
some kind of “return on investment” model. If you spend money, you must
expect to receive at least as much money in return (preferably more). With
QA, though, the relationship can be muddy. A well-established and
well-regarded product, for example, may be able to get by with quality
issues for longer than a new and unknown project. Obviously, no one
<em>wants</em> to produce a low-quality product, but the pressures in technology
are high. Time-to-market can be critical, and sometimes it’s better to
come to market with something that’s less than perfect than to come to
market with the perfect product months later.</p>

<p>In web development, quality can be broken down into four dimensions:</p>
<dl>
<dt>Reach</dt>
<dd>
<p>  <a data-type="indexterm" data-primary="reach (QA element)" id="idm45053598227208"/>Reach refers to the market penetration of your product: the number of
people viewing your website or using your service. There’s a
direct correlation between reach and profitability: the more people who
visit the website, the more people who buy the product or service. From a
development perspective, search engine optimization (SEO) will have the
biggest impact on reach, which is why we will be including SEO in our QA
plan.</p>
</dd>
<dt>Functionality</dt>
<dd>
<p>  <a data-type="indexterm" data-primary="functionality (QA element)" id="idm45053598224872"/>Once people are visiting your site or using your
service, the quality of your
site’s functionality will have a large impact on user retention; a site
that works as <span class="keep-together">advertised</span> is more
likely to drive return visits than one that isn’t. Functionality offers
the most opportunity for test automation.</p>
</dd>
<dt>Usability</dt>
<dd>
<p>  <a data-type="indexterm" data-primary="HCI (human-computer interaction)" id="idm45053598222040"/><a data-type="indexterm" data-primary="human-computer interaction (HCI)" id="idm45053598221432"/><a data-type="indexterm" data-primary="usability (QA element)" id="idm45053598220824"/>Where functionality is concerned with functional correctness, usability
evaluates human-computer interaction (HCI). The
fundamental question is, “Is the <span class="keep-together">functionality</span> delivered in a way that is
useful to the target audience?” This often translates to “Is it easy to
use?” though the pursuit of ease can often oppose flexibility or power;
what seems easy to a programmer might be different from what seems easy to
a nontechnical consumer. In other words, you must consider your target
audience when assessing usability. Since a fundamental input to a
usability <span class="keep-together">measurement</span> is a user,
usability is not usually something that can be automated. However, user
testing should be included in your QA plan.</p>
</dd>
<dt>Aesthetics</dt>
<dd>
<p>  <a data-type="indexterm" data-primary="aesthetics (QA element)" id="idm45053598216952"/>Aesthetics is the most subjective of the four dimensions and is therefore
the least relevant to development. While there are few
development concerns when it comes to your site’s aesthetics, routine
reviews of your site’s aesthetics should be part of your QA plan. Show
your site to a representative sample audience, and find out if it feels
dated or does not invoke the desired response. Keep in mind that
aesthetics is time sensitive (aesthetic standards shift over time) and
audience specific (what appeals to one audience may be completely
uninteresting to another).</p>
</dd>
</dl>

<p>While all four dimensions should be addressed in your QA plan,
functionality testing and SEO can be tested automatically during
development, so that will be the focus of this chapter.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Logic Versus Presentation"><div class="sect1" id="idm45053598214664">
<h1>Logic Versus Presentation</h1>

<p><a data-type="indexterm" data-primary="business logic, presentation versus" id="idm45053598213496"/><a data-type="indexterm" data-primary="logic (business logic), presentation versus" id="idm45053598212600"/><a data-type="indexterm" data-primary="Meadowlark Travel website (fictional example)" data-secondary="logic versus presentation" id="idm45053598211832"/><a data-type="indexterm" data-primary="presentation, logic versus" id="idm45053598210888"/><a data-type="indexterm" data-primary="quality assurance (QA)" data-secondary="logic versus presentation" id="idm45053598210248"/>Broadly speaking, in your website, there are two “realms”: <em>logic</em> (often
called <em>business logic</em>, a term I eschew because of its bias toward
commercial endeavor) and <em>presentation</em>. You
can think of your website’s logic existing in kind of a pure intellectual
domain. For example, in our Meadowlark Travel scenario, there might be a
rule that a customer must possess a valid driver’s license before renting a
scooter. This is a simple data-based rule: for every scooter
reservation, the user needs a valid driver’s license. The <em>presentation</em>
of this is disconnected. Perhaps it’s
just a checkbox on the final form of the order page, or perhaps the
customer has to provide a valid driver’s license number, which is validated
by Meadowlark Travel. It’s an important distinction, because things should
be as clear and simple as possible in the logic domain, whereas the
presentation can be as complicated or as simple as it needs to be. The
presentation is also subject to usability and aesthetic concerns, whereas the
business domain is not.</p>

<p>Whenever possible, you should seek a clear delineation between your logic
and presentation. There are many ways to do that, and in this book, we
will be focusing on encapsulating logic in JavaScript modules.
Presentation, on the other hand, will be a combination of HTML, CSS,
multimedia, JavaScript, and frontend frameworks like React, Vue, or
Angular.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="The Types of Tests"><div class="sect1" id="idm45053598205688">
<h1>The Types of Tests</h1>

<p><a data-type="indexterm" data-primary="quality assurance (QA)" data-secondary="test types" id="idm45053598204456"/>The type of testing we will be considering in this book falls into
two
broad categories: unit testing and integration testing (I am considering
system testing to be a type of integration testing).
Unit testing is very fine-grained, testing single components to make sure
they function properly, whereas integration testing tests the interaction
between multiple components or even the whole system.</p>

<p>In general, unit testing is more useful and appropriate for logic testing.
Integration testing is useful in both realms.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Overview of QA Techniques"><div class="sect1" id="idm45053598202152">
<h1>Overview of QA Techniques</h1>

<p><a data-type="indexterm" data-primary="quality assurance (QA)" data-secondary="overview of techniques" id="idm45053598200984"/>In this book, we will be using the following techniques and
software to accomplish
thorough testing:</p>
<dl>
<dt>Unit tests</dt>
<dd>
<p>  <a data-type="indexterm" data-primary="unit testing" data-secondary="defined" id="idm45053598198072"/>Unit tests cover the smallest units of functionality in your application,
usually a single function. They are almost always written by developers,
not QA (though QA should be empowered to assess the quality and coverage of
unit tests). In this book, we’ll be using Jest for unit tests.</p>
</dd>
<dt>Integration tests</dt>
<dd>
<p>  <a data-type="indexterm" data-primary="integration testing" id="idm45053598195352"/>Integration tests cover larger units of functionality, usually involving
multiple parts of your application (functions, modules, subsystems, etc.).
Since we are building web applications, the “ultimate” integration test is
to render the application in a browser, manipulate that browser, and verify
that the application behaves as expected. These tests are
typically more complicated to set up and maintain, and since the focus of
this book isn’t QA, we’ll have only one simple example of this, using
Puppeteer and Jest.</p>
</dd>
<dt>Linting</dt>
<dd>
<p>  <a data-type="indexterm" data-primary="linting" data-secondary="defined" id="idm45053598192664"/>Linting isn’t about finding errors but <em>potential</em> errors. The general
concept of linting is that it identifies areas that could represent
possible errors, or fragile constructs that could lead to errors in the
future. We will be using ESLint for linting.</p>
</dd>
</dl>

<p>Let’s start with Jest, our test framework (which will run both unit and
integration tests).</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Installing and Configuring Jest"><div class="sect1" id="idm45053598190040">
<h1>Installing and Configuring Jest</h1>

<p><a data-type="indexterm" data-primary="installation" data-secondary="Jest" id="idm45053598188600"/><a data-type="indexterm" data-primary="Jest" id="idm45053598187528"/><a data-type="indexterm" data-primary="quality assurance (QA)" data-secondary="Jest installation/configuration" id="idm45053598186920"/>I struggled somewhat to decide which testing framework to use in this book.
Jest began its life as a framework to test React applications (and it is
still the obvious choice for that), but Jest is not React-specific and is
an excellent general-purpose testing framework. It’s certainly not the only
one: <a href="https://mochajs.org">Mocha</a>, <a href="https://jasmine.github.io">Jasmine</a>,
<a href="https://github.com/avajs/ava">Ava</a>, and
<a href="https://github.com/substack/tape">Tape</a> are also excellent choices.</p>

<p>In the end, I chose Jest because I feel it offers the best overall
experience (an opinion backed by Jest’s excellent scores in the
<a href="http://bit.ly/33ErHUE">State of JavaScript 2018</a>
survey). That said, there are a lot of similarities among the testing
frameworks mentioned here, so you should be able to take what you learn and apply it to your favorite test framework.</p>

<p>To install Jest, run the following from your project root:</p>

<pre data-type="programlisting">npm install --save-dev jest</pre>

<p>(Note that we use <code>--save-dev</code> here; this tells npm that this is a
development dependency and is not needed for the application itself to
function; it will be listed in the <code>devDependencies</code> section of the
<em>package.json</em> file instead of the <code>dependencies</code> section.)</p>

<p>Before we move on, we need a way to run Jest (which will run any tests in
our project). The conventional way to do that is to add a script to
<em>package.json</em>. Edit <em>package.json</em> (<em>ch05/package.json</em> in the
companion repo), and modify the <code>scripts</code> property (or
add it if it doesn’t exist):</p>

<pre data-type="programlisting">  "scripts": {
    "test": "jest"
  },</pre>

<p>Now you can run all the tests in your project simply by typing that:</p>

<pre data-type="programlisting">npm test</pre>

<p>If you try that now, you’ll probably get an error that there aren’t any
tests configured…because we haven’t added any yet. So let’s write some
unit tests!</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="package.json file" data-secondary="scripts in" id="idm45053598171912"/><a data-type="indexterm" data-primary="scripts, in package.json file" id="idm45053598170712"/>Normally, if you add a script to your <em>package.json</em> file, you would run it
with <code>npm run</code>. For example, if you added a script <code>foo</code>, you would type
<code>npm run foo</code> to run it. The <code>test</code> script is so common, however, that npm
knows to run it if you simply type <code>npm test</code>.</p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Unit Testing"><div class="sect1" id="idm45053598189416">
<h1>Unit Testing</h1>

<p><a data-type="indexterm" data-primary="unit testing" data-secondary="basics" id="ix_ch-05-qa-asciidoc1"/>Now we’ll turn our attention to unit testing.  Since the focus of unit testing is on isolating a single function or component, we’ll first need to learn about mocking, an important technique for achieving that isolation.</p>








<section data-type="sect2" data-pdf-bookmark="Mocking"><div class="sect2" id="idm45053598164056">
<h2>Mocking</h2>

<p><a data-type="indexterm" data-primary="mocking" id="idm45053598162888"/><a data-type="indexterm" data-primary="unit testing" data-secondary="mocking" id="idm45053598162184"/>One of the challenges you’ll frequently face is how to write code that is
“testable.” In general, code that tries to do too much or assumes a lot of
dependencies is harder to test than focused code that assumes few or no
dependencies.</p>

<p>Whenever you have a dependency, you have something that needs to be
<em>mocked</em> (simulated) for effective testing. For example, our primary
dependency is Express, which is already thoroughly tested, so we don’t need
or want to test Express itself, just <em>how we use it</em>. The only way we can
determine if we’re using Express correctly is to simulate Express itself.</p>

<p>The routes we currently have (the home page, About page, 404 page, and 500
page) are pretty difficult to test because they assume three dependencies
on Express: they assume we have an Express app (so we can have <code>app.get</code>),
as well as request and response objects. Fortunately, it’s pretty easy to
eliminate the dependence on the Express app itself (the request and
response objects are harder…more on that later). Fortunately, we’re not
using very much functionality from the response object (we’re using only
the <code>render</code> method), so it will be easy to mock it, which we will see
shortly.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Refactoring the Application for Testability"><div class="sect2" id="idm45053598157112">
<h2>Refactoring the Application for Testability</h2>

<p><a data-type="indexterm" data-primary="unit testing" data-secondary="refactoring the application for testability" id="idm45053598155624"/>We don’t really have a lot of code in our application to test yet. To
date, we’ve currently added only a handful of route handlers and the
<code>getFortune</code> function.</p>

<p>To make our app more testable, we’re going to <em>extract</em> the actual route
handlers to their own library. Create a file <em>lib/handlers.js</em>
(<em>ch05/lib/handlers.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">fortune</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./fortune'</code><code class="p">)</code>

<code class="nx">exports</code><code class="p">.</code><code class="nx">home</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'home'</code><code class="p">)</code>

<code class="nx">exports</code><code class="p">.</code><code class="nx">about</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'about'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">fortune</code><code class="o">:</code> <code class="nx">fortune</code><code class="p">.</code><code class="nx">getFortune</code><code class="p">()</code> <code class="p">})</code>

<code class="nx">exports</code><code class="p">.</code><code class="nx">notFound</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'404'</code><code class="p">)</code>

<code class="nx">exports</code><code class="p">.</code><code class="nx">serverError</code> <code class="o">=</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'500'</code><code class="p">)</code></pre>

<p>Now we can rewrite our <em>meadowloark.js</em> application file to use these
handlers (<em>ch05/meadowlark.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="c1">// typically at the top of the file</code>
<code class="kr">const</code> <code class="nx">handlers</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./lib/handlers'</code><code class="p">)</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="nx">handlers</code><code class="p">.</code><code class="nx">home</code><code class="p">)</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/about'</code><code class="p">,</code> <code class="nx">handlers</code><code class="p">.</code><code class="nx">about</code><code class="p">)</code>

<code class="c1">// custom 404 page</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">handlers</code><code class="p">.</code><code class="nx">notFound</code><code class="p">)</code>

<code class="c1">// custom 500 page</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">handlers</code><code class="p">.</code><code class="nx">serverError</code><code class="p">)</code></pre>

<p>It’s easier now to test those handlers: they are just functions that take
request and response objects, and we need to verify that we’re using those
objects correctly.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Writing Our First Test"><div class="sect2" id="idm45053597932040">
<h2>Writing Our First Test</h2>

<p><a data-type="indexterm" data-primary="unit testing" data-secondary="writing a test" id="ix_ch-05-qa-asciidoc2"/>There are multiple ways to identify tests to Jest. The two most common are
to put tests in subdirectories named <em>__test__</em> (two underscores
before and after <em>test</em>) and to name files with the extension <em>.test.js</em>.
I personally like to combine the two techniques because they both serve a
purpose in my mind. Putting tests in <em>__test__</em> directories keeps my test
from cluttering up my source directories (otherwise, everything will look
doubled in your source directory…you’ll have a <em>foo.test.js</em> for every
file <em>foo.js</em>), and having the <em>.test.js</em> extension means that if I’m
looking at a bunch of tabs in my editor, I can see at a glance what is a
test and what is source code.</p>

<p>So let’s create a file called
<em>lib/__tests__/handlers.test.js</em>
(<em>ch05/lib/__tests__/handlers.test.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">handlers</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'../handlers'</code><code class="p">)</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'home page renders'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">req</code> <code class="o">=</code> <code class="p">{}</code>
  <code class="kr">const</code> <code class="nx">res</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">render</code><code class="o">:</code> <code class="nx">jest</code><code class="p">.</code><code class="nx">fn</code><code class="p">()</code> <code class="p">}</code>
  <code class="nx">handlers</code><code class="p">.</code><code class="nx">home</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">.</code><code class="nx">mock</code><code class="p">.</code><code class="nx">calls</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="mi">0</code><code class="p">]).</code><code class="nx">toBe</code><code class="p">(</code><code class="s1">'home'</code><code class="p">)</code>
<code class="p">})</code></pre>

<p>If you’re new to testing, this will probably look pretty weird, so let’s
break it down.</p>

<p>First, we import the code we’re trying to test (in this case, the route
handlers). Then each test has a description; we’re trying to describe
what’s being tested. In this case, we want to make sure that the home page
gets rendered.</p>

<p><a data-type="indexterm" data-primary="request objects" data-secondary="QA testing" id="idm45053597891112"/><a data-type="indexterm" data-primary="response objects" data-secondary="QA testing" id="idm45053597890264"/>To invoke our render, we need request and response objects. We’d
be writing code all week if we wanted to simulate the whole request and
response objects, but fortunately we don’t actually need much from them.
We know that we don’t need anything at all from the request
object in this case (so we just use an empty object), and the only thing we
need from the response object is a render method. Note how we construct
the render function: we just call a Jest method called <em>jest.fn()</em>. This
creates a generic mock function that keeps track of how it’s called.</p>

<p><a data-type="indexterm" data-primary="assertions, QA testing" id="idm45053597888024"/>Finally, we get to the important part of the test: assertions. We’ve gone
to all the trouble to invoke the code we’re testing, but how do we assert
that it did what it should? In this case, what the code should do is call
the <code>render</code> method of the response object with the string <code>home</code>.
Jest’s mock function keeps track of all the times it got called, so all we
have to do is verify it got called exactly once (it would probably be a
problem if it got called twice), which is what the first <code>expect</code> does, and
that it gets called with <code>home</code> as its first argument (the first array
index specifies which invocation, and the second one specifies which
argument).</p>
<div data-type="tip"><h6>Tip</h6>
<p>It can get tedious to constantly be rerunning your tests every time
you make a change to your code. Fortunately, most test frameworks have a
“watch” mode that constantly monitors your code and tests for changes and
reruns them automatically. To run your tests in watch mode, type <code>npm
test -- --watch</code> (the extra double-dash is necessary to let npm know to
pass the <code>--watch</code> argument to Jest).</p>
</div>

<p>Go ahead and change your <code>home</code> handler to render something other than the
home view; you’ll notice that your test has now failed, and you caught a
bug!</p>

<p>We can now add tests for our other routes:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">test</code><code class="p">(</code><code class="s1">'about page renders with fortune'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">req</code> <code class="o">=</code> <code class="p">{}</code>
  <code class="kr">const</code> <code class="nx">res</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">render</code><code class="o">:</code> <code class="nx">jest</code><code class="p">.</code><code class="nx">fn</code><code class="p">()</code> <code class="p">}</code>
  <code class="nx">handlers</code><code class="p">.</code><code class="nx">about</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">.</code><code class="nx">mock</code><code class="p">.</code><code class="nx">calls</code><code class="p">.</code><code class="nx">length</code><code class="p">).</code><code class="nx">toBe</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">.</code><code class="nx">mock</code><code class="p">.</code><code class="nx">calls</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="mi">0</code><code class="p">]).</code><code class="nx">toBe</code><code class="p">(</code><code class="s1">'about'</code><code class="p">)</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">.</code><code class="nx">mock</code><code class="p">.</code><code class="nx">calls</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="mi">1</code><code class="p">])</code>
    <code class="p">.</code><code class="nx">toEqual</code><code class="p">(</code><code class="nx">expect</code><code class="p">.</code><code class="nx">objectContaining</code><code class="p">({</code>
      <code class="nx">fortune</code><code class="o">:</code> <code class="nx">expect</code><code class="p">.</code><code class="nx">stringMatching</code><code class="p">(</code><code class="sr">/\W/</code><code class="p">),</code>
    <code class="p">}))</code>
<code class="p">})</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'404 handler renders'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">req</code> <code class="o">=</code> <code class="p">{}</code>
  <code class="kr">const</code> <code class="nx">res</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">render</code><code class="o">:</code> <code class="nx">jest</code><code class="p">.</code><code class="nx">fn</code><code class="p">()</code> <code class="p">}</code>
  <code class="nx">handlers</code><code class="p">.</code><code class="nx">notFound</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">.</code><code class="nx">mock</code><code class="p">.</code><code class="nx">calls</code><code class="p">.</code><code class="nx">length</code><code class="p">).</code><code class="nx">toBe</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">.</code><code class="nx">mock</code><code class="p">.</code><code class="nx">calls</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="mi">0</code><code class="p">]).</code><code class="nx">toBe</code><code class="p">(</code><code class="s1">'404'</code><code class="p">)</code>
<code class="p">})</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'500 handler renders'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">err</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'some error'</code><code class="p">)</code>
  <code class="kr">const</code> <code class="nx">req</code> <code class="o">=</code> <code class="p">{}</code>
  <code class="kr">const</code> <code class="nx">res</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">render</code><code class="o">:</code> <code class="nx">jest</code><code class="p">.</code><code class="nx">fn</code><code class="p">()</code> <code class="p">}</code>
  <code class="kr">const</code> <code class="nx">next</code> <code class="o">=</code> <code class="nx">jest</code><code class="p">.</code><code class="nx">fn</code><code class="p">()</code>
  <code class="nx">handlers</code><code class="p">.</code><code class="nx">serverError</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">.</code><code class="nx">mock</code><code class="p">.</code><code class="nx">calls</code><code class="p">.</code><code class="nx">length</code><code class="p">).</code><code class="nx">toBe</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">.</code><code class="nx">mock</code><code class="p">.</code><code class="nx">calls</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="mi">0</code><code class="p">]).</code><code class="nx">toBe</code><code class="p">(</code><code class="s1">'500'</code><code class="p">)</code>
<code class="p">})</code></pre>

<p>Note some extra functionality in the “about” and server error tests. The
“about” render function gets called with a fortune, so we’ve added an
expectation that it will get a fortune that is a string that contains at
least one character. It’s beyond the scope of this book to describe all of
the functionality that is available to you through Jest and its <code>expect</code>
method, but you can find comprehensive documentation on the
<a href="https://jestjs.io">Jest home page</a>. Note that the server error handler takes
four arguments, not two, so we have to provide additional mocks.<a data-type="indexterm" data-startref="ix_ch-05-qa-asciidoc2" id="idm45053597877272"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Test Maintenance"><div class="sect2" id="idm45053597931448">
<h2>Test Maintenance</h2>

<p><a data-type="indexterm" data-primary="unit testing" data-secondary="test maintenance" id="idm45053597539816"/>You might be realizing that tests are not a “set it and forget it” affair.
For example, if we renamed our “home” view for legitimate reasons, our
test would fail, and then we would have to fix the test in addition to fixing the
code.</p>

<p>For this reason, teams put a lot of effort into setting realistic
expectations about what should be tests and how specific the tests should
be. For example, we didn’t have to check to see if the “about” handler was
being called with a fortune…which would save us from having to fix the
test if we ditch that feature.</p>

<p>Furthermore, I can’t offer much advice about how thoroughly you should
test your code. I would expect you to have very different standards for
testing code for avionics or medical equipment than for
testing the code behind a marketing website.</p>

<p>What I can offer you is a way to answer the question, “How much of my code
is tested?” The answer to that is called <em>code coverage</em>, which we’ll
discuss next.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Code Coverage"><div class="sect2" id="idm45053597535912">
<h2>Code Coverage</h2>

<p><a data-type="indexterm" data-primary="code coverage" id="idm45053597534600"/><a data-type="indexterm" data-primary="coverage, of code" id="idm45053597533896"/><a data-type="indexterm" data-primary="unit testing" data-secondary="code coverage" id="idm45053597533224"/>Code coverage offers a quantitative answer to how much of your code is
tested, but like most topics in programming, there are no simple answers.</p>

<p>Jest helpfully provides some automated code coverage analysis. To see how
much of your code is tested, run the following:</p>

<pre data-type="programlisting">npm test -- --coverage</pre>

<p>If you’ve been following along, you should see a bunch of reassuringly
green “100%” coverage numbers for the files in <em>lib</em>. Jest will report
on the coverage percentage of statements (Stmts), branches, functions
(Funcs), and lines.</p>

<p>Statements are referring to JavaScript statements, such as every expression, control
flow statement, etc. Note that you could have 100% line coverage but not
100% statement coverage because you can put multiple statements on a single
line in JavaScript. Branch coverage refers to control flow statements,
such as <code>if-else</code>. If you have an <code>if-else</code> statement and your test
exercises only the <code>if</code> part, you will have 50% branch coverage for that
statement.</p>

<p>You may note that <em>meadowlark.js</em> does not have 100% coverage. This is not
necessarily a problem; if you look at our refactored <em>meadowlark.js</em> file,
you’ll see that most of what’s in there now is simply configuration…we’re
just gluing things together. We’re configuring Express with the relevant
middleware and starting the server. Not only would it be hard to
meaningfully test this code, but it’s a reasonable argument that you shouldn’t
have to since it’s merely assembling well-tested code.</p>

<p>You could even make the argument that the tests we’ve written so far are
not particularly useful; they’re also just verifying that we’re
configuring Express correctly.</p>

<p>Once again, I have no easy answers. At the end of the day, the type of
application you’re building, your level of experience, and the size and
configuration of your team will have a large impact on how far down the
test rabbit hole you go. I encourage you to err on the side of <em>too
much</em> testing than <em>not enough</em>, but with experience, you’ll find the “just
right” sweet spot.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45053597523448">
<h5>Testing Entropic Functionality</h5>
<p><a data-type="indexterm" data-primary="entropic functionality" id="idm45053597522280"/>Testing <em>entropic</em> functionality (functionality that is random)
comes with its own challenges.
Another test we could add for our fortune cookie generator would be a test
to make sure that it returns a <em>random</em> fortune cookie. But how do you know if something is random?
One approach is to get a large number of fortunes—a thousand, for
example—and then measure the distribution of the responses. If the
function is properly random, no one response will stand out. The downside
of this approach is that it’s nondeterministic: it’s possible (but
unlikely) to get one fortune 10 times more frequently than any other
fortune. If that happened, the test could fail (depending on how
aggressive you set the threshold of what is “random”), but that might not
actually indicate that the system being tested is failing; it’s just a
consequence of testing entropic systems. In the case of our fortune
generator, it would be reasonable to generate 50 fortunes and <span class="keep-together">expect</span> at least three different ones. On the
other hand, if we were developing a random source for a scientific
simulation or security component, we would probably want to have much more
detailed tests. The point is that testing entropic functionality is
difficult and requires more thought.<a data-type="indexterm" data-startref="ix_ch-05-qa-asciidoc1" id="idm45053597518664"/></p>
</div></aside>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Integration Testing"><div class="sect1" id="idm45053597535288">
<h1>Integration Testing</h1>

<p><a data-type="indexterm" data-primary="integration testing" id="ix_ch-05-qa-asciidoc3"/><a data-type="indexterm" data-primary="quality assurance (QA)" data-secondary="integration testing" id="ix_ch-05-qa-asciidoc4"/>There’s currently nothing interesting to test in our application; we just
have a couple of pages and there’s no interaction. So before we write an
integration test, let’s add some functionality that we can test. In the
interest of keeping things simple, we’ll let that functionality be a link
that allows you to get from the home page to the About page. It doesn’t
get much simpler than that! And yet, as simple as that would appear to a
user, it is a true integration test because it’s exercising not only two
Express route handlers, but also the HTML and the DOM interaction (the user
clicking the link and the resulting page navigation). Let’s add a link
to <em>views/home.handlebars</em>:</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;p&gt;</code>Questions?  Checkout out our
<code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"/about"</code> <code class="na">data-test-id=</code><code class="s">"about"</code><code class="nt">&gt;</code>About Us<code class="nt">&lt;/a&gt;</code> page!<code class="nt">&lt;/p&gt;</code></pre>

<p>You might be wondering about the <code>data-test-id</code> attribute. To make
testing, we need some way to identify the link so we can (virtually)
click it. We could have used a CSS class for this, but I prefer to
reserve classes for styling and use data attributes for automation. We also
could have searched for the text <em>About Us</em>, but that would be a
fragile and expensive DOM search. We also could have queried against the
<code>href</code> parameter, which would make sense (but then it would be harder
to make this test fail, which we want to do for educational purposes).</p>

<p>We can go ahead and run our application and verify with our clumsy human
hands that the functionality works as intended before we move on to
something more automated.</p>

<p>Before we jump into installing Puppeteer and writing an integration test,
we need to modify our application so that it can be required as a module
(right now it is designed only to be run directly). The way to do that in
Node is a little opaque: at the bottom of <em>meadowlark.js</em>, replace the
call to <code>app.listen</code> with the following:</p>

<pre data-type="programlisting" data-code-language="js"><code class="k">if</code><code class="p">(</code><code class="nx">require</code><code class="p">.</code><code class="nx">main</code> <code class="o">===</code> <code class="nx">module</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code> <code class="sb">`Express started on http://localhost:</code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">`</code> <code class="o">+</code>
      <code class="s1">'; press Ctrl-C to terminate.'</code> <code class="p">)</code>
  <code class="p">})</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
  <code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">app</code>
<code class="p">}</code></pre>

<p>I’ll skip the technical explanation for this as it’s rather tedious, but if
you’re curious, a careful reading of
<a href="http://bit.ly/32BDO3H">Node’s
module documentation</a> will make it clear. What’s important to know is that
if you run a JavaScript file directly with node, <code>require.main</code> will equal
the global <code>module</code>; otherwise, it’s being imported from another module.</p>

<p><a data-type="indexterm" data-primary="Puppeteer" id="ix_ch-05-qa-asciidoc5"/>Now that we’ve got that out of the way, we can install Puppeteer.
<a data-type="indexterm" data-primary="Chrome" data-secondary="Puppeteer and" id="idm45053597420040"/>Puppeteer is essentially a controllable, headless version of Chrome.
(<em>Headless</em> simply means that the browser is capable of running without
actually rendering a UI on-screen.) To install Puppeteer:</p>

<pre data-type="programlisting">npm install --save-dev puppeteer</pre>

<p>We’ll also install a small utility to find an open port so that we don’t
get a lot of test errors because our app can’t start on the port we
requested:</p>

<pre data-type="programlisting">npm install --save-dev portfinder</pre>

<p>Now we can write an integration that does the following:</p>
<ol>
<li>
<p>Starts our application server on an unoccupied port</p>
</li>
<li>
<p>Launches a headless Chrome browser and opens a page</p>
</li>
<li>
<p>Navigates to our application’s home page</p>
</li>
<li>
<p>Finds a link with <code>data-test-id="about"</code> and clicks it</p>
</li>
<li>
<p>Waits for the navigation to happen</p>
</li>
<li>
<p>Verifies that we are on the <em>/about</em> page</p>
</li>

</ol>

<p>Create a directory called <em>integration-tests</em> (you’re welcome to call it
something else if you like) and a file in that directory called
<em>basic-navigation.test.js</em>
(<em>ch05/integration-tests/basic-navigation.test.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">portfinder</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'portfinder'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">puppeteer</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'puppeteer'</code><code class="p">)</code>

<code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'../meadowlark.js'</code><code class="p">)</code>

<code class="kd">let</code> <code class="nx">server</code> <code class="o">=</code> <code class="kc">null</code>
<code class="kd">let</code> <code class="nx">port</code> <code class="o">=</code> <code class="kc">null</code>

<code class="nx">beforeEach</code><code class="p">(</code><code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">port</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">portfinder</code><code class="p">.</code><code class="nx">getPortPromise</code><code class="p">()</code>
  <code class="nx">server</code> <code class="o">=</code> <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">)</code>
<code class="p">})</code>

<code class="nx">afterEach</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">server</code><code class="p">.</code><code class="nx">close</code><code class="p">()</code>
<code class="p">})</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'home page links to about page'</code><code class="p">,</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">browser</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">puppeteer</code><code class="p">.</code><code class="nx">launch</code><code class="p">()</code>
  <code class="kr">const</code> <code class="nx">page</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">browser</code><code class="p">.</code><code class="nx">newPage</code><code class="p">()</code>
  <code class="nx">await</code> <code class="nx">page</code><code class="p">.</code><code class="kr">goto</code><code class="p">(</code><code class="sb">`http://localhost:</code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>
  <code class="nx">await</code> <code class="nb">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">([</code>
    <code class="nx">page</code><code class="p">.</code><code class="nx">waitForNavigation</code><code class="p">(),</code>
    <code class="nx">page</code><code class="p">.</code><code class="nx">click</code><code class="p">(</code><code class="s1">'[data-test-id="about"]'</code><code class="p">),</code>
  <code class="p">])</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">page</code><code class="p">.</code><code class="nx">url</code><code class="p">()).</code><code class="nx">toBe</code><code class="p">(</code><code class="sb">`http://localhost:</code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">/about`</code><code class="p">)</code>
  <code class="nx">await</code> <code class="nx">browser</code><code class="p">.</code><code class="nx">close</code><code class="p">()</code>
<code class="p">})</code></pre>

<p>We are using Jest’s <code>beforeEach</code> and <code>afterEach</code> hooks to start our server
before each test and stop it after each test (right now we have only one
test, so this will really be meaningful when we add more tests). We could
instead use <code>beforeAll</code> and <code>afterAll</code> so we’re not starting and tearing
down our server for every test, which may speed up your tests, but at the
cost of not having a “clean” environment for each test. That is, if one of
your tests makes changes that affect the outcome of future tests, you’re
introducing hard-to-maintain dependencies.</p>

<p>Our actual test uses Puppeteer’s API, which gives us a lot of DOM query
functionality. Note that almost everything here is asynchronous, and we’re
using <code>await</code> liberally to make the test easier to read and write (almost
all of the Puppeteer API calls return a promise).<sup><a data-type="noteref" id="idm45053597189896-marker" href="ch05.xhtml#idm45053597189896">1</a></sup> We wrap the
navigation and the click together in a call to <code>Promise.all</code> to prevent
race conditions per the Puppeteer documentation.</p>

<p>There’s far more functionality in the Puppeteer API than I could hope to
cover in this book. Fortunately, it has
<a href="http://bit.ly/2KctokI">excellent
documentation</a>.<a data-type="indexterm" data-startref="ix_ch-05-qa-asciidoc5" id="idm45053597186376"/></p>

<p>Testing is a vital backstop in ensuring the quality of your product, but
it’s not the only tool at your disposal. Linting helps you prevent common
errors in the first place.<a data-type="indexterm" data-startref="ix_ch-05-qa-asciidoc4" id="idm45053597185064"/><a data-type="indexterm" data-startref="ix_ch-05-qa-asciidoc3" id="idm45053597184360"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Linting"><div class="sect1" id="idm45053597516920">
<h1>Linting</h1>

<p><a data-type="indexterm" data-primary="linting" id="ix_ch-05-qa-asciidoc6"/><a data-type="indexterm" data-primary="quality assurance (QA)" data-secondary="linting" id="ix_ch-05-qa-asciidoc7"/>A good linter is like having a second set of eyes: it will spot things that
will slide right past our human brains. <a data-type="indexterm" data-primary="Crockford, Douglas" id="idm45053597179448"/><a data-type="indexterm" data-primary="JSLint" id="idm45053597178776"/>The original JavaScript linter is Douglas
Crockford’s JSLint. <a data-type="indexterm" data-primary="JSHint" id="idm45053597177976"/><a data-type="indexterm" data-primary="Kovalyov, Anton" id="idm45053597177304"/>In 2011, Anton Kovalyov forked JSLint, and JSHint was
born. Kovalyov found that JSLint was becoming too
opinionated, and he wanted to create a more customizable,
community-developed JavaScript linter. <a data-type="indexterm" data-primary="Zakas, Nicholas" id="idm45053597176280"/>After <a data-type="indexterm" data-primary="ESLint" id="ix_ch-05-qa-asciidoc8"/>JSHint came Nicholas Zakas’
<a href="https://eslint.org">ESLint</a>, which has become the most popular choice (it
won by a landslide in the <a href="http://bit.ly/2Q7w32O">2017
State of JavaScript survey</a>). In addition to its ubiquity, ESLint appears
to be the most actively maintained linter, and I prefer its flexible
configuration over JSHint, and it is what I am recommending.</p>

<p>ESLint can be installed on a per project basis or globally. To avoid
inadvertently breaking things, I try to avoid global installations (for
example, if I install ESLint globally and update it frequently, old
projects may no longer lint successfully because of breaking changes, and now I
have to do the extra work of updating my project).</p>

<p>To install ESLint in your project:</p>

<pre data-type="programlisting">npm install --save-dev eslint</pre>

<p>ESLint requires a configuration file to tell it which rules to apply.
Doing this from scratch would be a time-consuming task, so fortunately
ESLint provides a utility for creating one for you. From your project
root, run the following:</p>

<pre data-type="programlisting">./node_modules/.bin/eslint --init</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If we installed ESLint globally, we could just use <code>eslint --init</code>. The
awkward <code>./node_modules/.bin</code> path is required to directly run
locally installed utilities. We’ll see soon that we don’t have to do that
if we add utilities to the <code>scripts</code> section of our <em>package.json</em> file,
which is recommended for things we do frequently. However, creating an
ESLint configuration is something we have to do only once per project.</p>
</div>

<p>ESLint will ask you some questions. For most of them, it’s safe to choose
the defaults, but a couple deserve note:</p>
<dl>
<dt>What type of modules does your project use?</dt>
<dd>
<p> Since we’re using Node (as opposed to code that will run in the browser), you’ll want to choose
“CommonJS (require/exports).” You may have client-side JavaScript in your project too, in which case you may want a separate lint configuration. The easiest way to do this is to have two separate projects, but it is possible to have multiple ESLint configurations in the same project. Consult the <a href="https://eslint.org/">ESLint documentation</a> for more information.</p>
</dd>
<dt>Which framework does your project use?</dt>
<dd>
<p>Unless you see Express on there (I don’t at the time of this writing), choose “None of these.”</p>
</dd>
<dt>Where does your code run?</dt>
<dd>
<p>Choose Node.</p>
</dd>
</dl>

<p>Now that ESLint is set up, we need a convenient way of running it. Add the
following to the <code>scripts</code> section of your <em>package.json</em>:</p>

<pre data-type="programlisting">  "lint": "eslint meadowlark.js lib"</pre>

<p>Note that we have to explicitly tell ESLint what files and directories we
want to lint. This is an argument for collecting all of your source under
one directory (usually <em>src</em>).</p>

<p>Now brace yourself and run the following:</p>

<pre data-type="programlisting">npm run lint</pre>

<p>You’ll probably see a lot of unpleasant-looking errors—that’s usually
what happens when you first run ESLint. However, if you’ve been following
along with the Jest test, there will be some spurious errors related to
Jest, which look like this:</p>

<pre data-type="programlisting">   3:1   error  'test' is not defined    no-undef
   5:25  error  'jest' is not defined    no-undef
   7:3   error  'expect' is not defined  no-undef
   8:3   error  'expect' is not defined  no-undef
  11:1   error  'test' is not defined    no-undef
  13:25  error  'jest' is not defined    no-undef
  15:3   error  'expect' is not defined  no-undef</pre>

<p>ESLint (quite sensibly) doesn’t appreciate unrecognized global variables.
Jest injects global variables (notably <code>test</code>, <code>describe</code>, <code>jest</code>, and
<code>expect</code>). Fortunately, this is an easy problem to fix. In your project
root, open the <em>.eslintrc.js</em> file (this is the ESLint configuration). In
the <code>env</code> section, add the following:</p>

<pre data-type="programlisting">"jest": true,</pre>

<p>Now if you run <code>npm run lint</code> again, you should see a lot fewer errors.</p>

<p>So what to do about the remaining errors? Here’s where I can offer wisdom
but no specific guidance. Broadly speaking, a linting error has one of
three causes:</p>

<ul>
<li>
<p>It’s a legitimate problem, and you should fix it. It may not always be obvious, in which case you may need to refer to the ESLint documentation for the particular error.</p>
</li>
<li>
<p>It’s a rule you don’t agree with, and you can simply disable it. Many of the rules in ESLint are a matter of opinion. I’ll demonstrate disabling a rule in a moment.</p>
</li>
<li>
<p>You agree with the rule, but there’s an instance where it’s infeasible or costly to fix in some specific circumstance. For those situations, you can disable rules for only specific lines in a file, which we’ll also see an example of.</p>
</li>
</ul>

<p>If you’ve been following along, you should currently see the following
errors:</p>

<pre data-type="programlisting">/Users/ethan/wdne2e-companion/ch05/meadowlark.js
  27:5  error  Unexpected console statement  no-console

/Users/ethan/wdne2e-companion/ch05/lib/handlers.js
  10:39  error  'next' is defined but never used  no-unused-vars</pre>

<p>ESLint complains about console logging because it’s not necessarily a good
way to provide output for your application; it can be noisy and
inconsistent, and, depending on how you run it, the output can get swept
under the rug. However, for our use, let’s say it doesn’t bother us and we
want to disable that rule. Open your <em>.eslintrc</em> file, find the <code>rules</code>
section (if there isn’t a <code>rules</code> section, create one at the top level of
the exported object), and add the following rule:</p>

<pre data-type="programlisting" data-code-language="js">  <code class="s2">"rules"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"no-console"</code><code class="o">:</code> <code class="s2">"off"</code><code class="p">,</code>
  <code class="p">},</code></pre>

<p>Now if we run <code>npm run lint</code> again, we’ll see that error is no more! The
next one is a little trickier….</p>

<p>Open <em>lib/handlers.js</em> and consider the line in question:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">exports</code><code class="p">.</code><code class="nx">serverError</code> <code class="o">=</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'500'</code><code class="p">)</code></pre>

<p>ESLint is correct; we’re providing <code>next</code> as an argument but not doing
anything with it (we’re also not doing anything with <code>err</code> and <code>req</code>, but
because of the way JavaScript treats function arguments, we have to put
<em>something</em> there so we can get at <code>res</code>, which we <em>are</em> using).</p>

<p>You may be tempted to just remove the <code>next</code> argument. “What’s the harm?”
you may think. And indeed, there would be no runtime errors, and your
linter would be happy…but a hard-to-see harm would be done: your custom
error handler would stop working! (If you want to see for yourself, throw
an exception from one of your routes and try visiting it, and then remove the
<code>next</code> argument from the <code>serverError</code> handler.)</p>

<p>Express is doing something subtle here: it’s using the number of
actual arguments you pass to it to recognize that it’s supposed to be an
error handler. Without that <code>next</code> argument—whether you use it or not—Express no longer recognizes it as an error handler.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>What the Express team has done with the error handler is undeniably
“clever,” but clever code can often be confusing, easy to break, or
inscrutable. As much as I love Express, this is one choice I think the team
got wrong: I think it should have found a less idiosyncratic and more
explicit way to specify an error handler.</p>
</div>

<p>We can’t change our handler code, and we need our error handler, but we
like this rule and don’t want to disable it. We could just live with the
error, but the errors will accumulate and be a constant irritation, and they will
eventually corrode the very point of having a linter. Fortunately, we can
fix it by disabling that rule for that single line. Edit <em>lib/handlers.js</em>
and add the following around your error handler:</p>

<pre data-type="programlisting" data-code-language="js"><code class="c1">// Express recognizes the error handler by way of its four</code>
<code class="c1">// arguments, so we have to disable ESLint's no-unused-vars rule</code>
<code class="cm">/* eslint-disable no-unused-vars */</code>
<code class="nx">exports</code><code class="p">.</code><code class="nx">serverError</code> <code class="o">=</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'500'</code><code class="p">)</code>
<code class="cm">/* eslint-enable no-unused-vars */</code></pre>

<p>Linting can be a little frustrating at first—it may feel like it’s
constantly tripping you up. And certainly you should feel free to disable
rules that don’t suit you. Eventually, you will find it less and less
frustrating as you learn to avoid the common mistakes that linting is
designed to catch.<a data-type="indexterm" data-startref="ix_ch-05-qa-asciidoc8" id="idm45053597010664"/></p>

<p>Testing and linting are undeniably useful, but any tool is worthless if
you never use it! It may seem crazy that you would go to the time and
trouble to write unit tests and set up linting, but I’ve seen it
happen, especially when the pressure is on. Fortunately, there is a way to
ensure that these helpful tools don’t get forgotten: continuous
integration.<a data-type="indexterm" data-startref="ix_ch-05-qa-asciidoc7" id="idm45053597009288"/><a data-type="indexterm" data-startref="ix_ch-05-qa-asciidoc6" id="idm45053597005960"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Continuous Integration"><div class="sect1" id="idm45053597182776">
<h1>Continuous Integration</h1>

<p><a data-type="indexterm" data-primary="CI (continuous integration)" id="idm45053597004232"/><a data-type="indexterm" data-primary="continuous integration (CI)" id="idm45053597003560"/><a data-type="indexterm" data-primary="quality assurance (QA)" data-secondary="continuous integration" id="idm45053597002920"/>I’ll leave you with another extremely useful QA concept: continuous
integration (CI). It’s especially important if you’re working on a team, but
even if you’re working on your own, it can provide some helpful discipline.</p>

<p>Basically, CI runs some or all of your tests every time you contribute code
to a source code repository (you can control which branches this applies
to). If all of the tests pass, nothing usually happens (you
may get an email saying “good job,” depending on how your CI is
configured).</p>

<p>If, on the other hand, there are failures, the consequences are usually
more…public. Again, it depends on how you configure your CI, but usually
the entire team gets an email saying that you “broke the build.” If your
integration master is really sadistic, sometimes your boss is also on that
email list! I’ve even known teams that set up lights and sirens when
someone broke the build, and in one particularly creative office, a tiny
robotic foam missile launcher fired soft projectiles at the offending
developer! It’s a powerful incentive to run your QA toolchain before
committing.</p>

<p>It’s beyond the scope of this book to cover installing and configuring a CI
server, but a chapter on QA wouldn’t be complete without mentioning
it.</p>

<p><a data-type="indexterm" data-primary="Travis CI" id="idm45053596999032"/>Currently, the most popular CI server for Node projects is
<a href="https://travis-ci.org/">Travis CI</a>. Travis CI is a hosted
solution, which can be appealing (it saves you from having to set up
your own CI server). If you’re using GitHub, it offers excellent
integration support. <a href="https://circleci.com">CircleCI</a> is another option.</p>

<p>If you’re working on a project on your own, you may not get much benefit
from a CI server, but if you’re working on a team or an open source
project, I highly recommend looking into setting up CI for your
project.<a data-type="indexterm" data-startref="ix_ch-05-qa-asciidoc0" id="idm45053596995976"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="idm45053597182408">
<h1>Conclusion</h1>

<p>This chapter covered a lot of ground, but I consider these essential
real-world skills in any development framework. The JavaScript ecosystem
is dizzyingly large, and if you’re new to it, it can be hard to know where
to start. I hope this chapter pointed you in the right direction.</p>

<p>Now that we have some experience with these tools, we’ll turn our
attention to some fundamentals of the Node and Express objects that bracket
everything that happens in an Express application: the request and response
objects.</p>
</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idm45053597189896"><sup><a href="ch05.xhtml#idm45053597189896-marker">1</a></sup> If you are unfamiliar with <code>await</code>, I recommend <a href="http://bit.ly/2rEXU0d">this article</a> by Tamas Piros.</p></div></div></section></div>



  </body></html>