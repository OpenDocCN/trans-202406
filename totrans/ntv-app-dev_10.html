<html><head></head><body><section data-pdf-bookmark="Chapter 9. Networking" data-type="chapter" epub:type="chapter"><div class="chapter" id="topics_networking">&#13;
<h1><span class="label">Chapter 9. </span>Networking</h1>&#13;
&#13;
&#13;
<p>While<a data-primary="networking" data-secondary="HTTP requests and responses" data-type="indexterm" id="idm46177225420744"/> it’s certainly possible to have a largely self-contained app—perhaps it only makes HTTP requests to update its version using built-in, automagic Play update infrastructure—it’s rare in our connected world. Whether you need to authenticate users, post usage metrics to your analytics account, read content or media, download or upload files, listen for push notifications, or just sync up with a time server, you’ll want to know how to make an HTTP request and understand an HTTP response.</p>&#13;
&#13;
<p>Fortunately, the HTTP spec has a very simple rules set, and most people find it easy to understand and learn. At the risk of being too simplistic, imagine an HTTP transaction consists of two parts: a request and a response. Both are represented as simple (and often human-readable) text files. The first line of each describes some basic attributes about the file (like the URL for a request, and the status for a response). The next lines are header information in traditional key-value-pair syntax: <code>header-name: Header Value</code>. Then a “blank” (empty) line, and you’re at the body. That’s it! For more info, check out <a href="https://oreil.ly/Qh4ZZ">“HTTP Made Really Easy”</a>.</p>&#13;
&#13;
<p>From high-level authentication protocols to streaming encrypted video data to uploading every image on your phone in the background, all of these operations use the same basic tenets described previously.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tasks" data-type="sect1"><div class="sect1" id="idm46177225416280">&#13;
<h1>Tasks</h1>&#13;
&#13;
<p>In<a data-primary="networking" data-secondary="task overview" data-type="indexterm" id="idm46177225414952"/> this chapter, you’ll learn to:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Read and print a text file from a remote server.</p>&#13;
</li>&#13;
<li>&#13;
<p>Make an HTTP POST request.</p>&#13;
</li>&#13;
<li>&#13;
<p>Download a binary file.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Android" data-type="sect1"><div class="sect1" id="idm46177225410552">&#13;
<h1>Android</h1>&#13;
&#13;
<p>With<a data-primary="networking" data-secondary="Android" data-tertiary="third-party libraries" data-type="indexterm" id="idm46177225408952"/><a data-primary="Android" data-secondary="networking" data-tertiary="third-party libraries" data-type="indexterm" id="idm46177225407672"/> the fantastically open nature of Android development, some really terrific third-party libraries have come up around potentially complex tasks like networking. The most popular is probably OkHttp, developed by a well-known and trusted Android developer named Jake Wharton, who wrote a ton of great open source software while working for a company called Square and continues to contribute now directly from Google. If you check the links in the notes block at the end of this Android section, you’ll see a disproportionate number of links are from Square’s GitHub account.</p>&#13;
&#13;
<p>Remember<a data-primary="Android" data-secondary="networking" data-tertiary="threading and" data-type="indexterm" id="idm46177225405128"/><a data-primary="networking" data-secondary="Android" data-tertiary="threading and" data-type="indexterm" id="idm46177225403848"/> that any time you’re dealing with anything other than main memory (RAM), you should probably be working on a background thread. Reading a local file, querying a database, and even saving preferences should all happen off the main UI thread. <em>This is especially important when dealing with network requests and responses</em>. Imagine that a small file probably only takes a few milliseconds to touch, open, read, close, and convert to a <code>String</code> value—but even that few milliseconds can make the fling of a <code>RecyclerView</code> stutter or a <code>NavigationDrawer</code> seem to open fully and immediately. Now, imagine this along the lines of a network request. I’m sure we’ve all seen requests that take 10 seconds or 20 seconds or even longer to resolve—some servers won’t even timeout for a minute! Imagine blocking the drawing thread that whole time with a spinning for loop just waiting for data. <em>When preforming network operations, in almost all cases, you should be working on a background thread</em>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Read and Print a Text File on a Remote Server" data-type="sect2"><div class="sect2" id="idm46177225399608">&#13;
<h2>Read and Print a Text File on a Remote Server</h2>&#13;
&#13;
<p>That<a data-primary="Android" data-secondary="networking" data-tertiary="text files on remote servers" data-type="indexterm" id="idm46177225398072"/><a data-primary="networking" data-secondary="Android" data-tertiary="text files on remote servers" data-type="indexterm" id="idm46177225396776"/> <a data-primary="text files" data-secondary="Android" data-type="indexterm" id="idm46177225395416"/>said, making a network request with straight Java is really not that complicated—here are six lines (just counting statements) of magic that’ll<a data-primary="Java" data-secondary="networking" data-tertiary="text files on remote servers" data-type="indexterm" id="idm46177225394152"/><a data-primary="Kotlin" data-secondary="networking" data-tertiary="text files on remote servers" data-type="indexterm" id="idm46177225392920"/> print out any publicly accessible remote file:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177225391432">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Networking</code> <code class="o">{</code>&#13;
 <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">printRemoteFile</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
   <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="o">(</code><code class="s">"http://moagrius.com"</code><code class="o">);</code>&#13;
   <code class="n">HttpURLConnection</code> <code class="n">connection</code> <code class="o">=</code> <code class="o">(</code><code class="n">HttpURLConnection</code><code class="o">)</code> <code class="n">url</code><code class="o">.</code><code class="na">openConnection</code><code class="o">();</code>&#13;
   <code class="kt">int</code> <code class="n">data</code><code class="o">;</code>&#13;
   <code class="k">while</code> <code class="o">((</code><code class="n">data</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">().</code><code class="na">read</code><code class="o">())</code> <code class="o">!=</code> <code class="o">-</code><code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
     <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">((</code><code class="kt">char</code><code class="o">)</code> <code class="n">data</code><code class="o">);</code>&#13;
   <code class="o">}</code>&#13;
 <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">printRemoteFile</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">val</code> <code class="py">url</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="s">"http://moagrius.com"</code><code class="p">)</code>&#13;
  <code class="k">val</code> <code class="py">connection</code> <code class="p">=</code> <code class="n">url</code><code class="p">.</code><code class="n">openConnection</code><code class="p">()</code> <code class="k">as</code> <code class="n">HttpURLConnection</code>&#13;
  <code class="k">var</code> <code class="py">data</code><code class="p">:</code> <code class="n">Int</code> <code class="p">=</code> <code class="n">connection</code><code class="p">.</code><code class="n">inputStream</code><code class="p">.</code><code class="n">read</code><code class="p">();</code>&#13;
  <code class="k">while</code> <code class="p">(</code><code class="n">data</code> <code class="p">!=</code> <code class="p">-</code><code class="m">1</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">print</code><code class="p">(</code><code class="n">data</code><code class="p">.</code><code class="n">toChar</code><code class="p">())</code>&#13;
    <code class="n">data</code> <code class="p">=</code> <code class="n">connection</code><code class="p">.</code><code class="n">inputStream</code><code class="p">.</code><code class="n">read</code><code class="p">()</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Let’s break this down line by line.</p>&#13;
&#13;
<p>First, we need a <code>URL</code> instance. A <code>URL</code> instance represents a <em>resource</em>, not the <em>location</em> of that resource, despite the name. The location is most accurately represented by the <code>String</code> passed in to the <code>URL</code> constructor.</p>&#13;
&#13;
<p>By upping our game from <code>String</code> to <code>URL</code>, we get a ton of standard library goodies out of the box—like an <code>HttpUrlConnection</code> via the <code>openConnection</code> method. While there’s a lot that can be done with the connection, the most straightforward thing we can do with it happens on the next few lines—grab its <code>InputStream</code> and read it out! This may look a lot like how we dealt with stream data back in the <a data-type="xref" href="ch06.html#topics_files">Chapter 6</a> section—check that out for a refresher.</p>&#13;
&#13;
<p>That’s it! Pretty simple, right? Well, let’s dress it up a little.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Make an HTTP POST Request" data-type="sect2"><div class="sect2" id="idm46177225190008">&#13;
<h2>Make an HTTP POST Request</h2>&#13;
&#13;
<p>We’ll<a data-primary="Android" data-secondary="networking" data-tertiary="making HTTP POST requests" data-type="indexterm" id="idm46177225188312"/><a data-primary="networking" data-secondary="Android" data-tertiary="making HTTP POST requests" data-type="indexterm" id="idm46177225187064"/><a data-primary="jsonplaceholder.typicode.com" data-type="indexterm" id="idm46177225185880"/> make use of the publicly available <em>jsonplaceholder.typicode.com</em> free service to emulate POSTing data so that we can see that our code really is sending up data that we can read back out later. We’ll use the <a href="https://oreil.ly/2iZxz">Create A Resource</a> endpoint.</p>&#13;
&#13;
<p>Let’s<a data-primary="Java" data-secondary="networking" data-tertiary="making HTTP POST requests" data-type="indexterm" id="idm46177225183464"/><a data-primary="Kotlin" data-secondary="networking" data-tertiary="making HTTP POST requests" data-type="indexterm" id="idm46177225182120"/> modify our reader example with a simple, empty post:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177225180632">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Networking</code> <code class="o">{</code>&#13;
 <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">saveRemoteData</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
  <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="o">(</code><code class="s">"https://jsonplaceholder.typicode.com/posts"</code><code class="o">);</code>&#13;
  <code class="n">HttpsURLConnection</code> <code class="n">connection</code> <code class="o">=</code> <code class="o">(</code><code class="n">HttpsURLConnection</code><code class="o">)</code> <code class="n">url</code><code class="o">.</code><code class="na">openConnection</code><code class="o">();</code>&#13;
  <code class="n">connection</code><code class="o">.</code><code class="na">setRequestMethod</code><code class="o">(</code><code class="s">"POST"</code><code class="o">);</code>&#13;
  <code class="kt">int</code> <code class="n">data</code><code class="o">;</code>&#13;
  <code class="k">while</code> <code class="o">((</code><code class="n">data</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">().</code><code class="na">read</code><code class="o">())</code> <code class="o">!=</code> <code class="o">-</code><code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">((</code><code class="kt">char</code><code class="o">)</code> <code class="n">data</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
 <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">saveRemoteData</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">val</code> <code class="py">url</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="s">"https://jsonplaceholder.typicode.com/posts"</code><code class="p">)</code>&#13;
  <code class="k">val</code> <code class="py">connection</code> <code class="p">=</code> <code class="n">url</code><code class="p">.</code><code class="n">openConnection</code><code class="p">()</code> <code class="k">as</code> <code class="n">HttpsURLConnection</code>&#13;
  <code class="n">connection</code><code class="p">.</code><code class="n">requestMethod</code> <code class="p">=</code> <code class="s">"POST"</code>&#13;
  <code class="k">var</code> <code class="py">data</code><code class="p">:</code> <code class="n">Int</code> <code class="p">=</code> <code class="n">connection</code><code class="p">.</code><code class="n">inputStream</code><code class="p">.</code><code class="n">read</code><code class="p">();</code>&#13;
  <code class="k">while</code> <code class="p">(</code><code class="n">data</code> <code class="p">!=</code> <code class="p">-</code><code class="m">1</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">print</code><code class="p">(</code><code class="n">data</code><code class="p">.</code><code class="n">toChar</code><code class="p">())</code>&#13;
    <code class="n">data</code> <code class="p">=</code> <code class="n">connection</code><code class="p">.</code><code class="n">inputStream</code><code class="p">.</code><code class="n">read</code><code class="p">()</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>If you look closely, you’ll see only a couple very minor things changed:</p>&#13;
<ol>&#13;
<li>&#13;
<p>We cast the return of <code>openConnection</code> to <code>HttpsUrlConnection</code>, rather than <code>HttpUrlConnection</code>, simply because the location used the HTTPS scheme.</p>&#13;
</li>&#13;
<li>&#13;
<p>We set the request method of the connection to POST, instead of the default, GET.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>While this does in fact work and your output should give you some new ID for the object you created, there’s not a lot more going on. In a slightly closer to real-life example, we’d probably want to add some data to the request. This might happen in the form of query parameters, headers, or the post body. For this service, we’ll use a JSON post body.</p>&#13;
&#13;
<p>Just like the connection object has a built-in <code>InputStream</code> to read from, it also handily has an <code>OutputStream</code> to write to. However, that requires a little extra housekeeping—we have to call <code>connection.setDoOutput(true)</code> in order to be able to write to that <code>OutputStream</code>.</p>&#13;
&#13;
<p>Let’s update the example again:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177224944120">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">saveRemoteData</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
  <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="o">(</code><code class="s">"https://jsonplaceholder.typicode.com/posts"</code><code class="o">);</code>&#13;
  <code class="n">HttpsURLConnection</code> <code class="n">connection</code> <code class="o">=</code> <code class="o">(</code><code class="n">HttpsURLConnection</code><code class="o">)</code> <code class="n">url</code><code class="o">.</code><code class="na">openConnection</code><code class="o">();</code>&#13;
  <code class="n">connection</code><code class="o">.</code><code class="na">setRequestMethod</code><code class="o">(</code><code class="s">"POST"</code><code class="o">);</code>&#13;
  <code class="n">connection</code><code class="o">.</code><code class="na">setDoOutput</code><code class="o">(</code><code class="kc">true</code><code class="o">);</code>&#13;
  <code class="n">connection</code><code class="o">.</code><code class="na">setRequestProperty</code><code class="o">(</code><code class="s">"Content-Type"</code><code class="o">,</code> <code class="s">"application/x-www-form-urlencoded"</code><code class="o">);</code>&#13;
  <code class="n">String</code> <code class="n">json</code> <code class="o">=</code> <code class="s">"{title:'foo', body:'bar', userId:1}"</code><code class="o">;</code>&#13;
  <code class="n">connection</code><code class="o">.</code><code class="na">getOutputStream</code><code class="o">().</code><code class="na">write</code><code class="o">(</code><code class="n">json</code><code class="o">.</code><code class="na">getBytes</code><code class="o">());</code>&#13;
  <code class="kt">int</code> <code class="n">data</code><code class="o">;</code>&#13;
  <code class="k">while</code> <code class="o">((</code><code class="n">data</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">().</code><code class="na">read</code><code class="o">())</code> <code class="o">!=</code> <code class="o">-</code><code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">((</code><code class="kt">char</code><code class="o">)</code> <code class="n">data</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
 <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">saveRemoteData</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">val</code> <code class="py">url</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="s">"https://jsonplaceholder.typicode.com/posts"</code><code class="p">)</code>&#13;
  <code class="k">val</code> <code class="py">connection</code> <code class="p">=</code> <code class="n">url</code><code class="p">.</code><code class="n">openConnection</code><code class="p">()</code> <code class="k">as</code> <code class="n">HttpsURLConnection</code>&#13;
  <code class="n">connection</code><code class="p">.</code><code class="n">requestMethod</code> <code class="p">=</code> <code class="s">"POST"</code>&#13;
  <code class="n">connection</code><code class="p">.</code><code class="n">doOutput</code> <code class="p">=</code> <code class="k">true</code>&#13;
  <code class="n">connection</code><code class="p">.</code><code class="n">setRequestProperty</code><code class="p">(</code><code class="s">"Content-Type"</code><code class="p">,</code> <code class="s">"application/x-www-form-urlencoded"</code><code class="p">)</code>&#13;
  <code class="k">val</code> <code class="py">json</code> <code class="p">=</code> <code class="s">"{title:'foo', body:'bar', userId:1}"</code>&#13;
  <code class="n">connection</code><code class="p">.</code><code class="n">outputStream</code><code class="p">.</code><code class="n">write</code><code class="p">(</code><code class="n">json</code><code class="p">.</code><code class="n">toByteArray</code><code class="p">())</code>&#13;
  <code class="k">var</code> <code class="py">data</code><code class="p">:</code> <code class="n">Int</code> <code class="p">=</code> <code class="n">connection</code><code class="p">.</code><code class="n">inputStream</code><code class="p">.</code><code class="n">read</code><code class="p">();</code>&#13;
  <code class="k">while</code> <code class="p">(</code><code class="n">data</code> <code class="p">!=</code> <code class="p">-</code><code class="m">1</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">print</code><code class="p">(</code><code class="n">data</code><code class="p">.</code><code class="n">toChar</code><code class="p">())</code>&#13;
    <code class="n">data</code> <code class="p">=</code> <code class="n">connection</code><code class="p">.</code><code class="n">inputStream</code><code class="p">.</code><code class="n">read</code><code class="p">()</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Now we’re sending some data that the server can handle however it likes. Again, with each extension of functionality, there’s a little more work and a little more consideration required, but if you start at the fundamentals (the first example), you can get a pretty good idea of how the whole thing works.</p>&#13;
&#13;
<p>Developers will find that when working with networking libraries, a lot of the work is very similar, even if the libraries use dramatically different operations behind the scenes. When we first wrote our binary downloader for my current employer, I used all standard libraries. Later, we wanted to use a single HTTP client for all our network requests (images, REST, downloads, etc), so I sat down with a cup o’ joe and planned on spending the afternoon refitting our downloader to work with OkHttp. I don’t remember exactly how long it took, or exactly how many lines where changed, but I’ll say I was writing tests by lunch and in QA before EOD (read: it was a simple task).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Download a Binary File" data-type="sect2"><div class="sect2" id="idm46177224843352">&#13;
<h2>Download a Binary File</h2>&#13;
&#13;
<p>We’ll<a data-primary="files" data-secondary="Android" data-tertiary="downloading binary files" data-type="indexterm" id="idm46177224806264"/><a data-primary="binary files, downloading" data-secondary="Android" data-type="indexterm" id="idm46177224805016"/><a data-primary="Android" data-secondary="networking" data-tertiary="downloading binary files" data-type="indexterm" id="idm46177224804104"/><a data-primary="networking" data-secondary="Android" data-tertiary="downloading binary files" data-type="indexterm" id="idm46177224802920"/> combine the information presented so far with some of the things we learned in <a data-type="xref" href="ch06.html#topics_files">Chapter 6</a> to download a binary file. Don’t worry, it’s not a heck of a lot different from what we’ve already done.</p>&#13;
&#13;
<p>Here’s the URL to the header image I use on my personal site: <em><a href="http://moagrius.com/assets/images/hero-trips.png"><em class="hyperlink">http://moagrius.com/assets/images/hero-trips.png</em></a></em>. It’s just an image, but it is binary data—the same logic would work for a video or an executable, or even just a couple bits of arbitrary binary data.</p>&#13;
&#13;
<p>Let’s think what we’ll need to do differently. We know we’ll get back an <code>InputStream</code> with the bytes that make up the image, so what do we do with them? Well, if we remember the lessons in <a data-type="xref" href="ch06.html#topics_files">Chapter 6</a> on files, we know we’ll want a <code>FileOutputStream</code> on our local device to save those bytes to. That’s really about the only difference! Let’s<a data-primary="Java" data-secondary="networking" data-tertiary="downloading binary files" data-type="indexterm" id="idm46177224696344"/><a data-primary="Kotlin" data-secondary="networking" data-tertiary="downloading binary files" data-type="indexterm" id="idm46177224695032"/> give it a shot:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177224693544">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Networking</code> <code class="o">{</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">downloadBinaryData</code><code class="o">(</code><code class="n">Context</code> <code class="n">context</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
    <code class="n">File</code> <code class="n">file</code> <code class="o">=</code> <code class="k">new</code> <code class="n">File</code><code class="o">(</code><code class="n">context</code><code class="o">.</code><code class="na">getFilesDir</code><code class="o">(),</code> <code class="s">"downloaded-image.png"</code><code class="o">);</code>&#13;
    <code class="n">FileOutputStream</code> <code class="n">fileOutputStream</code> <code class="o">=</code> <code class="k">new</code> <code class="n">FileOutputStream</code><code class="o">(</code><code class="n">file</code><code class="o">);</code>&#13;
    <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="o">(</code><code class="s">"http://moagrius.com/assets/images/hero-trips.png"</code><code class="o">);</code>&#13;
    <code class="n">HttpURLConnection</code> <code class="n">connection</code> <code class="o">=</code> <code class="o">(</code><code class="n">HttpURLConnection</code><code class="o">)</code> <code class="n">url</code><code class="o">.</code><code class="na">openConnection</code><code class="o">();</code>&#13;
    <code class="kt">int</code> <code class="n">data</code><code class="o">;</code>&#13;
    <code class="k">while</code> <code class="o">((</code><code class="n">data</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">().</code><code class="na">read</code><code class="o">())</code> <code class="o">!=</code> <code class="o">-</code><code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="n">fileOutputStream</code><code class="o">.</code><code class="na">write</code><code class="o">(</code><code class="n">data</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
    <code class="n">fileOutputStream</code><code class="o">.</code><code class="na">flush</code><code class="o">();</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">downloadBinaryData</code><code class="p">(</code><code class="n">context</code><code class="p">:</code> <code class="n">Context</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="k">val</code> <code class="py">file</code> <code class="p">=</code> <code class="n">File</code><code class="p">(</code><code class="n">context</code><code class="p">.</code><code class="n">filesDir</code><code class="p">,</code> <code class="s">"downloaded-image.png"</code><code class="p">)</code>&#13;
  <code class="k">val</code> <code class="py">fileOutputStream</code> <code class="p">=</code> <code class="n">FileOutputStream</code><code class="p">(</code><code class="n">file</code><code class="p">)</code>&#13;
  <code class="k">val</code> <code class="py">url</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="s">"http://moagrius.com/assets/images/hero-trips.png"</code><code class="p">)</code>&#13;
  <code class="k">val</code> <code class="py">connection</code> <code class="p">=</code> <code class="n">url</code><code class="p">.</code><code class="n">openConnection</code><code class="p">()</code> <code class="k">as</code> <code class="n">HttpURLConnection</code>&#13;
  <code class="k">var</code> <code class="py">data</code><code class="p">:</code> <code class="n">Int</code> <code class="p">=</code> <code class="n">connection</code><code class="p">.</code><code class="n">inputStream</code><code class="p">.</code><code class="n">read</code><code class="p">();</code>&#13;
  <code class="k">while</code> <code class="p">(</code><code class="n">data</code> <code class="p">!=</code> <code class="p">-</code><code class="m">1</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">fileOutputStream</code><code class="p">.</code><code class="n">write</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>&#13;
    <code class="n">data</code> <code class="p">=</code> <code class="n">connection</code><code class="p">.</code><code class="n">inputStream</code><code class="p">.</code><code class="n">read</code><code class="p">()</code>&#13;
  <code class="p">}</code>&#13;
  <code class="n">fileOutputStream</code><code class="p">.</code><code class="n">flush</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>After running this method, you should find a fully decoded, visually accurate copy of the file on my site—congratulations!</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Networking<a data-primary="Android" data-secondary="networking" data-tertiary="additional resources" data-type="indexterm" id="idm46177224394168"/><a data-primary="networking" data-secondary="Android" data-tertiary="additional resources" data-type="indexterm" id="idm46177224392920"/> really includes a lot more than we can cover in this chapter, but we’ll point you in the right direction:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/_Lk9z">OkHttp</a> and <a href="https://oreil.ly/1fSIz">Volley</a> both provide additional networking APIs.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/0VyGt">Picasso</a>, <a href="https://oreil.ly/_D3HE">Glide</a>, and <a href="https://oreil.ly/2gaY5">Volley</a> all offer very simple APIs for loading and displaying remote images, combining the network, and decoding layers.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/RRhOS">Gson</a> and <a href="https://oreil.ly/e95wK">Jackson</a> are great JSON parsers for reading from REST APIs.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/lT-5Z">Retrofit</a> combines OkHttp for the network request and Gson for JSON parsing to allow for some simple API readers.</p>&#13;
</li>&#13;
</ul>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="iOS" data-type="sect1"><div class="sect1" id="idm46177224381880">&#13;
<h1>iOS</h1>&#13;
&#13;
<p>Networking has historically been a strength of macOS and, in turn, iOS. The suite of objects purpose-built and provided by the system are comprehensive and well thought out. In fact, most of the third-party networking libraries available sit lightly on top of the classes provided by the operating system. There are some very strong choices available, Alamofire for one, but for a large percentage of apps the built-in tools are the best choice. As such, in this chapter, we’ll use those very objects to demonstrate the powerful tools available right at your fingertips within iOS.</p>&#13;
&#13;
<p>Let’s dig in!</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Read and Print a Text File on a Remote Server" data-type="sect2"><div class="sect2" id="idm46177224379176">&#13;
<h2>Read and Print a Text File on a Remote Server</h2>&#13;
&#13;
<p>Reading<a data-primary="text files" data-secondary="iOS" data-type="indexterm" id="idm46177224377448"/><a data-primary="iOS" data-secondary="networking" data-tertiary="text files on remote servers" data-type="indexterm" id="idm46177224376440"/><a data-primary="networking" data-secondary="iOS" data-tertiary="text files on remote servers" data-type="indexterm" id="idm46177224375256"/> data from a web server somewhere in the world is, at its root, the simplest thing you can do with networking. In iOS, you can request information from a server with the following naive example:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"https://www.oreilly.com"</code><code class="p">)</code><code class="o">!</code>&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">dataTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">data</code> <code class="k">else</code> <code class="p">{</code> <code class="k">return</code> <code class="p">}</code>&#13;
    <code class="kd">let</code> <code class="nv">string</code> <code class="p">=</code> <code class="nb">String</code><code class="p">(</code><code class="n">data</code><code class="p">:</code> <code class="n">data</code><code class="p">,</code> <code class="n">encoding</code><code class="p">:</code> <code class="p">.</code><code class="n">utf8</code><code class="p">)</code><code class="o">!</code>&#13;
    <code class="bp">print</code><code class="p">(</code><code class="n">string</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>Let’s walk through what’s happening here.</p>&#13;
&#13;
<p>First, we create a <code>URL</code> that points to a specific file, website, or API—the O’Reilly Media homepage in this example. Next, we use a shared <code>URLSession</code> object to generate a <code>URLSessionDataTask</code> for our URL and give it a completion handler as a trailing <span class="keep-together">closure</span>. Inside the completion handler, we convert the raw data (passed in as a <code>Data</code> object) to a <code>String</code> instance and then <code>print</code> that data, which just happens to be the HTML normally displayed by a web browser. Finally, we call <code>resume()</code> on the task that was created to kickstart the whole process.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>You might notice in the example code we’re using an HTTPS URL. Since iOS 9, all HTTP requests need to be HTTPS, unless they are explicitly allowed (or fully disabled) within an<a data-primary="Info.plist file" data-type="indexterm" id="idm46177224263112"/> app’s <em>Info.plist</em> file via the <code>NSAppTransportSecurity</code> key.</p>&#13;
</div>&#13;
&#13;
<p>There are some new classes that have shown up in this example. The<a data-primary="URLSession class" data-secondary="basic function of" data-type="indexterm" id="idm46177224260616"/> first of these new classes is <code>URLSession</code>. This is the class that drives most of the functionality within the top-level networking APIs within iOS. At its most basic function, each <code>URLSession</code> is a coordinator of different network tasks; the tasks are associated directly with a <code>URLSession</code> object during creation. The session objects themselves can have their behavior configured by passing in a <code>URLSessionConfiguration</code> object in the initializer. You can create multiple sessions or, for simple needs, just use the shared session that is accessible by the aptly named <code>URLSession.shared</code> property as used previously.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p><code>URLSession</code> instances can be configured in a variety of ways. <code>URLSessionConfiguration</code> also has some standard configurations provided for convenience. These include <code>default</code>, <code>ephemeral</code>, and <code>background(with:)</code>. Check out the <a href="https://oreil.ly/_ldvZ">Apple developer docs</a> for more information.</p>&#13;
</div>&#13;
&#13;
<p>A <code>URLSession</code> instance is the originator of the tasks too. It’s easy to think of a network task as an operation; they provide all the actual functionality of a network request and response. Like operations, they also typically run asynchronously.</p>&#13;
&#13;
<p>There are three types of tasks:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>URLSessionDataTask</code>, which is used for receiving data (returned as a <code>Data</code> object) from a server</p>&#13;
</li>&#13;
<li>&#13;
<p><code>URLSessionDownloadTask</code>, which is primarily used for retrieving files from a server and can be paused and resumed, as well as provide updates on download progress (this will be covered later in the chapter)</p>&#13;
</li>&#13;
<li>&#13;
<p><code>URLSessionUploadTask</code>, which <em>sends</em> data or files to a server (this is covered in the next section in this chapter)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>It’s important to know when to use one task over another. Rarely would a developer use a data task to download a large file. In addition, it would be unwise (and quite cumbersome) to use a download task to receive a simple JSON response from an endpoint. Tasks are specialized to make your job, as a developer, easier and the logic <span class="keep-together">simpler</span>.</p>&#13;
&#13;
<p>Now, the preceding example is somewhat sparse and a bit naive in its approach. Here is a much fuller and complete example that checks for any client errors, for valid server response status codes, and for empty data:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"https://www.oreilly.com"</code><code class="p">)</code><code class="o">!</code>&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">dataTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
    <code class="k">if</code> <code class="kd">let</code> <code class="nv">error</code> <code class="p">=</code> <code class="n">error</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="n">error</code><code class="p">.</code><code class="n">localizedDescription</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">response</code> <code class="p">=</code> <code class="n">response</code> <code class="k">as</code><code class="p">?</code> <code class="n">HTTPURLResponse</code><code class="p">,</code> <code class="n">response</code><code class="p">.</code><code class="n">statusCode</code> <code class="o">&lt;</code> <code class="mi">300</code> <code class="k">else</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="s">"A server error occured."</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">data</code><code class="p">,</code> <code class="kd">let</code> <code class="nv">string</code> <code class="p">=</code> <code class="nb">String</code><code class="p">(</code><code class="n">data</code><code class="p">:</code> <code class="n">data</code><code class="p">,</code> <code class="n">encoding</code><code class="p">:</code> <code class="p">.</code><code class="n">utf8</code><code class="p">)</code> <code class="k">else</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="s">"No data returned."</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="bp">print</code><code class="p">(</code><code class="n">string</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>Receiving data from a server is useful, and certainly the majority of network calls made are requests for data. However, if you spend any time with a REST API, you’ll quickly need to learn how to send data as well as receive data.</p>&#13;
&#13;
<p>Let’s see how it works in iOS.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Make an HTTP POST Request" data-type="sect2"><div class="sect2" id="idm46177224378520">&#13;
<h2>Make an HTTP POST Request</h2>&#13;
&#13;
<p>The<a data-primary="iOS" data-secondary="networking" data-tertiary="making HTTP POST requests" data-type="indexterm" id="INpost09"/><a data-primary="networking" data-secondary="iOS" data-tertiary="making HTTP POST requests" data-type="indexterm" id="NIpost09"/> easiest way to get started sending data to the server is to send a bit of text to a URL. This can be accomplished with the following code:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="s">"text to send"</code><code class="p">.</code><code class="n">data</code><code class="p">(</code><code class="n">using</code><code class="p">:</code> <code class="p">.</code><code class="n">utf8</code><code class="p">)</code>&#13;
<code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"https://www.oreilly.com"</code><code class="p">)</code><code class="o">!</code>&#13;
&#13;
<code class="kd">var</code> <code class="nv">urlRequest</code> <code class="p">=</code> <code class="n">URLRequest</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code>&#13;
<code class="n">urlRequest</code><code class="p">.</code><code class="n">httpMethod</code> <code class="p">=</code> <code class="s">"POST"</code>&#13;
<code class="n">urlRequest</code><code class="p">.</code><code class="n">httpBody</code> <code class="p">=</code> <code class="n">data</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code>&#13;
  <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">dataTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">urlRequest</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
	<code class="p">...</code>&#13;
<code class="p">}</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>This is a simple example, but usually data that we wanted to send to a server isn’t unstructured text strings. Often it’s JSON or key-value form data. Luckily, there is a helpful object one can use called <code>URLComponents</code> to create a percent-encoded key-value data string from a set of values. You can use it like so:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">var</code> <code class="nv">components</code> <code class="p">=</code> <code class="n">URLComponents</code><code class="p">()</code>&#13;
<code class="n">components</code><code class="p">.</code><code class="n">queryItems</code> <code class="p">=</code> <code class="p">[</code>&#13;
    <code class="n">URLQueryItem</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="s">"name"</code><code class="p">,</code> <code class="n">value</code><code class="p">:</code> <code class="s">"O'Reilly"</code><code class="p">),</code>&#13;
    <code class="n">URLQueryItem</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="s">"isAwesome"</code><code class="p">,</code> <code class="n">value</code><code class="p">:</code> <code class="s">"true"</code><code class="p">)</code>&#13;
<code class="p">]</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"https://www.oreilly.com"</code><code class="p">)</code><code class="o">!</code>&#13;
&#13;
<code class="kd">var</code> <code class="nv">urlRequest</code> <code class="p">=</code> <code class="n">URLRequest</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code>&#13;
<code class="n">urlRequest</code><code class="p">.</code><code class="n">httpMethod</code> <code class="p">=</code> <code class="s">"POST"</code>&#13;
<code class="n">urlRequest</code><code class="p">.</code><code class="n">httpBody</code> <code class="p">=</code> <code class="n">components</code><code class="p">.</code><code class="n">query</code><code class="p">?.</code><code class="n">data</code><code class="p">(</code><code class="n">using</code><code class="p">:</code> <code class="p">.</code><code class="n">utf8</code><code class="p">)</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code>&#13;
  <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">dataTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">urlRequest</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
	<code class="p">...</code>&#13;
<code class="p">}</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>First, we create an instance of <code>URLComponents</code>. Next, we add query items to the <code><span class="keep-together">query</span>Items</code> property that consist of key-value objects of the type <code>URLQueryItem</code>. These objects are then transformed into a percent-encoded text string whenever the <code>httpBody</code> property is assigned to the <code>URLRequest</code> created.</p>&#13;
&#13;
<p>Often we might want to send more than just key-value data, though. Here is an example of how a file might be uploaded to a server:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="s">"file data"</code><code class="p">.</code><code class="n">data</code><code class="p">(</code><code class="n">using</code><code class="p">:</code> <code class="p">.</code><code class="n">utf8</code><code class="p">)</code><code class="o">!</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"http://www.example.com"</code><code class="p">)</code><code class="o">!</code>&#13;
<code class="kd">var</code> <code class="nv">request</code> <code class="p">=</code> <code class="n">URLRequest</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code>&#13;
<code class="n">request</code><code class="p">.</code><code class="n">httpMethod</code> <code class="p">=</code> <code class="s">"POST"</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">uploadTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">request</code><code class="p">,</code> <code class="n">from</code><code class="p">:</code> <code class="n">data</code><code class="p">)</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>Walking through this code, we first create a string of data representing our mock file, “file data,” that is converted to a <code>Data</code> object in preparation for being sent later. Next, we define a URL pointing to <em>http://www.example.com</em> as a placeholder. This is then passed to a new object type called <code>URLRequest</code> that we used in our simple <code>POST</code> example. A <code>URLRequest</code> is an abstraction of the request we are making. It’s done this way so we can specify some changes to the way we are sending this request to the server. In the preceding example, we’re specifying the HTTP method used: <code>POST</code>. This maps directly to the standard REST verbs available, with the default being <code>GET</code>.</p>&#13;
&#13;
<p>Finally, within this example, similar to our examples in the previous section, we are creating a <code>URLSessionTask</code> using the shared URL session; in this case, however, we are creating a <code>URLSessionUploadTask</code> with the <code>uploadTask</code> method. To kick off the task and perform the request, we call <code>resume()</code> to send the <code>data</code> object passed in off to the server.</p>&#13;
&#13;
<p>This is a simple example. It’s likely data will be returned from the server about the request sent, including information about whether the outcome was successful or if it failed. However, it’s possible to keep the simplicity of this example by using an overloaded method of <code>uploadTask</code> to pass in a completion handler like so:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="p">...</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code>&#13;
  <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">uploadTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">request</code><code class="p">,</code> <code class="n">from</code><code class="p">:</code> <code class="n">data</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
&#13;
    <code class="c1">// Handle any client errors with error</code>&#13;
&#13;
    <code class="c1">// Handle any server errors with response</code>&#13;
&#13;
    <code class="c1">// Use the data object returned</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Most modern APIs take structured data, like JSON, as input and return JSON as output. Our simplistic string of data example actually scales somewhat easily without changing much except creating a structure to provide the structure for our data. Here’s a complete example of how to post JSON up to an endpoint and handle the response:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="c1">// Define an object to hold our data</code>&#13;
<code class="kd">struct</code> <code class="nc">Book</code><code class="p">:</code> <code class="n">Codable</code> <code class="p">{</code>&#13;
    <code class="kd">let</code> <code class="nv">title</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">isbn</code><code class="p">:</code> <code class="nb">String</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Populate our data</code>&#13;
<code class="kd">let</code> <code class="nv">book</code> <code class="p">=</code> <code class="n">Book</code><code class="p">(</code><code class="n">title</code><code class="p">:</code> <code class="s">"Native Application Development"</code><code class="p">,</code> <code class="n">isbn</code><code class="p">:</code> <code class="s">"this ISBN"</code><code class="p">)</code>&#13;
&#13;
<code class="c1">// Encode that object as a raw Data object to use in our request</code>&#13;
<code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="k">try</code><code class="p">!</code> <code class="n">JSONEncoder</code><code class="p">().</code><code class="n">encode</code><code class="p">(</code><code class="n">book</code><code class="p">)</code>&#13;
&#13;
<code class="c1">// Create the request</code>&#13;
<code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"http://www.example.com"</code><code class="p">)</code><code class="o">!</code>&#13;
<code class="kd">var</code> <code class="nv">request</code> <code class="p">=</code> <code class="n">URLRequest</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code>&#13;
<code class="n">request</code><code class="p">.</code><code class="n">httpMethod</code> <code class="p">=</code> <code class="s">"POST"</code>&#13;
<code class="n">request</code><code class="p">.</code><code class="n">setValue</code><code class="p">(</code><code class="s">"application/json"</code><code class="p">,</code> <code class="n">forHTTPHeaderField</code><code class="p">:</code> <code class="s">"Content-Tye"</code><code class="p">)</code>&#13;
&#13;
<code class="c1">// Create and perform the task</code>&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code>&#13;
  <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">uploadTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">request</code><code class="p">,</code> <code class="n">from</code><code class="p">:</code> <code class="n">data</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
    <code class="c1">// Handle client errors</code>&#13;
    <code class="k">if</code> <code class="kd">let</code> <code class="nv">error</code> <code class="p">=</code> <code class="n">error</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="n">error</code><code class="p">.</code><code class="n">localizedDescription</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Handle server errors</code>&#13;
    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">response</code> <code class="p">=</code>&#13;
      <code class="n">response</code> <code class="k">as</code><code class="p">?</code> <code class="n">HTTPURLResponse</code><code class="p">,</code> <code class="n">response</code><code class="p">.</code><code class="n">statusCode</code> <code class="o">&lt;</code> <code class="mi">300</code> <code class="k">else</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="s">"A server error occured."</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Check if data exists</code>&#13;
    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">data</code> <code class="k">else</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="s">"No data returned."</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Decode the JSON returned into a Book instance</code>&#13;
    <code class="k">do</code> <code class="p">{</code>&#13;
        <code class="kd">let</code> <code class="nv">book</code> <code class="p">=</code> <code class="k">try</code> <code class="n">JSONDecoder</code><code class="p">().</code><code class="n">decode</code><code class="p">(</code><code class="n">Book</code><code class="p">.</code><code class="kc">self</code><code class="p">,</code> <code class="n">from</code><code class="p">:</code> <code class="n">data</code><code class="p">)</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="s">"The book's title is </code><code class="si">\(</code><code class="n">book</code><code class="p">.</code><code class="n">title</code><code class="si">)</code><code class="s"> and the ISBN is </code><code class="si">\(</code><code class="n">book</code><code class="p">.</code><code class="n">isbn</code><code class="si">)</code><code class="s">"</code><code class="p">)</code>&#13;
    <code class="p">}</code> <code class="k">catch</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="s">"Could not decode response to JSON"</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>That’s a big example, but if you look closely, there are really only a few lines that have changed much. First, at the top of the example, we’re defining a structure to hold our data. Soon after, we use <code>JSONEncoder</code> to transform this object into a raw <code>Data</code> object. <code>JSONEncoder</code> is part of the<a data-primary="Swift Standard Library" data-type="indexterm" id="idm46177223639032"/> Swift Standard Library and provides an easy-to-use method to serialize and deserialize JSON objects.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>There is a whole chapter dedicated to “transport data” like JSON. You can check it out for more information about functionality and available methods.</p>&#13;
</div>&#13;
&#13;
<p>The next important change to note is the following line:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="p">...</code>&#13;
<code class="n">request</code><code class="p">.</code><code class="n">setValue</code><code class="p">(</code><code class="s">"application/json"</code><code class="p">,</code> <code class="n">forHTTPHeaderField</code><code class="p">:</code> <code class="s">"Content-Tye"</code><code class="p">)</code></pre>&#13;
&#13;
<p>This command sets the HTTP header <code>Content-Type</code> on the request to equal <span class="keep-together"><code>application/json</code></span>. You can set other HTTP headers this way, but for most APIs, you’ll need to specify explicitly if you’re using JSON as the transport structure for the data you’re sending.</p>&#13;
&#13;
<p>The rest of the preceding example probably looks familiar when compared with the other examples until you dive into the completion handler used. We perform some validation checks for client errors, server errors, or missing data. Then, we use a new object type, <code>JSONDecoder</code>, to take the raw <code>data</code> object returned (which is really just JSON) and deserialize it directly into an instance of <code>Book</code>. From there, we do things like <code>print</code>ing the book’s <code>title</code> and <code>isbn</code> properties out to the command line.</p>&#13;
&#13;
<p>There are similarities and patterns in most network operations within the <code><span class="keep-together">URLSession</span></code> library of objects. Downloading files from a server requires additional logic to handle a slightly different set of requirements, however. Let’s see how this plays out in the next section on downloading binary files.<a data-primary="" data-startref="NIpost09" data-type="indexterm" id="idm46177223348472"/><a data-primary="" data-startref="INpost09" data-type="indexterm" id="idm46177223347528"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Download a Binary File" data-type="sect2"><div class="sect2" id="idm46177224239768">&#13;
<h2>Download a Binary File</h2>&#13;
&#13;
<p>Downloading<a data-primary="networking" data-secondary="iOS" data-tertiary="downloading binary files" data-type="indexterm" id="NIdown09"/><a data-primary="iOS" data-secondary="networking" data-tertiary="downloading binary files" data-type="indexterm" id="INdown09"/><a data-primary="binary files, downloading" data-secondary="iOS" data-type="indexterm" id="BFDios09"/><a data-primary="files" data-secondary="iOS" data-tertiary="downloading binary files" data-type="indexterm" id="FIdown09"/> files is similar, in code, to requesting data from a server. Here’s an example of how to execute a download request from a server to retrieve a file:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"https://www.example.com/file.zip"</code><code class="p">)</code><code class="o">!</code>&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code>&#13;
  <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">downloadTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">fileUrl</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
    <code class="c1">// Check for client errors</code>&#13;
    <code class="k">if</code> <code class="kd">let</code> <code class="nv">error</code> <code class="p">=</code> <code class="n">error</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="n">error</code><code class="p">.</code><code class="n">localizedDescription</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Check for server errors</code>&#13;
    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">response</code> <code class="p">=</code>&#13;
      <code class="n">response</code> <code class="k">as</code><code class="p">?</code> <code class="n">HTTPURLResponse</code><code class="p">,</code> <code class="n">response</code><code class="p">.</code><code class="n">statusCode</code> <code class="o">&lt;</code> <code class="mi">300</code> <code class="k">else</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="s">"A server error occured."</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Check for a downloaded file</code>&#13;
    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">tempFileUrl</code> <code class="p">=</code> <code class="n">fileUrl</code> <code class="k">else</code> <code class="p">{</code> <code class="k">return</code> <code class="p">}</code>&#13;
    <code class="bp">print</code><code class="p">(</code><code class="n">tempFileUrl</code><code class="p">.</code><code class="n">path</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>In the preceding example, we are requesting a file at a specific URL. One main difference is that instead of using <code>dataTask(with:)</code> to create our request, we’re using <code>downloadTask(with:)</code>. The completion handler has a slightly different signature—instead of a <code>Data</code> instance being passed in, we have a <code>Url</code> instance passed in that we’ve named <code>fileUrl</code> in the example.</p>&#13;
&#13;
<p>Download tasks differ from data tasks in that while data tasks store the content of the request in memory, download tasks store a buffer of the response into a temporary file as the download completes. For short downloads, this could be instantaneous, but for larger downloads, the task writes a little bit of the file at a time.</p>&#13;
&#13;
<p>Our completion handler is executed whenever the file is finished downloading and contains the temporary location where that file was written. These files are ephemeral in nature and will be removed.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>It’s important to remember to move the file somewhere else, such as the <em>Documents</em> directory. Our previous example just <code>print</code>s the path of the file. See <a data-type="xref" href="ch06.html#topics_files">Chapter 6</a> on file basics for information on how to copy a file.</p>&#13;
</div>&#13;
&#13;
<p>For larger downloads, it’s generally preferable to present some type of user interface to your users indicating how much of the file has been downloaded and how much is left. Our simplistic completion handler example doesn’t provide a mechanism to do that. Within the <code>URLSession</code> subsystem, however, there is a way to handle this: the <code>URLSessionDownloadDelegate</code> protocol.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="URLSessionDownloadDelegate" data-type="sect3"><div class="sect3" id="idm46177223165928">&#13;
<h3>URLSessionDownloadDelegate</h3>&#13;
&#13;
<p><code>URLSessionDownloadDelegate</code> contains<a data-primary="URLSession class" data-secondary="URLSessionDownloadDelegate" data-type="indexterm" id="idm46177223164072"/> a few optional methods for objects to implement in order to handle download events for a request as they come in. Here’s an example of how to implement a delegate, assign it to a <code>URLSession</code>, and create a download task, complete with progress updates:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">class</code> <code class="nc">NetworkClient</code><code class="p">:</code> <code class="bp">NSObject</code> <code class="p">{</code>&#13;
    <code class="c1">// ...</code>&#13;
<code class="p">}</code>&#13;
<code class="kd">extension</code> <code class="nc">NetworkClient</code><code class="p">:</code> <code class="n">URLSessionDownloadDelegate</code> <code class="p">{</code>&#13;
    <code class="kd">func</code> <code class="nf">urlSession</code><code class="p">(</code><code class="kc">_</code> <code class="n">session</code><code class="p">:</code> <code class="n">URLSession</code><code class="p">,</code>&#13;
                    <code class="n">downloadTask</code><code class="p">:</code> <code class="n">URLSessionDownloadTask</code><code class="p">,</code>&#13;
                    <code class="n">didFinishDownloadingTo</code> <code class="n">location</code><code class="p">:</code> <code class="nb">URL</code><code class="p">)</code> <code class="p">{</code>&#13;
&#13;
        <code class="c1">// Check for a server error</code>&#13;
        <code class="k">guard</code> <code class="kd">let</code> <code class="nv">response</code> <code class="p">=</code>&#13;
          <code class="n">downloadTask</code><code class="p">.</code><code class="n">response</code> <code class="k">as</code><code class="p">?</code> <code class="n">HTTPURLResponse</code><code class="p">,</code> <code class="n">response</code><code class="p">.</code><code class="n">statusCode</code> <code class="o">&lt;</code> <code class="mi">300</code> <code class="k">else</code> <code class="p">{</code>&#13;
          <code class="k">return</code> <code class="p">}</code>&#13;
&#13;
        <code class="c1">// Prints the temporary file location</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="n">location</code><code class="p">.</code><code class="n">path</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">urlSession</code><code class="p">(</code><code class="kc">_</code> <code class="n">session</code><code class="p">:</code> <code class="n">URLSession</code><code class="p">,</code> <code class="n">task</code><code class="p">:</code> <code class="n">URLSessionTask</code><code class="p">,</code>&#13;
      <code class="n">didCompleteWithError</code> <code class="n">error</code><code class="p">:</code> <code class="n">Error</code><code class="p">?)</code> <code class="p">{</code>&#13;
        <code class="k">if</code> <code class="kd">let</code> <code class="nv">error</code> <code class="p">=</code> <code class="n">error</code> <code class="p">{</code>&#13;
            <code class="bp">print</code><code class="p">(</code><code class="n">error</code><code class="p">.</code><code class="n">localizedDescription</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">urlSession</code><code class="p">(</code><code class="kc">_</code> <code class="n">session</code><code class="p">:</code> <code class="n">URLSession</code><code class="p">,</code>&#13;
                    <code class="n">downloadTask</code><code class="p">:</code> <code class="n">URLSessionDownloadTask</code><code class="p">,</code>&#13;
                    <code class="n">didWriteData</code> <code class="n">bytesWritten</code><code class="p">:</code> <code class="nb">Int64</code><code class="p">,</code>&#13;
                    <code class="n">totalBytesWritten</code><code class="p">:</code> <code class="nb">Int64</code><code class="p">,</code>&#13;
                    <code class="n">totalBytesExpectedToWrite</code><code class="p">:</code> <code class="nb">Int64</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="kd">let</code> <code class="nv">percent</code> <code class="p">=</code> <code class="p">(</code><code class="n">totalBytesWritten</code><code class="o">/</code><code class="n">totalBytesExpectedToWrite</code><code class="p">)</code> <code class="o">*</code> <code class="mi">100</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="n">percent</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"https://www.example.com/file.zip"</code><code class="p">)</code><code class="o">!</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">client</code> <code class="p">=</code> <code class="n">NetworkClient</code><code class="p">()</code>&#13;
<code class="kd">let</code> <code class="nv">urlSession</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">(</code><code class="n">configuration</code><code class="p">:</code> <code class="p">.</code><code class="k">default</code><code class="p">,</code> <code class="n">delegate</code><code class="p">:</code> <code class="n">client</code><code class="p">,</code> <code class="n">delegateQueue</code><code class="p">:</code> <code class="kc">nil</code><code class="p">)</code>&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">urlSession</code><code class="p">.</code><code class="n">downloadTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>Let’s walk through this code.</p>&#13;
&#13;
<p>First, we are creating a new class called <code>NetworkClient</code> that inherits from <code>NSObject</code>, the base class for<a data-primary="Objective-C" data-type="indexterm" id="idm46177223157832"/> Objective-C objects. This class has an extension where it <span class="keep-together">implements</span> the <code>URLSessionDownloadDelegate</code> protocol. The first method, <span class="keep-together"><code>urlSession(_:downloadTask:didFinishDownloadingTo:)</code></span>, is required. This is because download tasks store the files they download as temporary files in the filesystem; whenever a file finishes downloading, this method is called on the delegate to tell you where to access the downloaded file. We can also handle server errors in the body of this method by checking the <code>downloadTask</code>’s <code>response</code> object’s status code.</p>&#13;
&#13;
<p>The<a data-primary="iOS methods" data-secondary="urlSession(_:task:didCompleteWithError:)" data-type="indexterm" id="idm46177222946056"/> next method, <code>urlSession(_:task:didCompleteWithError:)</code>, is optional, but probably something that should be implemented in production apps. You can handle client errors here and check if there are issues that came up that prevented the file from being downloaded successfully. In our example, we’re printing out a description of the error to the console.</p>&#13;
&#13;
<p>Wondering<a data-primary="iOS methods" data-secondary="urlSession(_:downloadTask:didWrite Data:totalBytesWritten:totalBytesExpectedToWrite:)" data-type="indexterm" id="idm46177222943480"/> how the progress of the download is communicated to the app? The final method in the extension is the place to look: <code>urlSession(_:downloadTask:didWriteData:totalBytesWritten:totalBytesExpectedToWrite:)</code>. This method is called periodically at an interval determined by the networking subsystems within iOS. We can use the values of <code>totalBytesWritten</code> and <code>totalBytesExpectedToWrite</code> to calculate a <code>percent</code> value. This value could be used to update everything from text labels to custom drawing routines to <code>UIProgressView</code>s. In our example, we’re <code>print</code>ing out the value to the console, but use your imagination to see what’s possible!</p>&#13;
&#13;
<p>This class we’ve created is instantiated further down and passed to a custom <code><span class="keep-together">URLSession</span></code> initializer as the <code>delegate</code> argument. It’s important to note the following two lines where this happens:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="p">...</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">urlSession</code> <code class="p">=</code>&#13;
  <code class="n">URLSession</code><code class="p">(</code><code class="n">configuration</code><code class="p">:</code> <code class="p">.</code><code class="k">default</code><code class="p">,</code> <code class="n">delegate</code><code class="p">:</code> <code class="n">client</code><code class="p">,</code> <code class="n">delegateQueue</code><code class="p">:</code> <code class="kc">nil</code><code class="p">)</code>&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">urlSession</code><code class="p">.</code><code class="n">downloadTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>First, we create the <code>URLSession</code> instance. In the next line, we use that object to create the <code>downloadTask</code> for the given URL. We are <em>not</em> using the <code>URLSession.shared</code> instance that previous examples have been using. This is because we need to have some place to set the delegate, and in <code>URLSession</code>, that’s in the initializer.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pause and resume" data-type="sect3"><div class="sect3" id="idm46177223165304">&#13;
<h3>Pause and resume</h3>&#13;
&#13;
<p>With<a data-primary="iOS" data-secondary="networking" data-tertiary="pausing and resuming downloads" data-type="indexterm" id="idm46177222820408"/><a data-primary="networking" data-secondary="iOS" data-tertiary="pausing and resuming downloads" data-type="indexterm" id="idm46177222819160"/> long-running downloads, progress updates are not the only desirable thing your users might need. It’s possible partially completed downloads can fail. Or, maybe your user wants to pause the download and resume it mid-process in order to switch to a WiFi network. Whatever the case, pausing and resuming using <code>URLSession</code> is possible, but a bit odd to implement.</p>&#13;
&#13;
<p>Let’s check out an example and then discuss what’s going on after:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">class</code> <code class="nc">PauseableClient</code><code class="p">:</code> <code class="bp">NSObject</code> <code class="p">{</code>&#13;
    <code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"https://www.example.com/file.zip"</code><code class="p">)</code><code class="o">!</code>&#13;
    <code class="kd">var</code> <code class="nv">resumeData</code><code class="p">:</code> <code class="n">Data</code><code class="p">?</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">startDownload</code><code class="p">()</code> <code class="p">-&gt;</code> <code class="n">URLSessionDownloadTask</code><code class="p">?</code> <code class="p">{</code>&#13;
        <code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">downloadTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code>&#13;
        <code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code>&#13;
        <code class="k">return</code> <code class="n">task</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">pauseDownload</code><code class="p">(</code><code class="k">for</code> <code class="n">task</code><code class="p">:</code> <code class="n">URLSessionDownloadTask</code><code class="p">?)</code> <code class="p">{</code>&#13;
        <code class="k">guard</code> <code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">task</code> <code class="k">else</code> <code class="p">{</code> <code class="k">return</code> <code class="p">}</code>&#13;
        <code class="n">task</code><code class="p">.</code><code class="n">cancel</code> <code class="p">{</code> <code class="p">(</code><code class="n">resumeData</code><code class="p">)</code> <code class="k">in</code>&#13;
            <code class="kc">self</code><code class="p">.</code><code class="n">resumeData</code> <code class="p">=</code> <code class="n">resumeData</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">resumeDownload</code><code class="p">()</code> <code class="p">-&gt;</code> <code class="n">URLSessionDownloadTask</code><code class="p">?</code> <code class="p">{</code>&#13;
        <code class="k">guard</code> <code class="kd">let</code> <code class="nv">resumeData</code> <code class="p">=</code> <code class="n">resumeData</code> <code class="k">else</code> <code class="p">{</code>&#13;
            <code class="bp">print</code><code class="p">(</code><code class="s">"Download can't be resumed!"</code><code class="p">)</code>&#13;
            <code class="k">return</code> <code class="kc">nil</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">downloadTask</code><code class="p">(</code><code class="n">withResumeData</code><code class="p">:</code> <code class="n">resumeData</code><code class="p">)</code>&#13;
        <code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code>&#13;
        <code class="k">return</code> <code class="n">task</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">let</code> <code class="nv">client</code> <code class="p">=</code> <code class="n">PauseableClient</code><code class="p">()</code>&#13;
<code class="kd">var</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">client</code><code class="p">.</code><code class="n">startDownload</code><code class="p">()</code>&#13;
<code class="n">client</code><code class="p">.</code><code class="n">pauseDownload</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="n">task</code><code class="p">)</code>&#13;
<code class="n">task</code> <code class="p">=</code> <code class="n">client</code><code class="p">.</code><code class="n">resumeDownload</code><code class="p">()</code></pre>&#13;
&#13;
<p>In this example, we have a class, <code>PauseableClient</code>, that has three methods: <code>startDownload()</code>, <code>pauseDownload()</code>, and <code>resumeDownload()</code>. Inside the first of these, <code>startDownload()</code>, we kick off a download task with a URL. Presumably, this is a long-running download. We also return the <code>task</code> object created for use later. Further down the screen, we call <code>startDownload()</code>, and the client’s <code>pauseDownload(for:)</code> method is called and the <code>task</code> is passed in.</p>&#13;
&#13;
<p>Inside the <code>pauseDownload()</code> method, we take the <code>task</code> object passed in and call <code><span class="keep-together">cancel(byProducingResumeData:)</span></code>. This method takes a closure as its only argument. Once the task is canceled, the closure is called and a token, given as a <code>Data</code> instance, used for resuming the download is passed in. Storing this token for future use allows the code to potentially resume the download again in the future.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>You can potentially store resume data if there are client errors reported in the <code>urlSession(_:task:didCompleteWithError:)</code> delegate method. Check <code>userInfo[NSURLSessionDownloadTaskResumeData]</code> on the <code>error</code> object passed in as a parameter. Now, there are limitations about where resume data can be generated. For more information on these, it’s best to the consult <a href="https://oreil.ly/GITHH">Apple’s developer docs</a> on <code>URLSessionTask</code>.</p>&#13;
</div>&#13;
&#13;
<p>For all intents and purposes, the task we created to download the file is gone at this point. Calling <code>cancel</code> doesn’t actually pause the download—it <em>cancels</em> it. That said, we’ve got a way to bring this request back to life without having to redownload the data we’ve already received.</p>&#13;
&#13;
<p>This is done in our example within the <code>resumeDownload()</code> method. This method checks for resume data and then calls <code>URLSession</code> to create a new <code>URLSessionDownloadTask</code> via the method <code>downloadTask(withResumeData:)</code>. The resume data passed in is the same <code>resumeData</code> that was saved in <code>pauseDownload(for:)</code> by our previous task.</p>&#13;
&#13;
<p>Finally, once this task is created from the <code>URLSession</code>, <code>resume()</code> is called to kick off the download again, hopefully at the previous completion state it was in whenever we paused it (or canceled it) before.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Delegates" data-type="sect3"><div class="sect3" id="idm46177222821512">&#13;
<h3>Delegates</h3>&#13;
&#13;
<p>There<a data-primary="URLSession class" data-secondary="delegates and delegate methods" data-type="indexterm" id="idm46177222613672"/> are even more delegates and delegate methods in the <code>URLSession</code> subsystem than demonstrated in the code in this chapter. Objects<a data-primary="URLSession class" data-secondary="URLSessionTaskDelegate" data-type="indexterm" id="idm46177222612120"/><a data-primary="URLSession class" data-secondary="URLSessionDownloadDelegate" data-type="indexterm" id="idm46177222611144"/><a data-primary="URLSession class" data-secondary="URLSessionDataDelegate" data-type="indexterm" id="idm46177222610232"/> should also implement some or all of the methods in the <code>URLSessionTaskDelegate</code>, <code>URLSessionDataDelegate</code>, or <code>URLSessionDownloadDelegate</code> protocols to handle task-level events. These include events like the beginning and end of individual requests, and periodic progress updates from data or download tasks similar to what was shown earlier.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Background threads and updating the UI" data-type="sect3"><div class="sect3" id="idm46177222607528">&#13;
<h3>Background threads and updating the UI</h3>&#13;
&#13;
<p><code>URLSessionTask</code> operates<a data-primary="iOS" data-secondary="networking" data-tertiary="background threads and UI updates" data-type="indexterm" id="idm46177222605976"/><a data-primary="networking" data-secondary="iOS" data-tertiary="background threads and UI updates" data-type="indexterm" id="idm46177222604632"/> on its own background threads asynchronously without blocking the current thread without having to specify anything special. However, closures being called will not return on the main thread, so it’s important to dispatch any UI updates or model synchronization code on the main thread (or using whatever synchronization methods are used in other parts of your app).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="App transport security" data-type="sect3"><div class="sect3" id="idm46177222602632">&#13;
<h3>App transport security</h3>&#13;
&#13;
<p>To<a data-primary="App Transport Security" data-type="indexterm" id="idm46177222601336"/><a data-primary="iOS" data-secondary="networking" data-tertiary="transport security" data-type="indexterm" id="idm46177222600216"/><a data-primary="networking" data-secondary="iOS" data-tertiary="transport security" data-type="indexterm" id="idm46177222599000"/><a data-primary="Core Data" data-secondary="NSExceptionDomains" data-type="indexterm" id="idm46177222597784"/><a data-primary="Core Data" data-secondary="NSAllowsArbitraryLoads" data-type="indexterm" id="idm46177222596840"/> call nonsecure URLs such as ones that start with <em>http://</em>, it’s necessary to specify a special configuration in<a data-primary="Info.plist file" data-type="indexterm" id="idm46177222595320"/> an app’s <em>Info.plist</em> file for the <code>NSAppTransportSecurity</code> key. The recommendation is to specify that certain domains are insecure but trusted by excluding them using the key <code>NSExceptionDomains</code>. It’s possible to turn off App Transport Security altogether by setting its <code>NSAllowsArbitraryLoads</code> key to <code>true</code>, but that is not a recommended approach unless absolutely necessary.<a data-primary="" data-startref="INdown09" data-type="indexterm" id="idm46177222592136"/><a data-primary="" data-startref="NIdown09" data-type="indexterm" id="idm46177222591080"/><a data-primary="" data-startref="BFDios09" data-type="indexterm" id="idm46177222590136"/><a data-primary="" data-startref="FIdown09" data-type="indexterm" id="idm46177222589192"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What We’ve Learned" data-type="sect1"><div class="sect1" id="idm46177223346328">&#13;
<h1>What We’ve Learned</h1>&#13;
&#13;
<p>We’ve learned a lot about how networking functions in both Android and iOS:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>We learned how to make a simple request in both platforms. The processes for both were similar, but differed in the use of streams for Android.</p>&#13;
</li>&#13;
<li>&#13;
<p>We learned how to send data up to a server in a way that allowed the developer full control of the request and response.</p>&#13;
</li>&#13;
<li>&#13;
<p>We talked about the nature of downloading binary files and what kind of processing was necessary to store them to the filesystem.</p>&#13;
</li>&#13;
<li>&#13;
<p>Security controls embedded into iOS requires the use of HTTPS by default. This is in contrast to Android, which is a little more freewheeling, open, and less restrictive with regard to the defaults for networking security.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Oftentimes networks are unavailable or requests fail. In the next chapter, we’ll look at providing users feedback when issues crop up or you just want to keep them informed of some other operation happening. Let’s head over!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>