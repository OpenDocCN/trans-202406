<html><head></head><body><section data-pdf-bookmark="Chapter 18. Media" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_media">&#13;
<h1><span class="label">Chapter 18. </span>Media</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introduction" data-type="sect1"><div class="sect1" id="id239">&#13;
<h1>Introduction</h1>&#13;
&#13;
<p><a data-primary="media" data-type="indexterm" id="ix_18-media-asciidoc0"/>Modern  <a data-primary="media" data-secondary="basics" data-type="indexterm" id="id1249"/>browsers have rich APIs for working with video and audio streams. <a data-primary="WebRTC API" data-type="indexterm" id="id1250"/>The WebRTC API supports creating these streams from devices such as cameras.</p>&#13;
&#13;
<p>A video stream can be played live inside of a <code>&lt;video&gt;</code> element, and from there you can capture a frame of the video to save as an image or upload to an API. A <code>&lt;video&gt;</code> element can also be used to play back video that was recorded from a stream.</p>&#13;
&#13;
<p>Before these APIs were available, you would have needed browser plug-ins to access the user’s camera. Today, you can use the Media Capture and Streams API to start reading data from the camera and microphone with just a small amount of code.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Recording the Screen" data-type="sect1"><div class="sect1" id="id671">&#13;
<h1>Recording the Screen</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id240">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="&lt;video&gt; element" data-primary-sortas="video" data-secondary="for recording user’s screen" data-type="indexterm" id="ix_18-media-asciidoc1"/><a data-primary="media" data-secondary="recording the screen" data-type="indexterm" id="ix_18-media-asciidoc2"/><a data-primary="screen, capturing video of" data-type="indexterm" id="ix_18-media-asciidoc3"/><a data-primary="video capture" data-secondary="of user’s screen" data-type="indexterm" id="ix_18-media-asciidoc4"/>You want to capture a video of the user’s screen.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id241">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the Screen Capture API to capture a video of the screen, then set it as the source of a <code>&lt;video&gt;</code> element (see <a data-type="xref" href="#code_screenCapture">Example 18-1</a>).</p>&#13;
<div data-type="example" id="code_screenCapture">&#13;
<h5><span class="label">Example 18-1. </span>Capturing a video of the screen</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">async</code> <code class="kd">function</code> <code class="nx">captureScreen</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">stream</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">mediaDevices</code><code class="p">.</code><code class="nx">getDisplayMedia</code><code class="p">();</code>&#13;
  <code class="kr">const</code> <code class="nx">mediaRecorder</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MediaRecorder</code><code class="p">(</code><code class="nx">stream</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">mimeType</code><code class="o">:</code> <code class="s1">'video/webm'</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">mediaRecorder</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'dataavailable'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">blob</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Blob</code><code class="p">([</code><code class="nx">event</code><code class="p">.</code><code class="nx">data</code><code class="p">],</code> <code class="p">{</code>&#13;
      <code class="nx">type</code><code class="o">:</code> <code class="s1">'video/webm'</code><code class="p">,</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="kr">const</code> <code class="nx">url</code> <code class="o">=</code> <code class="nx">URL</code><code class="p">.</code><code class="nx">createObjectURL</code><code class="p">(</code><code class="nx">blob</code><code class="p">);</code>&#13;
    <code class="nx">video</code><code class="p">.</code><code class="nx">src</code> <code class="o">=</code> <code class="nx">url</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">mediaRecorder</code><code class="p">.</code><code class="nx">start</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The screen contents are not streamed live to the <code>&lt;video&gt;</code> element. Rather, the screen share is captured into memory. Once you’ve finished capturing the screen, the recorded video will play in the <code>&lt;video&gt;</code> element.</p>&#13;
</div>&#13;
&#13;
<p>There’s a lot going on here. First, call <code>navigator.mediaDevices.getDisplayMedia()</code> to initiate a screen capture. Depending on the browser and operating system, you will get some sort of prompt about screen recording (see <a data-type="xref" href="#img_screenRecording">Figure 18-1</a>).</p>&#13;
&#13;
<figure class="width-75"><div class="figure" id="img_screenRecording">&#13;
<img alt="Screen recording prompt from Chrome on macOS" src="assets/wacb_1801.png"/>&#13;
<h6><span class="label">Figure 18-1. </span>Screen recording prompt from Chrome on macOS</h6>&#13;
</div></figure>&#13;
&#13;
<p>This function returns a <code>Promise</code> that resolves to a <code>MediaStream</code> of the user’s screen. Once this <code>Promise</code> resolves, the screen is being recorded, but the data isn’t going anywhere yet.</p>&#13;
&#13;
<p>To stop recording, click the browser-provided button to stop sharing or call <code>mediaRecorder.stop()</code>. This will trigger the <code>dataavailable</code> event.</p>&#13;
&#13;
<p><a data-primary="Blob object" data-type="indexterm" id="id1251"/>Next, the event handler creates a <code>Blob</code> containing the captured video data and creates an object URL. You can then set the video’s <code>src</code> attribute to this object URL.</p>&#13;
&#13;
<p>Once this is done, the screen recording will start playing in the browser.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id242">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>This example uses the <code>video/webm</code> MIME type, which has good browser support. WebM is an open audio and video file format that supports multiple codecs.</p>&#13;
&#13;
<p>If the user does not give permission for screen recording, the <code>Promise</code> returned by <code>getDisplayMedia</code> will be rejected with an error.</p>&#13;
&#13;
<p>This example shows how to play back the screen recording in a <code>&lt;video&gt;</code> element, but there are other things you can do once you have the <code>Blob</code> and object URL.</p>&#13;
&#13;
<p>For example, you could send the <code>Blob</code> to a server using the Fetch API (see <a data-type="xref" href="#example18-2">Example 18-2</a>)<a data-startref="ix_18-media-asciidoc4" data-type="indexterm" id="id1252"/><a data-startref="ix_18-media-asciidoc3" data-type="indexterm" id="id1253"/><a data-startref="ix_18-media-asciidoc2" data-type="indexterm" id="id1254"/><a data-startref="ix_18-media-asciidoc1" data-type="indexterm" id="id1255"/>.</p>&#13;
<div data-type="example" id="example18-2">&#13;
<h5><span class="label">Example 18-2. </span>Uploading the captured screen recording</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">form</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">FormData</code><code class="p">();</code>&#13;
<code class="c1">// Here, "blob" is the Blob created in the captureScreen method.</code>&#13;
<code class="nx">formData</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s1">'file'</code><code class="p">,</code> <code class="nx">blob</code><code class="p">);</code>&#13;
&#13;
<code class="nx">fetch</code><code class="p">(</code><code class="s1">'/api/video/upload'</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="nx">method</code><code class="o">:</code> <code class="s1">'POST'</code><code class="p">,</code>&#13;
  <code class="nx">body</code><code class="o">:</code> <code class="nx">formData</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>You could also trigger the browser to download the captured video (see <a data-type="xref" href="#example18-3">Example 18-3</a>).</p>&#13;
<div data-type="example" id="example18-3">&#13;
<h5><span class="label">Example 18-3. </span>Triggering a download with a hidden link</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">link</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'a'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Here, "url" is the object URL created in the captureScreen method.</code>&#13;
<code class="nx">link</code><code class="p">.</code><code class="nx">href</code> <code class="o">=</code> <code class="nx">url</code><code class="p">;</code>&#13;
<code class="nx">link</code><code class="p">.</code><code class="nx">textContent</code> <code class="o">=</code> <code class="s1">'Download'</code><code class="p">;</code>&#13;
<code class="nx">link</code><code class="p">.</code><code class="nx">download</code> <code class="o">=</code> <code class="s1">'screen-recording.webm'</code><code class="p">;</code>&#13;
<code class="nx">link</code><code class="p">.</code><code class="nx">click</code><code class="p">();</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Capturing an Image from the User’s Camera" data-type="sect1"><div class="sect1" id="recipe_captureVideo">&#13;
<h1>Capturing an Image from the User’s Camera</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id243">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="cameras" data-secondary="capturing image from" data-type="indexterm" id="ix_18-media-asciidoc5"/><a data-primary="image capture" data-type="indexterm" id="ix_18-media-asciidoc6"/><a data-primary="media" data-secondary="capturing image from user’s camera" data-type="indexterm" id="ix_18-media-asciidoc7"/>You want to activate the user’s camera and take a photo.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id322">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use <code>navigator.mediaDevices.getUserMedia</code> to get video from the camera.</p>&#13;
&#13;
<p>First, you’ll need to create a few elements, as shown in <a data-type="xref" href="#example18-4">Example 18-4</a>.</p>&#13;
<div data-type="example" id="example18-4">&#13;
<h5><span class="label">Example 18-4. </span>The markup for capturing an image from the camera</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>&#13;
  <code class="nf">#canvas</code> <code class="p">{</code>&#13;
    <code class="k">display</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="nf">#photo</code> <code class="p">{</code>&#13;
    <code class="k">width</code><code class="o">:</code> <code class="m">640px</code><code class="p">;</code>&#13;
    <code class="k">height</code><code class="o">:</code> <code class="m">480px</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="nt">&lt;/style&gt;</code>&#13;
&#13;
<code class="p">&lt;</code><code class="nt">canvas</code> <code class="na">id</code><code class="o">=</code><code class="s">"canvas"</code><code class="p">&gt;&lt;/</code><code class="nt">canvas</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">img</code> <code class="na">id</code><code class="o">=</code><code class="s">"photo"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">video</code> <code class="na">id</code><code class="o">=</code><code class="s">"preview"</code><code class="p">&gt;</code></pre></div>&#13;
&#13;
<p>The canvas is hidden because it’s an intermediate step before producing an image.</p>&#13;
&#13;
<p><a data-primary="&lt;video&gt; element" data-primary-sortas="video" data-secondary="for capturing image from user’s camera" data-type="indexterm" id="id1256"/>The general approach is as follows:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Send the video stream to the <code>&lt;video&gt;</code> element to show a live preview from the camera.</p>&#13;
</li>&#13;
<li>&#13;
<p>When you want to capture a photo, draw the current video frame on the canvas.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create a data URL from the canvas to generate a JPEG image, and set it in the <code>&lt;img&gt;</code> element.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>First, open the video stream and attach it to the <code>&lt;video&gt;</code> element (see <a data-type="xref" href="#example18-5">Example 18-5</a>).</p>&#13;
<div data-type="example" id="example18-5">&#13;
<h5><span class="label">Example 18-5. </span>Getting the video stream</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">preview</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#preview'</code><code class="p">);</code>&#13;
&#13;
<code class="nx">async</code> <code class="kd">function</code> <code class="nx">startCamera</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">stream</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">mediaDevices</code><code class="p">.</code><code class="nx">getUserMedia</code><code class="p">(</code>&#13;
    <code class="p">{</code>&#13;
      <code class="nx">video</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>&#13;
      <code class="nx">audio</code><code class="o">:</code> <code class="kc">false</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">);</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">srcObject</code> <code class="o">=</code> <code class="nx">stream</code><code class="p">;</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">play</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Later, capture the image in response to a button click or other event (see <a data-type="xref" href="#example18-6">Example 18-6</a>).</p>&#13;
<div data-type="example" id="example18-6">&#13;
<h5><span class="label">Example 18-6. </span>Capturing the image</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// This is the &lt;video&gt; element.</code>&#13;
<code class="kr">const</code> <code class="nx">preview</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#preview'</code><code class="p">);</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">photo</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#photo'</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="nx">canvas</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#canvas'</code><code class="p">);</code>&#13;
&#13;
<code class="kd">function</code> <code class="nx">captureImage</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="c1">// Resize the canvas based on the device pixel density.</code>&#13;
  <code class="c1">// This helps prevent a blurred or pixellated image.</code>&#13;
  <code class="nx">canvas</code><code class="p">.</code><code class="nx">width</code> <code class="o">=</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">width</code> <code class="o">*</code> <code class="nb">window</code><code class="p">.</code><code class="nx">devicePixelRatio</code><code class="p">;</code>&#13;
  <code class="nx">canvas</code><code class="p">.</code><code class="nx">height</code> <code class="o">=</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">height</code> <code class="o">*</code> <code class="nb">window</code><code class="p">.</code><code class="nx">devicePixelRatio</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// Get the 2D context from the canvas and draw the current video frame.</code>&#13;
  <code class="kr">const</code> <code class="nx">context</code> <code class="o">=</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">getContext</code><code class="p">(</code><code class="s1">'2d'</code><code class="p">);</code>&#13;
  <code class="nx">context</code><code class="p">.</code><code class="nx">drawImage</code><code class="p">(</code><code class="nx">preview</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">width</code><code class="p">,</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">height</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// Create a JPEG data URL and set it as the image source.</code>&#13;
  <code class="kr">const</code> <code class="nx">dataUrl</code> <code class="o">=</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">toDataURL</code><code class="p">(</code><code class="s1">'image/jpeg'</code><code class="p">);</code>&#13;
  <code class="nx">photo</code><code class="p">.</code><code class="nx">src</code> <code class="o">=</code> <code class="nx">dataUrl</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id244">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>As you might expect, reading from the camera raises privacy concerns. As such, opening the user’s camera for the first time will trigger a permission request in the browser that the user must accept to grant access. If this request is denied, the <code>Promise</code> returned by <code>navigator.mediaDevices.getUserMedia</code> will be rejected with an error.<a data-startref="ix_18-media-asciidoc7" data-type="indexterm" id="id1257"/><a data-startref="ix_18-media-asciidoc6" data-type="indexterm" id="id1258"/><a data-startref="ix_18-media-asciidoc5" data-type="indexterm" id="id1259"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Capturing a Video from the User’s Camera" data-type="sect1"><div class="sect1" id="id673">&#13;
<h1>Capturing a Video from the User’s Camera</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id323">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="&lt;video&gt; element" data-primary-sortas="video" data-secondary="for capturing video from user’s camera" data-type="indexterm" id="ix_18-media-asciidoc8"/><a data-primary="cameras" data-secondary="capturing video from" data-type="indexterm" id="ix_18-media-asciidoc9"/><a data-primary="media" data-secondary="capturing video from user’s camera" data-type="indexterm" id="ix_18-media-asciidoc10"/><a data-primary="video capture" data-secondary="from user’s camera" data-type="indexterm" id="ix_18-media-asciidoc11"/>You want to record a video from the user’s camera and play it back in the browser.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id674">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>This solution has several steps:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Use <code>getUserMedia</code> to open a stream from the camera.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use a <code>&lt;video&gt;</code> element to show a preview of the video.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use a <code>MediaRecorder</code> to record the video.</p>&#13;
</li>&#13;
<li>&#13;
<p>Play back the recorded video in the <code>&lt;video&gt;</code> element.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>For this recipe, you need the <code>&lt;video&gt;</code> element and buttons to start and stop recording (see <a data-type="xref" href="#example18-7">Example 18-7</a>).</p>&#13;
<div data-type="example" id="example18-7">&#13;
<h5><span class="label">Example 18-7. </span>Setting up the video element</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">video</code> <code class="na">id</code><code class="o">=</code><code class="s">"preview"</code> <code class="na">muted</code><code class="p">&gt;&lt;/</code><code class="nt">video</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">button</code> <code class="na">id</code><code class="o">=</code><code class="s">"record-button"</code><code class="p">&gt;</code>Record<code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">button</code> <code class="na">id</code><code class="o">=</code><code class="s">"stop-record-button"</code><code class="p">&gt;</code>Stop Recording<code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code></pre></div>&#13;
&#13;
<p>Next, open the video stream and set the <code>&lt;video&gt;</code> element to preview it (see <a data-type="xref" href="#example18-8">Example 18-8</a>).</p>&#13;
<div data-type="example" id="example18-8">&#13;
<h5><span class="label">Example 18-8. </span>Opening the audio and video stream</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">preview</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#preview'</code><code class="p">);</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">stream</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">mediaDevices</code><code class="p">.</code><code class="nx">getUserMedia</code><code class="p">({</code>&#13;
  <code class="nx">video</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>&#13;
  <code class="nx">audio</code><code class="o">:</code> <code class="kc">true</code>&#13;
<code class="p">});</code>&#13;
<code class="nx">preview</code><code class="p">.</code><code class="nx">srcObject</code> <code class="o">=</code> <code class="nx">stream</code><code class="p">;</code>&#13;
<code class="nx">preview</code><code class="p">.</code><code class="nx">play</code><code class="p">();</code></pre></div>&#13;
&#13;
<p>Once the stream is open, the next step is to set up the <code>MediaRecorder</code>  (see <a data-type="xref" href="#example18-9">Example 18-9</a>).</p>&#13;
<div data-type="example" id="example18-9">&#13;
<h5><span class="label">Example 18-9. </span>Setting up the <code>MediaRecorder</code></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">mediaRecorder</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MediaRecorder</code><code class="p">(</code><code class="nx">stream</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="nx">mimeType</code><code class="o">:</code> <code class="s1">'video/webm'</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">mediaRecorder</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'dataavailable'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">blob</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Blob</code><code class="p">([</code><code class="nx">event</code><code class="p">.</code><code class="nx">data</code><code class="p">],</code> <code class="p">{</code>&#13;
    <code class="nx">type</code><code class="o">:</code> <code class="s1">'video/webm'</code><code class="p">,</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">url</code> <code class="o">=</code> <code class="nx">URL</code><code class="p">.</code><code class="nx">createObjectURL</code><code class="p">(</code><code class="nx">blob</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// Clear the "muted" flag so that the playback will</code>&#13;
  <code class="c1">// include audio.</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">muted</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// Reset the source of the video element to the object</code>&#13;
  <code class="c1">// URL just created.</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">srcObject</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">src</code> <code class="o">=</code> <code class="nx">url</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// Start playing the recording immediately.</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">autoplay</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">loop</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">controls</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>The last step is to wire up the buttons to start and stop the <code>MediaRecorder</code> (see <a data-type="xref" href="#example18-10">Example 18-10</a>).</p>&#13;
<div data-type="example" id="example18-10">&#13;
<h5><span class="label">Example 18-10. </span>Adding button event handlers</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#record-button'</code><code class="p">).</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">mediaRecorder</code><code class="p">.</code><code class="nx">start</code><code class="p">();</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#stop-record-button'</code><code class="p">).</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">mediaRecorder</code><code class="p">.</code><code class="nx">stop</code><code class="p">();</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id245">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>You might have noticed the <code>video</code> element initially had the <code>muted</code> attribute set on it. The media stream you open will have both video and audio. You want to preview the video, but you probably don’t want to preview the audio—this would cause whatever audio is recorded to immediately play back on the speakers, which could affect the recording or even cause microphone feedback. To prevent this, you can set the <code>muted</code> attribute on the <code>&lt;video&gt;</code> element.</p>&#13;
&#13;
<p>Later, when it’s time to play back what you recorded, you are clearing the <code>muted</code> flag so that the recorded audio will play as well<a data-startref="ix_18-media-asciidoc11" data-type="indexterm" id="id1260"/><a data-startref="ix_18-media-asciidoc10" data-type="indexterm" id="id1261"/><a data-startref="ix_18-media-asciidoc9" data-type="indexterm" id="id1262"/><a data-startref="ix_18-media-asciidoc8" data-type="indexterm" id="id1263"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Determining the System Media Capabilities" data-type="sect1"><div class="sect1" id="id675">&#13;
<h1>Determining the System Media Capabilities</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id324">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="media" data-secondary="determining system support for specific media type" data-type="indexterm" id="id1264"/>You want to know if a particular media type is supported by the browser.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id246">&#13;
<h2>Solution</h2>&#13;
&#13;
<p><a data-primary="Media Capabilities API" data-type="indexterm" id="id1265"/>Use the Media Capabilities API to query the browser for the given media type. The result will tell you if that media type is supported or not (see <a data-type="xref" href="#code_checkMediaCapabilities">Example 18-11</a>).</p>&#13;
<div data-type="example" id="code_checkMediaCapabilities">&#13;
<h5><span class="label">Example 18-11. </span>Checking media capabilities</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">navigator</code><code class="p">.</code><code class="nx">mediaCapabilities</code><code class="p">.</code><code class="nx">decodingInfo</code><code class="p">({</code>&#13;
  <code class="nx">type</code><code class="o">:</code> <code class="s1">'file'</code><code class="p">,</code>&#13;
  <code class="nx">audio</code><code class="o">:</code> <code class="p">{</code>&#13;
    <code class="nx">contentType</code><code class="o">:</code> <code class="s1">'audio/mp3'</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}).</code><code class="nx">then</code><code class="p">(</code><code class="nx">result</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">result</code><code class="p">.</code><code class="nx">supported</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// mp3 audio is supported!</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">navigator</code><code class="p">.</code><code class="nx">mediaCapabilities</code><code class="p">.</code><code class="nx">decodingInfo</code><code class="p">({</code>&#13;
  <code class="nx">type</code><code class="o">:</code> <code class="s1">'file'</code><code class="p">,</code>&#13;
  <code class="nx">audio</code><code class="o">:</code> <code class="p">{</code>&#13;
    <code class="nx">contentType</code><code class="o">:</code> <code class="s1">'audio/webm;codecs=opus'</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}).</code><code class="nx">then</code><code class="p">(</code><code class="nx">result</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">result</code><code class="p">.</code><code class="nx">supported</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// WebM audio is supported with the opus codec.</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id676">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p><a data-type="xref" href="#code_checkMediaCapabilities">Example 18-11</a> shows some examples of checking for audio codec support. The Media Capabilities API also lets you check for specific video format support. You can query not only by codec, but also by other attributes such as frame rate, bitrate, width, and height (see <a data-type="xref" href="#example18-12">Example 18-12</a>).</p>&#13;
<div data-type="example" id="example18-12">&#13;
<h5><span class="label">Example 18-12. </span>Checking for a supported video format</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">navigator</code><code class="p">.</code><code class="nx">mediaCapabilities</code><code class="p">.</code><code class="nx">decodingInfo</code><code class="p">({</code>&#13;
  <code class="nx">type</code><code class="o">:</code> <code class="s1">'file'</code><code class="p">,</code>&#13;
  <code class="nx">video</code><code class="o">:</code> <code class="p">{</code>&#13;
    <code class="nx">contentType</code><code class="o">:</code> <code class="s1">'video/webm;codecs=vp8'</code><code class="p">,</code>&#13;
    <code class="nx">bitrate</code><code class="o">:</code> <code class="mi">4000000</code><code class="p">,</code> <code class="c1">// 4 MB</code>&#13;
    <code class="nx">framerate</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code>&#13;
    <code class="nx">width</code><code class="o">:</code> <code class="mi">1920</code><code class="p">,</code>&#13;
    <code class="nx">height</code><code class="o">:</code> <code class="mi">1080</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}).</code><code class="nx">then</code><code class="p">(</code><code class="nx">result</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">result</code><code class="p">.</code><code class="nx">supported</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// This WebM configuration is supported.</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Applying Video Filters" data-type="sect1"><div class="sect1" id="id677">&#13;
<h1>Applying Video Filters</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id247">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="&lt;video&gt; element" data-primary-sortas="video" data-secondary="for applying video filters" data-type="indexterm" id="ix_18-media-asciidoc12"/><a data-primary="filter effect, applying to video stream" data-type="indexterm" id="ix_18-media-asciidoc13"/><a data-primary="media" data-secondary="applying video filters" data-type="indexterm" id="ix_18-media-asciidoc14"/><a data-primary="video filters" data-type="indexterm" id="ix_18-media-asciidoc15"/>You want to apply a filter effect to a video stream.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id678">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Render the video stream to a <code>&lt;canvas&gt;</code>, and apply a CSS filter to the canvas.</p>&#13;
&#13;
<p>You’ll set the video stream as the source of a <code>&lt;video&gt;</code> element, as in <a data-type="xref" href="#recipe_captureVideo">“Capturing an Image from the User’s Camera”</a>. However, in this case you’ll hide the <code>&lt;video&gt;</code> element as it’s just an intermediate step.</p>&#13;
&#13;
<p>Then, based on your desired frame rate, render each frame of the video to a <code>&lt;canvas&gt;</code> element. From there, you can apply CSS filters.</p>&#13;
&#13;
<p>First, the markup (see <a data-type="xref" href="#example18-13">Example 18-13</a>).</p>&#13;
<div data-type="example" id="example18-13">&#13;
<h5><span class="label">Example 18-13. </span>Markup for the video filter example</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="o">&lt;</code><code class="nx">canvas</code> <code class="nx">id</code><code class="o">=</code><code class="s2">"canvas"</code><code class="o">&gt;&lt;</code><code class="err">/canvas&gt;</code>&#13;
<code class="o">&lt;</code><code class="nx">video</code> <code class="nx">id</code><code class="o">=</code><code class="s2">"preview"</code> <code class="nx">style</code><code class="o">=</code><code class="s2">"display: none;"</code><code class="o">&gt;&lt;</code><code class="err">/video&gt;</code></pre></div>&#13;
&#13;
<p>Then, open the media stream and set it in the <code>&lt;video&gt;</code> element (see <a data-type="xref" href="#example18-14">Example 18-14</a>).</p>&#13;
<div data-type="example" id="example18-14">&#13;
<h5><span class="label">Example 18-14. </span>Setting up the video stream</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">async</code> <code class="kd">function</code> <code class="nx">startCamera</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">stream</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">mediaDevices</code><code class="p">.</code><code class="nx">getUserMedia</code><code class="p">({</code>&#13;
    <code class="nx">video</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>&#13;
    <code class="nx">audio</code><code class="o">:</code> <code class="kc">false</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// Hook up the video element to the stream.</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">srcObject</code> <code class="o">=</code> <code class="nx">stream</code><code class="p">;</code>&#13;
  <code class="nx">preview</code><code class="p">.</code><code class="nx">play</code><code class="p">();</code>&#13;
&#13;
  <code class="c1">// Resize the canvas based on the device pixel density.</code>&#13;
  <code class="c1">// This helps prevent a blurred or pixelated image.</code>&#13;
  <code class="nx">canvas</code><code class="p">.</code><code class="nx">width</code> <code class="o">=</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">width</code> <code class="o">*</code> <code class="nb">window</code><code class="p">.</code><code class="nx">devicePixelRatio</code><code class="p">;</code>&#13;
  <code class="nx">canvas</code><code class="p">.</code><code class="nx">height</code> <code class="o">=</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">height</code> <code class="o">*</code> <code class="nb">window</code><code class="p">.</code><code class="nx">devicePixelRatio</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="nx">context</code> <code class="o">=</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">getContext</code><code class="p">(</code><code class="s1">'2d'</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// Target frame rate of 30 FPS—draw each frame to the canvas.</code>&#13;
  <code class="nx">setInterval</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">context</code><code class="p">.</code><code class="nx">drawImage</code><code class="p">(</code><code class="nx">preview</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">width</code><code class="p">,</code> <code class="nx">canvas</code><code class="p">.</code><code class="nx">height</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="mi">30</code> <code class="o">/</code> <code class="mi">1000</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Now, you can apply a CSS filter to the <code>&lt;canvas&gt;</code> element (see <a data-type="xref" href="#example18-15">Example 18-15</a>).</p>&#13;
<div data-type="example" id="example18-15">&#13;
<h5><span class="label">Example 18-15. </span>Applying a filter</h5>&#13;
&#13;
<pre data-code-language="css" data-type="programlisting"><code class="nf">#canvas</code> <code class="p">{</code>&#13;
  <code class="k">filter</code><code class="o">:</code> <code class="n">hue</code><code class="o">-</code><code class="n">rotate</code><code class="p">(</code><code class="m">90deg</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id248">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Every 0.03 seconds, the current frame of the video will be drawn to the canvas. This is effectively a preview of the media stream, using the <code>&lt;video&gt;</code> element as an intermediate. This is because there’s currently no way to “draw” a video from a media stream directly to a <code>&lt;canvas&gt;</code> element.</p>&#13;
&#13;
<p>In addition to setting the filters with CSS, you can also set them using the <code>filter</code> property of the canvas 2D context<a data-startref="ix_18-media-asciidoc15" data-type="indexterm" id="id1266"/><a data-startref="ix_18-media-asciidoc14" data-type="indexterm" id="id1267"/><a data-startref="ix_18-media-asciidoc13" data-type="indexterm" id="id1268"/><a data-startref="ix_18-media-asciidoc12" data-type="indexterm" id="id1269"/>.<a data-startref="ix_18-media-asciidoc0" data-type="indexterm" id="id1270"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section></body></html>