<html><head></head><body><section data-pdf-bookmark="Chapter 18. Ambassador" data-type="chapter" epub:type="chapter"><div class="chapter" id="Ambassador">&#13;
<h1><span class="label">Chapter 18. </span>Ambassador</h1>&#13;
&#13;
&#13;
<p>The<a data-primary="Ambassador" data-type="indexterm" id="ambsdr18"/> <em>Ambassador</em> pattern is a<a data-primary="Sidecar" data-type="indexterm" id="idm45902091058784"/><a data-primary="Sidecar" data-secondary="Ambassador" data-type="indexterm" id="idm45902091058048"/> specialized sidecar responsible for hiding external complexities and providing a unified interface for accessing services outside the<a data-primary="Pods" data-secondary="decoupling from accessing external dependencies" data-type="indexterm" id="idm45902091056976"/> Pod.&#13;
In this chapter, you will see how the <em>Ambassador</em> pattern can act as a proxy and decouple the main container from directly accessing external<a data-primary="dependencies" data-type="indexterm" id="idm45902091055440"/> dependencies.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect1"><div class="sect1" id="idm45902091054608">&#13;
<h1>Problem</h1>&#13;
&#13;
<p>Containerized services<a data-primary="problems" data-secondary="services, accessing" data-type="indexterm" id="idm45902091053280"/> don’t exist in isolation and very often have to access other services that may be difficult to reach in a reliable way. The difficulty in accessing other services may be due to dynamic and changing addresses, the need for load balancing of clustered service instances, an unreliable protocol, or difficult data formats. Ideally, containers should be single-purposed and reusable in different contexts. But if we have a container that provides some business functionality and consumes an external service in a specialized way, the container will have more than one <span class="keep-together">responsibility</span>.</p>&#13;
&#13;
<p>Consuming the external service may require a special service discovery library that we do not want to put in our container. Or we may want to swap different kinds of services by using different kinds of service-discovery libraries and methods. This technique of abstracting and isolating the logic for accessing other services in the outside world is the goal of this <em>Ambassador</em> pattern.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect1"><div class="sect1" id="idm45902091050368">&#13;
<h1>Solution</h1>&#13;
&#13;
<p>To demonstrate the pattern, we will use a cache for an application. Accessing a local cache in the development environment may be a simple configuration, but in the production environment, we may need a client configuration that can connect to the different shards of the cache. Another example is consuming a service by looking it up in a registry and performing client-side service discovery. A third example is consuming a service over a nonreliable protocol such as HTTP, so to protect our application, we have to use circuit-breaker logic, configure timeouts, perform retries, and more.</p>&#13;
&#13;
<p>In all of these cases, we can use an ambassador container that hides the complexity of accessing the external services and provides a simplified view and access to the main application container over localhost. Figures <a data-type="xref" data-xrefstyle="select:labelnumber" href="#img-ambassador-distributed-cache">18-1</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#img-ambassador-local-cache">18-2</a> show how an ambassador Pod can decouple<a data-primary="data stores, decoupling" data-type="indexterm" id="idm45902091046016"/> access to a key-value store by connecting to an ambassador container listening on a local port. In <a data-type="xref" href="#img-ambassador-distributed-cache">Figure 18-1</a>, we see how data access can be delegated to a fully distributed remote store like etcd.</p>&#13;
&#13;
<figure><div class="figure" id="img-ambassador-distributed-cache">&#13;
<img alt="Ambassador for accessing a remote distributed cache" src="assets/kup2_1801.png"/>&#13;
<h6><span class="label">Figure 18-1. </span>Ambassador for accessing a remote distributed cache</h6>&#13;
</div></figure>&#13;
&#13;
<p>For development purposes, this ambassador container can be easily exchanged with a locally running in-memory key-value store like memcached (as shown in <a data-type="xref" href="#img-ambassador-local-cache">Figure 18-2</a>).</p>&#13;
&#13;
<figure><div class="figure" id="img-ambassador-local-cache">&#13;
<img alt="Ambassador for using a local cache" src="assets/kup2_1802.png"/>&#13;
<h6><span class="label">Figure 18-2. </span>Ambassador for accessing a local cache</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-type="xref" href="#ex-ambassador">Example 18-1</a> shows an ambassador that runs parallel to a REST service. Before returning its response, the REST service logs the generated data by sending it to a fixed URL: <em><a class="bare" href="http://localhost:9009"><em class="hyperlink">http://localhost:9009</em></a></em>. The ambassador process listens in on this port and processes the data. In this example, it prints the data out just to the console, but it could also do something more sophisticated like forward the data to a full logging infrastructure. For the REST service, it doesn’t matter what happens to the log data, and you can easily exchange the ambassador by reconfiguring the Pod without touching the main container.</p>&#13;
<div data-type="example" id="ex-ambassador">&#13;
<h5><span class="label">Example 18-1. </span>Ambassador processing log output</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">k8spatterns/random-generator:1.0</code><code class="w">            </code><a class="co" href="#callout_ambassador_CO1-1" id="co_ambassador_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">env</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">LOG_URL</code><code class="w">                                    </code><a class="co" href="#callout_ambassador_CO1-2" id="co_ambassador_CO1-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http://localhost:9009</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">ports</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">k8spatterns/random-generator-log-ambassador</code><code class="w"> </code><a class="co" href="#callout_ambassador_CO1-3" id="co_ambassador_CO1-3"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ambassador</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_ambassador_CO1-1" id="callout_ambassador_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Main application container providing a REST service for generating random numbers.</p></dd>&#13;
<dt><a class="co" href="#co_ambassador_CO1-2" id="callout_ambassador_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Connection URL for communicating with the ambassador via localhost.</p></dd>&#13;
<dt><a class="co" href="#co_ambassador_CO1-3" id="callout_ambassador_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Ambassador running in parallel and listening on port 9009 (which is not exposed to the outside of the Pod).</p></dd>&#13;
</dl></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect1"><div class="sect1" id="idm45902090938416">&#13;
<h1>Discussion</h1>&#13;
&#13;
<p>At a higher level, the <em>Ambassador</em> pattern is a <em>Sidecar</em> pattern. The main difference between ambassador and sidecar is that an ambassador does not enhance the main application with additional capability. Instead, it acts merely as a smart proxy to the outside world (this pattern is sometimes referred to as the <em>Proxy</em> pattern). This pattern can be useful for legacy applications that are difficult to modify and extend with modern networking concepts such as monitoring, logging, routing, and resiliency patterns.</p>&#13;
&#13;
<p>The benefits of the <em>Ambassador</em> pattern are similar to those of the <em>Sidecar</em> pattern—both allow you to keep containers single-purposed and reusable. With such a pattern, our application container can focus on its business logic and delegate the responsibility and specifics of consuming the external service to another specialized container. This also allows you to create specialized and reusable ambassador containers that can be combined with other application containers.<a data-primary="" data-startref="ambsdr18" data-type="indexterm" id="idm45902090883520"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="More Information" data-type="sect1"><div class="sect1" id="idm45902090882416">&#13;
<h1>More Information</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/m0KTi">Ambassador Example</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/TPQX5">How to Use the Ambassador Pattern to Dynamically Configure Services on CoreOS</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/6bszq">Modifications to the CoreOS Ambassador Pattern</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section></body></html>