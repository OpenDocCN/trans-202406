<html><head></head><body><section data-pdf-bookmark="Chapter 5. Sample Application: Visitors Site" data-type="chapter" epub:type="chapter"><div class="chapter" id="sample_application_visitors_site">&#13;
<h1><span class="label">Chapter 5. </span>Sample Application: Visitors Site</h1>&#13;
&#13;
&#13;
<p>Real, production-level applications are difficult. <a data-primary="Visitors Site sample application" data-type="indexterm" id="ix_VSapp"/>Container-based architectures are often made up of multiple services, each requiring their own configuration and installation process. Maintaining these types of applications, including the individual components and their interactions, is a time-consuming and error-prone process. Operators are designed to reduce the difficulty in this process.</p>&#13;
&#13;
<p>A simple, one–container “Hello World” application isn’t going to provide enough complexity to fully demonstrate what Operators can do. To really help you understand the capabilities of Operators, we need an application that requires multiple Kubernetes resources with configuration values that cross between them to use for demonstration.</p>&#13;
&#13;
<p>In this chapter we introduce the Visitors Site application, which we will use as an example in the following chapters that cover writing Operators. We’ll take a look at the application architecture and how to run the site, as well as the process of installing it through traditional Kubernetes manifests. In the chapters that follow, we’ll create Operators to deploy this application using each of the approaches provided by the Operator SDK (Helm, Ansible, and Go), and explore the benefits and drawbacks of each.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Application Overview" data-type="sect1"><div class="sect1" id="idm45261334580936">&#13;
<h1>Application Overview</h1>&#13;
&#13;
<p>The Visitors Site tracks information about each request to its home page.<a data-primary="Visitors Site sample application" data-secondary="overview" data-type="indexterm" id="idm45261334579432"/> Each time the page is refreshed, an entry is stored with details about the client, backend server, and timestamp. The home page displays a list of the most recent visits (as shown in <a data-type="xref" href="#fig5-1">Figure 5-1</a>).</p>&#13;
&#13;
<figure><div class="figure" id="fig5-1">&#13;
<img alt="Figure 5-1: Visitors Site Homepage" src="assets/kuop_0501.png"/>&#13;
<h6><span class="label">Figure 5-1. </span>Visitors Site home page</h6>&#13;
</div></figure>&#13;
&#13;
<p>While the home page itself is fairly simple, the architecture is what makes this an interesting example for exploring Operators. The Visitors Site is a traditional, three-tier application, consisting of:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A web frontend, implemented in <a href="https://reactjs.org/">React</a></p>&#13;
</li>&#13;
<li>&#13;
<p>A REST API, implemented in <a href="https://www.python.org/">Python</a> using <a href="https://www.djangoproject.com/">the Django framework</a></p>&#13;
</li>&#13;
<li>&#13;
<p>A database, using <a href="https://www.mysql.com/">MySQL</a></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>As shown in <a data-type="xref" href="#fig5-2">Figure 5-2</a>, each of these components is deployed as a separate container. The flow is simple, with users interacting with the web interface, which itself makes calls to the backend REST API. The data submitted to the REST API is persisted in a MySQL database, which also runs as its own container.</p>&#13;
&#13;
<figure><div class="figure" id="fig5-2">&#13;
<img alt="Figure 5-2: Visitors Site Architecture" src="assets/kuop_0502.png"/>&#13;
<h6><span class="label">Figure 5-2. </span>Visitors Site architecture</h6>&#13;
</div></figure>&#13;
&#13;
<p>Note that the database does not connect to a persistent volume and stores its data ephemerally. While this isn’t a suitable production solution, for the purposes of this example the important aspects are the deployments and interactions between the containers themselves.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Installation with Manifests" data-type="sect1"><div class="sect1" id="idm45261334564792">&#13;
<h1>Installation with Manifests</h1>&#13;
&#13;
<p>Each component in the Visitors Site requires two<a data-primary="Visitors Site sample application" data-secondary="installation with manifests" data-type="indexterm" id="idm45261334563096"/><a data-primary="manifests" data-secondary="installing Visitors Site application with" data-type="indexterm" id="idm45261334562040"/><a data-primary="resources" data-secondary="required for each component of Visitors Site application" data-type="indexterm" id="idm45261334561000"/> Kubernetes resources:</p>&#13;
<dl>&#13;
<dt>Deployment</dt>&#13;
<dd>&#13;
<p>Contains the information needed to create the containers, including the image name, exposed ports, and specific configuration for a single deployment.<a data-primary="deployment" data-secondary="for Visitors Site sample application" data-secondary-sortas="Visitors" data-type="indexterm" id="idm45261334558296"/></p>&#13;
</dd>&#13;
<dt>Service</dt>&#13;
<dd>&#13;
<p>A network abstraction across all containers in a deployment.<a data-primary="services" data-secondary="for Visitors Site sample application" data-secondary-sortas="Visitors" data-type="indexterm" id="idm45261334555752"/> If a deployment is scaled up beyond one container, which we will do with the backend, the service sits in front and balances incoming requests across all of the replicas.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>A third resource is used to store the authentication details for the database. The MySQL container uses this <em>secret</em> when it is started, and the backend containers use it to authenticate against the database when making requests.</p>&#13;
&#13;
<p>Additionally, there are configuration values that must be consistent between components. For example, the backend needs to know the name of the database service to connect to. When deploying applications through manifests, awareness of these relationships is required to ensure that the values line up.</p>&#13;
&#13;
<p>In the following manifests, the provided values will produce a working Visitors Site deployment. Each section will highlight specific instances where user intervention was required.</p>&#13;
&#13;
<p>You can find all of the manifests in the <a href="https://github.com/kubernetes-operators-book/chapters/tree/master/ch05">book’s GitHub repository</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deploying MySQL" data-type="sect2"><div class="sect2" id="idm45261334550312">&#13;
<h2>Deploying MySQL</h2>&#13;
&#13;
<p>The secret must be created before the database is deployed, since it is used during the <a data-primary="Visitors Site sample application" data-secondary="installation with manifests" data-tertiary="deploying MySQL instance" data-type="indexterm" id="ix_VSappdep"/><a data-primary="deployment" data-secondary="deploying MySQL instance into Kubernetes" data-type="indexterm" id="idm45261334546920"/><a data-primary="secrets," data-secondary="for MySQL instance deployment into Kubernetes" data-type="indexterm" id="idm45261334545880"/>container startup:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Secret</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql-auth</code><code> </code><a class="co" href="#callout_sample_application__visitors_site_CO1-1" id="co_sample_application__visitors_site_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Opaque</code><code>&#13;
</code><code class="nt">stringData</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">username</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors-user</code><code> </code><a class="co" href="#callout_sample_application__visitors_site_CO1-2" id="co_sample_application__visitors_site_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>  </code><code class="nt">password</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors-pass</code><code> </code><a class="co" href="#callout_sample_application__visitors_site_CO1-2" id="co_sample_application__visitors_site_CO1-3"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO1-1" id="callout_sample_application__visitors_site_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>When the database and backend deployments use the secret, it is referred to by this name.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO1-2" id="callout_sample_application__visitors_site_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>For simplicity in this example, the username and password are defaulted to testing values.</p></dd>&#13;
</dl>&#13;
&#13;
<p>You can find the definition for the secret resource in the <em>database.yaml</em> file in this book’s <a href="https://oreil.ly/jZTgt">GitHub repository</a>.</p>&#13;
&#13;
<p>Once the secret is in place, use the following manifest to deploy a MySQL instance into Kubernetes:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">apps/v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Deployment</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO2-1" id="co_sample_application__visitors_site_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">replicas</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">1</code><code>&#13;
</code><code>  </code><code class="nt">selector</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">matchLabels</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>      </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql</code><code>&#13;
</code><code>  </code><code class="nt">template</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">labels</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>        </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql</code><code>&#13;
</code><code>    </code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">containers</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors-mysql</code><code>&#13;
</code><code>          </code><code class="nt">image</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">mysql:5.7</code><code class="s">"</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO2-2" id="co_sample_application__visitors_site_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>          </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Always</code><code>&#13;
</code><code>          </code><code class="nt">ports</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql</code><code>&#13;
</code><code>              </code><code class="nt">containerPort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">3306</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO2-3" id="co_sample_application__visitors_site_CO2-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>              </code><code class="nt">protocol</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">TCP</code><code>&#13;
</code><code>          </code><code class="nt">env</code><code class="p">:</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO2-4" id="co_sample_application__visitors_site_CO2-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD</code><code>&#13;
</code><code>              </code><code class="nt">value</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">password</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">MYSQL_DATABASE</code><code>&#13;
</code><code>              </code><code class="nt">value</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors_db</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">MYSQL_USER</code><code>&#13;
</code><code>              </code><code class="nt">valueFrom</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="nt">secretKeyRef</code><code class="p">:</code><code>&#13;
</code><code>                  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql-auth</code><code> </code><a class="co" href="#callout_sample_application__visitors_site_CO2-5" id="co_sample_application__visitors_site_CO2-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>                  </code><code class="nt">key</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">username</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">MYSQL_PASSWORD</code><code>&#13;
</code><code>              </code><code class="nt">valueFrom</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="nt">secretKeyRef</code><code class="p">:</code><code>&#13;
</code><code>                  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql-auth</code><code> </code><a class="co" href="#callout_sample_application__visitors_site_CO2-5" id="co_sample_application__visitors_site_CO2-6"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>                  </code><code class="nt">key</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">password</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO2-1" id="callout_sample_application__visitors_site_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The deployment name must be unique to the namespace in which it is deployed.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO2-2" id="callout_sample_application__visitors_site_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The deployment requires the details of the image to deploy, including its name and hosting repository.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO2-3" id="callout_sample_application__visitors_site_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Users must be aware of each port that the image exposes, and must explicitly reference them.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO2-4" id="callout_sample_application__visitors_site_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The values used to configure the containers for this specific deployment are passed as environment variables.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO2-5" id="callout_sample_application__visitors_site_CO2-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The secret provides the values for the database authentication credentials.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Keep in mind the value of the container port, as well as each of the environment variables, as other manifests use these values.</p>&#13;
&#13;
<p>The deployment causes the creation of the MySQL container; however, it does not provide any ingress configuration on how to access it. For that, we will need a service. The following manifest will create a Kubernetes service that provides access to the MySQL deployment:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Service</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql-service</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO3-1" id="co_sample_application__visitors_site_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>  </code><code class="nt">labels</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>    </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">clusterIP</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">None</code><code>&#13;
</code><code>  </code><code class="nt">ports</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="nt">port</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">3306</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO3-2" id="co_sample_application__visitors_site_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>  </code><code class="nt">selector</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>    </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO3-1" id="callout_sample_application__visitors_site_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>As with deployments, service names must be unique in a given namespace. This will also apply to the deployment and services for the backend and frontend components.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO3-2" id="callout_sample_application__visitors_site_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The service maps to a port exposed by a deployment, so this value must be the same as in the <code>ports</code> section of the deployment.<a data-primary="Visitors Site sample application" data-secondary="installation with manifests" data-startref="ix_VSappdep" data-tertiary="deploying MySQL instance" data-type="indexterm" id="idm45261334182360"/></p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Backend" data-type="sect2"><div class="sect2" id="idm45261334549688">&#13;
<h2>Backend</h2>&#13;
&#13;
<p>Similar to the MySQL resources, the backend needs both a deployment and a service.<a data-primary="Visitors Site sample application" data-secondary="installation with manifests" data-tertiary="backend deployment" data-type="indexterm" id="idm45261334179304"/><a data-primary="deployment" data-secondary="deploying backend for Visitors Site application" data-type="indexterm" id="idm45261334178120"/> However, whereas the database is standalone, the configuration for the backend relies heavily on the values set for the database. While this isn’t an unreasonable requirement, it falls on the user to ensure that the values are consistent across both resources. A single error could result in the backend not being able to communicate with the database.<a data-primary="manifests" data-secondary="for deployment of backend for Visitors Site sample application" data-type="indexterm" id="idm45261334141944"/> Here’s the manifest to deploy the backend:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">apps/v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Deployment</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors-backend</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">replicas</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">1</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO4-1" id="co_sample_application__visitors_site_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>  </code><code class="nt">selector</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">matchLabels</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>      </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">backend</code><code>&#13;
</code><code>  </code><code class="nt">template</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">labels</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>        </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">backend</code><code>&#13;
</code><code>    </code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">containers</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors-backend</code><code>&#13;
</code><code>          </code><code class="nt">image</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">jdob/visitors-service:1.0.0</code><code class="s">"</code><code>&#13;
</code><code>          </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Always</code><code>&#13;
</code><code>          </code><code class="nt">ports</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>              </code><code class="nt">containerPort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">8000</code><code>&#13;
</code><code>          </code><code class="nt">env</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">MYSQL_DATABASE</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO4-2" id="co_sample_application__visitors_site_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>              </code><code class="nt">value</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors_db</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">MYSQL_SERVICE_HOST</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO4-3" id="co_sample_application__visitors_site_CO4-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>              </code><code class="nt">value</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql-service</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">MYSQL_USERNAME</code><code>&#13;
</code><code>              </code><code class="nt">valueFrom</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="nt">secretKeyRef</code><code class="p">:</code><code>&#13;
</code><code>                  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql-auth</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO4-4" id="co_sample_application__visitors_site_CO4-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>                  </code><code class="nt">key</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">username</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">MYSQL_PASSWORD</code><code>&#13;
</code><code>              </code><code class="nt">valueFrom</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="nt">secretKeyRef</code><code class="p">:</code><code>&#13;
</code><code>                  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">mysql-auth</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO4-4" id="co_sample_application__visitors_site_CO4-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>                  </code><code class="nt">key</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">password</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO4-1" id="callout_sample_application__visitors_site_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Each deployment configuration includes the number of containers it should spawn.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO4-2" id="callout_sample_application__visitors_site_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>These values must be manually checked to ensure they match up with the values set on the MySQL deployment. Otherwise, the backend will not be able to establish a connection to the database.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO4-3" id="callout_sample_application__visitors_site_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>This value tells the backend where to find the database and must match the name of the MySQL service created previously.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO4-4" id="callout_sample_application__visitors_site_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>As with the database deployment, the secret provides the authentication credentials for the database.</p></dd>&#13;
</dl>&#13;
&#13;
<p>One of the major benefits of using containerized applications is the ability they give you to individually scale specific components.<a data-primary="scaling" data-secondary="scaling individual components in containerized applications" data-type="indexterm" id="idm45261334013208"/><a data-primary="replicas" data-secondary="replicas field for Visitors Site application backend deployment" data-type="indexterm" id="idm45261334012376"/> In the backend deployment shown here, the <code>replicas</code> field can be modified to scale the backend. The example Operators in the following chapters use a custom resource to expose this replica count as a first-class configuration value of the Visitors Site custom resource. Users do not need to manually navigate to the specific backend deployment as they do when using manifests. The Operator knows how to appropriately use the entered value.</p>&#13;
&#13;
<p>The service manifest looks similar <a data-primary="services" data-secondary="for Visitors Site sample application" data-tertiary="deploying with manifest" data-type="indexterm" id="idm45261334010136"/><a data-primary="manifests" data-secondary="for service deployment in Visitors Site sample application" data-seealso="service" data-type="indexterm" id="idm45261334008872"/>to the one you created for the database:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Service</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors-backend-service</code><code>&#13;
</code><code>  </code><code class="nt">labels</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>    </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">backend</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">NodePort</code><code>&#13;
</code><code>  </code><code class="nt">ports</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="nt">port</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">8000</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO5-1" id="co_sample_application__visitors_site_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>      </code><code class="nt">targetPort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">8000</code><code>&#13;
</code><code>      </code><code class="nt">nodePort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">30685</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO5-2" id="co_sample_application__visitors_site_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>      </code><code class="nt">protocol</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">TCP</code><code>&#13;
</code><code>  </code><code class="nt">selector</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>    </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">backend</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO5-1" id="callout_sample_application__visitors_site_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>As with the database service, the port referenced in the service definition must match up with that exposed by the deployment.</p></dd>&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO5-2" id="callout_sample_application__visitors_site_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>In this example, the backend is configured to run through port 30685 on the same IP as Minikube. The frontend uses this port when making backend calls for data. For simplicity, the frontend defaults to using this value, so it does not need to be specified when the frontend is deployed.</p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Frontend" data-type="sect2"><div class="sect2" id="idm45261334032904">&#13;
<h2>Frontend</h2>&#13;
&#13;
<p>The frontend is in a similar position as the backend in the sense that it needs configuration that is consistent with the backend deployment.<a data-primary="Visitors Site sample application" data-secondary="installation with manifests" data-tertiary="frontend deployment" data-type="indexterm" id="idm45261334031208"/><a data-primary="Visitors Site sample application" data-secondary="frontends" data-type="indexterm" id="idm45261334030024"/> Once again, it falls on the user to manually verify that these values are consistent in both locations. Here’s the manifest that creates the frontend deployment:</p>&#13;
&#13;
<pre class="less_space pagebreak-before" data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">apps/v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Deployment</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors-frontend</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">replicas</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">1</code><code>&#13;
</code><code>  </code><code class="nt">selector</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">matchLabels</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>      </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">frontend</code><code>&#13;
</code><code>  </code><code class="nt">template</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">labels</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>        </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">frontend</code><code>&#13;
</code><code>    </code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">containers</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors-frontend</code><code>&#13;
</code><code>          </code><code class="nt">image</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">jdob/visitors-webui:1.0.0</code><code class="s">"</code><code>&#13;
</code><code>          </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Always</code><code>&#13;
</code><code>          </code><code class="nt">ports</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>              </code><code class="nt">containerPort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">3000</code><code>&#13;
</code><code>          </code><code class="nt">env</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">REACT_APP_TITLE</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO6-1" id="co_sample_application__visitors_site_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>              </code><code class="nt">value</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">Visitors</code><code class="nv"> </code><code class="s">Dashboard</code><code class="s">"</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO6-1" id="callout_sample_application__visitors_site_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>To make the Visitors Site application more interesting, you can override the home page title through an environment variable. The CR you’ll learn how to create in the next chapters will expose it as a value of the Visitors Site, shielding end users from having to know in which deployment to specify the value.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Similar to the MySQL and backend deployments, the following manifest creates a service that provides access to the frontend deployment:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Service</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors-frontend-service</code><code>&#13;
</code><code>  </code><code class="nt">labels</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>    </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">frontend</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">NodePort</code><code>&#13;
</code><code>  </code><code class="nt">ports</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="p-Indicator">-</code><code> </code><code class="nt">port</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">3000</code><code>&#13;
</code><code>      </code><code class="nt">targetPort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">3000</code><code>&#13;
</code><code>      </code><code class="nt">nodePort</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">30686</code><code>  </code><a class="co" href="#callout_sample_application__visitors_site_CO7-1" id="co_sample_application__visitors_site_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>      </code><code class="nt">protocol</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">TCP</code><code>&#13;
</code><code>  </code><code class="nt">selector</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">visitors</code><code>&#13;
</code><code>    </code><code class="nt">tier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">frontend</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_sample_application__visitors_site_CO7-1" id="callout_sample_application__visitors_site_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The frontend service looks very similar to the backend service, with the notable difference that it runs on port 30686.</p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deploying the Manifests" data-type="sect1"><div class="sect1" id="idm45261333689480">&#13;
<h1>Deploying the Manifests</h1>&#13;
&#13;
<p>You can run the <a data-primary="kubectl" data-secondary="running Visitors Site sample application with" data-type="indexterm" id="idm45261333694456"/><a data-primary="manifests" data-secondary="deploying for Visitors Site sample application" data-type="indexterm" id="idm45261333692920"/><a data-primary="deployment" data-secondary="deploying manifests for Visitors Site sample application" data-type="indexterm" id="idm45261333692008"/>Visitors Site for yourself using the <code>kubectl</code> command:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>ch05/database.yaml</code></strong><code>&#13;
</code><code>secret/mysql-auth</code><code> </code><code>created</code><code>&#13;
</code><code>deployment.apps/mysql</code><code> </code><code>created</code><code>&#13;
</code><code>service/mysql-service</code><code> </code><code>created</code><code>&#13;
&#13;
</code><code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>ch05/backend.yaml</code></strong><code>&#13;
</code><code>deployment.apps/visitors-backend</code><code> </code><code>created</code><code>&#13;
</code><code>service/visitors-backend-service</code><code> </code><code>created</code><code>&#13;
&#13;
</code><code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>ch05/frontend.yaml</code></strong><code>&#13;
</code><code>deployment.apps/visitors-frontend</code><code> </code><code>created</code><code>&#13;
</code><code>service/visitors-frontend-service</code><code> </code><code>created</code><code>&#13;
</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Accessing the Visitors Site" data-type="sect1"><div class="sect1" id="idm45261333743848">&#13;
<h1>Accessing the Visitors Site</h1>&#13;
&#13;
<p>Using these manifests, you can find the home page by using the IP address of the Minikube instance<a data-primary="Minikube, minikube ip command" data-type="indexterm" id="idm45261333753080"/><a data-primary="Visitors Site sample application" data-secondary="accessing" data-type="indexterm" id="idm45261333752520"/> and specifying port 30686 in your browser. The <code>minikube</code> command provides the IP address to access:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>minikube</code><code> </code><code>ip</code></strong><code>&#13;
</code><code>192.168.99.100</code><code>&#13;
</code></pre>&#13;
&#13;
<p>For this Minikube instance, you can access the Visitors Site by opening a browser and going to <em>http://192.168.99.100:30686</em>.</p>&#13;
&#13;
<p>Clicking refresh a few times will populate the table on that page with details of the internal cluster IP and the timestamp of each request, as previously shown in <a data-type="xref" href="#fig5-1">Figure 5-1</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cleaning Up" data-type="sect1"><div class="sect1" id="idm45261333710696">&#13;
<h1>Cleaning Up</h1>&#13;
&#13;
<p>Similar to deploying the manifests, you delete the created resources using the <code>kubectl</code> command:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
$ <strong>kubectl delete -f ch05/frontend.yaml</strong>&#13;
<code>deployment.apps "visitors-frontend" deleted</code>&#13;
<code>service "visitors-frontend-service" deleted</code>&#13;
&#13;
$ <strong>kubectl delete -f ch05/backend.yaml</strong>&#13;
<code>deployment.apps "visitors-backend" deleted</code>&#13;
<code>service "visitors-backend-service" deleted</code>&#13;
&#13;
$ <strong>kubectl delete -f ch05/database.yaml</strong>&#13;
<code>secret "mysql-auth" deleted</code>&#13;
<code>deployment.apps "mysql" deleted</code>&#13;
<code>service "mysql-service" deleted</code>&#13;
</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45261333708104">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>We will use this sample application in the following chapters to demonstrate a variety of technologies on which you can build Operators.</p>&#13;
&#13;
<p>In addition to the Operator implementations, keep in mind the end user experience. In this chapter we demonstrated a manifest-based installation, requiring a number of manual changes and internal references to be made. All of the following Operator implementations create a custom resource definition that acts as the sole API for creating and configuring an instance of the Visitors Site.<a data-primary="Visitors Site sample application" data-startref="ix_VSapp" data-type="indexterm" id="idm45261333720472"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>