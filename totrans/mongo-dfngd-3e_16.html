<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 13. Administration"><div class="chapter" id="chapter-repl-admin"><h1><span class="label">Chapter 13. </span>Administration</h1><p>This chapter covers replica set administration, including:</p><ul><li><p>Performing maintenance on individual members</p></li><li><p>Configuring sets under a variety of circumstances</p></li><li><p>Getting information about and resizing your oplog</p></li><li><p>Doing some more exotic set configurations</p></li><li><p>Converting from master/slave to a replica set</p></li></ul><section data-type="sect1" data-pdf-bookmark="Starting Members in Standalone Mode"><div class="sect1" id="idm45882353103928"><h1>Starting Members in Standalone Mode</h1><p>A<a data-type="indexterm" data-primary="servers" data-secondary="standalone mode" id="idm45882353102808"/><a data-type="indexterm" data-primary="standalone mode" id="idm45882353101672"/><a data-type="indexterm" data-primary="members" data-secondary="starting in standalone mode" id="idm45882353100840"/><a data-type="indexterm" data-primary="administration, of replica sets" data-secondary="starting members in standalone mode" id="idm45882353099672"/> lot of maintenance tasks cannot be performed on secondaries
    (because they involve writes) and shouldn’t be performed on primaries
    because of the impact this could have on application performance. Thus,
    the following sections frequently mention starting up a server in
    <span class="firstterm">standalone mode</span>. This means restarting the member
    so that it is a standalone server, not a member of a replica set
    (temporarily).</p><p>To<a data-type="indexterm" data-primary="db.serverCmdLineOpts()" id="idm45882353097016"/> start up a member in standalone mode, first look at the
    command-line options used to start it. Suppose they look something like
    this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">serverCmdLineOpts</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"argv"</code> <code class="o">:</code> <code class="p">[</code> <code class="s2">"mongod"</code><code class="p">,</code> <code class="s2">"-f"</code><code class="p">,</code> <code class="s2">"/var/lib/mongod.conf"</code> <code class="p">],</code>
    <code class="s2">"parsed"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"replSet"</code><code class="o">:</code> <code class="s2">"mySet"</code><code class="p">,</code>
        <code class="s2">"port"</code><code class="o">:</code> <code class="s2">"27017"</code><code class="p">,</code>
        <code class="s2">"dbpath"</code><code class="o">:</code> <code class="s2">"/var/lib/db"</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>To perform maintenance on this server we can restart it without the
    <code class="option">replSet</code> option. This will allow us to read and write to
    it as a normal standalone <em class="filename">mongod</em>. We
    don’t want the other servers in the set to be able to contact it, so we’ll
    make it listen on a different port (so that the other members won’t be
    able to find it). Finally, we want to keep the <code class="option">dbpath</code> the
    same, as we are presumably starting it up this way to manipulate the
    server’s data somehow.</p><p>First, we<a data-type="indexterm" data-primary="db.shutdownServer()" id="idm45882353059640"/> shut down the server from the <em>mongo</em>
    shell:</p><pre data-type="programlisting" data-code-language="shell">&gt; db.shutdownServer<code class="o">()</code></pre><p>Then,
    in an operating system shell (e.g., bash), we restart
    <em>mongod</em> on another port and without the
    <code class="option">replSet</code> parameter:</p><pre data-type="programlisting">$ mongod --port 30000 --dbpath /var/lib/db</pre><p>It will now be running as a standalone server, listening on port
    30000 for connections. The other members of the set will attempt to
    connect to it on port 27017 and assume that it is down.</p><p>When we have finished performing maintenance on the server, we can
    shut it down and restart it with its original options. It will
    automatically sync up with the rest of the set, replicating any operations
    that it missed while it was “away.”</p></div></section><section data-type="sect1" data-pdf-bookmark="Replica Set Configuration"><div class="sect1" id="idm45882353103624"><h1>Replica Set Configuration</h1><p>Replica<a data-type="indexterm" data-primary="administration, of replica sets" data-secondary="replica set configuration" id="Arepsetconfig13"/><a data-type="indexterm" data-primary="updates" data-secondary="configuration document" id="idm45882351503272"/><a data-type="indexterm" data-primary="replica sets, configuration of" data-secondary="configuration document" id="idm45882351201784"/> set configuration is always kept in a document in the
    <em class="filename">local.system.replset</em>
    collection<a data-type="indexterm" data-primary="local.system.replset collection" id="idm45882397764696"/>. This document is the same on all members of the set. Never
    update this document using <code>update</code>.
    Always use an<a data-type="indexterm" data-primary="rs helper functions" id="idm45882351721112"/> <code>rs</code> helper or the
    <code>replSetReconfig</code> command<a data-type="indexterm" data-primary="replSetReconfig command" id="idm45882351446536"/>.</p><section data-type="sect2" data-pdf-bookmark="Creating a Replica Set"><div class="sect2" id="idm45882398861768"><h2>Creating a Replica Set</h2><p>You<a data-type="indexterm" data-primary="replica sets, configuration of" data-secondary="creating replica sets" id="idm45882352128360"/> create a replica set by starting up the
      <em>mongods</em> that you want to be members and then
      passing one of them a configuration through <code class="function">rs.initiate()<a data-type="indexterm" data-primary="rs.initiate()" id="idm45882393529448"/></code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">config</code> <code class="o">=</code> <code class="p">{</code>
<code class="p">...</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="o">&lt;</code><code class="nx">setName</code><code class="o">&gt;</code><code class="p">,</code>
<code class="p">...</code> <code class="s2">"members"</code> <code class="o">:</code> <code class="p">[</code>
<code class="p">...</code>     <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"host"</code> <code class="o">:</code> <code class="o">&lt;</code><code class="nx">host1</code><code class="o">&gt;</code><code class="p">},</code>
<code class="p">...</code>     <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"host"</code> <code class="o">:</code> <code class="o">&lt;</code><code class="nx">host2</code><code class="o">&gt;</code><code class="p">},</code>
<code class="p">...</code>     <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="s2">"host"</code> <code class="o">:</code> <code class="o">&lt;</code><code class="nx">host3</code><code class="o">&gt;</code><code class="p">}</code>
<code class="p">...</code> <code class="p">]}</code>
<code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">initiate</code><code class="p">(</code><code class="nx">config</code><code class="p">)</code></pre><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>You should always pass a config object to <code class="function">rs.initiate()</code>. If you do not, MongoDB will
        attempt to automatically generate a config for a one-member replica
        set; it might not use the hostname that you want or correctly
        configure the set.</p></div><p>You only call <code class="function">rs.initiate()</code>
      on one member of the set. The member that receives the configuration
      will pass it on to the other members.</p></div></section><section data-type="sect2" data-pdf-bookmark="Changing Set Members"><div class="sect2" id="idm45882350800792"><h2>Changing Set Members</h2><p>When<a data-type="indexterm" data-primary="replica sets, configuration of" data-secondary="changing set members" id="idm45882350799784"/><a data-type="indexterm" data-primary="rs.add command" id="idm45882350798680"/><a data-type="indexterm" data-primary="replica sets, configuration of" data-secondary="adding new set members" id="idm45882350797848"/> you add a new set member, it should either have nothing
      in its data directory—in which case it will perform an initial sync—or
      have a copy of the data from another member (see <a data-type="xref" href="ch23.xhtml#chapter-backup">Chapter 23</a> for more information about backing up and
      restoring replica set members).</p><p>Connect to the primary and add a new member as follows:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="s2">"spock:27017"</code><code class="p">)</code></pre><p>Alternatively, you can specify a more complex member config as a
      document:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">add</code><code class="p">({</code><code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"spock:27017"</code><code class="p">,</code> <code class="s2">"priority"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code></pre><p>You<a data-type="indexterm" data-primary="rs.remove command" id="idm45882350735800"/><a data-type="indexterm" data-primary="replica sets, configuration of" data-secondary="removing set members" id="idm45882350734520"/> can also remove members by their <code>"host"</code> field:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">remove</code><code class="p">(</code><code class="s2">"spock:27017"</code><code class="p">)</code></pre><p>You<a data-type="indexterm" data-primary="replica sets, configuration of" data-secondary="restrictions on changing" id="idm45882350730280"/> can change a member’s settings by reconfiguring. There
      are a few restrictions in changing a member’s settings:</p><ul><li><p>You cannot change a member’s <code>"_id"</code>.</p></li><li><p>You cannot make the member you’re sending the reconfig to
          (generally the primary) priority 0.</p></li><li><p>You cannot turn an arbiter into a nonarbiter, or vice
          versa.</p></li><li><p>You cannot change a member’s <code>"buildIndexes"</code> field from <code>false</code> to <code>true</code>.</p></li></ul><p>Notably, you <em>can</em> change a member’s <code>"host"</code> field. Thus, if you incorrectly specify
      a host (say, if you use a public IP instead of a private one) you can
      later go back and simply change the config to use the correct IP.</p><p>To<a data-type="indexterm" data-primary="replica sets, configuration of" data-secondary="changing hostnames" id="idm45882350725608"/> change a hostname, you could do something like
      this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">config</code> <code class="o">=</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">config</code><code class="p">()</code>
<code class="o">&gt;</code> <code class="nx">config</code><code class="p">.</code><code class="nx">members</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">host</code> <code class="o">=</code> <code class="s2">"spock:27017"</code>
<code class="nx">spock</code><code class="o">:</code><code class="mi">27017</code>
<code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">reconfig</code><code class="p">(</code><code class="nx">config</code><code class="p">)</code></pre><p>This same strategy applies to changing any other option: fetch the
      config with <code class="function">rs.config()</code>, modify any
      parts of it that you wish, and reconfigure the set by passing <code class="function">rs.reconfig()</code> the new configuration.</p></div></section><section data-type="sect2" data-pdf-bookmark="Creating Larger Sets"><div class="sect2" id="idm45882350800664"><h2>Creating Larger Sets</h2><p>Replica<a data-type="indexterm" data-primary="elections" data-secondary="preventing voting" id="idm45882350656472"/><a data-type="indexterm" data-primary="replica sets, configuration of" data-secondary="creating larger sets" id="idm45882350655336"/> sets are limited to 50 members in total and only 7 voting
      members. This is to reduce the amount of network traffic required for
      everyone to heartbeat everyone else and to limit the amount of time
      elections take.</p><p>If you are creating a replica set that has more than seven
      members, every additional member must be given zero votes. You can do
      this by specifying it in the member’s config:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">add</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">7</code><code class="p">,</code> <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"server-7:27017"</code><code class="p">,</code> <code class="s2">"votes"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">})</code></pre><p>This prevents these members from casting positive votes in
      elections.</p></div></section><section data-type="sect2" data-pdf-bookmark="Forcing Reconfiguration"><div class="sect2" id="idm45882350648632"><h2>Forcing Reconfiguration</h2><p>When<a data-type="indexterm" data-primary="replica sets, configuration of" data-secondary="forcing reconfiguration" id="idm45882350644248"/> you permanently lose a majority of a set, you may want to
      reconfigure the set while it doesn’t have a primary. This is a little
      tricky, as usually you’d send the reconfig to the primary. In this case,
      you can <span class="firstterm">force-reconfigure</span> the set by sending <span class="keep-together">a reconfig command</span><a data-type="indexterm" data-primary="rs.reconfig()" id="idm45882350593544"/><a data-type="indexterm" data-primary="reconfig command" id="idm45882350592712"/> to a secondary. Connect to a secondary in the shell and
      pass it a reconfig with the <code>"force"</code>
      option:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">reconfig</code><code class="p">(</code><code class="nx">config</code><code class="p">,</code> <code class="p">{</code><code class="s2">"force"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code></pre><p>Forced reconfigurations follow the same rules as a normal
      reconfiguration: you must send a valid, well-formed configuration with
      the correct options. The <code>"force"</code>
      option doesn’t allow invalid configs; it just allows a secondary to
      accept a reconfig.</p><p>Forced reconfigurations bump the replica set <code>"version"</code> number by a large amount. You may
      see it jump by tens or hundreds of thousands. This is normal: it is to
      prevent version number collisions (just in case there’s a reconfig on
      either side of a network partition).</p><p>When the secondary receives the reconfig, it will update its
      configuration and pass the new config along to the other members. The
      other members of the set will only pick up on a change of config if they
      recognize the sending server as a member of their current config. Thus,
      if some of your members have changed hostnames, you should force
      reconfig from a member that kept its old hostname. If every member has a
      new hostname, you should shut down each member of the set, start a new
      one up in standalone mode, change its <em class="filename">local.system.replset</em> document manually, and
      then restart the<a data-type="indexterm" data-startref="Arepsetconfig13" id="idm45882350583704"/> member.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Manipulating Member State"><div class="sect1" id="idm45882350582776"><h1>Manipulating Member State</h1><p>There<a data-type="indexterm" data-primary="administration, of replica sets" data-secondary="manipulating member state" id="idm45882350581864"/><a data-type="indexterm" data-primary="members" data-secondary="manipulating state" id="idm45882350580792"/> are several ways to manually change a member’s state for
    maintenance or in response to load. Note that there is no way to force a
    member to become primary, however, other than configuring the set
    appropriately—in this case, by giving the replica set member a priority
    higher than any other member of the set.</p><section data-type="sect2" data-pdf-bookmark="Turning Primaries into Secondaries"><div class="sect2" id="idm45882350579208"><h2>Turning Primaries into Secondaries</h2><p>You can demote a primary to a secondary using the <code class="function">stepDown</code> function:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">stepDown</code><code class="p">()</code></pre><p>This makes the primary step down into SECONDARY state for 60
      seconds. If no other primary is elected in that time period, it will be
      able to attempt a reelection. If you would like it to remain a secondary
      for a longer or shorter amount of time, you can specify your own number
      of seconds for it to stay in SECONDARY state:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">stepDown</code><code class="p">(</code><code class="mi">600</code><code class="p">)</code> <code class="c1">// 10 minutes</code></pre></div></section><section data-type="sect2" data-pdf-bookmark="Preventing Elections"><div class="sect2" id="idm45882350554312"><h2>Preventing Elections</h2><p>If<a data-type="indexterm" data-primary="elections" data-secondary="preventing" id="idm45882350509992"/> you need to do some maintenance on the primary but don’t
      want any of the other eligible members to become primary in the interim,
      you can force them to stay secondaries by running <code>freeze</code> on each of them:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">freeze</code><code class="p">(</code><code class="mi">10000</code><code class="p">)</code></pre><p>Again, this takes a number of seconds for the member to remain a
      secondary.</p><p>If you finish whatever maintenance you’re doing on the primary
      before this time elapses and want to unfreeze the other members, simply
      run the command again on each of them, giving a timeout of 0
      seconds:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">freeze</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code></pre><p>An unfrozen member will be able to hold an election, if it
      chooses.</p><p>You can also unfreeze primaries that have been stepped down by
      running <code class="function">rs.freeze(0)</code>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Monitoring Replication"><div class="sect1" id="idm45882350485864"><h1>Monitoring Replication</h1><p>It<a data-type="indexterm" data-primary="administration, of replica sets" data-secondary="monitoring replication" id="Amonrep13"/><a data-type="indexterm" data-primary="replication" data-secondary="monitoring" data-tertiary="using logs for" id="idm45882350425608"/> is important to be able to monitor the status of a set: not
    only that all members are up, but what states they are in and how up to
    date the replication is. There are several commands you can use to see
    replica set information. MongoDB hosting services <span class="keep-together">and management</span> tools
    including Atlas, Cloud Manager, and Ops Manager (see <a data-type="xref" href="ch22.xhtml#chapter-mms">Chapter 22</a>) also provide mechanisms to monitor replication and dashboards on the key replication metrics.</p><p>Often issues with replication are transient: a server could not
    reach another server, but now it can. The easiest way to see issues like
    this is to look at the logs. Make sure you know where the logs are being
    stored (and that they <em>are</em> being stored) and that you
    can access them.</p><section data-type="sect2" data-pdf-bookmark="Getting the Status"><div class="sect2" id="idm45882350421128"><h2>Getting the Status</h2><p>One<a data-type="indexterm" data-primary="rs.status()" id="idm45882350420152"/><a data-type="indexterm" data-primary="replication" data-secondary="monitoring" data-tertiary="obtaining current information" id="idm45882350419288"/> of the most useful commands you can run is <code>replSetGetStatus<a data-type="indexterm" data-primary="members" data-secondary="obtaining current status of" id="idm45882350457624"/></code><a data-type="indexterm" data-primary="replSetGetStatus command" id="idm45882350456520"/>, which gets the current information about every member of
      the set (from the view of the member you’re running it on). There is a
      helper for this command in the shell:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">status</code><code class="p">()</code>

   <code class="s2">"set"</code> <code class="o">:</code> <code class="s2">"replset"</code><code class="p">,</code>
   <code class="s2">"date"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:16.543Z"</code><code class="p">),</code>
   <code class="s2">"myState"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
   <code class="s2">"term"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code>
   <code class="s2">"heartbeatIntervalMillis"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">2000</code><code class="p">),</code>
   <code class="s2">"optimes"</code> <code class="o">:</code> <code class="p">{</code>
         <code class="s2">"lastCommittedOpTime"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116934</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
         <code class="p">},</code>
         <code class="s2">"readConcernMajorityOpTime"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116934</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
         <code class="p">},</code>
         <code class="s2">"appliedOpTime"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116934</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
         <code class="p">},</code>
         <code class="s2">"durableOpTime"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116934</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
         <code class="p">}</code>
      <code class="p">},</code>

   <code class="s2">"members"</code> <code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"m1.example.net:27017"</code><code class="p">,</code>
            <code class="s2">"health"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"stateStr"</code> <code class="o">:</code> <code class="s2">"PRIMARY"</code><code class="p">,</code>
            <code class="s2">"uptime"</code> <code class="o">:</code> <code class="mi">269</code><code class="p">,</code>
            <code class="s2">"optime"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116934</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
                        <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:14Z"</code><code class="p">),</code>
            <code class="s2">"infoMessage"</code> <code class="o">:</code> <code class="s2">"could not find member to sync from"</code><code class="p">,</code>
            <code class="s2">"electionTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116933</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"electionDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:13Z"</code><code class="p">),</code>
            <code class="s2">"configVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"self"</code> <code class="o">:</code> <code class="kc">true</code>
      <code class="p">},</code>
      <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"m2.example.net:27017"</code><code class="p">,</code>
            <code class="s2">"health"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"stateStr"</code> <code class="o">:</code> <code class="s2">"SECONDARY"</code><code class="p">,</code>
            <code class="s2">"uptime"</code> <code class="o">:</code> <code class="mi">14</code><code class="p">,</code>
            <code class="s2">"optime"</code> <code class="o">:</code> <code class="p">{</code>
               <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116934</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
               <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDurable"</code> <code class="o">:</code> <code class="p">{</code>
               <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116934</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
               <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:14Z"</code><code class="p">),</code>
            <code class="s2">"optimeDurableDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:14Z"</code><code class="p">),</code>
            <code class="s2">"lastHeartbeat"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:15.618Z"</code><code class="p">),</code>
            <code class="s2">"lastHeartbeatRecv"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:14.866Z"</code><code class="p">),</code>
            <code class="s2">"pingMs"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code>
            <code class="s2">"syncingTo"</code> <code class="o">:</code> <code class="s2">"m3.example.net:27017"</code><code class="p">,</code>
            <code class="s2">"configVersion"</code> <code class="o">:</code> <code class="mi">1</code>
      <code class="p">},</code>
      <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"m3.example.net:27017"</code><code class="p">,</code>
            <code class="s2">"health"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"stateStr"</code> <code class="o">:</code> <code class="s2">"SECONDARY"</code><code class="p">,</code>
            <code class="s2">"uptime"</code> <code class="o">:</code> <code class="mi">14</code><code class="p">,</code>
            <code class="s2">"optime"</code> <code class="o">:</code> <code class="p">{</code>
               <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116934</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
               <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDurable"</code> <code class="o">:</code> <code class="p">{</code>
               <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1478116934</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
               <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:14Z"</code><code class="p">),</code>
            <code class="s2">"optimeDurableDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:14Z"</code><code class="p">),</code>
            <code class="s2">"lastHeartbeat"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:15.619Z"</code><code class="p">),</code>
            <code class="s2">"lastHeartbeatRecv"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-11-02T20:02:14.787Z"</code><code class="p">),</code>
            <code class="s2">"pingMs"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code>
            <code class="s2">"syncingTo"</code> <code class="o">:</code> <code class="s2">"m1.example.net:27018"</code><code class="p">,</code>
            <code class="s2">"configVersion"</code> <code class="o">:</code> <code class="mi">1</code>
      <code class="p">}</code>
   <code class="p">],</code>
   <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>These are some of the most useful fields:</p><dl><dt><code>"self"</code></dt><dd><p>This<a data-type="indexterm" data-primary="replication" data-secondary="monitoring" data-tertiary="useful fields" id="idm45882350401016"/> field is only present in the member <code class="function">rs.status()</code> was run on—in this case,
            <em class="filename">server-2</em>
            (<em>m1.example.net:27017</em>).</p></dd><dt><code>"stateStr"</code></dt><dd><p>A string describing the state of the server. See <a data-type="xref" href="ch11.xhtml#sect2-rs-states">“Member States”</a> for descriptions of the various
            states.</p></dd><dt><code>"uptime"</code></dt><dd><p>The number of seconds a member has been reachable, or the
            time since this server was started for the <code>"self"</code> member. Thus, <em class="filename">server-1</em> has been up for 269 seconds,
            and <em class="filename">server-2</em> and <em class="filename">server-3</em> for 14 seconds.</p></dd><dt><code>"optimeDate"</code></dt><dd><p>The last optime in each member’s oplog (where that member is
            synced to). Note that this is the state of each member as reported
            by the heartbeat, so the optime reported here may be off by a
            couple of seconds.</p></dd><dt><code>"lastHeartbeat"</code></dt><dd><p>The time this server last received a heartbeat from the
            <code>"self"</code> member. If there have
            been network issues or the server has been busy, this may be
            longer than two seconds ago.</p></dd><dt><code>"pingMs"</code></dt><dd><p>The running average of how long heartbeats to this server
            have taken. This is used in determining which member to sync
            from.</p></dd><dt><code>"errmsg"</code></dt><dd><p>Any status message that the member chose to return in the
            heartbeat request. These are often merely informational, not error
            messages. For example, the <code>"errmsg"</code> field in <em class="filename">server-3</em> indicates that this server is
            in the process of initial syncing. The hexadecimal number
            507e9a30:851 is the timestamp of the operation this member needs
            to get to to complete the initial sync.</p></dd></dl><p>There are several fields that give overlapping information.
      <code>"state"</code> is the same as <code>"stateStr"</code>; it’s simply the internal ID for
      the state. <code>"health"</code> merely reflects
      whether a given server is reachable (<code>1</code>) or unreachable (<code>0</code>), which is also shown by <code>"state"</code> and <code>"stateStr"</code> (they’ll be <code>UNKNOWN</code> or <code>DOWN</code> if the server is unreachable). Similarly,
      <code>"optime"</code> and <code>"optimeDate"</code> are the same value represented in
      two ways: one <span class="keep-together">represents</span> milliseconds since the epoch (<code>"t" : 135...</code>) and the other is a more
      human-readable date.</p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>Note that this report is from the point of view of whichever
        member of the set you run it on: the information it contains may be
        incorrect or out of date due to network issues.</p></div></div></section><section data-type="sect2" data-pdf-bookmark="Visualizing the Replication Graph"><div class="sect2" id="idm45882349998760"><h2>Visualizing the Replication Graph</h2><p>If<a data-type="indexterm" data-primary="replication" data-secondary="monitoring" data-tertiary="replication graph" id="idm45882349997368"/> you run <code class="function">rs.status()</code>
      on a secondary, there will be a top-level field called <span class="keep-together"><code>"syncingTo"</code></span>. This gives the host that
      this member is replicating from. By running the <code>replSetGetStatus</code> command on each member of the
      set, you can figure out the replication graph. For example, assuming
      <code>server1</code> was a connection to <em class="filename">server1</em>, <code>server2</code> was a connection to <em class="filename">server2</em>, and so on, you might have something
      like:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">server1</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="nx">replSetGetStatus</code><code class="o">:</code> <code class="mi">1</code><code class="p">})[</code><code class="s1">'syncingTo'</code><code class="p">]</code>
<code class="nx">server0</code><code class="o">:</code><code class="mi">27017</code>
<code class="o">&gt;</code> <code class="nx">server2</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="nx">replSetGetStatus</code><code class="o">:</code> <code class="mi">1</code><code class="p">})[</code><code class="s1">'syncingTo'</code><code class="p">]</code>
<code class="nx">server1</code><code class="o">:</code><code class="mi">27017</code>
<code class="o">&gt;</code> <code class="nx">server3</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="nx">replSetGetStatus</code><code class="o">:</code> <code class="mi">1</code><code class="p">})[</code><code class="s1">'syncingTo'</code><code class="p">]</code>
<code class="nx">server1</code><code class="o">:</code><code class="mi">27017</code>
<code class="o">&gt;</code> <code class="nx">server4</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="nx">replSetGetStatus</code><code class="o">:</code> <code class="mi">1</code><code class="p">})[</code><code class="s1">'syncingTo'</code><code class="p">]</code>
<code class="nx">server2</code><code class="o">:</code><code class="mi">27017</code></pre><p>Thus, <em class="filename">server0</em> is the
      replication source for <em class="filename">server1</em>,
      <em class="filename">server1</em> is the replication source
      for <em class="filename">server2</em> and <em class="filename">server3</em>, and <em class="filename">server2</em> is the replication source for
      <em class="filename">server4</em>.</p><p>MongoDB determines who to sync to based on ping time<a data-type="indexterm" data-primary="ping time" id="idm45882349932392"/>. When one member heartbeats another, it times how long
      that request takes. MongoDB keeps a running average of these times. When
      a member has to choose another member to sync from, it looks for the one
      that is closest to it and ahead of it in replication (thus, you cannot
      end up with a replication cycle: members will only replicate from the
      primary or secondaries that are further ahead).</p><p>This means that if you bring up a new member in a secondary data
      center, it is more likely to sync from another member in that data
      center than a member in your primary data center (thus minimizing WAN
      traffic), as shown in <a data-type="xref" href="#repl-admin-1">Figure 13-1</a>.</p><p>However, there<a data-type="indexterm" data-primary="replication" data-secondary="automatic replication chaining" id="idm45882349929240"/> is a downside to automatic replication chaining<a data-type="indexterm" data-primary="automatic replication chaining" id="idm45882349927944"/>: more replication hops means that it takes a bit longer
      to replicate writes to all servers. For example, let’s say that
      everything is in one data center but, due to the vagaries of network
      speeds when you added members, MongoDB ends up replicating in a line, as
      shown in <a data-type="xref" href="#repl-admin-2">Figure 13-2</a>.</p><figure style="float: 0"><div id="repl-admin-1" class="figure"><img src="Images/mdb3_1301.png" width="535" height="325"/><h6><span class="label">Figure 13-1. </span>New secondaries will generally choose to sync from a member in
        the same data center</h6></div></figure><figure style="float: 0"><div id="repl-admin-2" class="figure"><img src="Images/mdb3_1302.png" width="485" height="370"/><h6><span class="label">Figure 13-2. </span>As replication chains get longer, it takes longer for all
        members to get a copy of the data</h6></div></figure><p>This is highly unlikely, but not impossible. It is, however,
      probably undesirable: each secondary in the chain will have to be a bit
      further behind than the secondary “in front” of it. You can fix this by
      modifying the replication source for a member using the <code>replSetSyncFrom</code> command<a data-type="indexterm" data-primary="replSetSyncFrom command" id="idm45882349921848"/> (or the <code class="function">rs.syncFrom()<a data-type="indexterm" data-primary="rs.syncFrom()" id="idm45882349920264"/></code> helper).</p><p>Connect to the secondary whose replication source you want to
      change and run this command, passing it the server you’d prefer this
      member to sync from:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">secondary</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"replSetSyncFrom"</code> <code class="o">:</code> <code class="s2">"server0:27017"</code><code class="p">})</code></pre><p>It may take a few seconds to switch sync sources, but if you run
      <code class="function">rs.status()</code> on that member again,
      you should see that the <code>"syncingTo"</code>
      field now says <code>"server0:27017"</code>.</p><p>This member (<em class="filename">server4</em>) will
      now continue replicating from <em class="filename">server0</em> until <em class="filename">server0</em> becomes unavailable or, if it
      happened to be a secondary, falls significantly behind the other <span class="keep-together">members</span>.</p></div></section><section data-type="sect2" data-pdf-bookmark="Replication Loops"><div class="sect2" id="idm45882349998456"><h2>Replication Loops</h2><p>A<a data-type="indexterm" data-primary="replication" data-secondary="monitoring" data-tertiary="replication loops" id="idm45882349846472"/> <em>replication loop</em> is when members end
      up replicating from one another—for example, <em class="filename">A</em> is syncing from <em class="filename">B</em> who is syncing from <em class="filename">C</em> who is syncing from <em class="filename">A</em>. As none of the members in a replication
      loop can be a primary, the members will not receive any new operations
      to replicate and will fall behind.</p><p>Replication loops should be impossible when members choose who to
      sync from automatically. However, you can force replication loops using
      the <code>replSetSyncFrom</code> command. Inspect
      the <code>rs.status()</code> output carefully
      before manually changing sync targets, and be careful not to create
      loops. The <code>replSetSyncFrom</code> command
      will warn you if you do not choose to sync from a member that is
      strictly ahead, but it will allow it.</p></div></section><section data-type="sect2" data-pdf-bookmark="Disabling Chaining"><div class="sect2" id="idm45882349907016"><h2>Disabling Chaining</h2><p><em>Chaining</em> is<a data-type="indexterm" data-primary="automatic replication chaining" id="idm45882349898648"/><a data-type="indexterm" data-primary="chaining" id="idm45882349897816"/><a data-type="indexterm" data-primary="replication" data-secondary="monitoring" data-tertiary="disabling chaining" id="idm45882349896984"/> when a secondary syncs from another secondary (instead of
      the primary). As mentioned earlier, members may decide to sync from
      other members automatically. You can disable chaining, forcing everyone
      to sync from the primary, by changing the <code>"chainingAllowed"</code> setting to <code>false</code> (if not specified, it defaults to
      <code>true</code>):</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">config</code> <code class="o">=</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">config</code><code class="p">()</code>
<code class="o">&gt;</code> <code class="c1">// create the settings subobject, if it does not already exist</code>
<code class="o">&gt;</code> <code class="nx">config</code><code class="p">.</code><code class="nx">settings</code> <code class="o">=</code> <code class="nx">config</code><code class="p">.</code><code class="nx">settings</code> <code class="o">||</code> <code class="p">{}</code>
<code class="o">&gt;</code> <code class="nx">config</code><code class="p">.</code><code class="nx">settings</code><code class="p">.</code><code class="nx">chainingAllowed</code> <code class="o">=</code> <code class="kc">false</code>
<code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">reconfig</code><code class="p">(</code><code class="nx">config</code><code class="p">)</code></pre><p>With <code class="option">"chainingAllowed"</code> set to <code>false</code>, all members will sync from the primary.
      If the primary becomes unavailable, they will fall back to syncing from
      secondaries.</p></div></section><section data-type="sect2" data-pdf-bookmark="Calculating Lag"><div class="sect2" id="idm45882349715144"><h2>Calculating Lag</h2><p>One<a data-type="indexterm" data-primary="lag, calculating" id="idm45882349714024"/><a data-type="indexterm" data-primary="replication" data-secondary="monitoring" data-tertiary="calculating lag" id="idm45882349713160"/> of the most important metrics to track for replication is
      how well the secondaries are keeping up with the primary.
      <em>Lag</em> is how far behind a secondary is, which means
      the difference between the timestamp of the last operation the primary
      has performed and the timestamp of the last operation the secondary has
      applied.</p><p>You can use <code class="function">rs.status()</code> to
      see a member’s replication state, but you can also get a quick summary
      by running <code class="function">rs.printReplicationInfo()<a data-type="indexterm" data-primary="rs.printReplicationInfo()" id="idm45882349709208"/></code> or <code class="function">rs.printSlaveReplicationInfo(<a data-type="indexterm" data-primary="rs.printSlaveReplicationInfo()" id="idm45882349707720"/>)</code>.</p><p><code class="function">rs.printReplicationInfo()</code>
      <span>gives a summary of the primary’s oplog, including its size and
      the date range of its operations</span>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">printReplicationInfo</code><code class="p">();</code>
    <code class="nx">configured</code> <code class="nx">oplog</code> <code class="nx">size</code><code class="o">:</code>   <code class="mf">10.48576</code><code class="nx">MB</code>
    <code class="nx">log</code> <code class="nx">length</code> <code class="nx">start</code> <code class="nx">to</code> <code class="nx">end</code><code class="o">:</code> <code class="mi">3590</code> <code class="nx">secs</code> <code class="p">(</code><code class="mf">1.00</code><code class="nx">hrs</code><code class="p">)</code>
    <code class="nx">oplog</code> <code class="nx">first</code> <code class="nx">event</code> <code class="nx">time</code><code class="o">:</code>  <code class="nx">Tue</code> <code class="nx">Apr</code> <code class="mi">10</code> <code class="mi">2018</code> <code class="mi">09</code><code class="o">:</code><code class="mi">27</code><code class="o">:</code><code class="mi">57</code> <code class="nx">GMT</code><code class="o">-</code><code class="mi">0400</code> <code class="p">(</code><code class="nx">EDT</code><code class="p">)</code>
    <code class="nx">oplog</code> <code class="nx">last</code> <code class="nx">event</code> <code class="nx">time</code><code class="o">:</code>   <code class="nx">Tue</code> <code class="nx">Apr</code> <code class="mi">10</code> <code class="mi">2018</code> <code class="mi">10</code><code class="o">:</code><code class="mi">27</code><code class="o">:</code><code class="mi">47</code> <code class="nx">GMT</code><code class="o">-</code><code class="mi">0400</code> <code class="p">(</code><code class="nx">EDT</code><code class="p">)</code>
    <code class="nx">now</code><code class="o">:</code>                     <code class="nx">Tue</code> <code class="nx">Apr</code> <code class="mi">10</code> <code class="mi">2018</code> <code class="mi">10</code><code class="o">:</code><code class="mi">27</code><code class="o">:</code><code class="mi">47</code> <code class="nx">GMT</code><code class="o">-</code><code class="mi">0400</code> <code class="p">(</code><code class="nx">EDT</code><code class="p">)</code></pre><p>In this example, the oplog is about 10 MB (10 MiB) and is only
      able to fit about an hour of operations.</p><p>If this were a real deployment, the oplog should probably be
      larger (see the next section for instructions on changing oplog size).
      We want the log length to be <em>at least</em> as long as
      the time it takes to do a full resync. That way, we don’t run into a
      case where a secondary falls off the end of the oplog before finishing
      its initial sync.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>The log length is computed by taking the time difference between
        the first and last operation in the oplog once the oplog has filled
        up. If the server has just started with nothing in the oplog, then the
        earliest operation will be relatively recent. In that case, the log
        length will be small, even though the oplog probably still has free
        space available. The length is a more useful metric for servers that
        have been operating long enough to write through their entire oplog at
        least once.</p></div><p>You can also use the <code class="function">rs.printSlaveReplicationInfo()</code> function to
      get the <code>syncedTo</code> value for each
      member and the time when the last oplog entry was written to each
      secondary, as shown in the following example:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">printSlaveReplicationInfo</code><code class="p">();</code>
<code class="nx">source</code><code class="o">:</code> <code class="nx">m1</code><code class="p">.</code><code class="nx">example</code><code class="p">.</code><code class="nx">net</code><code class="o">:</code><code class="mi">27017</code>
    <code class="nx">syncedTo</code><code class="o">:</code> <code class="nx">Tue</code> <code class="nx">Apr</code> <code class="mi">10</code> <code class="mi">2018</code> <code class="mi">10</code><code class="o">:</code><code class="mi">27</code><code class="o">:</code><code class="mi">47</code> <code class="nx">GMT</code><code class="o">-</code><code class="mi">0400</code> <code class="p">(</code><code class="nx">EDT</code><code class="p">)</code>
    <code class="mi">0</code> <code class="nx">secs</code> <code class="p">(</code><code class="mi">0</code> <code class="nx">hrs</code><code class="p">)</code> <code class="nx">behind</code> <code class="nx">the</code> <code class="nx">primary</code>
<code class="nx">source</code><code class="o">:</code> <code class="nx">m2</code><code class="p">.</code><code class="nx">example</code><code class="p">.</code><code class="nx">net</code><code class="o">:</code><code class="mi">27017</code>
    <code class="nx">syncedTo</code><code class="o">:</code> <code class="nx">Tue</code> <code class="nx">Apr</code> <code class="mi">10</code> <code class="mi">2018</code> <code class="mi">10</code><code class="o">:</code><code class="mi">27</code><code class="o">:</code><code class="mi">43</code> <code class="nx">GMT</code><code class="o">-</code><code class="mi">0400</code> <code class="p">(</code><code class="nx">EDT</code><code class="p">)</code>
    <code class="mi">0</code> <code class="nx">secs</code> <code class="p">(</code><code class="mi">0</code> <code class="nx">hrs</code><code class="p">)</code> <code class="nx">behind</code> <code class="nx">the</code> <code class="nx">primary</code>
<code class="nx">source</code><code class="o">:</code> <code class="nx">m3</code><code class="p">.</code><code class="nx">example</code><code class="p">.</code><code class="nx">net</code><code class="o">:</code><code class="mi">27017</code>
    <code class="nx">syncedTo</code><code class="o">:</code> <code class="nx">Tue</code> <code class="nx">Apr</code> <code class="mi">10</code> <code class="mi">2018</code> <code class="mi">10</code><code class="o">:</code><code class="mi">27</code><code class="o">:</code><code class="mi">39</code> <code class="nx">GMT</code><code class="o">-</code><code class="mi">0400</code> <code class="p">(</code><code class="nx">EDT</code><code class="p">)</code>
    <code class="mi">0</code> <code class="nx">secs</code> <code class="p">(</code><code class="mi">0</code> <code class="nx">hrs</code><code class="p">)</code> <code class="nx">behind</code> <code class="nx">the</code> <code class="nx">primary</code></pre><p>Remember that a replica set member’s lag is calculated relative to
      the primary, not against “wall time.” This usually is irrelevant, but on
      very low-write systems, this can cause phantom replication lag “spikes.”
      For example, suppose you do a write once an hour. Right after that
      write, before it’s replicated, the secondary will look like it’s an hour
      behind the primary. However, it’ll be able to catch up with that “hour”
      of operations in a few milliseconds. This can sometimes cause confusion
      when monitoring a low-throughput system.</p></div></section><section data-type="sect2" data-pdf-bookmark="Resizing the Oplog"><div class="sect2" id="sect1-resize-oplog"><h2>Resizing the Oplog</h2><p>Your<a data-type="indexterm" data-primary="oplogs" data-secondary="resizing" id="idm45882349507368"/><a data-type="indexterm" data-primary="replication" data-secondary="monitoring" data-tertiary="resizing oplogs" id="idm45882349370888"/> primary’s oplog should be thought of as your maintenance
      window. If your primary has an oplog that is an hour long, then you only
      have one hour to fix anything that goes wrong before your secondaries
      fall too far behind and must be resynced from scratch. Thus, you
      generally want to have an oplog that can hold a couple days’ to a week’s
      worth of data, to give yourself some breathing room if something goes
      wrong.</p><p>Unfortunately, there’s no easy way to tell how long your oplog is
      going to be before it fills up. The WiredTiger storage engine allows
      online resizing of your oplog while your server is running. You should
      perform these steps on each secondary replica set member first; once
      these have been changed, then and only then should you make the changes
      to your primary. Remember that each server that could become a primary
      should have a large enough oplog to give you a sane maintenance
      window.</p><p>To increase the size of your oplog, perform the following
      steps:</p><ol><li><p>Connect to the replica set member. If authentication is
          enabled, be sure to use a user with privileges that can modify the
          <code>local</code> database.</p></li><li><p>Verify the current size of the oplog:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">use</code> <code class="nx">local</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">oplog</code><code class="p">.</code><code class="nx">rs</code><code class="p">.</code><code class="nx">stats</code><code class="p">(</code><code class="mi">1024</code><code class="o">*</code><code class="mi">1024</code><code class="p">).</code><code class="nx">maxSize</code></pre><div data-type="note" epub:type="note"><h6>Note</h6><p>This will display the collection size in megabytes.</p></div></li><li><p>Change the oplog size of the replica set member:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="nx">replSetResizeOplog</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">size</code><code class="o">:</code> <code class="mi">16000</code><code class="p">})</code></pre><div data-type="note" epub:type="note"><h6>Note</h6><p>The following operation changes the oplog size of the
            replica set member to 16 gigabytes, or 16000 megabytes.</p></div></li><li><p>Finally, if you have reduced the size of the oplog, you may
          need to run the <code>compact</code> to
          reclaim the disk space allocated. This should not be run against a
          member while it is a primary. Please see the <a href="https://oreil.ly/krv0R">“Change
          the Size of the Oplog” tutorial in the MongoDB documentation</a>
          for more details on this case and on the entire procedure.</p></li></ol><p>You generally should not decrease the size of your oplog: although
      it may be months long, there is usually ample disk space for it and it
      does not use up any valuable resources like RAM or CPU.</p></div></section><section data-type="sect2" data-pdf-bookmark="Building Indexes"><div class="sect2" id="repl-building-indexes"><h2>Building Indexes</h2><p>If<a data-type="indexterm" data-primary="replication" data-secondary="monitoring" data-tertiary="building indexes" id="idm45882349296776"/> you send an index build to the primary, the primary will
      build the index normally and then the secondaries will build the index
      when they replicate the “build index” operation. Although this is the
      easiest way to build an index, index builds are resource-intensive
      operations that can make members unavailable. If all of your secondaries
      start building an index at the same time, almost every member of your
      set will be offline until the index build completes. This process is
      only for replica sets; for a sharded cluster, please see <a href="https://oreil.ly/wJNeE">the
      MongoDB documentation tutorial about building indexes on a sharded
      cluster</a>.</p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>You must stop all writes to a collection when you are creating a
        <code>"unique"</code> index. If the writes are not stopped, you
        can end up with inconsistent data across the replica set
        members.</p></div><p>Therefore, you may want to build an index on one member at a time
      to minimize the impact on your application. To accomplish this, do the
      following:</p><ol><li><p>Shut down a secondary.</p></li><li><p>Restart it as a standalone server.</p></li><li><p>Build the index on the standalone server.</p></li><li><p>When the index build is complete, restart the server as a
          member of the replica set. When restarting this member, you need to
          remove the <code>disableLogicalSessionCacheRefresh</code>
          parameter if it is present in your command-line options or
          configuration file.</p></li><li><p>Repeat steps 1 through 4 for each secondary in the replica
          set.</p></li></ol><p>You should now have a set where every member other than the
      primary has the index built. Now there are two options, and you should
      choose the one that will impact your production system the least:</p><ol><li><p>Build the index on the primary. If you have an “off” time when
          you have less traffic, that would probably be a good time to build
          it. You also might want to modify read preferences to temporarily
          shunt more load onto secondaries while the build is in
          progress.</p><p>The primary will replicate the index build to the secondaries,
          but they will already have the index so it will be a no-op for
          them.</p></li><li><p>Step down the primary, then follow steps 2 through 4 of the
          procedure outlined previously. This requires a failover, but you
          will have a normally functioning primary while the old primary is
          building its index. After its index build is complete, you can
          reintroduce it to the set.</p></li></ol><p>Note that you could also use this technique to build different
      indexes on a secondary than you have on the rest of the set. This could
      be useful for offline processing, but make sure a member with different
      indexes can never become primary: its priority should always be <code>0</code>.</p><p>If you are building a unique index, make sure that the primary is
      not inserting duplicates or that you build the index on the primary
      first. Otherwise, the primary could be inserting duplicates that would
      then cause replication errors on secondaries. If this occurs, the
      secondary will shut itself down. You will have to restart it as a
      standalone server, remove the unique index, and <a data-type="indexterm" data-startref="Amonrep13" id="idm45882349337656"/>restart it.</p></div></section><section data-type="sect2" data-pdf-bookmark="Replication on a Budget"><div class="sect2" id="idm45882349297944"><h2>Replication on a Budget</h2><p>If<a data-type="indexterm" data-primary="replication" data-secondary="budget approach to" id="idm45882349335880"/><a data-type="indexterm" data-primary="administration, of replica sets" data-secondary="replication on a budget" id="idm45882349334744"/> it is difficult to get more than one high-quality server,
      consider getting a secondary server that is strictly for disaster
      recovery, with less RAM and CPU, slower disk I/O, etc. The good server
      will always be your primary and the cheaper server will never handle any
      client traffic (configure your clients to send all reads to the
      primary). Here are the options to set for the cheaper box:</p><dl><dt><code>"priority" : 0</code></dt><dd><p>You do not want this server to ever become primary.</p></dd><dt><code>"hidden" : true</code></dt><dd><p>You do not want clients ever sending reads to this
            secondary.</p></dd><dt><code>"buildIndexes" :
          false</code></dt><dd><p>This is optional, but it can decrease the load this server
            has to handle considerably. If you ever need to restore from this
            server, you’ll need to rebuild the indexes.</p></dd><dt><code>"votes" : 0</code></dt><dd><p>If you only have two machines, set <code>"votes"</code> on this secondary to <code>0</code> so that the primary can stay primary
            if this machine goes down. If you have a third server (even just
            your application server), run an arbiter on that instead of
            setting <code>"votes"</code> to <code>0</code>.</p></dd></dl><p>This will give you the safety and security of having a secondary
      without having to invest in two high-performance servers.</p></div></section></div></section></div></section></div>



  </body></html>