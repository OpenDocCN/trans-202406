<html><head></head><body><section data-pdf-bookmark="Chapter 16. Create, Read, Update, and Delete Operations" data-type="chapter" epub:type="chapter"><div class="chapter" id="create_read_update_and_delete">&#13;
<h1><span class="label">Chapter 16. </span>Create, Read, Update, <span class="keep-together">and Delete Operations</span></h1>&#13;
&#13;
&#13;
<p><a data-primary="CRUD operations" data-type="indexterm" id="ix_ch16-asciidoc0"/>I love paper notebooks and keep one with me at nearly all times. Usually they are relatively inexpensive and I quickly fill them with half-formed thoughts. Not long ago I purchased a pricier hardback notebook, with a lovely cover and fancy paper stock. At the time of purchase, I had grand ambitions of the types of sketches and planning that would happen within that notebook, but it sat completely empty on my desk for months. Eventually, I put it on a shelf and went back to my standard notebook brand.</p>&#13;
&#13;
<p>Much like my fancy notebook, our app is useful only if our users are able to interact with it. You may recall from our API development that the Notedly application is a “CRUD” (create, read, update, and delete) application. An authenticated user can create new notes, read notes, update the content of a note or a note’s status as a favorite, and delete a note. In this chapter, we’ll implement all of this functionality within our web user interface. To accomplish these tasks, we’ll be writing GraphQL mutations and queries.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating New Notes" data-type="sect1"><div class="sect1" id="idm45339491766136">&#13;
<h1>Creating New Notes</h1>&#13;
&#13;
<p><a data-primary="CRUD operations" data-secondary="creating new notes" data-type="indexterm" id="ix_ch16-asciidoc1"/><a data-primary="newNote" data-secondary="creating" data-type="indexterm" id="ix_ch16-asciidoc2"/>Currently we have the means to view notes, but not a way to create them. This is akin to having a notebook without a pen. Let’s add the ability for users to create new notes. We’ll do this by creating a <a data-primary="textarea form" data-type="indexterm" id="idm45339491761400"/><code>textarea</code> form in which users can write the note. When the user submits the form, we’ll perform a GraphQL mutation to create the note in our database.</p>&#13;
&#13;
<p>To begin, let’s create the <code>NewNote</code> component at <em>src/pages/new.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useEffect</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useMutation</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NewNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// update the document title</code>&#13;
    <code class="nb">document</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="s1">'New Note — Notedly'</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code><code class="nx">New</code> <code class="nx">note</code><code class="o">&lt;</code><code class="err">/div&gt;;</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NewNote</code><code class="p">;</code></pre>&#13;
&#13;
<p>Next, let’s set up the new route in our <em>src/pages/index.js</em> file:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// import the NewNote route component</code>&#13;
<code class="kr">import</code> <code class="nx">NewNote</code> <code class="nx">from</code> <code class="s1">'./new'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// add a private route to our list of routes, within the</code>&#13;
<code class="o">&lt;</code><code class="nx">PrivateRoute</code> <code class="nx">path</code><code class="o">=</code><code class="s2">"/new"</code> <code class="nx">component</code><code class="o">=</code><code class="p">{</code><code class="nx">NewNote</code><code class="p">}</code> <code class="o">/&gt;</code></pre>&#13;
&#13;
<p>We know that we’ll be both creating new notes as well as updating existing notes. To accommodate this behavior, let’s create a new component called <code>NoteForm</code>, which will serve as the markup and React state for note form editing.</p>&#13;
&#13;
<p>We’ll create a new file at <em>src/components/NoteForm.js</em>. The component will consist of a form element containing a text area along with some minimal styles. The functionality will be much like our <code>UserForm</code> component:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useState</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">styled</code> <code class="nx">from</code> <code class="s1">'styled-components'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">Button</code> <code class="nx">from</code> <code class="s1">'./Button'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">Wrapper</code> <code class="o">=</code> <code class="nx">styled</code><code class="p">.</code><code class="nx">div</code><code class="sb">`</code>&#13;
<code class="sb">  height: 100%;</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">Form</code> <code class="o">=</code> <code class="nx">styled</code><code class="p">.</code><code class="nx">form</code><code class="sb">`</code>&#13;
<code class="sb">  height: 100%;</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">TextArea</code> <code class="o">=</code> <code class="nx">styled</code><code class="p">.</code><code class="nx">textarea</code><code class="sb">`</code>&#13;
<code class="sb">  width: 100%;</code>&#13;
<code class="sb">  height: 90%;</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NoteForm</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// set the default state of the form</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">value</code><code class="p">,</code> <code class="nx">setValue</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">({</code> <code class="nx">content</code><code class="o">:</code> <code class="nx">props</code><code class="p">.</code><code class="nx">content</code> <code class="o">||</code> <code class="s1">''</code> <code class="p">});</code>&#13;
&#13;
  <code class="c1">// update the state when a user types in the form</code>&#13;
  <code class="kr">const</code> <code class="nx">onChange</code> <code class="o">=</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">setValue</code><code class="p">({</code>&#13;
      <code class="p">...</code><code class="nx">value</code><code class="p">,</code>&#13;
      <code class="p">[</code><code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code><code class="o">:</code> <code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">value</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">};</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">Wrapper</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">Form</code>&#13;
        <code class="nx">onSubmit</code><code class="o">=</code><code class="p">{</code><code class="nx">e</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
          <code class="nx">e</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>&#13;
          <code class="nx">props</code><code class="p">.</code><code class="nx">action</code><code class="p">({</code>&#13;
            <code class="nx">variables</code><code class="o">:</code> <code class="p">{</code>&#13;
              <code class="p">...</code><code class="nx">values</code>&#13;
            <code class="p">}</code>&#13;
          <code class="p">});</code>&#13;
        <code class="p">}}</code>&#13;
      <code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">TextArea</code>&#13;
          <code class="nx">required</code>&#13;
          <code class="nx">type</code><code class="o">=</code><code class="s2">"text"</code>&#13;
          <code class="nx">name</code><code class="o">=</code><code class="s2">"content"</code>&#13;
          <code class="nx">placeholder</code><code class="o">=</code><code class="s2">"Note content"</code>&#13;
          <code class="nx">value</code><code class="o">=</code><code class="p">{</code><code class="nx">value</code><code class="p">.</code><code class="nx">content</code><code class="p">}</code>&#13;
          <code class="nx">onChange</code><code class="o">=</code><code class="p">{</code><code class="nx">onChange</code><code class="p">}</code>&#13;
        <code class="o">/&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">Button</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"submit"</code><code class="o">&gt;</code><code class="nx">Save</code><code class="o">&lt;</code><code class="err">/Button&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/Form&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/Wrapper&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NoteForm</code><code class="p">;</code></pre>&#13;
&#13;
<p>Next, we will need to reference our <code>NoteForm</code> component in our <code>NewNote</code> page component. In <em>src/pages/new.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useEffect</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useMutation</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
<code class="c1">// import the NoteForm component</code>&#13;
<code class="kr">import</code> <code class="nx">NoteForm</code> <code class="nx">from</code> <code class="s1">'../components/NoteForm'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NewNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// update the document title</code>&#13;
    <code class="nb">document</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="s1">'New Note — Notedly'</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">NoteForm</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
<code class="p">};</code>&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NewNote</code><code class="p">;</code></pre>&#13;
&#13;
<p class="pagebreak-before">With these updates, navigating to <em>http://localhost:1234/new</em> will display our form (<a data-type="xref" href="#web_note_form">Figure 16-1</a>).</p>&#13;
&#13;
<figure><div class="figure" id="web_note_form">&#13;
<img alt="A screenshot of the note form component" src="assets/jsev_1601.png"/>&#13;
<h6><span class="label">Figure 16-1. </span>Our NewNote component presents the user with a large text area and Save button</h6>&#13;
</div></figure>&#13;
&#13;
<p>With the form complete, we can go about writing our <a data-primary="mutations" data-secondary="new note" data-type="indexterm" id="idm45339491190584"/>mutation to create the new note. In <em>src/pages/new.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useEffect</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useMutation</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">NoteForm</code> <code class="nx">from</code> <code class="s1">'../components/NoteForm'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// our new note query</code>&#13;
<code class="kr">const</code> <code class="nx">NEW_NOTE</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  mutation newNote($content: String!) {</code>&#13;
<code class="sb">    newNote(content: $content) {</code>&#13;
<code class="sb">      id</code>&#13;
<code class="sb">      content</code>&#13;
<code class="sb">      createdAt</code>&#13;
<code class="sb">      favoriteCount</code>&#13;
<code class="sb">      favoritedBy {</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">        username</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">      author {</code>&#13;
<code class="sb">        username</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NewNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// update the document title</code>&#13;
    <code class="nb">document</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="s1">'New Note — Notedly'</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code> <code class="p">}]</code> <code class="o">=</code> <code class="nx">useMutation</code><code class="p">(</code><code class="nx">NEW_NOTE</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">onCompleted</code><code class="o">:</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="c1">// when complete, redirect the user to the note page</code>&#13;
      <code class="nx">props</code><code class="p">.</code><code class="nx">history</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="sb">`note/</code><code class="si">${</code><code class="nx">data</code><code class="p">.</code><code class="nx">newNote</code><code class="p">.</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="cm">/* as the mutation is loading, display a loading message*/</code><code class="p">}</code>&#13;
      <code class="p">{</code><code class="nx">loading</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
      <code class="p">{</code><code class="cm">/* if there is an error, display a error message*/</code><code class="p">}</code>&#13;
      <code class="p">{</code><code class="nx">error</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code> <code class="nx">saving</code> <code class="nx">the</code> <code class="nx">note</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
      <code class="p">{</code><code class="cm">/* the form component, passing the mutation data as a prop */</code><code class="p">}</code>&#13;
      <code class="o">&lt;</code><code class="nx">NoteForm</code> <code class="nx">action</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NewNote</code><code class="p">;</code></pre>&#13;
&#13;
<p>In the previous code we are performing a <code>newNote</code> mutation when the form is submitted. If the mutation is successful, the user is redirected to the individual note page. You may notice that the <code>newNote</code> mutation requests quite a bit of data. This matches the data requested by the <code>note</code> mutation, ideally updating Apollo’s cache for quick navigation to the individual note component.</p>&#13;
&#13;
<p>As mentioned earlier, Apollo aggressively caches our queries, which is helpful for speeding up our application’s navigation. Unfortunately, this also means a user could visit a page and not see an update they’ve just made. We can manually update Apollo’s cache, but an easier way to accomplish this is to use Apollo’s <a data-primary="refetchQueries" data-type="indexterm" id="idm45339490910232"/><code>refetchQueries</code> feature to intentionally update the cache when performing a mutation. To do this, we’ll need access to our prewritten queries. Up until now, we’ve been including them at the top of a component file, but let’s move them to their own <em>query.js</em> file. Create a new file at <em>/src/gql/query.js</em> and add each of our note queries as well as our <code>IS_LOGGED_IN</code> query:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="p">{</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">GET_NOTES</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  query noteFeed($cursor: String) {</code>&#13;
<code class="sb">    noteFeed(cursor: $cursor) {</code>&#13;
<code class="sb">      cursor</code>&#13;
<code class="sb">      hasNextPage</code>&#13;
<code class="sb">      notes {</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">        createdAt</code>&#13;
<code class="sb">        content</code>&#13;
<code class="sb">        favoriteCount</code>&#13;
<code class="sb">        author {</code>&#13;
<code class="sb">          username</code>&#13;
<code class="sb">          id</code>&#13;
<code class="sb">          avatar</code>&#13;
<code class="sb">        }</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">GET_NOTE</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  query note($id: ID!) {</code>&#13;
<code class="sb">    note(id: $id) {</code>&#13;
<code class="sb">      id</code>&#13;
<code class="sb">      createdAt</code>&#13;
<code class="sb">      content</code>&#13;
<code class="sb">      favoriteCount</code>&#13;
<code class="sb">      author {</code>&#13;
<code class="sb">        username</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">        avatar</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">IS_LOGGED_IN</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  {</code>&#13;
<code class="sb">    isLoggedIn @client</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="p">{</code> <code class="nx">GET_NOTES</code><code class="p">,</code> <code class="nx">GET_NOTE</code><code class="p">,</code> <code class="nx">IS_LOGGED_IN</code> <code class="p">};</code></pre>&#13;
<div data-type="tip"><h1>Reusable Queries and Mutations</h1>&#13;
<p>Moving forward, we will keep all of our queries and mutations separate from our components This will allow us to easily reuse them in our application and is also useful for <a href="https://oreil.ly/qo9uE">mocking</a> during testing.</p>&#13;
</div>&#13;
&#13;
<p>Now in <em>src/pages/new.js</em> we can request that our mutation refetch the <code>GET_NOTES</code> query by importing the query and adding the <code>refetchQueries</code> option:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// import the query</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_NOTES</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// within the NewNote component update the mutation</code>&#13;
<code class="c1">//everything else stays the same</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NewNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// update the document title</code>&#13;
    <code class="nb">document</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="s1">'New Note — Notedly'</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code> <code class="p">}]</code> <code class="o">=</code> <code class="nx">useMutation</code><code class="p">(</code><code class="nx">NEW_NOTE</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="c1">// refetch the GET_NOTES query to update the cache</code>&#13;
    <code class="nx">refetchQueries</code><code class="o">:</code> <code class="p">[{</code> <code class="nx">query</code><code class="o">:</code> <code class="nx">GET_NOTES</code> <code class="p">}],</code>&#13;
    <code class="nx">onCompleted</code><code class="o">:</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="c1">// when complete, redirect the user to the note page</code>&#13;
      <code class="nx">props</code><code class="p">.</code><code class="nx">history</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="sb">`note/</code><code class="si">${</code><code class="nx">data</code><code class="p">.</code><code class="nx">newNote</code><code class="p">.</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="cm">/* as the mutation is loading, display a loading message*/</code><code class="p">}</code>&#13;
      <code class="p">{</code><code class="nx">loading</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
      <code class="p">{</code><code class="cm">/* if there is an error, display a error message*/</code><code class="p">}</code>&#13;
      <code class="p">{</code><code class="nx">error</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code> <code class="nx">saving</code> <code class="nx">the</code> <code class="nx">note</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
      <code class="p">{</code><code class="cm">/* the form component, passing the mutation data as a prop */</code><code class="p">}</code>&#13;
      <code class="o">&lt;</code><code class="nx">NoteForm</code> <code class="nx">action</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>Our final step will be to add a link to our <em>/new</em> page, so that users can easily navigate to it. In the <em>src/components/Navigation.js</em> file, add a new link item as follows:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="o">&lt;</code><code class="nx">li</code><code class="o">&gt;</code>&#13;
  <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">to</code><code class="o">=</code><code class="s2">"/new"</code><code class="o">&gt;</code><code class="nx">New</code><code class="o">&lt;</code><code class="err">/Link&gt;</code>&#13;
<code class="o">&lt;</code><code class="err">/li&gt;</code></pre>&#13;
&#13;
<p>With this, our users are able to navigate to the new note page, type a note, and save the note to the database.<a data-startref="ix_ch16-asciidoc2" data-type="indexterm" id="idm45339490593816"/><a data-startref="ix_ch16-asciidoc1" data-type="indexterm" id="idm45339490593208"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reading User Notes" data-type="sect1"><div class="sect1" id="idm45339491765192">&#13;
<h1>Reading User Notes</h1>&#13;
&#13;
<p><a data-primary="CRUD operations" data-secondary="reading user notes" data-type="indexterm" id="ix_ch16-asciidoc3"/><a data-primary="reading user notes" data-type="indexterm" id="ix_ch16-asciidoc4"/>Our application is currently capable of reading our note feed as well as individual notes, but we are not yet querying the notes of authenticated users. Let’s write two GraphQL queries to create a feed of notes by the user as well as their favorites.</p>&#13;
&#13;
<p>In <em>src/gql/query.js</em>, add a <code>GET_MY_NOTES</code> query and update the exports like so:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// add the GET_MY_NOTES query</code>&#13;
<code class="kr">const</code> <code class="nx">GET_MY_NOTES</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  query me {</code>&#13;
<code class="sb">    me {</code>&#13;
<code class="sb">      id</code>&#13;
<code class="sb">      username</code>&#13;
<code class="sb">      notes {</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">        createdAt</code>&#13;
<code class="sb">        content</code>&#13;
<code class="sb">        favoriteCount</code>&#13;
<code class="sb">        author {</code>&#13;
<code class="sb">          username</code>&#13;
<code class="sb">          id</code>&#13;
<code class="sb">          avatar</code>&#13;
<code class="sb">        }</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// update to include GET_MY_NOTES</code>&#13;
<code class="kr">export</code> <code class="p">{</code> <code class="nx">GET_NOTES</code><code class="p">,</code> <code class="nx">GET_NOTE</code><code class="p">,</code> <code class="nx">IS_LOGGED_IN</code><code class="p">,</code> <code class="nx">GET_MY_NOTES</code> <code class="p">};</code></pre>&#13;
&#13;
<p>Now in <em>src/pages/mynotes.js</em>, import the query and display the notes using the <code>NoteFeed</code> component:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useEffect</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">NoteFeed</code> <code class="nx">from</code> <code class="s1">'../components/NoteFeed'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_MY_NOTES</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">MyNotes</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// update the document title</code>&#13;
    <code class="nb">document</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="s1">'My Notes — Notedly'</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">data</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_MY_NOTES</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// if the data is loading, our app will display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="s1">'Loading...'</code><code class="p">;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="sb">`Error! </code><code class="si">${</code><code class="nx">error</code><code class="p">.</code><code class="nx">message</code><code class="si">}</code><code class="sb">`</code><code class="p">;</code>&#13;
  <code class="c1">// if the query is successful and there are notes, return the feed of notes</code>&#13;
  <code class="c1">// else if the query is successful and there aren't notes, display a message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">notes</code><code class="p">.</code><code class="nx">length</code> <code class="o">!==</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">NoteFeed</code> <code class="nx">notes</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">notes</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">No</code> <code class="nx">notes</code> <code class="nx">yet</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">MyNotes</code><code class="p">;</code></pre>&#13;
&#13;
<p>We can repeat this process to make the “favorites” page. First, in <em>src/gql/query.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// add the GET_MY_FAVORITES query</code>&#13;
<code class="kr">const</code> <code class="nx">GET_MY_FAVORITES</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  query me {</code>&#13;
<code class="sb">    me {</code>&#13;
<code class="sb">      id</code>&#13;
<code class="sb">      username</code>&#13;
<code class="sb">      favorites {</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">        createdAt</code>&#13;
<code class="sb">        content</code>&#13;
<code class="sb">        favoriteCount</code>&#13;
<code class="sb">        author {</code>&#13;
<code class="sb">          username</code>&#13;
<code class="sb">          id</code>&#13;
<code class="sb">          avatar</code>&#13;
<code class="sb">        }</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// update to include GET_MY_FAVORITES</code>&#13;
<code class="kr">export</code> <code class="p">{</code> <code class="nx">GET_NOTES</code><code class="p">,</code> <code class="nx">GET_NOTE</code><code class="p">,</code> <code class="nx">IS_LOGGED_IN</code><code class="p">,</code> <code class="nx">GET_MY_NOTES</code><code class="p">,</code> <code class="nx">GET_MY_FAVORITES</code> <code class="p">};</code></pre>&#13;
&#13;
<p>Now, in <em>src/pages/favorites.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useEffect</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">NoteFeed</code> <code class="nx">from</code> <code class="s1">'../components/NoteFeed'</code><code class="p">;</code>&#13;
<code class="c1">// import the query</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_MY_FAVORITES</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">Favorites</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// update the document title</code>&#13;
    <code class="nb">document</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="s1">'Favorites — Notedly'</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">data</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_MY_FAVORITES</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// if the data is loading, our app will display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="s1">'Loading...'</code><code class="p">;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="sb">`Error! </code><code class="si">${</code><code class="nx">error</code><code class="p">.</code><code class="nx">message</code><code class="si">}</code><code class="sb">`</code><code class="p">;</code>&#13;
  <code class="c1">// if the query is successful and there are notes, return the feed of notes</code>&#13;
  <code class="c1">// else if the query is successful and there aren't notes, display a message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">favorites</code><code class="p">.</code><code class="nx">length</code> <code class="o">!==</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">NoteFeed</code> <code class="nx">notes</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">favorites</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">No</code> <code class="nx">favorites</code> <code class="nx">yet</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">Favorites</code><code class="p">;</code></pre>&#13;
&#13;
<p>Finally, let’s update our <em>src/pages/new.js</em> file to refetch the <code>GET_MY_NOTES</code> query, to ensure that a cached list of user notes is updated when the note is created. In <em>src/pages/new.js</em>, first update the GraphQL query import statement:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_MY_NOTES</code><code class="p">,</code> <code class="nx">GET_NOTES</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code></pre>&#13;
&#13;
<p>And then update the mutation:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code> <code class="p">}]</code> <code class="o">=</code> <code class="nx">useMutation</code><code class="p">(</code><code class="nx">NEW_NOTE</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="c1">// refetch the GET_NOTES and GET_MY_NOTES queries to update the cache</code>&#13;
  <code class="nx">refetchQueries</code><code class="o">:</code> <code class="p">[{</code> <code class="nx">query</code><code class="o">:</code> <code class="nx">GET_MY_NOTES</code> <code class="p">},</code> <code class="p">{</code> <code class="nx">query</code><code class="o">:</code> <code class="nx">GET_NOTES</code> <code class="p">}],</code>&#13;
  <code class="nx">onCompleted</code><code class="o">:</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// when complete, redirect the user to the note page</code>&#13;
    <code class="nx">props</code><code class="p">.</code><code class="nx">history</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="sb">`note/</code><code class="si">${</code><code class="nx">data</code><code class="p">.</code><code class="nx">newNote</code><code class="p">.</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>With these changes, we now can perform all of the read operations within our <span class="keep-together">application.</span><a data-startref="ix_ch16-asciidoc4" data-type="indexterm" id="idm45339489841688"/><a data-startref="ix_ch16-asciidoc3" data-type="indexterm" id="idm45339489841080"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Updating Notes" data-type="sect1"><div class="sect1" id="idm45339490606616">&#13;
<h1>Updating Notes</h1>&#13;
&#13;
<p><a data-primary="CRUD operations" data-secondary="updating notes" data-type="indexterm" id="ix_ch16-asciidoc5"/><a data-primary="updateNote mutation" data-type="indexterm" id="ix_ch16-asciidoc6"/>Currently once a user writes a note, they have no way to make an update to it. To address this, we want to enable note editing in our application. Our GraphQL API has an <code>updateNote</code> mutation, which accepts a note ID and content as parameters. If the note exists in the database, the mutation will update the stored content with the content sent in the mutation.</p>&#13;
&#13;
<p>In our application, we can create a route at <em>/edit/NOTE_ID</em> that will place the existing note content in a form <code>textarea</code>. When a user clicks Save, we’ll submit the form and perform the <code>updateNote</code> mutation.</p>&#13;
&#13;
<p>Let’s create a new route where our notes will be edited.  To begin, we can make a duplicate of our <em>src/pages/note.js</em> page and name it <em>edit.js</em>. For now, this page will simply display the note.</p>&#13;
&#13;
<p>At <em>src/pages/edit.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code><code class="p">,</code> <code class="nx">useMutation</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// import the Note component</code>&#13;
<code class="kr">import</code> <code class="nx">Note</code> <code class="nx">from</code> <code class="s1">'../components/Note'</code><code class="p">;</code>&#13;
<code class="c1">// import the GET_NOTE query</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_NOTE</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">EditNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// store the id found in the url as a variable</code>&#13;
  <code class="kr">const</code> <code class="nx">id</code> <code class="o">=</code> <code class="nx">props</code><code class="p">.</code><code class="nx">match</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code>&#13;
  <code class="c1">// define our note query</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">data</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_NOTE</code><code class="p">,</code> <code class="p">{</code> <code class="nx">variables</code><code class="o">:</code> <code class="p">{</code> <code class="nx">id</code> <code class="p">}</code> <code class="p">});</code>&#13;
&#13;
  <code class="c1">// if the data is loading, display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="s1">'Loading...'</code><code class="p">;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!</code> <code class="nx">Note</code> <code class="nx">not</code> <code class="nx">found</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="c1">// if successful, pass the data to the note component</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">Note</code> <code class="nx">note</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">note</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">EditNote</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now, we can make the page navigable by adding it to our routes in <em>src/pages/index.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// import the edit page component</code>&#13;
<code class="kr">import</code> <code class="nx">EditNote</code> <code class="nx">from</code> <code class="s1">'./edit'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// add a new private route that accepts an :id parameter</code>&#13;
<code class="o">&lt;</code><code class="nx">PrivateRoute</code> <code class="nx">path</code><code class="o">=</code><code class="s2">"/edit/:id"</code> <code class="nx">component</code><code class="o">=</code><code class="p">{</code><code class="nx">EditNote</code><code class="p">}</code> <code class="o">/&gt;</code></pre>&#13;
&#13;
<p>With this, if you navigate to a note page at <em>/note/ID</em> and swap it for <em>/edit/ID</em> you’ll see a render of the note itself. Let’s change this so that it instead displays the note content presented in a form’s <code>textarea</code>.</p>&#13;
&#13;
<p>In <em>src/pages/edit.js</em>, remove the import statement of the <code>Note</code> component and replace it with the <code>NoteForm</code> component:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// import the NoteForm component</code>&#13;
<code class="kr">import</code> <code class="nx">NoteForm</code> <code class="nx">from</code> <code class="s1">'../components/NoteForm'</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now we can update our <code>EditNote</code> component to use our editing form. We can pass the content of the note to our form component by using the <code>content</code> property. Though our GraphQL mutation will accept updates only from the original author, we can also limit displaying the form to the note’s author, to avoid confusing other users.</p>&#13;
&#13;
<p>First, add a new query to the <em>src/gql/query.js</em> file to get the current user, their user ID, and a list of favorited note IDs:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// add GET_ME to our queries</code>&#13;
<code class="kr">const</code> <code class="nx">GET_ME</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  query me {</code>&#13;
<code class="sb">    me {</code>&#13;
<code class="sb">      id</code>&#13;
<code class="sb">      favorites {</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// update to include GET_ME</code>&#13;
<code class="kr">export</code> <code class="p">{</code>&#13;
  <code class="nx">GET_NOTES</code><code class="p">,</code>&#13;
  <code class="nx">GET_NOTE</code><code class="p">,</code>&#13;
  <code class="nx">GET_MY_NOTES</code><code class="p">,</code>&#13;
  <code class="nx">GET_MY_FAVORITES</code><code class="p">,</code>&#13;
  <code class="nx">GET_ME</code><code class="p">,</code>&#13;
  <code class="nx">IS_LOGGED_IN</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>In <em>src/pages/edit.js</em>, import the <code>GET_ME</code> query and include a user check:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useMutation</code><code class="p">,</code> <code class="nx">useQuery</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// import the NoteForm component</code>&#13;
<code class="kr">import</code> <code class="nx">NoteForm</code> <code class="nx">from</code> <code class="s1">'../components/NoteForm'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_NOTE</code><code class="p">,</code> <code class="nx">GET_ME</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">EDIT_NOTE</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/mutation'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">EditNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// store the id found in the url as a variable</code>&#13;
  <code class="kr">const</code> <code class="nx">id</code> <code class="o">=</code> <code class="nx">props</code><code class="p">.</code><code class="nx">match</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code>&#13;
  <code class="c1">// define our note query</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">data</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_NOTE</code><code class="p">,</code> <code class="p">{</code> <code class="nx">variables</code><code class="o">:</code> <code class="p">{</code> <code class="nx">id</code> <code class="p">}</code> <code class="p">});</code>&#13;
  <code class="c1">// fetch the current user's data</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">userdata</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_ME</code><code class="p">);</code>&#13;
  <code class="c1">// if the data is loading, display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="s1">'Loading...'</code><code class="p">;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!</code> <code class="nx">Note</code> <code class="nx">not</code> <code class="nx">found</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="c1">// if the current user and the author of the note do not match</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">userdata</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">id</code> <code class="o">!==</code> <code class="nx">data</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">You</code> <code class="k">do</code> <code class="nx">not</code> <code class="nx">have</code> <code class="nx">access</code> <code class="nx">to</code> <code class="nx">edit</code> <code class="k">this</code> <code class="nx">note</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="p">}</code>&#13;
  <code class="c1">// pass the data to the form component</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">NoteForm</code> <code class="nx">content</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">content</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>We are now able to edit a note in the form, but clicking the button does not yet save our changes. Let’s write our GraphQL <code>updateNote</code> mutation. Similar to our file of queries, let’s create a file to hold our mutations. In <em>src/gql/mutation</em>, add the following:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="p">{</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">EDIT_NOTE</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  mutation updateNote($id: ID!, $content: String!) {</code>&#13;
<code class="sb">    updateNote(id: $id, content: $content) {</code>&#13;
<code class="sb">      id</code>&#13;
<code class="sb">      content</code>&#13;
<code class="sb">      createdAt</code>&#13;
<code class="sb">      favoriteCount</code>&#13;
<code class="sb">      favoritedBy {</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">        username</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">      author {</code>&#13;
<code class="sb">        username</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="p">{</code> <code class="nx">EDIT_NOTE</code> <code class="p">};</code></pre>&#13;
&#13;
<p>With our mutation written, we can import it and update our component code to call the mutation when the button is clicked. To do this, we will add a <a data-primary="useMutation" data-type="indexterm" id="idm45339489234168"/><code>useMutation</code> hook. When the mutation is complete, we’ll redirect the user to the note page.</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// import the mutation</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">EDIT_NOTE</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/mutation'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">EditNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// store the id found in the url as a variable</code>&#13;
  <code class="kr">const</code> <code class="nx">id</code> <code class="o">=</code> <code class="nx">props</code><code class="p">.</code><code class="nx">match</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code>&#13;
  <code class="c1">// define our note query</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">data</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_NOTE</code><code class="p">,</code> <code class="p">{</code> <code class="nx">variables</code><code class="o">:</code> <code class="p">{</code> <code class="nx">id</code> <code class="p">}</code> <code class="p">});</code>&#13;
  <code class="c1">// fetch the current user's data</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">userdata</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_ME</code><code class="p">);</code>&#13;
  <code class="c1">// define our mutation</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">editNote</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useMutation</code><code class="p">(</code><code class="nx">EDIT_NOTE</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">variables</code><code class="o">:</code> <code class="p">{</code>&#13;
      <code class="nx">id</code>&#13;
    <code class="p">},</code>&#13;
    <code class="nx">onCompleted</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="nx">props</code><code class="p">.</code><code class="nx">history</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="sb">`/note/</code><code class="si">${</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// if the data is loading, display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="s1">'Loading...'</code><code class="p">;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="c1">// if the current user and the author of the note do not match</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">userdata</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">id</code> <code class="o">!==</code> <code class="nx">data</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">You</code> <code class="k">do</code> <code class="nx">not</code> <code class="nx">have</code> <code class="nx">access</code> <code class="nx">to</code> <code class="nx">edit</code> <code class="k">this</code> <code class="nx">note</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="c1">// pass the data and mutation to the form component</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">NoteForm</code> <code class="nx">content</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">content</code><code class="p">}</code> <code class="nx">action</code><code class="o">=</code><code class="p">{</code><code class="nx">editNote</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">EditNote</code><code class="p">;</code></pre>&#13;
&#13;
<p>Finally, we’ll want to display an “Edit” link to users, but only if they are the author of the note. In our application, we will need to check to ensure that the ID of the current user matches the ID of the note author. To implement this behavior, we’ll be touching several components.</p>&#13;
&#13;
<p>Now we could implement our functionality directly within the <code>Note</code> component, but let’s instead create a component specifically for logged-in user interactions at <em>src/components/NoteUser.js</em>. In this React component we will perform a GraphQL query for the current user ID and provide a routable link to the edit page. With this information, we can begin by including our required libraries and setting up a new React component. Within the React component, we will include an edit link, which will route the user to the edit page for the note. For now, the user will see this link regardless of who owns the note.</p>&#13;
&#13;
<p>Update <em>src/components/NoteUser.js</em> as follows:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">Link</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react-router-dom'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NoteUser</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">to</code><code class="o">=</code><code class="p">{</code><code class="sb">`/edit/</code><code class="si">${</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">}</code><code class="o">&gt;</code><code class="nx">Edit</code><code class="o">&lt;</code><code class="err">/Link&gt;;</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NoteUser</code><code class="p">;</code></pre>&#13;
&#13;
<p>Next, we will update our <code>Note</code> component to perform a local <a data-primary="isLoggedIn state query" data-type="indexterm" id="idm45339489017192"/><code>isLoggedIn</code> state query. We can then conditionally render our <code>NoteUser</code> component based on the logged-in state of the user.</p>&#13;
&#13;
<p>Let’s first import the GraphQL libraries to perform the query along with our <code>NoteUser</code> component. In <em>src/components/Note.js</em>, add the following at the top of the file:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// import logged in user UI components</code>&#13;
<code class="kr">import</code> <code class="nx">NoteUser</code> <code class="nx">from</code> <code class="s1">'./NoteUser'</code><code class="p">;</code>&#13;
<code class="c1">// import the IS_LOGGED_IN local query</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">IS_LOGGED_IN</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now, we can update our JSX component to check the logged-in state. If the user is logged in, we’ll display the <code>NoteUser</code> component; otherwise, we’ll display the favorite count.</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">const</code> <code class="nx">Note</code> <code class="o">=</code> <code class="p">({</code> <code class="nx">note</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">data</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">IS_LOGGED_IN</code><code class="p">);</code>&#13;
  <code class="c1">// if the data is loading, display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!&lt;</code><code class="err">/p&gt;;</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">StyledNote</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">MetaData</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">MetaInfo</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">img</code>&#13;
            <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">avatar</code><code class="p">}</code>&#13;
            <code class="nx">alt</code><code class="o">=</code><code class="p">{</code><code class="sb">`</code><code class="si">${</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">username</code><code class="si">}</code><code class="sb"> avatar`</code><code class="p">}</code>&#13;
            <code class="nx">height</code><code class="o">=</code><code class="s2">"50px"</code>&#13;
          <code class="o">/&gt;</code>&#13;
        <code class="o">&lt;</code><code class="err">/MetaInfo&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">MetaInfo</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">em</code><code class="o">&gt;</code><code class="nx">by</code><code class="o">&lt;</code><code class="sr">/em&gt; {note.author.username} &lt;br /</code><code class="o">&gt;</code>&#13;
          <code class="p">{</code><code class="nx">format</code><code class="p">(</code><code class="nx">note</code><code class="p">.</code><code class="nx">createdAt</code><code class="p">,</code> <code class="s1">'MMM Do YYYY'</code><code class="p">)}</code>&#13;
        <code class="o">&lt;</code><code class="err">/MetaInfo&gt;</code>&#13;
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">isLoggedIn</code> <code class="o">?</code> <code class="p">(</code>&#13;
          <code class="o">&lt;</code><code class="nx">UserActions</code><code class="o">&gt;</code>&#13;
            <code class="o">&lt;</code><code class="nx">NoteUser</code> <code class="nx">note</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
          <code class="o">&lt;</code><code class="err">/UserActions&gt;</code>&#13;
        <code class="p">)</code> <code class="o">:</code> <code class="p">(</code>&#13;
          <code class="o">&lt;</code><code class="nx">UserActions</code><code class="o">&gt;</code>&#13;
            <code class="o">&lt;</code><code class="nx">em</code><code class="o">&gt;</code><code class="nx">Favorites</code><code class="o">:&lt;</code><code class="err">/em&gt; {note.favoriteCount}</code>&#13;
          <code class="o">&lt;</code><code class="err">/UserActions&gt;</code>&#13;
        <code class="p">)}</code>&#13;
      <code class="o">&lt;</code><code class="err">/MetaData&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">ReactMarkdown</code> <code class="nx">source</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">content</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/StyledNote&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code></pre>&#13;
<div data-type="note" epub:type="note"><h1>Unauthenticated Edits</h1>&#13;
<p>Though we will be hiding the edit link in the UI, users could still navigate to a note’s edit screen without being the note owner. Thankfully, our GraphQL API is designed to prevent anyone but the note owner from editing the note’s content. Though we won’t be doing it in this book, a good additional step would be to update the <em>src/pages/edit.js</em> component to redirect a user if they are not the note owner.</p>&#13;
</div>&#13;
&#13;
<p>With this change, logged-in users are able to see an edit link at the top of each note. Clicking the link will navigate to an edit form, regardless of who is the owner of the note. Let’s address this by updating our <code>NoteUser</code> component to query for the current user’s ID and display the edit link only if it matches the ID of the note author.</p>&#13;
&#13;
<p>First in <em>src/components/NoteUser.js</em>, add the following:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">Link</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react-router-dom'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// import our GET_ME query</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_ME</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NoteUser</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">data</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_ME</code><code class="p">);</code>&#13;
  <code class="c1">// if the data is loading, display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
      <code class="nx">Favorites</code><code class="o">:</code> <code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">favoriteCount</code><code class="p">}</code>&#13;
      <code class="o">&lt;</code><code class="nx">br</code> <code class="o">/&gt;</code>&#13;
      <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code> <code class="o">&amp;&amp;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">to</code><code class="o">=</code><code class="p">{</code><code class="sb">`/edit/</code><code class="si">${</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">}</code><code class="o">&gt;</code><code class="nx">Edit</code><code class="o">&lt;</code><code class="err">/Link&gt;</code>&#13;
        <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
      <code class="p">)}</code>&#13;
    <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NoteUser</code><code class="p">;</code></pre>&#13;
&#13;
<p>With this change, only the note’s original author will see the edit link in the UI (<a data-type="xref" href="#web-edit-link">Figure 16-2</a>).<a data-startref="ix_ch16-asciidoc6" data-type="indexterm" id="idm45339488648632"/><a data-startref="ix_ch16-asciidoc5" data-type="indexterm" id="idm45339488647992"/></p>&#13;
&#13;
<figure><div class="figure" id="web-edit-link">&#13;
<img alt="A screenshot of the edit link" src="assets/jsev_1602.png"/>&#13;
<h6><span class="label">Figure 16-2. </span>Only the note’s author will see the edit link</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deleting Notes" data-type="sect1"><div class="sect1" id="idm45339489839528">&#13;
<h1>Deleting Notes</h1>&#13;
&#13;
<p><a data-primary="CRUD operations" data-secondary="deleting notes" data-type="indexterm" id="idm45339488434040"/><a data-primary="deleteNote mutation" data-type="indexterm" id="idm45339488433064"/>Our CRUD application is still missing the ability to delete a note. We can write a button UI component that, when clicked, will perform a GraphQL mutation, deleting the note. Let’s start by creating a new component at <em>src/components/DeleteNote.js</em>. Since we will be performing a redirect within a nonroutable component, we will use React Router’s <code>withRouter</code> higher-order component:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useMutation</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">withRouter</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react-router-dom'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">ButtonAsLink</code> <code class="nx">from</code> <code class="s1">'./ButtonAsLink'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">DeleteNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">ButtonAsLink</code><code class="o">&gt;</code><code class="nx">Delete</code> <code class="nx">Note</code><code class="o">&lt;</code><code class="err">/ButtonAsLink&gt;;</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">withRouter</code><code class="p">(</code><code class="nx">DeleteNote</code><code class="p">);</code></pre>&#13;
&#13;
<p>Now, we can write our mutation. Our GraphQL API has a <code>deleteNote</code> mutation, which returns a boolean of <code>true</code> if the note is deleted. When the mutation completes, we’ll redirect the user to the <em>/mynotes</em> page of our application.</p>&#13;
&#13;
<p>First, in <em>src/gql/mutation.js</em>, write the mutation as follows:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">const</code> <code class="nx">DELETE_NOTE</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  mutation deleteNote($id: ID!) {</code>&#13;
<code class="sb">    deleteNote(id: $id)</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// update to include DELETE_NOTE</code>&#13;
<code class="kr">export</code> <code class="p">{</code> <code class="nx">EDIT_NOTE</code><code class="p">,</code> <code class="nx">DELETE_NOTE</code> <code class="p">};</code></pre>&#13;
&#13;
<p>Now in <em>src/components/DeleteNote</em>, add the following:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useMutation</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">withRouter</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react-router-dom'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">ButtonAsLink</code> <code class="nx">from</code> <code class="s1">'./ButtonAsLink'</code><code class="p">;</code>&#13;
<code class="c1">// import the DELETE_NOTE mutation</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">DELETE_NOTE</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/mutation'</code><code class="p">;</code>&#13;
<code class="c1">// import queries to refetch after note deletion</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_MY_NOTES</code><code class="p">,</code> <code class="nx">GET_NOTES</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">DeleteNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">deleteNote</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useMutation</code><code class="p">(</code><code class="nx">DELETE_NOTE</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">variables</code><code class="o">:</code> <code class="p">{</code>&#13;
      <code class="nx">id</code><code class="o">:</code> <code class="nx">props</code><code class="p">.</code><code class="nx">noteId</code>&#13;
    <code class="p">},</code>&#13;
    <code class="c1">// refetch the note list queries to update the cache</code>&#13;
    <code class="nx">refetchQueries</code><code class="o">:</code> <code class="p">[{</code> <code class="nx">query</code><code class="o">:</code> <code class="nx">GET_MY_NOTES</code><code class="p">,</code> <code class="nx">GET_NOTES</code> <code class="p">}],</code>&#13;
    <code class="nx">onCompleted</code><code class="o">:</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="c1">// redirect the user to the "my notes" page</code>&#13;
      <code class="nx">props</code><code class="p">.</code><code class="nx">history</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="s1">'/mynotes'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">ButtonAsLink</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="nx">deleteNote</code><code class="p">}</code><code class="o">&gt;</code><code class="nx">Delete</code> <code class="nx">Note</code><code class="o">&lt;</code><code class="err">/ButtonAsLink&gt;;</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">withRouter</code><code class="p">(</code><code class="nx">DeleteNote</code><code class="p">);</code></pre>&#13;
&#13;
<p>Now, we can import the new <code>DeleteNote</code> component within our <em>src/components/NoteUser.js</em> file, displaying it only to a note’s author:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">Link</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react-router-dom'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_ME</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code>&#13;
<code class="c1">// import the DeleteNote component</code>&#13;
<code class="kr">import</code> <code class="nx">DeleteNote</code> <code class="nx">from</code> <code class="s1">'./DeleteNote'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NoteUser</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">data</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_ME</code><code class="p">);</code>&#13;
  <code class="c1">// if the data is loading, display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!&lt;</code><code class="err">/p&gt;;</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
      <code class="nx">Favorites</code><code class="o">:</code> <code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">favoriteCount</code><code class="p">}</code> <code class="o">&lt;</code><code class="nx">br</code> <code class="o">/&gt;</code>&#13;
      <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code> <code class="o">&amp;&amp;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">to</code><code class="o">=</code><code class="p">{</code><code class="sb">`/edit/</code><code class="si">${</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">}</code><code class="o">&gt;</code><code class="nx">Edit</code><code class="o">&lt;</code><code class="sr">/Link&gt; &lt;br /</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">DeleteNote</code> <code class="nx">noteId</code><code class="o">=</code><code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
        <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
      <code class="p">)}</code>&#13;
    <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NoteUser</code><code class="p">;</code></pre>&#13;
&#13;
<p>With this mutation written, logged-in users are now able to delete a note with the click of a button.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Toggling Favorites" data-type="sect1"><div class="sect1" id="idm45339488434568">&#13;
<h1>Toggling Favorites</h1>&#13;
&#13;
<p><a data-primary="CRUD operations" data-secondary="toggling favorites" data-type="indexterm" id="ix_ch16-asciidoc7"/><a data-primary="toggleFavorite" data-type="indexterm" id="ix_ch16-asciidoc8"/>The last piece of user functionality missing from our application is the ability to add and remove “favorite” notes. Let’s follow our pattern of creating a component for this feature and integrating it into our application. First, create a new component at <em>src/components/FavoriteNote.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useState</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useMutation</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">ButtonAsLink</code> <code class="nx">from</code> <code class="s1">'./ButtonAsLink'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">FavoriteNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">ButtonAsLink</code><code class="o">&gt;</code><code class="nx">Add</code> <code class="nx">to</code> <code class="nx">favorites</code><code class="o">&lt;</code><code class="err">/ButtonAsLink&gt;;</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">FavoriteNote</code><code class="p">;</code></pre>&#13;
&#13;
<p>Before we add any functionality, let’s go ahead and incorporate this component into our <em>src/components/NoteUser.js</em> component. First, import the component:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">FavoriteNote</code> <code class="nx">from</code> <code class="s1">'./FavoriteNote'</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now, within our JSX, include a reference to the component. You may recall that when we wrote our <code>GET_ME</code> query, we included a list of favorited note IDs, which we’ll make use of here:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="k">return</code> <code class="p">(</code>&#13;
  <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">FavoriteNote</code>&#13;
      <code class="nx">me</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">me</code><code class="p">}</code>&#13;
      <code class="nx">noteId</code><code class="o">=</code><code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code>&#13;
      <code class="nx">favoriteCount</code><code class="o">=</code><code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">favoriteCount</code><code class="p">}</code>&#13;
    <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">br</code> <code class="o">/&gt;</code>&#13;
    <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">id</code> <code class="o">&amp;&amp;</code> <code class="p">(</code>&#13;
      <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">to</code><code class="o">=</code><code class="p">{</code><code class="sb">`/edit/</code><code class="si">${</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">}</code><code class="o">&gt;</code><code class="nx">Edit</code><code class="o">&lt;</code><code class="sr">/Link&gt; &lt;br /</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">DeleteNote</code> <code class="nx">noteId</code><code class="o">=</code><code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
    <code class="p">)}</code>&#13;
  <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
<code class="p">);</code></pre>&#13;
&#13;
<p>You’ll notice that we’re passing three properties to our <code>FavoriteNote</code> component. First is our <code>me</code> data, which will include the current user’s ID as well as a list of notes favorited by that user. Second, the <code>noteID</code> of the current note. And finally is the <code>favoriteCount</code>, which is the current total number of user favorites.</p>&#13;
&#13;
<p>Now we can return to our <em>src/components/FavoriteNote.js</em> file. In this file, we’ll store the current number of favorites as state and check to see if the current note ID is in the existing list of user favorites. We’ll change the text that the user sees based on the state of the user’s favorite. When the user clicks the button, it will call our <code>toggleFavorite</code> mutation, which will either add or remove the favorite from the user’s list. Let’s begin by updating the component to use state to control the click functionality.</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">const</code> <code class="nx">FavoriteNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// store the note's favorite count as state</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">count</code><code class="p">,</code> <code class="nx">setCount</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">props</code><code class="p">.</code><code class="nx">favoriteCount</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// store if the user has favorited the note as state</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">favorited</code><code class="p">,</code> <code class="nx">setFavorited</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code>&#13;
    <code class="c1">// check if the note exists in the user favorites list</code>&#13;
    <code class="nx">props</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">favorites</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="nx">note</code> <code class="o">=&gt;</code> <code class="nx">note</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">props</code><code class="p">.</code><code class="nx">noteId</code><code class="p">).</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="nx">favorited</code> <code class="o">?</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">ButtonAsLink</code>&#13;
          <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
            <code class="nx">setFavorited</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>&#13;
            <code class="nx">setCount</code><code class="p">(</code><code class="nx">count</code> <code class="o">-</code> <code class="mi">1</code><code class="p">);</code>&#13;
          <code class="p">}}</code>&#13;
        <code class="o">&gt;</code>&#13;
          <code class="nx">Remove</code> <code class="nx">Favorite</code>&#13;
        <code class="o">&lt;</code><code class="err">/ButtonAsLink&gt;</code>&#13;
      <code class="p">)</code> <code class="o">:</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">ButtonAsLink</code>&#13;
          <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
            <code class="nx">setFavorited</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>&#13;
            <code class="nx">setCount</code><code class="p">(</code><code class="nx">count</code> <code class="o">+</code> <code class="mi">1</code><code class="p">);</code>&#13;
          <code class="p">}}</code>&#13;
        <code class="o">&gt;</code>&#13;
          <code class="nx">Add</code> <code class="nx">Favorite</code>&#13;
        <code class="o">&lt;</code><code class="err">/ButtonAsLink&gt;</code>&#13;
      <code class="p">)}</code>&#13;
      <code class="o">:</code> <code class="p">{</code><code class="nx">count</code><code class="p">}</code>&#13;
    <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>With the preceding changes we’re updating the state when a user clicks, but we’re not yet calling our GraphQL mutation. Let’s complete this component by writing the mutation and adding it to the component. The result is shown in <a data-type="xref" href="#user_actions_final">Figure 16-3</a>.<a data-startref="ix_ch16-asciidoc8" data-type="indexterm" id="idm45339487655240"/><a data-startref="ix_ch16-asciidoc7" data-type="indexterm" id="idm45339487654600"/></p>&#13;
&#13;
<p>In <em>src/gql/mutation.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// add the TOGGLE_FAVORITE mutation</code>&#13;
<code class="kr">const</code> <code class="nx">TOGGLE_FAVORITE</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  mutation toggleFavorite($id: ID!) {</code>&#13;
<code class="sb">    toggleFavorite(id: $id) {</code>&#13;
<code class="sb">      id</code>&#13;
<code class="sb">      favoriteCount</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// update to include TOGGLE_FAVORITE</code>&#13;
<code class="kr">export</code> <code class="p">{</code> <code class="nx">EDIT_NOTE</code><code class="p">,</code> <code class="nx">DELETE_NOTE</code><code class="p">,</code> <code class="nx">TOGGLE_FAVORITE</code> <code class="p">};</code></pre>&#13;
&#13;
<p>In <em>src/components/FavoriteNote.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useState</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useMutation</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">ButtonAsLink</code> <code class="nx">from</code> <code class="s1">'./ButtonAsLink'</code><code class="p">;</code>&#13;
<code class="c1">// the TOGGLE_FAVORITE mutation</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">TOGGLE_FAVORITE</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/mutation'</code><code class="p">;</code>&#13;
<code class="c1">// add the GET_MY_FAVORITES query to refetch</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">GET_MY_FAVORITES</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../gql/query'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">FavoriteNote</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// store the note's favorite count as state</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">count</code><code class="p">,</code> <code class="nx">setCount</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">props</code><code class="p">.</code><code class="nx">favoriteCount</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// store if the user has favorited the note as state</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">favorited</code><code class="p">,</code> <code class="nx">setFavorited</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code>&#13;
    <code class="c1">// check if the note exists in the user favorites list</code>&#13;
    <code class="nx">props</code><code class="p">.</code><code class="nx">me</code><code class="p">.</code><code class="nx">favorites</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="nx">note</code> <code class="o">=&gt;</code> <code class="nx">note</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">props</code><code class="p">.</code><code class="nx">noteId</code><code class="p">).</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="c1">// toggleFavorite mutation hook</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">toggleFavorite</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useMutation</code><code class="p">(</code><code class="nx">TOGGLE_FAVORITE</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">variables</code><code class="o">:</code> <code class="p">{</code>&#13;
      <code class="nx">id</code><code class="o">:</code> <code class="nx">props</code><code class="p">.</code><code class="nx">noteId</code>&#13;
    <code class="p">},</code>&#13;
    <code class="c1">// refetch the GET_MY_FAVORITES query to update the cache</code>&#13;
    <code class="nx">refetchQueries</code><code class="o">:</code> <code class="p">[{</code> <code class="nx">query</code><code class="o">:</code> <code class="nx">GET_MY_FAVORITES</code> <code class="p">}]</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// if the user has favorited the note, display the option to remove the favorite</code>&#13;
  <code class="c1">// else, display the option to add as a favorite</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="nx">favorited</code> <code class="o">?</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">ButtonAsLink</code>&#13;
          <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
            <code class="nx">toggleFavorite</code><code class="p">();</code>&#13;
            <code class="nx">setFavorited</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>&#13;
            <code class="nx">setCount</code><code class="p">(</code><code class="nx">count</code> <code class="o">-</code> <code class="mi">1</code><code class="p">);</code>&#13;
          <code class="p">}}</code>&#13;
        <code class="o">&gt;</code>&#13;
          <code class="nx">Remove</code> <code class="nx">Favorite</code>&#13;
        <code class="o">&lt;</code><code class="err">/ButtonAsLink&gt;</code>&#13;
      <code class="p">)</code> <code class="o">:</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">ButtonAsLink</code>&#13;
          <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
            <code class="nx">toggleFavorite</code><code class="p">();</code>&#13;
            <code class="nx">setFavorited</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>&#13;
            <code class="nx">setCount</code><code class="p">(</code><code class="nx">count</code> <code class="o">+</code> <code class="mi">1</code><code class="p">);</code>&#13;
          <code class="p">}}</code>&#13;
        <code class="o">&gt;</code>&#13;
          <code class="nx">Add</code> <code class="nx">Favorite</code>&#13;
        <code class="o">&lt;</code><code class="err">/ButtonAsLink&gt;</code>&#13;
      <code class="p">)}</code>&#13;
      <code class="o">:</code> <code class="p">{</code><code class="nx">count</code><code class="p">}</code>&#13;
    <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">FavoriteNote</code><code class="p">;</code></pre>&#13;
&#13;
<figure><div class="figure" id="user_actions_final">&#13;
<img alt="A screenshot of the application with links to create, update, read, and delete a note." src="assets/jsev_1603.png"/>&#13;
<h6><span class="label">Figure 16-3. </span>A logged-in user will be able to create, read, update, and delete notes</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Conclusion" data-type="sect1"><div class="sect1" id="idm45339488138616">&#13;
<h1>Conclusion</h1>&#13;
&#13;
<p>In this chapter we’ve turned our site into a fully functioning CRUD (create, read, update, delete) application. We are now able to implement GraphQL queries and mutations based on the state of a signed-in user. The ability to build user interfaces that integrate CRUD user interactions will provide a solid foundation for building all sorts of web applications. With this functionality, we’ve completed the MVP (minimum viable product) of our app. In the next chapter, we’ll deploy the application to a web server.<a data-startref="ix_ch16-asciidoc0" data-type="indexterm" id="idm45339487519704"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>