# 第五章。迁移到 Kubernetes

在当今世界，消费者和企业客户都要求更快的速度。复杂的现代应用程序在个性化、人工智能和各个行业的欺诈检测等领域必须更快地提供更好的结果。集中管理和人工操作的应用程序对苦苦挣扎的 IT 团队构成负担，并且提供回报逐渐减少；传统应用架构无法跟上当今巨大的数据量、全球部署需求以及对水平扩展的需求。

PaaS 和 SaaS 是在面对不可预测需求时效果最佳的范式。与传统的单体式本地应用程序不同，PaaS 和 SaaS 必须进行水平扩展，在需要时立即添加物理或虚拟资源。由于在本地添加物理服务器通常是一个缓慢且时间长的过程，这意味着现代应用程序必须能够在任何地方运行：在本地环境、云环境或二者组合的混合环境中。

出现的答案是将应用程序分解为在容器中运行的微服务。这引入了超出 IT 团队手动管理能力的复杂性，需要自动化管理、配置、负载平衡和故障解决。这些需求本质上构成了 Kubernetes 的功能列表。Kubernetes 是一个平台，能够在各种环境中编排容器集合，使得构建基于云原生、微服务的应用程序并在任何地方运行成为可能。因此，Kubernetes 已成为企业大规模部署应用程序的主要方式。

即使 DevOps 团队拥有运行生产 Kubernetes 集群所需的所有技能，数据存储仍然具有挑战性。每个应用程序和服务都有自己的存储需求、元数据以及处理状态的方式。每种数据都有其围绕安全性、可扩展性、合规性和可用性的要求。如果这还不够，企业所需的应用程序和数据类型数量庞大，意味着复杂性呈指数级增加。

# Kubernetes 采用的挑战

很少有企业是从头开始的。典型的企业运行大量最初设计为在物理服务器或虚拟机上运行的遗留应用程序。尽管云原生、容器化应用程序是明确的前进路径，但立即放弃支持组织运行的所有遗留应用程序并不现实。

采用 Kubernetes 意味着投资于云原生、容器化应用程序，同时支持更传统的应用程序架构。为两种软件提供单独的存储既因操作成本高昂又因其减慢数据处理速度而不切实际。有两种方法可以帮助解决问题：在 VM 内部运行容器，或在容器内部运行 VM。后一种方法的优势在于允许 Kubernetes 管理传统应用程序运行的 VM，并根据需要移动它们。

对于每个组织来说，持久存储在数据量增长时至关重要。企业需要无缝管理大量数据，且在数据安全性、高可用性和灾难恢复方面具有严格的需求。数据必须在多个位置可用，并且在地理上可控以符合合规要求，并具有高性能。最初设计为无状态进程的 Kubernetes 并不是企业公司数据需求的本能适配器。

要在规模上运行应用程序，企业需要 Kubernetes。但要在规模上运行 Kubernetes，公司还需要制定策略，提供一个与计算容器解耦的底层存储层，以支持复杂的大规模业务应用程序的需求。

# 在 Kubernetes 上运行大规模系统

在规模化运行 Kubernetes 的关键在于能够根据需求优化资源分配，根据需要自动缩放资源和服务。虽然 Kubernetes 允许您声明式地自动化集群管理和计算资源，但仍然需要额外的工具来有效管理存储。

一个重要因素是确保存储被适当地分配并且不被浪费。因为块存储最初并不是为大量容器使用而设计的，所以在 Kubernetes 中实现资源效率可能具有挑战性。开箱即用，Kubernetes 每个主机提供的卷数量有限，并且不提供广泛的工具来实现故障转移、备份和灾难恢复等功能。这经常导致块存储的过度配置，通常是两到三倍，并导致应用程序效率降低。

在公共云上，供应商通常限制单个虚拟机可以附加的块设备数量，从而导致另一种过度配置。如果虚拟机的计算能力足以为更多容器提供服务，超出了供应商允许的限制，那么在某些时候就必须为存储预留额外的虚拟机。这会增加计算成本并增加管理开销。

在管理大规模存储资源时，数据可移植性变得更加重要。为了最大化运营存储效率，必须能够将工作负载移动到成本最低的存储中。这意味着企业必须能够在环境之间、提供商之间或从一个团队到另一个团队之间敏捷地移动数据和应用程序。超融合拓扑结构可以帮助降低成本和复杂性，使扩展变得更加容易。

软件定义存储将所有可用存储抽象为单一池，是在大规模高效运行 Kubernetes 中的一个重要组成部分，因为它可以支持传统应用程序和容器化工作负载。您仍然需要就底层计算和存储硬件做出决策。仅仅运行计算和存储平台需要每个节点的最低资源集。在此基础上，您必须做出有关每个节点应具备多少工作能力的决策，例如：

+   每个节点将运行多少个应用程序

+   每个节点将支持多少个容器

+   每个容器获得多少 CPU

对于相同总集群工作负载，您必须决定是运行少量更强大的节点还是更多数量的性能较弱的节点。

云和混合环境使得这些问题更容易解决，因为它们允许您从小规模开始，并根据需要提供更多的计算和存储资源。无法预料每种可能应用程序和工作负载的需求。无法为每个人都适用的集群进行规划。通过仅提供所需的内容并随着业务增长进行扩展，您可以持续地调整规模化的 Kubernetes 以满足企业的需求。

Kubernetes 在生产环境中最耗时且破坏性最大的一个方面是存储容量管理。在高度动态的环境中，存储需求可能非常不稳定，使得没有复杂工具和自动化几乎无法管理存储。正确的存储管理解决方案可以帮助您智能地配置存储，避免浪费，同时根据需求进行扩展。

最终，大规模运行 Kubernetes 部署的目标是为企业应用提供服务，包括 PaaS 和 SaaS。这些部署必须满足数据安全性、可移植性、合规性、本地性和可用性等需求。没有帮助，Kubernetes 无法满足这些业务关键需求。为了满足市场数据需求，您需要一个协调的存储层，可以管理容器卷的可靠性和性能，提供高可用性、复制、存储分层、灾难恢复、备份以及现代企业应用所需的其他功能。
