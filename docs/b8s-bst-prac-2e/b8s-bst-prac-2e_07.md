# 第七章。全球应用分发与分级

到目前为止，本书中我们已经看到了许多不同的实践方法，用于构建、开发和部署应用程序，但是在部署和管理具有全球影响力的应用程序时，会出现一整套不同的考虑因素。

应用程序可能需要扩展到全球部署的原因有很多。第一个也是最明显的原因就是规模。您的应用程序可能非常成功或者具有使命关键性，因此需要全球部署以提供用户所需的容量。此类应用程序的示例包括公共云提供商的全球 API 网关、具有全球足迹的大规模物联网产品、非常成功的社交网络等。

尽管我们中相对较少的人会构建需要全球规模的系统，但更多的应用程序需要全球足迹来减少延迟。即使使用容器和 Kubernetes，也无法摆脱光速。为了最小化客户端与我们应用程序之间的延迟，有时需要将我们的应用程序分布到世界各地，以尽量减少应用程序与其用户之间的物理距离。

最后，全球分布的更常见原因是地理位置的需求。出于带宽（例如，远程感知平台）或数据隐私（例如，地理限制）的原因，有时需要在特定位置部署应用程序，以使应用程序的部署或成功成为可能。随着越来越多的国家和地区实施数据隐私和主权法律法规，将您的应用程序部署在特定位置以服务于居住在该地区的用户正在成为一种常见的商业必要性。

在所有这些情况下，您的应用程序不再仅仅存在于少数几个生产集群中。相反，它分布在数十到数百个不同的地理位置。管理这些位置以及推出一个全球可靠的服务的需求是一个重大挑战。本章涵盖了成功实现这一目标的方法和实践。

# 分发您的镜像

在你考虑将你的应用程序在全球范围内运行之前，你需要确保这个镜像可以在全球各地的集群中使用。首先要考虑的是你的镜像仓库是否支持自动地理复制。许多由云提供商提供的镜像仓库会自动将你的镜像分发到全球，并将请求定位到离拉取镜像的集群最近的存储位置。许多云平台允许你决定在哪些地方复制镜像；例如，你可能知道某些你不会出现的地方。一个例子是[Microsoft Azure 容器注册表](https://oreil.ly/4jWNh)，但其他提供类似服务的也有很多。如果你使用支持地理复制的云提供的注册表，将你的镜像分发到全球就变得很简单。你只需将镜像推送到注册表，选择地理复制的区域，剩下的就由注册表来处理了。

如果你没有使用云注册表，或者你的提供商不支持镜像的自动地理分发，你就需要自己解决这个问题。一个选项是使用位于特定位置的注册表。对这种方法有几个担忧。镜像拉取延迟通常决定了你在集群中启动容器的速度。这反过来可以决定在机器故障时你能多快地做出响应，考虑到通常情况下，在机器故障时你需要将容器镜像下载到新机器上。

关于单一注册表的另一个问题是它可能是单点故障。如果注册表位于单一区域或单一数据中心，那么在该数据中心发生大规模事故时，注册表可能会下线。如果你的注册表下线了，你的 CI/CD 管道将停止工作，你将无法部署新的代码。这显然会对开发者的生产力和应用程序的运行产生重大影响。此外，单一注册表可能会更加昂贵，因为每次启动新容器时都会使用大量带宽，尽管容器镜像通常很小，但带宽消耗会累积。尽管存在这些负面因素，对于只在少数全球区域运行的小规模应用程序来说，单一注册表解决方案可能是合适的答案。它确实比全面复制镜像更容易设置。

如果您无法使用云提供的地理复制，并且需要复制您的镜像，您就需要自行制定镜像复制的解决方案。要实施这样的服务，您有两个选择。第一个选择是为每个镜像注册表使用地理名称（例如，`us.my-registry.io`，`eu.my-registry.io`等）。这种方法的优点是设置和管理简单。每个注册表都是完全独立的，您可以在 CI/CD 流程结束时简单地推送到所有注册表。缺点是每个集群将需要稍微不同的配置来从最近的地理位置拉取镜像。然而，鉴于您的应用配置可能会在地理上存在差异，这种缺点相对容易管理，并且可能已经存在于您的环境中。

第二个选项是使用网络配置将您的镜像拉取连接到特定的仓库。在这种方法中，您仍然将镜像推送到多个注册表，但不是为每个注册表提供唯一的名称，而是为它们都提供一个单一的 DNS 终端点（例如，`my-registry.io`）。您可以使用地理感知 DNS（GeoDNS），它会对来自不同地理区域的 DNS 请求响应不同的 IP 地址，或者如果您拥有正确的网络基础设施，可以使用组播 IP 地址。在组播中，所有的注册表共享相同的 IP 地址，但会在多个物理位置向互联网广播，依靠最短路径网络路由将流量发送到提供最近镜像注册表的服务器。这两种网络配置都很难正确实施。最佳答案无疑是使用基于云的注册表，即使您是在本地服务器上进行拉取。如果您确实想要运行自己的注册表（并承担相应的运营负担），我们强烈建议您使用前一段讨论过的区域服务器方法，除非您已经具备复制服务的网络经验。接下来的部分将描述如何对您的部署进行参数化，例如在不同区域使用不同的注册表。

# 参数化您的部署

当您在所有地方复制了您的镜像后，您需要对不同的全球位置进行部署参数化。每当您部署到各种不同的地区时，这些地区的应用配置都可能有所不同。例如，如果您没有地理复制的注册表，您可能需要为不同的区域调整镜像名称。然而，即使您有地理复制的镜像，不同的地理位置可能会对您的应用产生不同的负载，因此大小（例如副本数）以及其他配置可能会在区域之间有所不同。以一种不会增加过多负担的方式管理这种复杂性，是成功管理全球应用的关键。

首先要考虑的是如何在磁盘上组织不同的配置。一种常见的实现方法是为每个全局区域使用不同的目录。在这些目录中，也许会诱惑你简单地将相同的配置复制到每个目录中，但这样做肯定会导致配置之间的漂移和变化，某些区域被修改而其他区域被遗忘。相反，采用基于模板的方法，使大部分配置保留在一个单一模板中，该模板被所有区域共享，然后将参数应用于该模板以生成特定于区域的模板。[Helm](https://helm.sh) 是用于这种模板化的常用工具（详细信息请参见第一章）。

# 在全球范围内负载均衡流量

现在，您的应用程序已经在全球运行，下一步是确定如何将流量引导到该应用程序。通常情况下，您希望利用地理位置的近距离来确保对服务的低延迟访问。但您还希望在发生故障或任何其他服务故障源的情况下，在地理区域之间进行故障切换。正确设置流量平衡到各个区域部署是建立高性能和可靠系统的关键。

让我们从假设您有一个要用于服务的单个主机名开始，例如*myapp.myco.com*。您需要做出的第一个决定是是否要使用域名系统（DNS）协议来实现负载均衡跨您的区域终端点。如果您使用 DNS 进行负载平衡，当用户对*myapp.myco.com*进行 DNS 查询时返回的 IP 地址基于用户访问服务的位置以及您服务的当前可用性。另一种选择是多播 IP 地址，其中相同的 IP 地址从互联网上的多个位置进行广告。当用户查找*myapp.myco.com*时，DNS 始终返回这个固定 IP 地址，但实际数据包的路由因连接在网络中的位置而异。

# 在全球范围内可靠地推出软件

当你将应用程序模板化，为每个区域准备适当的配置后，下一个重要问题是如何在全球范围内部署这些配置。可能会有诱惑，同时在全球范围内部署你的应用程序，以便你可以高效快速地迭代应用程序，但这种做法虽然敏捷，却很容易导致全球性故障。你在世界范围内意外推出的任何错误都会立即影响到所有地区的所有用户。相比之下，对于大多数生产应用程序而言，更为谨慎的全球软件推出策略更为合适。当结合全球负载均衡等因素时，这些方法可以在面对重大应用程序故障时保持高可用性。

###### 提示

总的来说，在处理全球推出的问题时，目标是尽快推出软件，同时迅速检测问题，最好是在影响到多个用户之前就能发现。

让我们假设在进行全球推出时，你的应用程序已经通过了基本功能和负载测试。在某个特定镜像（或镜像）被认证为全球推出之前，它应该经过足够的测试，你相信应用程序正在正确运行。重要的是要注意，这并不意味着你的应用程序确实正在正确运行。尽管测试可以发现许多问题，但在现实世界中，应用程序问题通常是在推出到生产流量时首次注意到的。这是因为生产流量的真实性质通常很难完美模拟。例如，你可能只测试英语输入，而在现实世界中，你会看到多种语言的输入。或者你的测试输入集可能对应用程序接收的真实世界数据不够全面。当然，每当你在生产环境中看到未经测试就发生的故障时，这是需要扩展和扩大你的测试的一个强烈指示。尽管如此，仍然有许多问题是在生产推出期间被捕捉到的。

当你考虑到这一点时，你每次推出新的区域都是发现新问题的机会。而且由于该区域是生产区域，它也是一个潜在的故障停机，你需要对此做出反应。这些因素共同为你如何应对区域性推出奠定了基础。

###### 注

在本讨论中，我们谈论的是将软件推广到一个地理区域，但这种渐进式推广只是渐进式暴露控制的一种形式。推出功能的另一种方法是使用特征标志来进行渐进式暴露。使用特征标志时，新功能首先通过遵循接下来描述的地理推广的发布进行推广；然而，默认情况下，该功能的标志被设为“关闭”。一旦发布到所有地区，标志就会逐渐打开，例如，首先激活 10%的用户的功能，然后是 20%，依此类推，直到功能完全推出。有许多配置系统可用于进行基于标志的实验和渐进式推广。将标志与地理发布结合使用是发布新功能的一种非常稳定的方式，同时可以快速响应故障。

## 预发布验证

在您甚至考虑将软件的特定版本在全球范围内推广之前，非常重要的是在某种合成测试环境中验证该软件。如果您的持续交付流水线设置正确，特定发布构建之前的所有代码将经过某种形式的单元测试，可能还有有限的集成测试。然而，即使有这些测试，也很重要考虑发布之前的另外两种测试。第一种是完整的集成测试。这意味着您将整个堆栈组装成您应用程序的全面部署，但没有任何真实世界的流量。这个完整的堆栈通常会包括一个生产数据的副本或者在与您真实生产数据相同规模和尺度的模拟数据。如果在现实世界中，您的应用程序数据为 500 GB，那么在预生产测试中，您的数据集大致应该是相同的大小（甚至可能是确实相同的数据集）。

一般来说，建立完整的集成测试环境是一个重大挑战。通常，生产数据仅在生产环境中存在，生成相同规模和尺度的合成数据集非常困难。由于这种复杂性，设置一个真实的集成测试数据集是一个非常值得在应用程序开发早期就做的任务的绝佳示例。如果早期设置了数据集的合成副本，当数据集本身很小的时候，您的集成测试数据会与生产数据的增长速度保持一致。这通常比在已经达到规模时尝试复制生产数据要容易得多。

不幸的是，许多人直到已经处于大规模并且任务困难时才意识到他们需要数据的副本。在这种情况下，可能可以在您的生产数据存储前部署一个读写偏转层。显然，您不希望您的集成测试写入生产数据，但通常可以在您的生产数据存储前设置一个代理，从生产中读取但将写入存储在一个侧表中，后续读取时也会查询该侧表。

当然，如果您将生产数据用于测试和开发，非常重要的是要非常小心该数据的安全性。许多数据泄漏事件与开发人员意外地将他们的生产用户数据放置在不安全的位置有关。

无论您如何设置集成测试环境，目标都是相同的：验证在给定一系列测试输入和交互时，您的应用程序是否按预期行为。有多种方法来定义和执行这些测试——从最手动的方式，即测试工作表和人工操作（不建议，因为容易出错），到模拟浏览器和用户交互（例如点击等）的测试。在中间阶段是探测 RESTful API 的测试，但不一定测试构建在这些 API 之上的 Web UI。无论您如何定义集成测试，目标都应该是相同的：一个自动化测试套件，验证您的应用程序对完整一组真实世界输入的正确行为。对于简单的应用程序，可能可以在合并前进行此验证，但对于大多数大规模现实世界的应用程序，需要一个完整的集成环境。

集成测试将验证您的应用程序的正确操作，但您还应该对应用程序进行负载测试。证明应用程序的行为正确是一回事；证明它能够经受住真实世界的负载是另一回事。在任何相当高规模的系统中，例如请求延迟增加 20%这样的性能显著回退，对应用程序的用户体验有重大影响，并且除了让用户感到沮丧外，还可能导致应用程序完全失败。因此，确保在生产环境中不发生这种性能退化非常关键。

像集成测试一样，识别正确的应用程序负载测试方式可能是一个复杂的命题；毕竟，这需要您以合成和可重现的方式生成类似于生产流量的负载。其中一个最简单的方法就是简单地回放来自真实生产系统流量的日志。这样做可以是执行负载测试的一种很好的方式，因为其特性与应用程序在部署时将会经历的情况相匹配。然而，使用回放并非总是万无一失。例如，如果您的日志已经过时，而您的应用程序或数据集已发生变化，那么旧的回放日志上的性能可能与新鲜流量上的性能不同。此外，如果您有实际的依赖关系没有进行模拟，那么当发送到依赖关系时，旧的流量可能是无效的（例如，数据可能不再存在）。

就像生产数据一样，保护记录的任何真实请求的安全性至关重要。就像生产数据库一样，生产请求通常包含私人信息或安全凭据（或两者都有！），确保任何记录的安全性与实际用户请求同等重要。

因为与保存、保护和管理这些测试数据相关的挑战，许多系统，甚至是关键系统，在长时间内开发而没有进行负载测试。就像对生产数据建模一样，这是一个明显的例子，如果你早点开始，就会更容易维护。如果在应用程序只有少数依赖关系时建立负载测试，并在调整应用程序时改进和迭代负载测试，你将比试图在现有的大型应用程序上进行负载测试要容易得多。

假设您已经创建了一个负载测试，下一个问题是在负载测试应用程序时要关注的指标。显而易见的是每秒请求和请求延迟，因为这些显然是用户关注的指标。

在测量延迟时，重要的是要意识到这实际上是一个分布，并且您需要测量平均延迟以及异常百分位数（如第 90 和第 99 百分位数），因为它们代表了您应用程序的“最差”用户体验。如果只看平均值，则可能隐藏具有非常长延迟的问题，但如果有 10%的用户体验不佳，那么这可能会对您产品的成功产生显著影响。

另外，值得关注的是应用程序在负载测试下的资源使用情况（CPU、内存、网络、磁盘）。虽然这些指标并不直接影响用户体验，但你的应用程序资源使用发生较大变化时，应在预生产测试中识别并理解。如果你的应用程序突然消耗了两倍的内存，即使通过了负载测试，你也需要调查，因为这样显著的资源增长最终会影响应用程序的质量和可用性。根据情况，你可能会继续将发布推向生产，但同时，你需要理解为什么应用程序的资源占用量在变化。

## 金丝雀区域

当你的应用程序看起来运行正常时，第一步应该是一个*金丝雀区域*。金丝雀区域是一个接收来自希望验证你发布的真实流量的人和团队的部署。这些可以是依赖于你服务的内部团队，也可以是使用你服务的外部客户。金丝雀的存在是为了给团队一些关于即将推出的变化的早期警告。无论你的集成和负载测试有多好，总有可能有一些未被你的测试覆盖但对某些用户或客户至关重要的错误会漏过。在这种情况下，在每个人都知道失败可能性更高的空间中捕捉到这些问题要好得多。这就是金丝雀区域。

###### 注意

金丝雀也是你的团队或公司在生产之前进行*自我测试*或早期测试的好地方。一个很好的最佳实践是设置一个 HTTP 重定向器，使得公司内部的请求重定向到运行在金丝雀环境中的产品实例。这样你团队的每个人在发布进入外部用户之前都变成了端到端的测试人员。

金丝雀在监控、规模、功能等方面必须像生产区域一样对待。然而，由于它是发布过程中的第一站，它也是最有可能看到出现故障发布的位置。这没问题；事实上，这正是目的所在。你的客户将会有意使用金丝雀来进行低风险的用例（例如开发或内部用户），以便他们能够早期了解到你可能作为发布的一部分推出的任何破坏性变化。

因为金丝雀的目标是在发布后获得早期反馈，所以在金丝雀区域保留发布几天是个好主意。这样能让广泛的客户群体在您移动到其他区域之前就能访问它。这段时间是必要的，因为有时候 bug 是概率性的（例如，影响到 1% 的请求），或者它只在一个需要时间才能显现的边缘案例中出现。它甚至可能不严重到触发自动警报，但可能存在业务逻辑问题，只有通过客户互动才能看到。

## 辨识区域类型

当您开始考虑在全球范围内推广您的软件时，重要的是考虑不同区域的不同特征。在将软件推向生产区域后，您需要进行集成测试以及初始的金丝雀测试。这意味着您找到的任何后续问题将是在这两种设置中都没有显现的问题。思考一下您的不同区域。有些区域的流量比其他区域多吗？有些区域的访问方式不同吗？一个例子是，发展中国家的流量更可能来自移动 Web 浏览器。因此，与更多发展中国家地理上接近的区域可能比您的测试或金丝雀区域有更多的移动流量。

另一个例子可能是输入语言。世界非英语区域的区域可能会发送更多的 Unicode 字符，这可能在字符串或字符处理中显现出 bug。如果您正在构建一个基于 API 的服务，某些 API 在某些区域可能比其他区域更受欢迎。所有这些都是您的应用程序可能存在的差异的示例，这些差异可能与您的金丝雀流量不同。每个这些差异都是生产事故的可能来源。建立一个您认为重要的不同特征的表格。识别这些特征将帮助您规划全球推广。

## 构建全球推广

识别了您的各个区域的特征后，您希望制定一个向所有区域推出的计划。显然，您希望尽量减少生产中断的影响，因此一个很好的起始区域是一个看起来大部分像您的金丝雀区域并且用户流量较轻的区域。这样的区域几乎不太可能出现问题，但如果出现问题，影响也较小，因为该区域接收的流量较少。

在第一个生产区域成功推出后，你需要决定在转移到下一个区域之前等待多长时间。等待的原因不是为了人为延迟你的发布；相反，是为了等待足够长的时间以便发现问题。这个时间到问题发现的间隔是一个衡量标准，通常是在推出完成后多长时间内，你的监控看到问题的迹象。显然，如果一个推出包含问题，那么在推出完成的那一刻，问题就存在于你的基础设施中。但即使它存在，也可能需要一些时间才能显现。例如，内存泄漏可能需要一个小时或更长时间，才能在监控中清晰地看到泄漏内存的影响或影响用户。时间到问题发现的间隔是一个概率分布，指示你应该等待多长时间才能有很强的概率表明你的发布正在正确运行。一般来说，一个不错的经验法则是将过去问题显现的平均时间加倍。

如果在过去六个月中，每次故障平均需要一个小时才能出现，那么在区域推出之间等待两个小时可以让你有很大的概率成功。如果你想根据应用程序历史推导出更丰富（和更有意义）的统计数据，你可以更加准确地估计这个时间到问题发现的间隔。

在成功向类似金丝雀的低流量区域推出后，现在是时候向类似金丝雀的高流量区域推出了。这是一个输入数据看起来与你的金丝雀相似，但接收大量流量的区域。因为你已经成功向流量较低的类似区域推出，此时你所测试的唯一事情就是你的应用程序扩展的能力。如果你安全地执行了这次推出，你就可以对你的发布质量有很强的信心。

在向接收类似金丝雀数据的高流量区域推出后，你应该对其他潜在的流量差异遵循相同的模式。例如，接下来你可能会向亚洲或欧洲的低流量区域推出。此时，加速推出可能很诱人，但关键是只向代表任何输入或负载变化的单个区域推出。在你确信已经测试了应用程序生产输入的所有潜在变化后，你可以开始并行化发布以加快速度，并且有很强的信心它正在正确运行，你的推出可以成功完成。

# 当出现问题时

到目前为止，我们已经看到了设置软件系统全球发布的各个要素，并了解了如何构建这种发布方式以尽量减少出错的机会。但是，当确实出现问题时，你该怎么办呢？所有应急响应人员都知道，在危机的热情和恐慌中，你的大脑处于极度紧张状态，即使是最简单的流程也更难记住。加上这种压力，你知道一旦发生故障，公司中从 CEO 到基层的每个人都会急切地等待“一切清楚”的信号，你就能明白，犯错误是多么容易。此外，在这种情况下，一个简单的错误，比如在恢复过程中忘记某个步骤，或者推出一个“修复”版本实际上有更多问题，都会使糟糕的情况恶化十倍。

出于所有这些原因，当发布出现问题时，能够迅速、冷静和正确地响应是至关重要的。为了确保所有必要的事情都做到位，并按正确的顺序进行，有一个清晰的任务检查列表是值得的，按照执行顺序组织每个步骤的预期输出。记录下每一步，无论看起来多么显而易见。在紧要关头，即使是最显而易见和简单的步骤也可能被遗忘并意外地跳过。

急救人员确保在高压情况下作出正确响应的方式是在紧急情况之外练习这种响应。同样的练习也适用于你在处理发布问题时可能采取的所有活动。你首先要确定应对问题和执行回滚所需的所有步骤，并进行练习。理想情况下，首要响应是“止血”，将用户流量从受影响区域转移到尚未进行发布且系统正常运行的区域。这是你应该练习的第一件事情。你能成功地引导流量远离一个区域吗？需要多长时间？

第一次尝试使用基于 DNS 的流量负载均衡器来移动流量时，您会意识到我们的计算机如何缓存 DNS 条目，以及这需要多长时间。使用基于 DNS 的流量整形器完全消除某一区域的流量可能需要将近一天的时间。无论您第一次尝试排放流量的情况如何，都要做好记录。哪些方面运作良好？哪些方面运作不佳？根据这些数据，设定一个排放流量所需时间的目标，例如，在不到 10 分钟内排放掉 99%的流量。持续练习，直到达到这个目标。您可能需要进行架构更改才能实现这一目标。您可能需要添加自动化，以确保不再需要人工复制和粘贴命令。无论需要做出哪些变更，实践将确保您在应对事件时更为从容，并且您将了解到系统设计需要改进的地方。

对您可能在系统上采取的每个操作都应采用相同的实践。实践全面的数据恢复。实践将您的系统全球回滚到以前的版本。设定时间目标。记录任何可能犯的错误，并添加验证和自动化来消除错误的可能性。在实践中达到您的事件反应目标将使您确信，在真实事件中您将能够做出正确反应。但就像每个紧急响应人员都继续训练和学习一样，您也需要建立定期实践的节奏，以确保团队中的每个人都熟悉正确的应对措施，并且（也许更重要的是）随着系统的变化，您的响应保持最新。

# 全球推出最佳实践

在全球范围内推出您的软件，特别是如果您以前从未这样做过，可能是一个重大挑战。以下是我们多年生产经验基础上的一些最佳实践，用于管理关键任务软件的全球部署：

+   将每个镜像分布到全球各地。成功的推出取决于发布的位（二进制文件、镜像等）是否靠近它们将被使用的地方。这也确保在网络减速或不规则性存在时推出的可靠性。地理分布应成为您的自动化发布流水线的一部分，以确保一致性。

+   尽可能将您的测试尽量向左移动，通过尽可能广泛的集成和重放测试来测试您的应用程序。您希望仅通过您强烈相信正确的发布才开始推出。

+   在金丝雀区域开始发布，这是一个预生产环境，在这里其他团队或大客户可以在您开始更大规模的推出之前验证他们对您服务的使用。

+   辨识您部署的不同地区的特征。每一个差异可能都会导致故障和完全或部分的停机。尽量先向风险较低的地区推出。

+   记录并实践对可能遇到的任何问题或流程（例如回滚）的响应。试图在紧急情况下记住该做什么往往会导致遗漏某些步骤，使问题更加严重。

# 总结

今天看起来可能不太可能，但我们大多数人在职业生涯中最终会运行一个全球规模的系统。本章描述了如何逐步构建和迭代您的系统，使其成为真正的全球设计。还讨论了如何设置您的部署以确保系统在更新期间最小化停机时间。最后，我们讨论了设置和实践必要的流程和程序，以在出现问题时做出反应（请注意，我们没有说“如果”而是“当”出现问题时）。
