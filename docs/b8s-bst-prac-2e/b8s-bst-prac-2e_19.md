# 第十九章：安全

Kubernetes 是一个强大的平台，用于编排云原生应用程序。然而，在我们熟悉和喜爱的 API 和工具之下，隐藏着一个庞大而复杂的分布式系统，需要特定的知识来确保安全。保护 Kubernetes 是一个复杂的话题，实际上需要一本专门的书来详细讲解；然而，如果您忽视了理解和实施安全最佳实践，可能会面临重大风险，我们在这里简要介绍。如果您没有正确地保护 Kubernetes 集群和工作负载，可能会导致您的数据和资源暴露给黑客、恶意软件和未经授权的访问。我们必须覆盖一些主要的安全领域，并提供最佳实践以帮助您走上正轨。

考虑到 Kubernetes 的复杂性，我们建议将问题分解为逻辑层次，在每个层次可以专注于具体的工具。处理安全问题的一个很好的方法是遵循“深度防御”策略。这要求在每个层次使用多重安全措施来保护 Kubernetes 和您的工作负载。此外，牢记最小特权原则，即用户和工作负载应仅具有执行其功能所需的访问权限。这些理论听起来都很好，但在实践中是什么样子呢？本章提供了一种将安全问题分层处理的方法，帮助您关注可用的解决方案和工具，以及集群安全、容器安全和代码安全。

许多安全最佳实践在其他章节中已经详细介绍，包括第 4 至第十一章。我们鼓励您查看这些章节，因为我们在这里不会再次以相同的详细程度涵盖这些特定主题，而是专注于我们未涵盖的领域。特别是，本章将重点放在层次结构上；深入挖掘它们，涵盖安全领域，并为每个层次提供最佳实践。

# 集群安全

鉴于 Kubernetes 控制平面通过一组 API 开放，保护集群的第一步是规范和限制谁可以访问集群以及他们可以执行的操作。接下来，我们将介绍 Kubernetes 控制平面的不同部分以及如何保护它们。

## etcd 访问

Kubernetes 的默认存储系统是 etcd。您必须确保只有 Kubernetes API 服务器通过使用强密码来访问 etcd，并且不共享这些凭据。您还必须确保只有 API 服务器通过使用网络防火墙才能访问 etcd。直接访问 etcd 将绕过您所采取的所有后续安全措施，因此这是一个非常重要的安全层。

## 认证

Kubernetes 提供多种不同的认证方法，从 bearer token 和证书到 OpenID Connect（OIDC）和 Lightweight Directory Access Protocol（LDAP）集成。选择适合你业务需求的正确认证模型非常重要。安全挑战通常出现在创建、分发和存储用户需要使用 `kubectl` 来认证 Kubernetes 的 Kubeconfig 文件过程中。使用认证提供者允许检索临时动态令牌，而不是使用容易被恶意角色获取的静态令牌或证书。有关存储在 Kubeconfig 文件中的恶意代码实例的论文已经被撰写，因此控制它们的创建和分发非常重要。

## 授权

我们在第十七章中讨论了授权；然而，在 Kubernetes 安全的上下文中，授权是一个强大的工具，用于强制执行谁可以在哪些资源上执行什么操作。你可以使用基于角色的访问控制（RBAC）作为主要工具。幸运的是，Kubernetes 默认情况下提供了合理的默认设置；但是，你需要考虑整合团队成员身份以及命名空间，作为扩展 RBAC 资源的方法，以支持不断增长的工作负载和用户数量。使用 RBAC 锁定服务账户也非常重要，以确保需要访问 Kubernetes API 的工作负载只能执行其功能所需的最低操作。

## TLS

默认情况下，Kubernetes 使用 TLS 加密的 API 端点。然而，不同的工具和平台可能启用了 HTTP 明文通信，这会导致安全漏洞，因为流量是不安全的。安全存储和控制访问 Kubernetes 使用的证书和密钥是非常重要的，并创建一个计划来轮换它们，以防它们丢失或被 compromise。在证书上设置较短的生命周期有助于降低安全风险。

## Kubelet 和云元数据访问

Kubelet 是在每个节点上运行的组件，负责管理节点和运行在其上的 pod。不幸的是，Kubelet 默认启用了未经身份验证的 API。Kubelet API 非常强大，因此应该启用认证和授权。你的 Kubernetes 提供商可能已经为你处理了这些问题；然而，如果你自己搭建 Kubernetes 集群，应该仔细检查。除了 Kubelet API 外，如果在云提供商上运行，节点可能有访问云元数据 API 的权限，该 API 可用于暴露 Kubernetes 的配置凭证。建议使用网络策略锁定对元数据端点的访问。

## Secrets

Kubernetes 秘密默认情况下未加密并非秘密。这意味着恶意行为者可以通过其他途径在静止状态下读取这些秘密。幸运的是，有几种不同的解决方案可以帮助解决这个问题。Kubernetes API 服务器提供配置加密提供程序的能力，该提供程序与配置文件合作，用于在存储在 etcd 之前加密特定的 Kubernetes 资源。加密提供程序通常是云秘密存储服务。当前加密提供程序实现的唯一挑战是没有办法加密所有内容，且配置繁琐且容易出错。Kubernetes 社区构建的另一个解决方案是[csi secret store](https://oreil.ly/cbiYT)，它允许将秘密直接挂载到通过临时 RAMDISK 文件系统的 Pod 中。使用`csi-secret-store`使您可以绕过使用 Kubernetes 秘密，而是直接从其他受信任的秘密存储中访问它们。

## 日志记录和审计

Kubernetes 默认配置了丰富的日志记录。此外，还重要的是在 API 服务器上启用审计日志记录，这将记录所有安全事件的时间顺序日志，并可以通过审计策略进行配置。启用审计只是解决方案的一部分；您还必须确保将审计日志发送到聚合点，并配置触发器，一旦检测到异常事件，即向安全团队发出警报。

## 集群安全姿态工具

实施 Kubernetes 安全可能具有挑战性。好消息是，有开源工具可以扫描您的 Kubernetes 集群，检测安全风险，并标记常见的配置错误。此外，它们可以扫描集群上的所有资源并提供最佳实践。像[Kubescape](https://oreil.ly/qPoHQ)这样的工具运行快速，并根据严重性提供输出。建议定期在所有集群上运行这些工具，以确定集群及其部署资源的安全姿态。

# 集群安全最佳实践

现在我们已经涵盖了集群层面的最大安全领域，这里有一个方便的安全最佳实践清单供您参考：

+   限制 etcd 访问并将访问凭据和证书存储在安全位置。

+   禁用不安全和未经身份验证的 API 端点。

+   使用提供临时动态令牌而不是静态配置令牌的身份验证提供者在 Kubeconfig 中进行配置。

+   确保用户和服务遵循最小权限原则。

+   定期轮换基础设施凭据。

+   使用密钥和证书对静止和传输中的敏感数据进行加密。

+   在部署到集群之前，扫描容器镜像以检测漏洞和恶意软件。

+   启用审计日志记录和监控以检测和响应可疑活动。

+   使用安全扫描工具如 Kubescape 来基准您的 Kubernetes 集群和工作负载的安全姿态。

# 工作负载容器安全性

现在我们已经讨论了集群安全的核心组件，我们将看看工作负载层面的安全机制。Kubernetes 提供了许多专注于安全的 API，通过相同的工具可以简化配置和部署工作负载。

## Pod 安全准入

Pod 安全准入是您工作负载安全性的重要组成部分，允许您配置和管理 pod 配置中所有安全敏感组件，并在命名空间或集群级别应用开箱即用的最佳实践。专门有关容器和 pod 安全的详细内容，请查阅第十章。

## Seccomp、AppArmor 和 SELinux

Linux 提供了几种不同的安全机制，可以与 Kubernetes 结合使用，增强运行在 Kubernetes 上的工作负载的安全性。Seccomp 允许创建系统调用过滤配置文件，用于限制容器发出的系统调用。不幸的是，Kubernetes 社区对 Seccomp 配置的讨论不足，或者根本没有进行配置，或者配置错误，允许容器访问可能用于恶意目的的系统调用。Kubernetes 社区开发了一个称为[安全配置操作器](https://oreil.ly/g0tNJ)的优秀工具，简化了配置 Seccomp 配置文件的管理开销。从安全角度来看，Seccomp 是一个低成本的配置项，强烈建议您至少启用 Seccomp 的默认配置文件。

AppArmor 和 SELinux 是 Linux 内核安全模块，允许对每个容器进行精细化的强制访问控制配置。这些模块允许集群管理员对容器的操作权限进行细粒度控制。结合 Pod 安全准入和这些 Linux 安全机制，您可以控制容器对操作系统的访问级别。

## 准入控制器

准入控制器是确保工作负载安全的关键部分。Kubernetes 提供了一组集成的准入控制器，并且所有与安全相关的准入控制器都默认启用。例如，NodeRestriction 准入控制器限制了 Kubelet 只能修改分配给特定节点的 pod 的权限。准入控制器是一个重要主题，建议您查看第十七章获取更多详细信息。

## 操作器

运算符是使用 Kubernetes API 提供自定义资源来支持特定工作负载的控制器，这些工作负载需要应用程序特定的知识。如果您想了解更多关于运算符模式的信息，请参考第二十一章，我们在其中详细介绍了如何实现运算符。在安全的背景下，不幸的是，许多运算符具有非常宽松的 RBAC 配置，以便于使用。许多运算符授予集群管理员或等效权限，这可能作为攻击向量。此外，尽管较少见，这些运算符可能直接暴露其他 API，这可能提供特权升级的路径。

## 网络策略

Kubernetes 提供了网络策略资源；但是，您需要确保您的网络提供商在运行时实现了该资源。有关网络安全的更多详细信息，请参考第九章。Kubernetes 网络策略可以对允许进入或退出服务或命名空间的网络流量进行细粒度控制，适用于集群内外的资源。网络策略还允许集群管理员创建集群范围或命名空间特定的策略，并将应用程序特定的网络策略委托给应用程序开发人员。网络策略仅涵盖 IP 地址和 TCP/UDP 端口，而不涉及特定的 HTTP 流量或端点路由访问控制。如果您需要应用程序特定的访问策略，服务网格提供了高级别的访问策略，这些策略不是 Kubernetes 集成 API 的一部分。

## 运行时安全

大多数 Kubernetes 集群默认使用诸如[containerd](https://oreil.ly/Vyq_N)或[CRI-O](https://oreil.ly/OiXpP)等容器运行时，它们在底层使用 Linux cgroups 提供轻量级沙箱以支持容器运行时。对于一些安全敏感的工作负载，这些安全保证可能不足够。存在一系列不同的容器运行时，包括[Kata containers](https://oreil.ly/ANDje)和[gvisor](https://oreil.ly/fuNPn)，它们提供不同的安全配置以满足工作负载的需求。Kubernetes 支持在同一集群中使用多个容器运行时，使用 pod 规范中的 `RuntimeClass` 字段。请参考第十章以获取有关 `RuntimeClass` 的更多详细信息。如果您仍然需要更高级别的安全性，则[机密容器](https://oreil.ly/v66K0)可能也是需要考虑的选项。机密容器利用[受信执行环境](https://oreil.ly/eSJfX)，这是在 CPU 上运行工作负载的安全区域。

类似 Kubernetes 控制平面上的审计日志，您还应该投资于容器运行时内部的审计日志记录。像 [Falco](https://oreil.ly/9KOeg) 这样的工具提供了一种启用容器运行时内应用程序可以执行的审计日志记录和策略的方式。了解容器运行时的情况使您能够尽可能接近源头地监视和捕获恶意行为。

## 工作负载容器安全最佳实践

Kubernetes 为您提供了丰富的安全工具集，可以帮助您几乎无法理解。这里是一些快速提高集群上运行负载安全姿态的最佳实践的简短列表：

+   使用 Node 和 RBAC 授权器以及 NodeRestriction 准入插件的组合。

+   使用强身份验证和授权机制保护集群控制平面。

+   检查操作员 API 权限，并确保它们遵循最小特权原则。

+   应用最小特权原则来限制用户、pod 和服务账号的访问和权限。

+   实施网络策略来限制 pod 和命名空间之间的流量。

+   确保启用推荐的基于安全的准入控制器集。

+   使用 Seccomp、AppArmor 和 SELinux 来减少容器运行时能够访问的 Linux 内核攻击面。

+   确保动态 Webhook 准入控制器的安全配置，仅限于它们需要验证/变更的资源，并遵循最小特权 RBAC。

+   在您的集群上提供不同的容器运行时沙盒，并使用 `RuntimeClass` 允许应用程序开发人员选择与安全要求匹配的运行时。

+   使用准入控制器验证应用程序工作负载的安全最佳实践。

# 代码安全性

良好的安全性在代码进入 Kubernetes 之前就开始了。我们将介绍一些不同的工具和技术，您可以引入来进一步改善安全姿态。

## 非根和无分发容器

在构建容器时有两个快速的胜利点可以提高安全姿态。通过在容器构建文件中指定非根用户来配置应用程序进程不以 root 用户身份运行。Kubernetes 允许在 pod 规范的 `securityContext` 部分设置此项。这可用作故障安全机制；但优先考虑在容器构建文件中配置。此外，许多基础容器预安装了常用软件包，这些软件包可能未被使用并可能引入漏洞。像 [distroless](https://oreil.ly/tpSEA) 和 scratch 容器提供了可能的最小基础容器映像，再次减少了攻击面。

## 容器漏洞扫描

许多开源工具提供容器镜像的漏洞扫描。这些工具，如[Trivy](https://oreil.ly/pFbNN)，易于使用，并可以提供容器镜像中漏洞的基线。然后根据这些结果决定是否部署容器。然而，这些工具可能会产生很多噪音并提供不一致的结果。许多容器仓库提供商提供集成的漏洞扫描，某些准入控制器会根据镜像中存在的漏洞来允许或拒绝工作负载的部署。

## 代码仓库安全

源代码仓库是改善安全性的另一个良好场所，幸运的是有工具和指导可帮助改善此层的安全姿态。

[软件工件的供应链级别](https://oreil.ly/CWXWD)，或 SLSA，是一个基于递增级别的控制清单框架，可帮助提高软件安全性和完整性。许多开源项目正在采纳 SLSA 以改善软件安全性。这些级别定义明确，实施后可以提升源代码的安全姿态。

[OpenSSF 评分卡](https://oreil.ly/q-NI3) 提供一组自动化工具，为您可能使用或考虑作为依赖项的开源仓库提供安全姿态的 0 到 10 分评分。综合评分提供了一目了然的视图，可用于评估开源项目的信任度。许多知名开源项目正在采用此评分卡。

# 代码安全最佳实践

良好的安全性始于容器部署到 Kubernetes 集群之前。代码仓库也是实施安全措施来构建深入安全策略的好地方。以下是一些最佳实践，可帮助您在代码安全性前线上快速取得成功：

+   检查操作者 API 权限，并确保其遵循最小权限原则。

+   配置容器构建文件以非根用户身份运行应用程序进程。

+   使用像 scratch 和 distroless 这样的容器基础镜像。

+   对容器进行漏洞扫描，并根据这些漏洞实施策略，决定是否允许部署容器。

+   查看您依赖的开源项目的 OpenSSF 评分卡。

+   实施 SLSA Level 1 以为您的软件提供基线级别的透明度和完整性。

# 概述

在本章中我们覆盖了大量内容。理解如何全面保护 Kubernetes 是非常重要的，这样你可以将问题分解成更小的部分来实施。安全是一个旅程而不是一个目的地。它将一直是一个动态的目标，通过遵循这些最佳实践，您可以提高 Kubernetes 集群的安全性并减少数据泄露或妥协的风险。
